| Date | Query | Rows | Notes |
|------|-------|------|-------|
| 2026-02-27 | Q0 schema checks | — | profiles: no email; org_members: no status; subscriptions: no organization_id; org scope uses billing_customers.stripe_subscription_id ↔ subscriptions.stripe_subscription_id | 
| 2026-02-27 | Q1 expired trials | 0 | No orgs stuck in trialing past trial_ends_at | 
| 2026-02-27 | Q2 duplicate active | 0 | No workspaces with >1 active subscription | 
| 2026-02-27 | Q3 missing org link | 0 | No active/trialing subscriptions missing billing_customers link | 
| 2026-02-27 | Q4 bc/sub mismatch | 0 | No active/trialing billing_customers rows missing subscriptions row | 
| 2026-02-27 | Q5 trialing+paid | 0 | No trialing billing_customers rows linked to active subscriptions | 
| 2026-02-27 | Q6 orphan stripe IDs | 0 | No billing_customers stripe_subscription_id missing from subscriptions | 

---

## P0.7 Guardrails (constraints + indexes)

### Target rules

| Area | Rule | Why |
|------|------|-----|
| organization_members | One membership per user per workspace (organization_id, user_id unique) | Prevent duplicate membership rows |
| billing_customers | One billing row per workspace (organization_id unique) | Prevent split/competing billing state |
| billing_customers | Stripe IDs unique when present (stripe_customer_id, stripe_subscription_id) | Prevent cross-linking Stripe records |
| subscriptions | Stripe subscription ID unique when present (stripe_subscription_id) | Prevent duplicates |
| profiles | Index current_organization_id | Faster active-workspace lookups |

### Run log

| Date | Change set | Status | Notes |
|------|------------|--------|------|
| 2026-02-27 | P0.7 guardrails v1 | ✅ Applied/verified | Pre-checks A–C: 0 rows. Found duplicate billing_customers.stripe_subscription_id (sub_1T20KJG4h8YnGsk4A4dHG3Fe) in 2 rows; confirmed real owner via subscriptions (user_id 4466f0e0… in a222759e…); cleaned by nulling stripe_subscription_id on orphan billing_customers row id 49825c06-e991-4ab4-81e4-42b46c520127. Then applied/verified guardrails: org_members unique (organization_id,user_id) already existed; billing_customers unique(organization_id) OK; unique stripe_customer_id/stripe_subscription_id partial uniques OK; subscriptions unique stripe_subscription_id partial unique OK; index on profiles.current_organization_id OK. |

## P0.8 Payment failure rules (status mapping)

- Current billing_customers statuses observed: trial_expired (51), active (4)
- Current subscriptions statuses observed: active (3), canceled (3)
- Next: define Stripe→DB status mapping for incomplete/incomplete_expired/past_due/unpaid/paused/canceled, and app gating rules per status.
