# P0.6 — Baseline DB Health Checks

Run these queries in the Supabase SQL editor (project: `yduzbvijzwczjapanxbd`).
Record results in the "Results" column each time you run them.

---

## 1. Orgs with expired trials still marked `trialing` in `billing_customers`

```sql
SELECT
  organization_id,
  status,
  trial_ends_at,
  stripe_subscription_id,
  plan_name
FROM billing_customers
WHERE status = 'trialing'
  AND trial_ends_at IS NOT NULL
  AND trial_ends_at < now()
ORDER BY trial_ends_at DESC;
```

**Expected:** 0 rows (or rows where `stripe_subscription_id` is set, meaning the trial
converted to a paid subscription and `billing_customers` just hasn't been synced yet).

**Action:** For each row with no `stripe_subscription_id` and `trial_ends_at` in the past,
update `status = 'trial_expired'` (or let billing-status do it lazily on next request).

---

## 2. Duplicate active subscriptions per org

```sql
SELECT
  organization_id,
  COUNT(*) AS active_count,
  array_agg(stripe_subscription_id ORDER BY updated_at DESC) AS sub_ids
FROM subscriptions
WHERE status = 'active'
  AND organization_id IS NOT NULL
GROUP BY organization_id
HAVING COUNT(*) > 1
ORDER BY active_count DESC;
```

**Expected:** 0 rows.

**Action:** Investigate each org. Cancel or archive the older (lower `updated_at`) subscription
in Stripe, then delete or mark the stale DB row.

---

## 3. Subscriptions missing `organization_id` for a user who belongs to exactly one org

```sql
SELECT
  s.stripe_subscription_id,
  s.status,
  s.user_id,
  s.organization_id,
  s.updated_at,
  om.organization_id AS derived_org_id
FROM subscriptions s
JOIN (
  SELECT user_id, organization_id, COUNT(*) OVER (PARTITION BY user_id) AS org_count
  FROM organization_members
) om ON om.user_id = s.user_id AND om.org_count = 1
WHERE s.organization_id IS NULL
  AND s.status IN ('active', 'trialing')
ORDER BY s.updated_at DESC;
```

**Expected:** 0 rows (legacy rows may exist; they are handled by `allowLegacyUserScopedFallback`
in billing-status, but should be patched for cleanliness).

**Action:** For each row, set `organization_id = derived_org_id` if the org can be confirmed.

---

## 4. `billing_customers` / `subscriptions` mismatch — org marked active in billing_customers but no active subscription

```sql
SELECT
  bc.organization_id,
  bc.status         AS bc_status,
  bc.stripe_subscription_id AS bc_sub_id,
  s.stripe_subscription_id  AS sub_id,
  s.status          AS sub_status
FROM billing_customers bc
LEFT JOIN subscriptions s
  ON s.organization_id = bc.organization_id
  AND s.status IN ('active', 'trialing')
WHERE bc.status IN ('active', 'trialing')
  AND s.stripe_subscription_id IS NULL
ORDER BY bc.organization_id;
```

**Expected:** 0 rows (all active/trialing `billing_customers` should have a matching active
`subscriptions` row, or a `stripe_subscription_id` for on-demand lookup).

**Action:** Run `billing-status` for each org to trigger the Stripe fallback and upsert the
subscription row.

---

## 5. Orgs with `billing_customers.status = 'trialing'` but `billing_customers.stripe_subscription_id` set (should be `active`)

```sql
SELECT
  bc.organization_id,
  bc.status,
  bc.stripe_subscription_id,
  s.status AS sub_status
FROM billing_customers bc
JOIN subscriptions s
  ON s.stripe_subscription_id = bc.stripe_subscription_id
WHERE bc.status = 'trialing'
  AND bc.stripe_subscription_id IS NOT NULL
  AND s.status = 'active'
ORDER BY bc.organization_id;
```

**Expected:** 0 rows. These orgs paid but `billing_customers.status` was never synced.

**Action:** `UPDATE billing_customers SET status = 'active', trial_ends_at = NULL WHERE organization_id = '<id>';`

---

## 6. Stripe subscription IDs in `billing_customers` that are not in `subscriptions`

```sql
SELECT
  bc.organization_id,
  bc.stripe_subscription_id,
  bc.status
FROM billing_customers bc
WHERE bc.stripe_subscription_id IS NOT NULL
  AND NOT EXISTS (
    SELECT 1 FROM subscriptions s
    WHERE s.stripe_subscription_id = bc.stripe_subscription_id
  )
ORDER BY bc.organization_id;
```

**Expected:** 0 rows (or rows pending first-time sync).

**Action:** Trigger `billing-status?organization_id=<org_id>` for each org to force Stripe
lookup and upsert the subscription row.

---

## Results Log

| Date | Query | Rows | Notes |
|------|-------|------|-------|
| _YYYY-MM-DD_ | Q1 expired trials | — | First run |
| _YYYY-MM-DD_ | Q2 duplicate active | — | First run |
| _YYYY-MM-DD_ | Q3 missing org_id | — | First run |
| _YYYY-MM-DD_ | Q4 bc/sub mismatch | — | First run |
| _YYYY-MM-DD_ | Q5 trialing+paid | — | First run |
| _YYYY-MM-DD_ | Q6 orphan stripe IDs | — | First run |

P0.6 is **DONE** once all six queries return 0 rows (or remaining rows are documented
anomalies) and results are recorded in the table above.
