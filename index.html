<!doctype html>
<!--
  TRUCK PACKER 3D
  Version: 1.0.0 (MVP)
  A production-ready, single-file 3D logistics planning workspace.

  QUICK START:
  1) Open this file in a modern browser (Chrome/Edge/Firefox/Safari).
  2) Create cases (Cases) and a project (Packs).
  3) Open a pack (Editor), add cases, drag to place, or AutoPack.

  NOTE:
  - Works on file:// for demos. For best results, run on http(s):// (some browsers restrict features on file://).
  - CDN libraries are required; if any CDN fails, the app shows a recovery message.
-->
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <title>Truck Packer 3D</title>

    <!-- ===== BOOT: CDN failure capture (must run before vendor scripts) ===== -->
    <!-- Pre-init: capture CDN failures before app boot -->
    <script>
      (function () {
        'use strict';
        window.__TP3D_BOOT = window.__TP3D_BOOT || {
          cdnFailures: [],
          vendorLoaded: {},
          vendorPromises: {},
          vendorResolvers: {},
        };

        function debugEnabled() {
          try {
            return window.localStorage && window.localStorage.getItem('tp3dDebug') === '1';
          } catch (_) {
            return false;
          }
        }

        function ensureVendorPromise(key) {
          const k = String(key || '').trim();
          if (!k) return null;
          window.__TP3D_BOOT.vendorPromises[k] =
            window.__TP3D_BOOT.vendorPromises[k] ||
            new Promise(resolve => {
              window.__TP3D_BOOT.vendorResolvers[k] = resolve;
            });
          return window.__TP3D_BOOT.vendorPromises[k];
        }

        window.__tp3dCdnFail = function (name, url, key) {
          try {
            window.__TP3D_BOOT.cdnFailures.push({
              key: key ? String(key) : '',
              name: String(name || 'CDN'),
              url: String(url || ''),
            });
          } catch (_) {
            // Ignore errors if boot object is not available
          }
        };

        window.__tp3dVendorOk = function (key) {
          const k = String(key || '').trim();
          if (!k) return;
          window.__TP3D_BOOT.vendorLoaded[k] = true;
          ensureVendorPromise(k);
          if (window.__TP3D_BOOT.vendorResolvers[k]) window.__TP3D_BOOT.vendorResolvers[k](true);
          if (debugEnabled()) console.info('[TP3D] vendor ok:', k);
        };

        window.__tp3dVendorFail = function (key, name, url, fallbackUrl, el, localPath) {
          const k = String(key || '').trim();
          window.__tp3dCdnFail(name, url, k);
          ensureVendorPromise(k);
          if (!k || window.__TP3D_BOOT.vendorLoaded[k]) return;
          const fallback = String(fallbackUrl || '').trim();
          if (!fallback) return;

          try {
            const parent = el && el.parentNode ? el.parentNode : document.head;
            const script = document.createElement('script');
            script.src = fallback;
            script.async = false;
            script.onload = function () {
              window.__tp3dVendorOk(k);
              if (debugEnabled()) console.info('[TP3D] vendor CDN fallback ok:', k, fallback);
            };
            script.onerror = function () {
              window.__tp3dCdnFail(name + ' (CDN fallback)', fallback, k);
              if (debugEnabled()) console.info('[TP3D] vendor CDN fallback failed:', k, fallback);

              // Try local fallback as final option
              const local = String(localPath || '').trim();
              if (local && !window.__TP3D_BOOT.vendorLoaded[k]) {
                try {
                  const localScript = document.createElement('script');
                  localScript.src = local;
                  localScript.async = false;
                  localScript.onload = function () {
                    window.__tp3dVendorOk(k);
                    if (debugEnabled()) console.info('[TP3D] vendor local fallback ok:', k, local);
                  };
                  localScript.onerror = function () {
                    window.__tp3dCdnFail(name + ' (local fallback)', local, k);
                    if (debugEnabled()) console.info('[TP3D] vendor local fallback failed:', k, local);
                  };
                  parent.insertBefore(localScript, script && script.nextSibling ? script.nextSibling : null);
                  if (debugEnabled()) console.info('[TP3D] vendor local fallback injecting:', k, local);
                } catch (_) {
                  // ignore
                }
              }
            };
            parent.insertBefore(script, el && el.nextSibling ? el.nextSibling : null);
            if (debugEnabled()) console.info('[TP3D] vendor CDN fallback injecting:', k, fallback);
          } catch (_) {
            // ignore
          }
        };

        window.__tp3dVendorAllReady = function () {
          const promises =
            window.__TP3D_BOOT && window.__TP3D_BOOT.vendorPromises ? window.__TP3D_BOOT.vendorPromises : {};
          return Promise.all(Object.keys(promises).map(k => promises[k]));
        };
      })();
    </script>

    <!-- 3D Rendering (ES Modules) -->
    <!--
      NOTE (compatibility): Import maps are not supported in Safari 14, so we avoid them.
      We load ESM via esm.sh, which rewrites internal bare imports for broad compatibility.
    -->
    <script type="module">
      window.__TP3D_BOOT = window.__TP3D_BOOT || { cdnFailures: [] };
      // ===== BOOT: THREE.js ESM loader (sets window.THREE + OrbitControls) =====
      window.__TP3D_BOOT.threeReady = (async function () {
        const primaryBase = 'https://esm.sh/three@0.160.0';
        const fallbackBase = 'https://cdn.skypack.dev/three@0.160.0';
        try {
          const ThreeModule = await import(primaryBase);
          const Orbit = await import(`${primaryBase}/examples/jsm/controls/OrbitControls.js`);
          window.THREE = { ...ThreeModule, OrbitControls: Orbit.OrbitControls };
          window.__tp3dVendorOk && window.__tp3dVendorOk('three');
          return true;
        } catch (err) {
          try {
            const ThreeModule = await import(fallbackBase);
            const Orbit = await import(`${fallbackBase}/examples/jsm/controls/OrbitControls.js`);
            window.THREE = { ...ThreeModule, OrbitControls: Orbit.OrbitControls };
            window.__tp3dVendorOk && window.__tp3dVendorOk('three');
            return true;
          } catch (err2) {
            try {
              const localThree = './vendor/three.module.js';
              const localOrbit = './vendor/OrbitControls.module.js';
              const ThreeModule = await import(localThree);
              const Orbit = await import(localOrbit);
              window.THREE = { ...ThreeModule, OrbitControls: Orbit.OrbitControls };
              window.__tp3dVendorOk && window.__tp3dVendorOk('three');
              return true;
            } catch (err3) {
              window.__tp3dCdnFail('three@0.160.0 (ESM) / OrbitControls', primaryBase, 'three');
              window.__tp3dCdnFail('three@0.160.0 (local module) / OrbitControls', './vendor/three.module.js', 'three');
              console.error(err2);
              console.error(err3);
              return false;
            }
          }
        }
      })();
    </script>

    <!-- Animation -->
    <!-- ===== VENDOR: TWEEN.js ===== -->
    <script
      src="https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@23.1.1/dist/tween.umd.js"
      onload="__tp3dVendorOk('tween')"
      onerror="
        __tp3dVendorFail(
          'tween',
          '@tweenjs/tween.js@23.1.1',
          'https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@23.1.1/dist/tween.umd.js',
          'https://unpkg.com/@tweenjs/tween.js@23.1.1/dist/tween.umd.js',
          this,
          'vendor/tween.umd.js'
        )
      "
    ></script>

    <!-- PDF Generation -->
    <!-- ===== VENDOR: jsPDF ===== -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
      onload="__tp3dVendorOk('jspdf')"
      onerror="
        __tp3dVendorFail(
          'jspdf',
          'jsPDF@2.5.1',
          'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
          'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js',
          this,
          'vendor/jspdf.umd.min.js'
        )
      "
    ></script>

    <!-- Excel/CSV Import -->
    <!-- ===== VENDOR: XLSX ===== -->
    <script
      src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"
      onload="__tp3dVendorOk('xlsx')"
      onerror="
        __tp3dVendorFail(
          'xlsx',
          'xlsx@0.18.5',
          'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
          'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js',
          this,
          'vendor/xlsx.full.min.js'
        )
      "
    ></script>

    <!-- UI Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      onerror="
        this.onerror = null;
        this.href = 'vendor/fontawesome.min.css';
        __tp3dCdnFail(
          'Font Awesome 6.5.1',
          'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css',
          'fontawesome'
        );
      "
    />

    <!-- Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <!-- ===== STYLES: App CSS (single-file) ===== -->
    <link rel="stylesheet" href="styles/main.css" />
    <style media="not all">
      /* moved to styles/main.css */
    </style>
  </head>

  <body>
    <noscript>
      <div style="padding: 20px; font-family: system-ui">This app requires JavaScript enabled.</div>
    </noscript>

    <!-- ===== APP SHELL ===== -->
    <div class="app" id="app">
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="brand-mark" aria-hidden="true"></div>
          <div class="brand-text">
            <div class="brand-name">Truck Packer 3D</div>
          </div>
        </div>

        <nav class="nav" aria-label="Primary">
          <button class="nav-btn" type="button" data-nav="packs">
            <i class="fa-solid fa-layer-group"></i>
            Packs
          </button>
          <button class="nav-btn" type="button" data-nav="cases">
            <i class="fa-solid fa-box"></i>
            Cases
          </button>
          <button class="nav-btn" type="button" data-nav="editor">
            <i class="fa-solid fa-cube"></i>
            Editor
          </button>
        </nav>

        <div style="padding: var(--space-3)">
          <button class="btn" id="btn-account-switcher" type="button">
            <span style="display: flex; align-items: center; gap: var(--space-3); min-width: 0">
              <span
                class="brand-mark tp3d-settings-account-avatar"
                aria-hidden="true"
                style="width: 34px; height: 34px; border-radius: 12px; flex: 0 0 auto"
              ></span>
              <span style="display: flex; flex-direction: column; align-items: flex-start; min-width: 0">
                <span style="font-weight: var(--font-semibold); line-height: 1.1">Personal Account</span>
                <span class="muted" data-account-name style="font-size: var(--text-sm); line-height: 1.1">—</span>
              </span>
            </span>
            <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
          </button>
        </div>
      </aside>

      <main class="main">
        <header class="topbar">
          <div class="topbar-left">
            <button class="btn btn-ghost" id="btn-sidebar" type="button" title="Menu" aria-label="Menu">
              <i class="fa-solid fa-bars"></i>
            </button>
            <div class="topbar-title">
              <h1 id="topbar-title">Packs</h1>
              <div class="topbar-subtitle" id="topbar-subtitle">Project library</div>
            </div>
          </div>
          <div class="topbar-right"></div>
        </header>

        <div class="content">
          <!-- Packs -->
          <!-- ===== SCREEN: PACKS ===== -->
          <section class="screen" id="screen-packs">
            <div class="row space-between">
              <div class="grid" style="gap: 6px">
                <div style="font-size: var(--text-2xl); font-weight: var(--font-semibold)">Packs</div>
                <div class="muted" style="font-size: var(--text-sm)">
                  Create projects, duplicate, export, and open in the editor.
                </div>
              </div>
              <div class="row" id="packs-actions-default">
                <button class="btn" id="btn-import-pack" type="button">
                  <i class="fa-solid fa-file-import"></i>
                  Import Pack
                </button>
                <button class="btn btn-primary" id="btn-new-pack" type="button">
                  <i class="fa-solid fa-plus"></i>
                  New Pack
                </button>
              </div>
              <div class="row" id="packs-actions-bulk" style="display: none; gap: 8px; align-items: center">
                <div class="muted" id="packs-selected-count"></div>
                <button class="btn btn-danger" id="btn-packs-bulk-delete" type="button">
                  <i class="fa-solid fa-trash"></i>
                  Delete (0)
                </button>
              </div>
            </div>
            <div style="height: 14px"></div>
            <div class="row" style="align-items: center">
              <div style="flex: 1; min-width: 220px; position: relative">
                <i
                  class="fa-solid fa-magnifying-glass"
                  style="
                    position: absolute;
                    left: 10px;
                    top: 50%;
                    transform: translateY(-50%);
                    color: var(--text-muted);
                  "
                ></i>
                <input
                  class="input"
                  id="packs-search"
                  type="text"
                  placeholder="Search packs..."
                  style="padding-left: 30px"
                  aria-label="Search packs"
                />
              </div>
              <div class="row" style="gap: 4px">
                <button class="btn" id="packs-view-grid" type="button" title="Grid view" aria-label="Grid view">
                  <i class="fa-solid fa-grip"></i>
                </button>
                <button class="btn" id="packs-view-list" type="button" title="List view" aria-label="List view">
                  <i class="fa-solid fa-list"></i>
                </button>

                <button
                  class="btn"
                  id="packs-filters-toggle"
                  type="button"
                  title="Toggle filters"
                  aria-label="Toggle filters"
                >
                  <i class="fa-solid fa-filter"></i>
                </button>
                <button
                  class="btn"
                  id="packs-card-display"
                  type="button"
                  title="Card display"
                  aria-label="Card display"
                >
                  <i class="fa-solid fa-eye"></i>
                </button>
                <button
                  class="btn"
                  id="packs-trailer-presets"
                  type="button"
                  title="Trailer preset"
                  aria-label="Trailer preset"
                >
                  <i class="fa-solid fa-truck"></i>
                </button>
              </div>
              <div class="search-shell" style="flex: 1; min-width: 260px; display: none">
                <div class="search-input"></div>
                <div class="search-empty" id="packs-filter-empty">
                  <div id="packs-filter-empty-msg" style="font-weight: var(--font-semibold); margin-bottom: 4px">
                    No matching packs
                  </div>
                  <div class="muted" style="font-size: var(--text-sm)">
                    Try a different keyword or press Esc to reset search.
                  </div>
                </div>
              </div>
            </div>
            <div style="height: 10px"></div>
            <div class="row" style="gap: 8px; flex-wrap: wrap">
              <button class="chip" id="packs-filter-chip-empty" type="button" title="Packs with 0 cases">
                <span class="chip-dot"></span>
                Empty
              </button>
              <button class="chip" id="packs-filter-chip-partial" type="button" title="Packs with some volume used">
                <span class="chip-dot"></span>
                Partial
              </button>
              <button class="chip" id="packs-filter-chip-full" type="button" title="Packs at 100% volume">
                <span class="chip-dot"></span>
                Full
              </button>
            </div>
            <div style="height: 14px"></div>
            <div class="pack-grid" id="packs-grid"></div>
            <div class="table-wrap" id="packs-list" style="display: none">
              <table>
                <thead>
                  <tr>
                    <th scope="col" style="width: 36px; text-align: center">
                      <input id="packs-select-all" type="checkbox" aria-label="Select all visible packs" />
                    </th>
                    <th scope="col" data-sort="title">
                      <span class="th-sort" role="button" tabindex="0">
                        <span class="th-label">Title</span>
                        <span class="th-chevrons" aria-hidden="true">
                          <i class="fa-solid fa-chevron-up th-chevron th-chevron-up"></i>
                          <i class="fa-solid fa-chevron-down th-chevron th-chevron-down"></i>
                        </span>
                      </span>
                    </th>
                    <th scope="col" data-sort="cases">
                      <span class="th-sort" role="button" tabindex="0">
                        <span class="th-label">Cases</span>
                        <span class="th-chevrons" aria-hidden="true">
                          <i class="fa-solid fa-chevron-up th-chevron th-chevron-up"></i>
                          <i class="fa-solid fa-chevron-down th-chevron th-chevron-down"></i>
                        </span>
                      </span>
                    </th>
                    <th scope="col" data-sort="length">
                      <span class="th-sort" role="button" tabindex="0">
                        <span class="th-label">Length</span>
                        <span class="th-chevrons" aria-hidden="true">
                          <i class="fa-solid fa-chevron-up th-chevron th-chevron-up"></i>
                          <i class="fa-solid fa-chevron-down th-chevron th-chevron-down"></i>
                        </span>
                      </span>
                    </th>
                    <th scope="col" data-sort="width">
                      <span class="th-sort" role="button" tabindex="0">
                        <span class="th-label">Width</span>
                        <span class="th-chevrons" aria-hidden="true">
                          <i class="fa-solid fa-chevron-up th-chevron th-chevron-up"></i>
                          <i class="fa-solid fa-chevron-down th-chevron th-chevron-down"></i>
                        </span>
                      </span>
                    </th>
                    <th scope="col" data-sort="height">
                      <span class="th-sort" role="button" tabindex="0">
                        <span class="th-label">Height</span>
                        <span class="th-chevrons" aria-hidden="true">
                          <i class="fa-solid fa-chevron-up th-chevron th-chevron-up"></i>
                          <i class="fa-solid fa-chevron-down th-chevron th-chevron-down"></i>
                        </span>
                      </span>
                    </th>
                    <th scope="col" data-sort="mode">
                      <span class="th-sort" role="button" tabindex="0">
                        <span class="th-label">SHAPE</span>
                        <span class="th-chevrons" aria-hidden="true">
                          <i class="fa-solid fa-chevron-up th-chevron th-chevron-up"></i>
                          <i class="fa-solid fa-chevron-down th-chevron th-chevron-down"></i>
                        </span>
                      </span>
                    </th>
                    <th scope="col" data-sort="packed">
                      <span class="th-sort" role="button" tabindex="0">
                        <span class="th-label">Packed</span>
                        <span class="th-chevrons" aria-hidden="true">
                          <i class="fa-solid fa-chevron-up th-chevron th-chevron-up"></i>
                          <i class="fa-solid fa-chevron-down th-chevron th-chevron-down"></i>
                        </span>
                      </span>
                    </th>
                    <th scope="col" data-sort="volume">
                      <span class="th-sort" role="button" tabindex="0">
                        <span class="th-label">Volume</span>
                        <span class="th-chevrons" aria-hidden="true">
                          <i class="fa-solid fa-chevron-up th-chevron th-chevron-up"></i>
                          <i class="fa-solid fa-chevron-down th-chevron th-chevron-down"></i>
                        </span>
                      </span>
                    </th>
                    <th scope="col" data-sort="weight">
                      <span class="th-sort" role="button" tabindex="0">
                        <span class="th-label">Weight</span>
                        <span class="th-chevrons" aria-hidden="true">
                          <i class="fa-solid fa-chevron-up th-chevron th-chevron-up"></i>
                          <i class="fa-solid fa-chevron-down th-chevron th-chevron-down"></i>
                        </span>
                      </span>
                    </th>
                    <th scope="col" data-sort="edited">
                      <span class="th-sort" role="button" tabindex="0">
                        <span class="th-label">Edited</span>
                        <span class="th-chevrons" aria-hidden="true">
                          <i class="fa-solid fa-chevron-up th-chevron th-chevron-up"></i>
                          <i class="fa-solid fa-chevron-down th-chevron th-chevron-down"></i>
                        </span>
                      </span>
                    </th>
                    <th class="col-actions" scope="col"></th>
                  </tr>
                </thead>
                <tbody id="packs-tbody"></tbody>
              </table>
            </div>
            <div class="card" id="packs-empty" style="display: none; margin-top: 16px">
              <div style="font-weight: var(--font-semibold); margin-bottom: 6px">No packs yet</div>
              <div class="muted" style="font-size: var(--text-sm)">Create your first pack to start planning.</div>
            </div>
          </section>

          <!-- Cases -->
          <!-- ===== SCREEN: CASES ===== -->
          <section class="screen" id="screen-cases">
            <div class="tp3d-cases-header">
              <div class="tp3d-cases-header-left">
                <div class="tp3d-cases-title-row">
                  <div style="font-size: var(--text-2xl); font-weight: var(--font-semibold)">Cases</div>
                  <button class="btn btn-primary" id="btn-new-case" type="button">
                    <i class="fa-solid fa-plus"></i>
                    New Case
                  </button>
                </div>
                <div class="muted" style="font-size: var(--text-sm)">
                  Manage your inventory. Import via CSV/XLSX or create manually.
                </div>
              </div>
              <div class="row" id="cases-actions-default">
                <button class="btn" id="btn-cases-template" type="button">
                  <i class="fa-solid fa-download"></i>
                  Template
                </button>
                <button class="btn" id="btn-cases-import" type="button">
                  <i class="fa-solid fa-file-import"></i>
                  Import Case
                </button>
              </div>
              <div class="row" id="cases-actions-bulk" style="display: none; gap: 8px; align-items: center">
                <div class="muted" id="cases-selected-count"></div>
                <button class="btn btn-danger" id="btn-cases-bulk-delete" type="button">
                  <i class="fa-solid fa-trash"></i>
                  Delete (0)
                </button>
              </div>
            </div>
            <div style="height: 14px"></div>
            <div class="row" style="gap: 10px; align-items: center">
              <div style="flex: 1; min-width: 220px; position: relative">
                <i
                  class="fa-solid fa-magnifying-glass"
                  style="
                    position: absolute;
                    left: 10px;
                    top: 50%;
                    transform: translateY(-50%);
                    color: var(--text-muted);
                  "
                ></i>
                <input
                  class="input"
                  id="cases-search"
                  type="text"
                  placeholder="Search cases..."
                  style="padding-left: 30px"
                />
              </div>
              <div class="row" style="gap: 4px">
                <button class="btn" id="cases-view-grid" type="button" title="Grid view" aria-label="Grid view">
                  <i class="fa-solid fa-grip"></i>
                </button>
                <button class="btn" id="cases-view-list" type="button" title="List view" aria-label="List view">
                  <i class="fa-solid fa-list"></i>
                </button>
                <button
                  class="btn"
                  id="cases-filters-toggle"
                  type="button"
                  title="Toggle filters"
                  aria-label="Toggle filters"
                >
                  <i class="fa-solid fa-filter"></i>
                </button>
                <button
                  class="btn"
                  id="cases-card-display"
                  type="button"
                  title="Card display"
                  aria-label="Card display"
                >
                  <i class="fa-solid fa-eye"></i>
                </button>
                <button class="btn" id="btn-manage-categories" type="button" title="Categories" aria-label="Categories">
                  <i class="fa-solid fa-tags"></i>
                </button>
              </div>
            </div>
            <div style="height: 10px"></div>
            <div class="row" id="cases-filters"></div>
            <div style="height: 14px"></div>
            <div class="pack-grid" id="cases-grid"></div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th scope="col" style="width: 36px; text-align: center">
                      <input id="cases-select-all" type="checkbox" aria-label="Select all visible cases" />
                    </th>
                    <th scope="col" data-sort="name">
                      <span class="th-sort" role="button" tabindex="0">
                        <span class="th-label">Name</span>
                        <span class="th-chevrons" aria-hidden="true">
                          <i class="fa-solid fa-chevron-up th-chevron th-chevron-up"></i>
                          <i class="fa-solid fa-chevron-down th-chevron th-chevron-down"></i>
                        </span>
                      </span>
                    </th>
                    <th scope="col" data-sort="manufacturer">
                      <span class="th-sort" role="button" tabindex="0">
                        <span class="th-label">Manufacturer</span>
                        <span class="th-chevrons" aria-hidden="true">
                          <i class="fa-solid fa-chevron-up th-chevron th-chevron-up"></i>
                          <i class="fa-solid fa-chevron-down th-chevron th-chevron-down"></i>
                        </span>
                      </span>
                    </th>
                    <th scope="col" data-sort="length">
                      <span class="th-sort" role="button" tabindex="0">
                        <span class="th-label">Length</span>
                        <span class="th-chevrons" aria-hidden="true">
                          <i class="fa-solid fa-chevron-up th-chevron th-chevron-up"></i>
                          <i class="fa-solid fa-chevron-down th-chevron th-chevron-down"></i>
                        </span>
                      </span>
                    </th>
                    <th scope="col" data-sort="width">
                      <span class="th-sort" role="button" tabindex="0">
                        <span class="th-label">Width</span>
                        <span class="th-chevrons" aria-hidden="true">
                          <i class="fa-solid fa-chevron-up th-chevron th-chevron-up"></i>
                          <i class="fa-solid fa-chevron-down th-chevron th-chevron-down"></i>
                        </span>
                      </span>
                    </th>
                    <th scope="col" data-sort="height">
                      <span class="th-sort" role="button" tabindex="0">
                        <span class="th-label">Height</span>
                        <span class="th-chevrons" aria-hidden="true">
                          <i class="fa-solid fa-chevron-up th-chevron th-chevron-up"></i>
                          <i class="fa-solid fa-chevron-down th-chevron th-chevron-down"></i>
                        </span>
                      </span>
                    </th>
                    <th scope="col" data-sort="volume">
                      <span class="th-sort" role="button" tabindex="0">
                        <span class="th-label">Volume</span>
                        <span class="th-chevrons" aria-hidden="true">
                          <i class="fa-solid fa-chevron-up th-chevron th-chevron-up"></i>
                          <i class="fa-solid fa-chevron-down th-chevron th-chevron-down"></i>
                        </span>
                      </span>
                    </th>
                    <th scope="col" data-sort="weight">
                      <span class="th-sort" role="button" tabindex="0">
                        <span class="th-label">Weight</span>
                        <span class="th-chevrons" aria-hidden="true">
                          <i class="fa-solid fa-chevron-up th-chevron th-chevron-up"></i>
                          <i class="fa-solid fa-chevron-down th-chevron th-chevron-down"></i>
                        </span>
                      </span>
                    </th>
                    <th scope="col" data-sort="category">
                      <span class="th-sort" role="button" tabindex="0">
                        <span class="th-label">Category</span>
                        <span class="th-chevrons" aria-hidden="true">
                          <i class="fa-solid fa-chevron-up th-chevron th-chevron-up"></i>
                          <i class="fa-solid fa-chevron-down th-chevron th-chevron-down"></i>
                        </span>
                      </span>
                    </th>
                    <th scope="col">Flip</th>
                    <th class="col-actions" scope="col"></th>
                  </tr>
                </thead>
                <tbody id="cases-tbody"></tbody>
              </table>
            </div>
            <div class="card" id="cases-empty" style="display: none; margin-top: 16px">
              <div style="font-weight: var(--font-semibold); margin-bottom: 6px">No cases found</div>
              <div class="muted" style="font-size: var(--text-sm)">Add cases or import a CSV/XLSX template.</div>
            </div>
          </section>

          <!-- Editor -->
          <!-- ===== SCREEN: EDITOR ===== -->
          <section class="screen" id="screen-editor">
            <div class="editor-shell">
              <div class="panel left" id="editor-left">
                <div class="panel-header">
                  <div class="panel-title">Case Browser</div>
                  <button
                    class="btn btn-ghost"
                    id="btn-left-close"
                    type="button"
                    title="Hide"
                    aria-label="Hide case browser"
                  >
                    <i class="fa-solid fa-xmark"></i>
                  </button>
                </div>
                <div class="panel-body">
                  <div class="field tp3d-editor-case-search">
                    <div class="row tp3d-editor-case-search-row" style="gap: 8px; align-items: center">
                      <div style="position: relative; flex: 1">
                        <i
                          class="fa-solid fa-magnifying-glass"
                          style="
                            position: absolute;
                            left: 10px;
                            top: 50%;
                            transform: translateY(-50%);
                            color: var(--text-muted);
                          "
                        ></i>
                        <input
                          class="input"
                          id="editor-case-search"
                          type="text"
                          placeholder="Search cases..."
                          style="padding-left: 30px"
                        />
                      </div>
                      <button
                        class="btn"
                        id="editor-case-filters-toggle"
                        type="button"
                        title="Toggle filters"
                        aria-label="Toggle filters"
                        aria-pressed="true"
                      >
                        <i class="fa-solid fa-filter"></i>
                      </button>
                    </div>
                  </div>
                  <div style="height: 12px"></div>
                  <div class="row" id="editor-case-chips"></div>
                  <div style="height: 12px"></div>
                  <div class="grid" id="editor-case-list"></div>
                </div>
              </div>

              <div class="panel canvas-wrap">
                <div id="viewport"></div>
                <div class="viewport-toolbar" id="viewport-toolbar">
                  <button class="toolbar-btn" id="btn-editor-left" type="button" title="Toggle case browser">
                    <i class="fa-solid fa-boxes-stacked"></i>
                    Cases
                  </button>
                  <button class="toolbar-btn" id="btn-editor-right" type="button" title="Toggle inspector">
                    <i class="fa-solid fa-sliders"></i>
                    Inspector
                  </button>
                  <button class="toolbar-btn" id="btn-autopack" type="button" title="AutoPack (Ctrl/Cmd+P)">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                    AutoPack
                  </button>
                  <button class="toolbar-btn" id="btn-screenshot" type="button" title="Screenshot PNG">
                    <i class="fa-solid fa-camera"></i>
                    Screenshot
                  </button>
                  <button class="toolbar-btn" id="btn-pdf" type="button" title="PDF plan sheet">
                    <i class="fa-solid fa-file-pdf"></i>
                    PDF
                  </button>
                </div>
                <div class="viewport-overlay" id="viewport-hint">
                  Tip: Click to select. Drag to move. Shift+Click for multi-select.
                </div>
              </div>

              <div class="panel right" id="editor-right">
                <div class="panel-header">
                  <div class="panel-title">Inspector</div>
                  <button
                    class="btn btn-ghost"
                    id="btn-right-close"
                    type="button"
                    title="Hide"
                    aria-label="Hide inspector"
                  >
                    <i class="fa-solid fa-xmark"></i>
                  </button>
                </div>
                <div class="panel-body" id="inspector-body"></div>
              </div>
            </div>
          </section>

          <!-- Updates -->
          <section class="screen" id="screen-updates">
            <div class="grid" style="gap: 6px">
              <div style="font-size: var(--text-2xl); font-weight: var(--font-semibold)">Product Updates</div>
              <div class="muted" style="font-size: var(--text-sm)">
                Release notes for buyers. Customize these for your roadmap.
              </div>
            </div>
            <div style="height: 14px"></div>
            <div class="grid" id="updates-list"></div>
          </section>

          <!-- Roadmap -->
          <section class="screen" id="screen-roadmap">
            <div class="grid" style="gap: 6px">
              <div style="font-size: var(--text-2xl); font-weight: var(--font-semibold)">Roadmap</div>
              <div class="muted" style="font-size: var(--text-sm)">
                Set expectations and communicate upcoming features.
              </div>
            </div>
            <div style="height: 14px"></div>
            <div class="grid" id="roadmap-list"></div>
          </section>

          <!-- Settings -->
          <section class="screen" id="screen-settings">
            <div class="row space-between">
              <div class="grid" style="gap: 6px">
                <div style="font-size: var(--text-2xl); font-weight: var(--font-semibold)">Settings</div>
                <div class="muted" style="font-size: var(--text-sm)">Preferences persist locally on this device.</div>
              </div>
            </div>
            <div style="height: 14px"></div>
            <div class="card" style="max-width: 820px">
              <div style="display: grid; gap: 18px">
                <div style="font-weight: var(--font-semibold)">Units</div>
                <div class="row" style="gap: 12px">
                  <div class="field" style="flex: 1; min-width: 240px">
                    <div class="label">Length</div>
                    <select class="select" id="pref-length">
                      <option value="in">Inches</option>
                      <option value="ft">Feet</option>
                      <option value="mm">Millimeters</option>
                      <option value="cm">Centimeters</option>
                      <option value="m">Meters</option>
                    </select>
                  </div>
                  <div class="field" style="flex: 1; min-width: 240px">
                    <div class="label">Weight</div>
                    <select class="select" id="pref-weight">
                      <option value="lb">Pounds</option>
                      <option value="kg">Kilograms</option>
                    </select>
                  </div>
                </div>

                <div style="font-weight: var(--font-semibold)">Appearance</div>
                <div class="row" style="gap: 12px">
                  <div class="field" style="flex: 1; min-width: 240px">
                    <div class="label">Theme</div>
                    <select class="select" id="pref-theme">
                      <option value="light">Light</option>
                      <option value="dark">Dark</option>
                    </select>
                  </div>
                  <div class="field" style="flex: 1; min-width: 240px">
                    <div class="label">Label size (px)</div>
                    <input class="input" id="pref-label-size" type="number" min="8" max="24" step="1" />
                  </div>
                </div>
                <div class="row" style="gap: 12px">
                  <div class="field" style="flex: 1; min-width: 240px">
                    <div class="label">Hidden case opacity</div>
                    <input class="input" id="pref-hidden-opacity" type="number" min="0" max="1" step="0.05" />
                  </div>
                </div>

                <div style="font-weight: var(--font-semibold)">Editor</div>
                <div class="row" style="gap: 12px">
                  <div class="field" style="flex: 1; min-width: 240px">
                    <div class="label">Snapping</div>
                    <select class="select" id="pref-snapping-enabled">
                      <option value="true">Enabled</option>
                      <option value="false">Disabled</option>
                    </select>
                  </div>
                  <div class="field" style="flex: 1; min-width: 240px">
                    <div class="label">Grid size (in)</div>
                    <input class="input" id="pref-grid-size" type="number" min="0.25" step="0.25" />
                  </div>
                </div>

                <div style="font-weight: var(--font-semibold)">Export</div>
                <div class="row" style="gap: 12px">
                  <div class="field" style="flex: 1; min-width: 240px">
                    <div class="label">Screenshot resolution</div>
                    <select class="select" id="pref-shot-res">
                      <option value="1920x1080">1920×1080</option>
                      <option value="2560x1440">2560×1440</option>
                      <option value="3840x2160">3840×2160</option>
                    </select>
                  </div>
                  <div class="field" style="flex: 1; min-width: 240px">
                    <div class="label">Include stats in PDF</div>
                    <select class="select" id="pref-pdf-stats">
                      <option value="true">Yes</option>
                      <option value="false">No</option>
                    </select>
                  </div>
                </div>

                <div class="row" style="justify-content: flex-end; gap: 10px">
                  <button class="btn" id="btn-reset-demo" type="button">
                    <i class="fa-solid fa-rotate-left"></i>
                    Reset demo data
                  </button>
                  <button class="btn btn-primary" id="btn-save-prefs" type="button">
                    <i class="fa-solid fa-floppy-disk"></i>
                    Save changes
                  </button>
                </div>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>

    <!-- ===== GLOBAL UI ROOTS: MODAL + TOASTS ===== -->
    <div id="modal-root"></div>
    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <!-- ===== GLOBAL UI ROOT: SYSTEM OVERLAY (runtime failures) ===== -->
    <div class="system-overlay" id="system-overlay">
      <div class="system-card">
        <h2 id="system-title">Truck Packer 3D</h2>
        <p id="system-message"></p>
        <ul class="system-list" id="system-list"></ul>
        <div style="height: 14px"></div>
        <div class="row" style="justify-content: flex-end">
          <button class="btn btn-primary" id="system-retry" type="button">
            <i class="fa-solid fa-rotate"></i>
            Retry
          </button>
        </div>
      </div>
    </div>

    <script>
      window.__TP3D_SUPABASE = {
        url: 'https://yduzbvijzwczjapanxbd.supabase.co',
        anonKey: 'sb_publishable_pZ8LBlPGe8N_Ny_jp3CV1Q_s7D48jTC',
      };
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.1/dist/umd/supabase.min.js"
      onload="__tp3dVendorOk('supabase')"
      onerror="
        __tp3dVendorFail(
          'supabase',
          'supabase-js@2.48.1',
          'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.1/dist/umd/supabase.min.js',
          'https://unpkg.com/@supabase/supabase-js@2.48.1/dist/umd/supabase.min.js',
          this,
          'vendor/supabase.min.js'
        )
      "
    ></script>

    <script type="module" src="src/app.js"></script>
  </body>
</html>
