[{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/.stylelintrc.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/cleanup/scripts/eslint-report.mjs","messages":[{"ruleId":"no-undef","severity":2,"message":"'process' is not defined.","line":5,"column":20,"nodeType":"Identifier","messageId":"undef","endLine":5,"endColumn":27},{"ruleId":"no-undef","severity":2,"message":"'process' is not defined.","line":5,"column":52,"nodeType":"Identifier","messageId":"undef","endLine":5,"endColumn":59},{"ruleId":"no-undef","severity":2,"message":"'process' is not defined.","line":6,"column":28,"nodeType":"Identifier","messageId":"undef","endLine":6,"endColumn":35},{"ruleId":"no-undef","severity":2,"message":"'console' is not defined.","line":12,"column":3,"nodeType":"Identifier","messageId":"undef","endLine":12,"endColumn":10},{"ruleId":"no-undef","severity":2,"message":"'process' is not defined.","line":13,"column":3,"nodeType":"Identifier","messageId":"undef","endLine":13,"endColumn":10},{"ruleId":"no-undef","severity":2,"message":"'console' is not defined.","line":20,"column":3,"nodeType":"Identifier","messageId":"undef","endLine":20,"endColumn":10},{"ruleId":"no-undef","severity":2,"message":"'process' is not defined.","line":21,"column":3,"nodeType":"Identifier","messageId":"undef","endLine":21,"endColumn":10},{"ruleId":"no-undef","severity":2,"message":"'process' is not defined.","line":28,"column":34,"nodeType":"Identifier","messageId":"undef","endLine":28,"endColumn":41},{"ruleId":"no-undef","severity":2,"message":"'console' is not defined.","line":57,"column":3,"nodeType":"Identifier","messageId":"undef","endLine":57,"endColumn":10},{"ruleId":"no-undef","severity":2,"message":"'console' is not defined.","line":58,"column":3,"nodeType":"Identifier","messageId":"undef","endLine":58,"endColumn":10},{"ruleId":"no-undef","severity":2,"message":"'console' is not defined.","line":59,"column":3,"nodeType":"Identifier","messageId":"undef","endLine":59,"endColumn":10},{"ruleId":"no-undef","severity":2,"message":"'console' is not defined.","line":61,"column":3,"nodeType":"Identifier","messageId":"undef","endLine":61,"endColumn":10},{"ruleId":"no-undef","severity":2,"message":"'process' is not defined.","line":62,"column":3,"nodeType":"Identifier","messageId":"undef","endLine":62,"endColumn":10}],"suppressedMessages":[],"errorCount":13,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\nimport fs from 'fs';\nimport path from 'path';\n\nconst reportPath = process.argv[2] || path.resolve(process.cwd(), 'eslint-report.json');\nconst outMd = path.resolve(process.cwd(), 'cleanup/ESLINT_WARNINGS_SUMMARY.md');\n\nlet raw;\ntry {\n  raw = fs.readFileSync(reportPath, 'utf8');\n} catch (err) {\n  console.error(`Failed to read ${reportPath}: ${err.message}`);\n  process.exit(2);\n}\n\nlet data;\ntry {\n  data = JSON.parse(raw);\n} catch (err) {\n  console.error(`Failed to parse JSON from ${reportPath}: ${err.message}`);\n  process.exit(2);\n}\n\n// Aggregate warnings (severity === 1)\nconst agg = new Map();\n\nfor (const file of data) {\n  const filePath = path.relative(process.cwd(), file.filePath || file.path || '') || file.filePath;\n  for (const msg of file.messages || []) {\n    if (msg.severity !== 1) continue; // only warnings\n    const rule = msg.ruleId || '(no-rule)';\n    const existing = agg.get(rule) || { count: 0, samples: [] };\n    existing.count += 1;\n    if (existing.samples.length < 3) {\n      existing.samples.push({ file: filePath, line: msg.line || 0, message: msg.message });\n    }\n    agg.set(rule, existing);\n  }\n}\n\nconst sorted = Array.from(agg.entries()).sort((a, b) => b[1].count - a[1].count);\n\n// Build markdown\nlet md = '# ESLint Warnings Summary\\n\\n';\nmd += `Generated: ${new Date().toISOString()}\\n\\n`;\nmd += '| Rule | Count | Examples (file:line — message) |\\n';\nmd += '| --- | ---: | --- |\\n';\n\nfor (const [rule, info] of sorted) {\n  const examples = info.samples.map(s => `\\`${s.file}\\`:${s.line} — ${s.message.replace(/\\|/g, '\\\\|')}`).join('<br>');\n  md += `| ${rule} | ${info.count} | ${examples} |\\n`;\n}\n\ntry {\n  fs.mkdirSync(path.dirname(outMd), { recursive: true });\n  fs.writeFileSync(outMd, md, 'utf8');\n  console.log(`Wrote summary to ${outMd}`);\n  console.log('\\n---\\n');\n  console.log(md);\n} catch (err) {\n  console.error(`Failed to write summary: ${err.message}`);\n  process.exit(3);\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/eslint.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/index.html","messages":[{"ruleId":null,"nodeType":null,"fatal":true,"severity":2,"message":"Parsing error: Unexpected token function","line":2379,"column":13,"source":"            function replace(nextState, options = {}) {"}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":1,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"<!doctype html>\n<!--\n  TRUCK PACKER 3D\n  Version: 1.0.0 (MVP)\n  A production-ready, single-file 3D logistics planning workspace.\n\n  QUICK START:\n  1) Open this file in a modern browser (Chrome/Edge/Firefox/Safari).\n  2) Create cases (Cases) and a project (Packs).\n  3) Open a pack (Editor), add cases, drag to place, or AutoPack.\n\n  NOTE:\n  - Works on file:// for demos. For best results, run on http(s):// (some browsers restrict features on file://).\n  - CDN libraries are required; if any CDN fails, the app shows a recovery message.\n-->\n<html lang=\"en\" data-theme=\"light\">\n  <head>\n    <meta charset=\"utf-8\" />\n    <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />\n    <meta name=\"color-scheme\" content=\"light dark\" />\n    <title>Truck Packer 3D</title>\n\n    <!-- Pre-init: capture CDN failures before app boot -->\n    <script>\n      (function () {\n        'use strict';\n        window.__TP3D_BOOT = window.__TP3D_BOOT || { cdnFailures: [] };\n        window.__tp3dCdnFail = function (name, url) {\n          try {\n            window.__TP3D_BOOT.cdnFailures.push({ name: String(name || 'CDN'), url: String(url || '') });\n          } catch (_) {\n            // Ignore errors if boot object is not available\n          }\n        };\n      })();\n    </script>\n\n    <!-- 3D Rendering (ES Modules) -->\n    <!--\n      NOTE (compatibility): Import maps are not supported in Safari 14, so we avoid them.\n      We load ESM via esm.sh, which rewrites internal bare imports for broad compatibility.\n    -->\n    <script type=\"module\">\n      window.__TP3D_BOOT = window.__TP3D_BOOT || { cdnFailures: [] };\n      window.__TP3D_BOOT.threeReady = (async function () {\n        try {\n          const ThreeModule = await import('https://esm.sh/three@0.160.0');\n          const Orbit = await import('https://esm.sh/three@0.160.0/examples/jsm/controls/OrbitControls.js');\n          window.THREE = { ...ThreeModule, OrbitControls: Orbit.OrbitControls };\n          return true;\n        } catch (err) {\n          window.__tp3dCdnFail('three@0.160.0 (ESM) / OrbitControls', 'https://esm.sh/three@0.160.0');\n          console.error(err);\n          return false;\n        }\n      })();\n    </script>\n\n    <!-- Animation -->\n    <script\n      src=\"https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@23.1.1/dist/tween.umd.js\"\n      onerror=\"\n        __tp3dCdnFail(\n          '@tweenjs/tween.js@23.1.1',\n          'https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@23.1.1/dist/tween.umd.js'\n        )\n      \"\n    ></script>\n\n    <!-- PDF Generation -->\n    <script\n      src=\"https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js\"\n      onerror=\"__tp3dCdnFail('jsPDF@2.5.1', 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js')\"\n    ></script>\n\n    <!-- Excel/CSV Import -->\n    <script\n      src=\"https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js\"\n      onerror=\"__tp3dCdnFail('xlsx@0.18.5', 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js')\"\n    ></script>\n\n    <!-- UI Icons -->\n    <link\n      rel=\"stylesheet\"\n      href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css\"\n      onerror=\"\n        __tp3dCdnFail('Font Awesome 6.5.1', 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css')\n      \"\n    />\n\n    <!-- Typography -->\n    <link rel=\"preconnect\" href=\"https://fonts.googleapis.com\" />\n    <link rel=\"preconnect\" href=\"https://fonts.gstatic.com\" crossorigin />\n    <link href=\"https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap\" rel=\"stylesheet\" />\n\n    <style>\n      :root {\n        /* Backgrounds */\n        --bg-primary: #f6f7fb;\n        --bg-secondary: #ffffff;\n        --bg-elevated: #ffffff;\n        --bg-hover: #f0f1f5;\n\n        /* Text */\n        --text-primary: #1a1a1f;\n        --text-secondary: #6b6b78;\n        --text-muted: #9b9ba8;\n        --text-inverse: #ffffff;\n\n        /* Borders */\n        --border-subtle: #e6e8ef;\n        --border-strong: #d1d3dd;\n\n        /* Accent */\n        --accent-primary: #ff9f1c;\n        --accent-hover: #ffb547;\n        --accent-pressed: #e88c0c;\n\n        /* Semantic */\n        --success: #10b981;\n        --warning: #f59e0b;\n        --error: #ef4444;\n        --info: #3b82f6;\n        --pattern-line: rgba(26, 26, 31, 0.012);\n\n        /* Shadows */\n        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);\n        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);\n        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);\n\n        /* Typography */\n        --font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n        --text-xs: 0.75rem;\n        --text-sm: 0.875rem;\n        --text-base: 1rem;\n        --text-lg: 1.125rem;\n        --text-xl: 1.25rem;\n        --text-2xl: 1.5rem;\n        --text-3xl: 2rem;\n        --font-normal: 400;\n        --font-medium: 500;\n        --font-semibold: 600;\n        --font-bold: 700;\n        --leading-tight: 1.25;\n        --leading-normal: 1.5;\n        --leading-relaxed: 1.75;\n\n        /* Spacing */\n        --space-1: 0.25rem;\n        --space-2: 0.5rem;\n        --space-3: 0.75rem;\n        --space-4: 1rem;\n        --space-5: 1.5rem;\n        --space-6: 2rem;\n        --space-8: 3rem;\n        --space-10: 4rem;\n        --space-12: 6rem;\n\n        --radius-sm: 6px;\n        --radius-md: 10px;\n        --radius-lg: 14px;\n      }\n\n      [data-theme='dark'] {\n        --bg-primary: #121318;\n        --bg-secondary: #1c1e26;\n        --bg-elevated: #25252d;\n        --bg-hover: #2a2d39;\n\n        --text-primary: #ffffff;\n        --text-secondary: #a0a0ab;\n        --text-muted: #6b6b78;\n        --text-inverse: #1a1a1f;\n\n        --border-subtle: #2a2d39;\n        --border-strong: #3a3a47;\n        --pattern-line: rgba(255, 255, 255, 0.018);\n\n        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);\n        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);\n        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);\n      }\n\n      * {\n        box-sizing: border-box;\n      }\n\n      html,\n      body {\n        height: 100%;\n      }\n\n      body {\n        margin: 0;\n        font-family: var(--font-family);\n        background: var(--bg-primary);\n        color: var(--text-primary);\n        line-height: var(--leading-normal);\n      }\n\n      a {\n        color: inherit;\n      }\n\n      .app {\n        display: grid;\n        grid-template-columns: 240px 1fr;\n        grid-template-rows: 100vh;\n      }\n\n      .app.sidebar-collapsed {\n        grid-template-columns: 0px 1fr;\n      }\n\n      .app.sidebar-collapsed .sidebar {\n        transform: translateX(-102%);\n        width: 0;\n        min-width: 0;\n        padding: 0;\n        overflow: hidden;\n        pointer-events: none;\n        border-right: none;\n      }\n\n      .sidebar {\n        background: var(--bg-secondary);\n        border-right: 1px solid var(--border-subtle);\n        display: flex;\n        flex-direction: column;\n        min-width: 240px;\n      }\n\n      .sidebar-header {\n        padding: var(--space-5) var(--space-4);\n        border-bottom: 1px solid var(--border-subtle);\n        display: flex;\n        align-items: center;\n        gap: var(--space-3);\n      }\n\n      .brand-mark {\n        width: 34px;\n        height: 34px;\n        border-radius: 10px;\n        background: linear-gradient(135deg, var(--accent-primary), #ffd166);\n        box-shadow: var(--shadow-md);\n      }\n\n      .brand-text {\n        display: flex;\n        flex-direction: column;\n      }\n\n      .brand-name {\n        font-weight: var(--font-bold);\n        font-size: var(--text-base);\n        letter-spacing: 0.2px;\n      }\n\n      .brand-sub {\n        font-size: var(--text-xs);\n        color: var(--text-secondary);\n      }\n\n      .nav {\n        padding: var(--space-3);\n        display: flex;\n        flex-direction: column;\n        gap: var(--space-1);\n        overflow: auto;\n      }\n\n      .nav-btn {\n        all: unset;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        gap: var(--space-3);\n        padding: var(--space-3) var(--space-3);\n        border-radius: var(--radius-sm);\n        color: var(--text-secondary);\n        font-size: var(--text-sm);\n      }\n\n      .nav-btn:hover {\n        background: var(--bg-hover);\n        color: var(--text-primary);\n      }\n\n      .nav-btn.active {\n        background: rgba(255, 159, 28, 0.14);\n        color: var(--text-primary);\n        border: 1px solid rgba(255, 159, 28, 0.25);\n      }\n\n      .trial-card {\n        background: linear-gradient(180deg, var(--bg-elevated), var(--bg-secondary));\n        border: 1px solid var(--border-subtle);\n        border-radius: var(--radius-md);\n        padding: var(--space-4);\n        box-shadow: var(--shadow-sm);\n      }\n\n      .trial-row {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        gap: var(--space-3);\n        margin-bottom: var(--space-3);\n      }\n\n      .trial-title {\n        font-weight: var(--font-semibold);\n        font-size: var(--text-sm);\n      }\n\n      .trial-sub {\n        color: var(--text-secondary);\n        font-size: var(--text-xs);\n      }\n\n      .main {\n        overflow: hidden;\n        display: flex;\n        flex-direction: column;\n        min-width: 0;\n      }\n\n      .topbar {\n        height: 58px;\n        background: var(--bg-secondary);\n        border-bottom: 1px solid var(--border-subtle);\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 0 var(--space-4);\n        gap: var(--space-4);\n      }\n\n      .topbar-left,\n      .topbar-right {\n        display: flex;\n        align-items: center;\n        gap: var(--space-2);\n        min-width: 0;\n      }\n\n      .topbar-title {\n        display: flex;\n        flex-direction: column;\n        min-width: 0;\n      }\n\n      .topbar-title h1 {\n        margin: 0;\n        font-size: var(--text-lg);\n        font-weight: var(--font-semibold);\n        line-height: var(--leading-tight);\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      }\n\n      .topbar-subtitle {\n        font-size: var(--text-xs);\n        color: var(--text-secondary);\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      }\n\n      .content {\n        flex: 1;\n        overflow: auto;\n        padding: var(--space-5);\n        background-color: var(--bg-primary);\n        background-image:\n          linear-gradient(var(--pattern-line) 1px, transparent 1px),\n          linear-gradient(90deg, var(--pattern-line) 1px, transparent 1px);\n        background-size:\n          28px 28px,\n          28px 28px;\n      }\n\n      .content.editor-mode {\n        padding: 0;\n        overflow: hidden;\n        background-image: none;\n      }\n\n      .screen {\n        display: none;\n      }\n\n      .screen.active {\n        display: block;\n      }\n\n      .row {\n        display: flex;\n        align-items: center;\n        gap: var(--space-3);\n        flex-wrap: wrap;\n      }\n\n      .row.space-between {\n        justify-content: space-between;\n      }\n\n      .btn {\n        border: 1px solid var(--border-subtle);\n        background: var(--bg-elevated);\n        color: var(--text-primary);\n        border-radius: var(--radius-sm);\n        padding: var(--space-2) var(--space-3);\n        font-size: var(--text-sm);\n        font-weight: var(--font-medium);\n        cursor: pointer;\n        display: inline-flex;\n        align-items: center;\n        gap: var(--space-2);\n        box-shadow: var(--shadow-sm);\n        transition:\n          transform 0.15s ease,\n          background 0.15s ease,\n          box-shadow 0.15s ease,\n          border-color 0.15s ease;\n      }\n\n      .btn:hover {\n        background: var(--bg-hover);\n        box-shadow: var(--shadow-md);\n        transform: translateY(-1px);\n      }\n\n      .btn:active {\n        transform: translateY(0px);\n      }\n\n      .btn:disabled {\n        opacity: 0.6;\n        cursor: not-allowed;\n        transform: none;\n      }\n\n      .btn-primary {\n        border-color: rgba(255, 159, 28, 0.4);\n        background: var(--accent-primary);\n        color: var(--text-inverse);\n      }\n\n      .btn-primary:hover {\n        background: var(--accent-hover);\n      }\n\n      .btn-danger {\n        border-color: rgba(239, 68, 68, 0.4);\n        background: rgba(239, 68, 68, 0.12);\n        color: var(--text-primary);\n      }\n\n      /* Icon + checkbox theming (keep consistent across the app) */\n      .btn i {\n        color: var(--text-secondary);\n      }\n\n      .btn:hover i {\n        color: var(--text-primary);\n      }\n\n      .btn-primary i,\n      .btn-primary:hover i {\n        color: currentColor;\n      }\n\n      .btn-danger i,\n      .btn-danger:hover i {\n        color: var(--error);\n      }\n\n      .btn-ghost {\n        border-color: transparent;\n        background: transparent;\n        box-shadow: none;\n        color: var(--text-secondary);\n      }\n\n      .btn-ghost:hover {\n        background: var(--bg-hover);\n        box-shadow: none;\n        transform: none;\n        color: var(--text-primary);\n      }\n\n      input[type='checkbox'] {\n        -webkit-appearance: none;\n        -moz-appearance: none;\n        appearance: none;\n        width: 16px;\n        height: 16px;\n        border: 2px solid var(--border-strong);\n        border-radius: 3px;\n        cursor: pointer;\n        position: relative;\n        background: var(--bg-secondary);\n        transition: all 0.15s ease;\n      }\n\n      input[type='checkbox']:hover {\n        border-color: var(--accent-primary);\n      }\n\n      input[type='checkbox']:checked {\n        background: var(--accent-primary);\n        border-color: var(--accent-primary);\n      }\n\n      input[type='checkbox']:checked::after {\n        content: '';\n        position: absolute;\n        left: 4px;\n        top: 1px;\n        width: 4px;\n        height: 8px;\n        border: solid white;\n        border-width: 0 2px 2px 0;\n        transform: rotate(45deg);\n      }\n\n      input[type='checkbox']:focus-visible {\n        outline: 2px solid rgba(255, 159, 28, 0.35);\n        outline-offset: 2px;\n      }\n\n      .input,\n      .select,\n      textarea {\n        width: 100%;\n        background: var(--bg-primary);\n        border: 1px solid var(--border-subtle);\n        border-radius: var(--radius-sm);\n        padding: var(--space-2) var(--space-3);\n        font-size: var(--text-sm);\n        color: var(--text-primary);\n        transition:\n          border-color 0.15s ease,\n          box-shadow 0.15s ease;\n      }\n\n      textarea {\n        min-height: 84px;\n        resize: vertical;\n      }\n\n      .input:focus,\n      .select:focus,\n      textarea:focus {\n        outline: none;\n        border-color: var(--accent-primary);\n        box-shadow: 0 0 0 3px rgba(255, 159, 28, 0.14);\n      }\n\n      .search-shell {\n        display: grid;\n        gap: 6px;\n      }\n\n      .search-input {\n        position: relative;\n        display: flex;\n        align-items: center;\n        background: var(--bg-secondary);\n        border-radius: var(--radius-sm);\n        border: 1px solid var(--border-subtle);\n        box-shadow: var(--shadow-sm);\n      }\n\n      .search-input .input {\n        border: none;\n        box-shadow: none;\n        padding-left: 34px;\n        flex: 1;\n        min-width: 0;\n      }\n\n      .search-icon {\n        position: absolute;\n        left: 12px;\n        color: var(--text-secondary);\n        font-size: var(--text-sm);\n        pointer-events: none;\n      }\n\n      .search-hint {\n        margin-right: 10px;\n        color: var(--text-muted);\n        font-size: var(--text-xs);\n      }\n\n      .search-empty {\n        display: none;\n        border: 1px solid var(--border-subtle);\n        background: var(--bg-secondary);\n        border-radius: var(--radius-md);\n        padding: 12px 14px;\n        box-shadow: var(--shadow-sm);\n      }\n\n      .field {\n        display: grid;\n        gap: var(--space-2);\n      }\n\n      .label {\n        font-size: var(--text-xs);\n        color: var(--text-secondary);\n        font-weight: var(--font-medium);\n      }\n\n      .card {\n        background: var(--bg-secondary);\n        border: 1px solid var(--border-subtle);\n        border-radius: var(--radius-md);\n        padding: var(--space-4);\n        box-shadow: var(--shadow-sm);\n      }\n\n      .muted {\n        color: var(--text-secondary);\n      }\n\n      .chip {\n        display: inline-flex;\n        align-items: center;\n        gap: var(--space-2);\n        padding: var(--space-1) var(--space-3);\n        border-radius: 999px;\n        font-size: var(--text-xs);\n        font-weight: var(--font-medium);\n        border: 1px solid var(--border-subtle);\n        background: var(--bg-elevated);\n        color: var(--text-secondary);\n        cursor: pointer;\n        user-select: none;\n      }\n\n      .chip.active {\n        background: rgba(255, 159, 28, 0.16);\n        border-color: rgba(255, 159, 28, 0.3);\n        color: var(--text-primary);\n      }\n\n      .chip-dot {\n        width: 8px;\n        height: 8px;\n        border-radius: 999px;\n        background: var(--border-strong);\n      }\n\n      .grid {\n        display: grid;\n        gap: var(--space-4);\n      }\n\n      .pack-grid {\n        display: grid;\n        grid-template-columns: repeat(3, minmax(0, 1fr));\n        gap: var(--space-4);\n      }\n\n      .pack-card {\n        position: relative;\n        cursor: pointer;\n        transition:\n          transform 0.15s ease,\n          box-shadow 0.15s ease,\n          border-color 0.15s ease;\n        min-height: 140px;\n        overflow: hidden;\n      }\n\n      .pack-card:hover {\n        transform: translateY(-2px);\n        box-shadow: var(--shadow-md);\n        border-color: rgba(255, 159, 28, 0.3);\n      }\n\n      .pack-card h3 {\n        margin: 0 0 var(--space-2) 0;\n        font-size: var(--text-base);\n        font-weight: var(--font-semibold);\n      }\n\n      .pack-meta {\n        display: flex;\n        flex-wrap: wrap;\n        gap: var(--space-2);\n        align-items: center;\n        margin-top: var(--space-3);\n        position: relative;\n      }\n\n      .pack-meta-badges {\n        display: flex;\n        flex-wrap: wrap;\n        gap: var(--space-2);\n        flex: 1;\n      }\n\n      .pack-preview {\n        position: relative;\n        height: 120px;\n        border-radius: var(--radius-md);\n        border: 1px solid var(--border-subtle);\n        background: linear-gradient(135deg, rgba(255, 159, 28, 0.06), rgba(59, 130, 246, 0.04));\n        margin: 0 0 var(--space-3) 0;\n        display: grid;\n        grid-template-columns: repeat(6, minmax(0, 1fr));\n        gap: 6px;\n        padding: 10px;\n        overflow: hidden;\n      }\n\n      .pack-preview::after {\n        content: '';\n        position: absolute;\n        inset: 0;\n        background-image:\n          linear-gradient(var(--pattern-line) 1px, transparent 1px),\n          linear-gradient(90deg, var(--pattern-line) 1px, transparent 1px);\n        background-size:\n          18px 18px,\n          18px 18px;\n        pointer-events: none;\n        opacity: 0.6;\n      }\n\n      .pack-preview-cell {\n        border-radius: 10px;\n        box-shadow: var(--shadow-sm);\n        background: var(--bg-hover);\n        min-height: 30px;\n        border: 1px solid rgba(0, 0, 0, 0.04);\n      }\n\n      .pack-preview.empty {\n        align-items: center;\n        justify-items: center;\n        color: var(--text-secondary);\n        font-size: var(--text-sm);\n      }\n\n      .pack-preview.empty::after {\n        display: none;\n      }\n\n      .pack-preview.has-thumb {\n        display: block;\n        padding: 0;\n        grid-template-columns: none;\n        gap: 0;\n        background: var(--bg-elevated);\n      }\n\n      .pack-preview.has-thumb::after {\n        opacity: 0.18;\n      }\n\n      .pack-preview.has-thumb img {\n        width: 100%;\n        height: 100%;\n        object-fit: cover;\n        display: block;\n      }\n\n      .badge {\n        font-size: var(--text-xs);\n        padding: 4px 8px;\n        border-radius: 999px;\n        border: 1px solid var(--border-subtle);\n        color: var(--text-secondary);\n        background: var(--bg-elevated);\n      }\n\n      .kebab {\n        display: flex;\n        align-items: center;\n        margin-left: auto;\n      }\n\n      .table-wrap {\n        background: var(--bg-secondary);\n        border: 1px solid var(--border-subtle);\n        border-radius: var(--radius-md);\n        overflow: hidden;\n        box-shadow: var(--shadow-sm);\n      }\n\n      table {\n        width: 100%;\n        border-collapse: collapse;\n        font-size: var(--text-sm);\n      }\n\n      th,\n      td {\n        padding: 12px 12px;\n        border-bottom: 1px solid var(--border-subtle);\n        text-align: left;\n        vertical-align: middle;\n        white-space: nowrap;\n      }\n\n      th {\n        font-size: var(--text-xs);\n        text-transform: uppercase;\n        letter-spacing: 0.06em;\n        color: var(--text-secondary);\n        background: var(--bg-elevated);\n        position: sticky;\n        top: 0;\n        z-index: 1;\n      }\n\n      tr:hover td {\n        background: rgba(255, 159, 28, 0.05);\n      }\n\n      .col-actions {\n        width: 44px;\n        text-align: right;\n      }\n\n      .dropdown {\n        position: relative;\n        display: inline-block;\n      }\n\n      .dropdown-menu {\n        position: absolute;\n        right: auto;\n        left: 0;\n        top: calc(100% + 8px);\n        min-width: 180px;\n        background: var(--bg-secondary);\n        border: 1px solid var(--border-subtle);\n        border-radius: var(--radius-md);\n        box-shadow: var(--shadow-lg);\n        padding: var(--space-2);\n        z-index: 1000;\n      }\n\n      .dropdown-item {\n        width: 100%;\n        border: 0;\n        background: transparent;\n        color: var(--text-primary);\n        padding: var(--space-2) var(--space-3);\n        border-radius: var(--radius-sm);\n        text-align: left;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        gap: var(--space-2);\n        font-size: var(--text-sm);\n      }\n\n      .dropdown-item:hover {\n        background: var(--bg-hover);\n      }\n\n      .dropdown-item[data-variant=\"danger\"] {\n        color: var(--error);\n      }\n\n      .dropdown-item[data-variant=\"danger\"]:hover {\n        background: rgba(239, 68, 68, 0.08);\n      }\n\n      .dropdown-item[data-variant=\"danger\"] i {\n        color: var(--error);\n      }\n\n      .dropdown-item i {\n        width: 18px;\n        height: 18px;\n        display: inline-flex;\n        align-items: center;\n        justify-content: center;\n        color: var(--text-secondary);\n        flex-shrink: 0;\n      }\n\n      .dropdown-item:hover i {\n        color: var(--text-primary);\n      }\n\n      .dropdown-item[data-variant=\"danger\"]:hover i {\n        color: var(--error);\n      }\n\n      .sort-icon {\n        color: var(--text-muted);\n        opacity: 0.85;\n      }\n\n      /* Modal */\n      .modal-overlay {\n        position: fixed;\n        inset: 0;\n        background: rgba(0, 0, 0, 0.45);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        padding: var(--space-5);\n        z-index: 10000;\n      }\n\n      .modal {\n        width: min(580px, 100%);\n        background: var(--bg-secondary);\n        border: 1px solid var(--border-subtle);\n        border-radius: var(--radius-lg);\n        box-shadow: var(--shadow-lg);\n        overflow: hidden;\n      }\n\n      .modal-header {\n        padding: var(--space-4) var(--space-5);\n        border-bottom: 1px solid var(--border-subtle);\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        gap: var(--space-3);\n      }\n\n      .modal-title {\n        font-size: var(--text-lg);\n        font-weight: var(--font-semibold);\n        margin: 0;\n      }\n\n      .modal-body {\n        padding: var(--space-5);\n        display: grid;\n        gap: var(--space-4);\n      }\n\n      .modal-footer {\n        padding: var(--space-4) var(--space-5);\n        border-top: 1px solid var(--border-subtle);\n        display: flex;\n        justify-content: flex-end;\n        gap: var(--space-2);\n      }\n\n      /* Toasts */\n      #toast-container {\n        position: fixed;\n        bottom: 18px;\n        right: 18px;\n        z-index: 20000;\n        display: flex;\n        flex-direction: column-reverse;\n        gap: 10px;\n        max-width: 360px;\n      }\n\n      .toast {\n        background: var(--bg-secondary);\n        border: 1px solid var(--border-subtle);\n        border-radius: var(--radius-md);\n        box-shadow: var(--shadow-lg);\n        padding: 12px 12px;\n        display: flex;\n        gap: var(--space-3);\n        align-items: flex-start;\n        cursor: pointer;\n        animation: toastIn 0.22s ease;\n      }\n\n      .toast-icon {\n        width: 26px;\n        height: 26px;\n        border-radius: 999px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-weight: var(--font-bold);\n        color: white;\n        flex: 0 0 auto;\n      }\n\n      .toast-body {\n        display: grid;\n        gap: 4px;\n        flex: 1;\n        min-width: 0;\n      }\n\n      .toast-title {\n        font-size: var(--text-sm);\n        font-weight: var(--font-semibold);\n        line-height: var(--leading-tight);\n      }\n\n      .toast-message {\n        font-size: var(--text-xs);\n        color: var(--text-secondary);\n        line-height: var(--leading-normal);\n      }\n\n      .toast-actions {\n        display: flex;\n        gap: var(--space-2);\n        margin-top: 6px;\n      }\n\n      .toast-btn {\n        border: 1px solid var(--border-subtle);\n        background: var(--bg-elevated);\n        color: var(--text-primary);\n        padding: 6px 10px;\n        border-radius: var(--radius-sm);\n        font-size: var(--text-xs);\n        cursor: pointer;\n      }\n\n      .toast-btn:hover {\n        background: var(--bg-hover);\n      }\n\n      @keyframes toastIn {\n        from {\n          transform: translateX(12px);\n          opacity: 0;\n        }\n        to {\n          transform: translateX(0);\n          opacity: 1;\n        }\n      }\n\n      /* Editor layout */\n      .editor-shell {\n        --left-col: 290px;\n        --right-col: 340px;\n        height: calc(100vh - 58px);\n        display: grid;\n        grid-template-columns: var(--left-col) 1fr var(--right-col);\n        grid-template-rows: 100%;\n        gap: var(--space-3);\n        padding: var(--space-3);\n        background: var(--bg-primary);\n      }\n\n      .panel {\n        background: var(--bg-secondary);\n        border: 1px solid var(--border-subtle);\n        border-radius: var(--radius-md);\n        box-shadow: var(--shadow-sm);\n        overflow: hidden;\n        display: flex;\n        flex-direction: column;\n        min-width: 0;\n        min-height: 0;\n      }\n\n      .panel-header {\n        padding: var(--space-3) var(--space-4);\n        border-bottom: 1px solid var(--border-subtle);\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        gap: var(--space-2);\n      }\n\n      .panel-title {\n        font-size: var(--text-sm);\n        font-weight: var(--font-semibold);\n        margin: 0;\n      }\n\n      .panel-body {\n        padding: var(--space-3);\n        overflow: auto;\n      }\n\n      .canvas-wrap {\n        position: relative;\n        min-height: 0;\n      }\n\n      #viewport {\n        position: absolute;\n        inset: 0;\n      }\n\n      .viewport-overlay {\n        position: absolute;\n        left: 12px;\n        bottom: 12px;\n        background: rgba(0, 0, 0, 0.55);\n        color: white;\n        padding: 8px 10px;\n        border-radius: 10px;\n        font-size: var(--text-xs);\n        max-width: 360px;\n        pointer-events: none;\n      }\n\n      .viewport-toolbar {\n        position: absolute;\n        top: 12px;\n        left: 50%;\n        transform: translateX(-50%);\n        display: flex;\n        gap: var(--space-2);\n        padding: 8px;\n        border-radius: 999px;\n        background: rgba(255, 255, 255, 0.86);\n        border: 1px solid rgba(0, 0, 0, 0.08);\n        box-shadow: var(--shadow-md);\n        backdrop-filter: blur(8px);\n      }\n\n      [data-theme='dark'] .viewport-toolbar {\n        background: rgba(28, 30, 38, 0.82);\n        border-color: rgba(255, 255, 255, 0.08);\n      }\n\n      .toolbar-btn {\n        border: 1px solid var(--border-subtle);\n        background: var(--bg-elevated);\n        color: var(--text-primary);\n        padding: 7px 10px;\n        border-radius: 999px;\n        font-size: var(--text-xs);\n        cursor: pointer;\n        display: inline-flex;\n        align-items: center;\n        gap: 8px;\n        box-shadow: var(--shadow-sm);\n      }\n\n      .toolbar-btn:hover {\n        background: var(--bg-hover);\n      }\n\n      .toolbar-btn.active {\n        border-color: rgba(255, 159, 28, 0.32);\n        background: rgba(255, 159, 28, 0.14);\n      }\n\n      /* System overlays */\n      .system-overlay {\n        position: fixed;\n        inset: 0;\n        z-index: 30000;\n        display: none;\n        align-items: center;\n        justify-content: center;\n        padding: var(--space-6);\n        background:\n          radial-gradient(circle at 20% 10%, rgba(255, 159, 28, 0.18), transparent 40%),\n          radial-gradient(circle at 80% 70%, rgba(59, 130, 246, 0.12), transparent 45%), rgba(0, 0, 0, 0.65);\n      }\n\n      .system-overlay.active {\n        display: flex;\n      }\n\n      .system-card {\n        width: min(760px, 100%);\n        background: var(--bg-secondary);\n        border: 1px solid var(--border-subtle);\n        border-radius: var(--radius-lg);\n        box-shadow: var(--shadow-lg);\n        padding: var(--space-6);\n      }\n\n      .system-card h2 {\n        margin: 0 0 var(--space-2) 0;\n        font-size: var(--text-2xl);\n      }\n\n      .system-card p {\n        margin: 0 0 var(--space-4) 0;\n        color: var(--text-secondary);\n      }\n\n      .system-list {\n        margin: 0;\n        padding-left: 18px;\n        color: var(--text-secondary);\n      }\n\n      /* Responsive */\n      @media (max-width: 1279px) {\n        .pack-grid {\n          grid-template-columns: repeat(2, minmax(0, 1fr));\n        }\n\n        .editor-shell {\n          --left-col: 270px;\n          --right-col: 300px;\n        }\n      }\n\n      @media (max-width: 899px) {\n        .app {\n          grid-template-columns: 1fr;\n        }\n\n        .sidebar {\n          position: fixed;\n          left: 0;\n          top: 0;\n          bottom: 0;\n          transform: translateX(-102%);\n          transition: transform 0.25s ease;\n          z-index: 15000;\n          width: 240px;\n        }\n\n        .sidebar.open {\n          transform: translateX(0);\n        }\n\n        .topbar {\n          position: sticky;\n          top: 0;\n          z-index: 14000;\n        }\n\n        .editor-shell {\n          grid-template-columns: 1fr;\n          grid-template-rows: 1fr;\n          padding: var(--space-3);\n        }\n\n        .panel.left,\n        .panel.right {\n          position: fixed;\n          top: 58px;\n          bottom: 0;\n          width: min(360px, 92vw);\n          z-index: 14000;\n          transform: translateX(-110%);\n          transition: transform 0.25s ease;\n        }\n\n        .panel.right {\n          right: 0;\n          transform: translateX(110%);\n        }\n\n        .panel.left.open {\n          left: 0;\n          transform: translateX(0);\n        }\n\n        .panel.right.open {\n          transform: translateX(0);\n        }\n\n        .pack-grid {\n          grid-template-columns: 1fr;\n        }\n      }\n    </style>\n  </head>\n\n  <body>\n    <noscript>\n      <div style=\"padding: 20px; font-family: system-ui\">This app requires JavaScript enabled.</div>\n    </noscript>\n\n    <div class=\"app\" id=\"app\">\n      <aside class=\"sidebar\" id=\"sidebar\">\n        <div class=\"sidebar-header\">\n          <div class=\"brand-mark\" aria-hidden=\"true\"></div>\n          <div class=\"brand-text\">\n            <div class=\"brand-name\">Truck Packer 3D</div>\n          </div>\n        </div>\n\n        <nav class=\"nav\" aria-label=\"Primary\">\n          <button class=\"nav-btn\" type=\"button\" data-nav=\"packs\">\n            <i class=\"fa-solid fa-layer-group\"></i>\n            Packs\n          </button>\n          <button class=\"nav-btn\" type=\"button\" data-nav=\"cases\">\n            <i class=\"fa-solid fa-box\"></i>\n            Cases\n          </button>\n          <button class=\"nav-btn\" type=\"button\" data-nav=\"editor\">\n            <i class=\"fa-solid fa-cube\"></i>\n            Editor\n          </button>\n          <button class=\"nav-btn\" type=\"button\" data-nav=\"updates\">\n            <i class=\"fa-solid fa-bullhorn\"></i>\n            Updates\n          </button>\n          <button class=\"nav-btn\" type=\"button\" data-nav=\"roadmap\">\n            <i class=\"fa-solid fa-route\"></i>\n            Roadmap\n          </button>\n        </nav>\n\n        <div style=\"padding: var(--space-3)\">\n          <button\n            class=\"btn\"\n            id=\"btn-account-switcher\"\n            type=\"button\"\n            style=\"width: 100%; justify-content: space-between; padding: var(--space-2) var(--space-3)\"\n          >\n            <span style=\"display: flex; align-items: center; gap: var(--space-3); min-width: 0\">\n              <span\n                class=\"brand-mark\"\n                aria-hidden=\"true\"\n                style=\"width: 34px; height: 34px; border-radius: 12px; flex: 0 0 auto\"\n              ></span>\n              <span style=\"display: flex; flex-direction: column; align-items: flex-start; min-width: 0\">\n                <span style=\"font-weight: var(--font-semibold); line-height: 1.1\">Personal Account</span>\n                <span class=\"muted\" data-account-name style=\"font-size: var(--text-sm); line-height: 1.1\">—</span>\n              </span>\n            </span>\n            <i class=\"fa-solid fa-chevron-down\" aria-hidden=\"true\"></i>\n          </button>\n        </div>\n\n      </aside>\n\n      <main class=\"main\">\n        <header class=\"topbar\">\n          <div class=\"topbar-left\">\n            <button class=\"btn btn-ghost\" id=\"btn-sidebar\" type=\"button\" title=\"Menu\" aria-label=\"Menu\">\n              <i class=\"fa-solid fa-bars\"></i>\n            </button>\n            <div class=\"topbar-title\">\n              <h1 id=\"topbar-title\">Packs</h1>\n              <div class=\"topbar-subtitle\" id=\"topbar-subtitle\">Project library</div>\n            </div>\n          </div>\n          <div class=\"topbar-right\">\n            <button class=\"btn\" id=\"btn-export-app\" type=\"button\" title=\"Export app JSON\">\n              <i class=\"fa-solid fa-file-export\"></i>\n              Export\n            </button>\n            <button class=\"btn\" id=\"btn-import-app\" type=\"button\" title=\"Import app JSON\">\n              <i class=\"fa-solid fa-file-import\"></i>\n              Import\n            </button>\n            <button class=\"btn\" id=\"btn-help\" type=\"button\" title=\"Help\">\n              <i class=\"fa-solid fa-circle-info\"></i>\n              Help\n            </button>\n          </div>\n        </header>\n\n        <div class=\"content\">\n          <!-- Packs -->\n          <section class=\"screen\" id=\"screen-packs\">\n            <div class=\"row space-between\">\n              <div class=\"grid\" style=\"gap: 6px\">\n                <div style=\"font-size: var(--text-2xl); font-weight: var(--font-semibold)\">Packs</div>\n                <div class=\"muted\" style=\"font-size: var(--text-sm)\">\n                  Create projects, duplicate, export, and open in the editor.\n                </div>\n              </div>\n              <div class=\"row\">\n                <button class=\"btn\" id=\"btn-import-pack\" type=\"button\">\n                  <i class=\"fa-solid fa-file-import\"></i>\n                  Import Pack\n                </button>\n                <button class=\"btn btn-primary\" id=\"btn-new-pack\" type=\"button\">\n                  <i class=\"fa-solid fa-plus\"></i>\n                  New Pack\n                </button>\n              </div>\n            </div>\n            <div style=\"height: 14px\"></div>\n            <div class=\"row\" style=\"align-items: center\">\n              <div style=\"flex: 1; min-width: 220px; position: relative\">\n                <i\n                  class=\"fa-solid fa-magnifying-glass\"\n                  style=\"\n                    position: absolute;\n                    left: 10px;\n                    top: 50%;\n                    transform: translateY(-50%);\n                    color: var(--text-muted);\n                  \"\n                ></i>\n                <input\n                  class=\"input\"\n                  id=\"packs-search\"\n                  type=\"text\"\n                  placeholder=\"Search packs...\"\n                  style=\"padding-left: 30px\"\n                  aria-label=\"Search packs\"\n                />\n              </div>\n              <div style=\"min-width: 220px\">\n                <select class=\"select\" id=\"packs-sort\" aria-label=\"Sort packs\">\n                  <option value=\"edited-desc\" selected>Recently edited</option>\n                  <option value=\"edited-asc\">Oldest edited</option>\n                  <option value=\"title-asc\">Title A–Z</option>\n                  <option value=\"title-desc\">Title Z–A</option>\n                  <option value=\"created-desc\">Created newest</option>\n                  <option value=\"created-asc\">Created oldest</option>\n                </select>\n              </div>\n              <div class=\"search-shell\" style=\"flex: 1; min-width: 260px; display: none\">\n                <div class=\"search-input\"></div>\n                <div class=\"search-empty\" id=\"packs-filter-empty\">\n                  <div id=\"packs-filter-empty-msg\" style=\"font-weight: var(--font-semibold); margin-bottom: 4px\">\n                    No matching packs\n                  </div>\n                  <div class=\"muted\" style=\"font-size: var(--text-sm)\">\n                    Try a different keyword or press Esc to reset search.\n                  </div>\n                </div>\n              </div>\n            </div>\n            <div style=\"height: 10px\"></div>\n            <div class=\"row\" style=\"gap: 8px; flex-wrap: wrap\">\n              <button class=\"chip\" id=\"packs-filter-chip-empty\" type=\"button\" title=\"Packs with 0 cases\">\n                <span class=\"chip-dot\"></span>\n                Empty\n              </button>\n              <button\n                class=\"chip\"\n                id=\"packs-filter-chip-partial\"\n                type=\"button\"\n                title=\"Packs with some volume used\"\n              >\n                <span class=\"chip-dot\" style=\"background: var(--warning)\"></span>\n                Partial\n              </button>\n              <button\n                class=\"chip\"\n                id=\"packs-filter-chip-full\"\n                type=\"button\"\n                title=\"Packs at 100% volume\"\n              >\n                <span class=\"chip-dot\" style=\"background: var(--success)\"></span>\n                Full\n              </button>\n            </div>\n            <div style=\"height: 14px\"></div>\n            <div class=\"pack-grid\" id=\"packs-grid\"></div>\n            <div class=\"card\" id=\"packs-empty\" style=\"display: none; margin-top: 16px\">\n              <div style=\"font-weight: var(--font-semibold); margin-bottom: 6px\">No packs yet</div>\n              <div class=\"muted\" style=\"font-size: var(--text-sm)\">Create your first pack to start planning.</div>\n            </div>\n          </section>\n\n\t          <!-- Cases -->\n\t          <section class=\"screen\" id=\"screen-cases\">\n\t            <div class=\"row space-between\">\n\t              <div class=\"grid\" style=\"gap: 6px\">\n\t                <div style=\"font-size: var(--text-2xl); font-weight: var(--font-semibold)\">Cases</div>\n\t                <div class=\"muted\" style=\"font-size: var(--text-sm)\">\n\t                  Manage your inventory. Import via CSV/XLSX or create manually.\n\t                </div>\n\t              </div>\n\t              <div class=\"row\" id=\"cases-actions-default\">\n\t                <button class=\"btn\" id=\"btn-cases-template\" type=\"button\">\n\t                  <i class=\"fa-solid fa-download\"></i>\n\t                  Template\n\t                </button>\n\t                <button class=\"btn\" id=\"btn-cases-import\" type=\"button\">\n\t                  <i class=\"fa-solid fa-file-import\"></i>\n\t                  Import\n\t                </button>\n\t                <button class=\"btn btn-primary\" id=\"btn-new-case\" type=\"button\">\n\t                  <i class=\"fa-solid fa-plus\"></i>\n\t                  New Case\n\t                </button>\n\t              </div>\n\t              <div class=\"row\" id=\"cases-actions-bulk\" style=\"display: none; gap: 8px; align-items: center\">\n\t                <div class=\"muted\" id=\"cases-selected-count\" style=\"font-size: var(--text-sm)\"></div>\n\t                <button class=\"btn btn-danger\" id=\"btn-cases-bulk-delete\" type=\"button\">\n\t                  <i class=\"fa-solid fa-trash\"></i>\n\t                  Delete (0)\n\t                </button>\n\t                <button class=\"btn\" id=\"btn-cases-bulk-template\" type=\"button\">\n\t                  <i class=\"fa-solid fa-layer-group\"></i>\n\t                  Template\n\t                </button>\n\t              </div>\n\t            </div>\n\t            <div style=\"height: 14px\"></div>\n\t            <div class=\"row\" style=\"gap: 10px; align-items: center\">\n\t              <div style=\"flex: 1; min-width: 220px; position: relative\">\n                <i\n                  class=\"fa-solid fa-magnifying-glass\"\n                  style=\"\n                    position: absolute;\n                    left: 10px;\n                    top: 50%;\n                    transform: translateY(-50%);\n                    color: var(--text-muted);\n                  \"\n                ></i>\n                <input\n                  class=\"input\"\n                  id=\"cases-search\"\n                  type=\"text\"\n                  placeholder=\"Search cases...\"\n                  style=\"padding-left: 30px\"\n                />\n              </div>\n              <button class=\"btn\" id=\"btn-manage-categories\" type=\"button\">\n                <i class=\"fa-solid fa-tags\"></i>\n                Categories\n              </button>\n            </div>\n            <div style=\"height: 10px\"></div>\n            <div class=\"row\" id=\"cases-filters\" style=\"gap: 8px\"></div>\n            <div style=\"height: 14px\"></div>\n\t            <div class=\"table-wrap\">\n\t              <table>\n\t                <thead>\n\t                  <tr>\n\t                    <th scope=\"col\" style=\"width: 36px; text-align: center\">\n\t                      <input id=\"cases-select-all\" type=\"checkbox\" aria-label=\"Select all visible cases\" />\n\t                    </th>\n\t                    <th scope=\"col\" data-sort=\"name\">Name</th>\n\t                    <th scope=\"col\" data-sort=\"manufacturer\">Manufacturer</th>\n\t                    <th scope=\"col\">Dimensions</th>\n\t                    <th scope=\"col\" data-sort=\"volume\">Volume</th>\n                    <th scope=\"col\" data-sort=\"weight\">Weight</th>\n                    <th scope=\"col\" data-sort=\"category\">Category</th>\n                    <th scope=\"col\">Flip</th>\n                    <th class=\"col-actions\" scope=\"col\"></th>\n                  </tr>\n                </thead>\n                <tbody id=\"cases-tbody\"></tbody>\n              </table>\n            </div>\n            <div class=\"card\" id=\"cases-empty\" style=\"display: none; margin-top: 16px\">\n              <div style=\"font-weight: var(--font-semibold); margin-bottom: 6px\">No cases found</div>\n              <div class=\"muted\" style=\"font-size: var(--text-sm)\">Add cases or import a CSV/XLSX template.</div>\n            </div>\n          </section>\n\n          <!-- Editor -->\n          <section class=\"screen\" id=\"screen-editor\" style=\"padding: 0\">\n            <div class=\"editor-shell\">\n              <div class=\"panel left\" id=\"editor-left\">\n                <div class=\"panel-header\">\n                  <div class=\"panel-title\">Case Browser</div>\n                  <button\n                    class=\"btn btn-ghost\"\n                    id=\"btn-left-close\"\n                    type=\"button\"\n                    title=\"Hide\"\n                    aria-label=\"Hide case browser\"\n                  >\n                    <i class=\"fa-solid fa-xmark\"></i>\n                  </button>\n                </div>\n                <div class=\"panel-body\">\n                  <div class=\"field\">\n                    <div class=\"label\">Search</div>\n                    <input class=\"input\" id=\"editor-case-search\" type=\"text\" placeholder=\"Search cases...\" />\n                  </div>\n                  <div style=\"height: 12px\"></div>\n                  <div class=\"row\" id=\"editor-case-chips\" style=\"gap: 8px\"></div>\n                  <div style=\"height: 12px\"></div>\n                  <div class=\"grid\" id=\"editor-case-list\" style=\"gap: 10px\"></div>\n                </div>\n              </div>\n\n              <div class=\"panel canvas-wrap\">\n                <div id=\"viewport\"></div>\n                <div class=\"viewport-toolbar\" id=\"viewport-toolbar\">\n                  <button class=\"toolbar-btn\" id=\"btn-editor-left\" type=\"button\" title=\"Toggle case browser\">\n                    <i class=\"fa-solid fa-boxes-stacked\"></i>\n                    Cases\n                  </button>\n                  <button class=\"toolbar-btn\" id=\"btn-editor-right\" type=\"button\" title=\"Toggle inspector\">\n                    <i class=\"fa-solid fa-sliders\"></i>\n                    Inspector\n                  </button>\n                  <button class=\"toolbar-btn\" id=\"btn-autopack\" type=\"button\" title=\"AutoPack (Ctrl/Cmd+P)\">\n                    <i class=\"fa-solid fa-wand-magic-sparkles\"></i>\n                    AutoPack\n                  </button>\n                  <button class=\"toolbar-btn\" id=\"btn-screenshot\" type=\"button\" title=\"Screenshot PNG\">\n                    <i class=\"fa-solid fa-camera\"></i>\n                    PNG\n                  </button>\n                  <button class=\"toolbar-btn\" id=\"btn-pdf\" type=\"button\" title=\"PDF plan sheet\">\n                    <i class=\"fa-solid fa-file-pdf\"></i>\n                    PDF\n                  </button>\n                  <button class=\"toolbar-btn\" id=\"btn-capture-preview\" type=\"button\" title=\"Capture pack preview\">\n                    <i class=\"fa-solid fa-image\"></i>\n                    Preview\n                  </button>\n                </div>\n                <div class=\"viewport-overlay\" id=\"viewport-hint\">\n                  Tip: Click to select. Drag to move. Shift+Click for multi-select.\n                </div>\n              </div>\n\n              <div class=\"panel right\" id=\"editor-right\">\n                <div class=\"panel-header\">\n                  <div class=\"panel-title\">Inspector</div>\n                  <button\n                    class=\"btn btn-ghost\"\n                    id=\"btn-right-close\"\n                    type=\"button\"\n                    title=\"Hide\"\n                    aria-label=\"Hide inspector\"\n                  >\n                    <i class=\"fa-solid fa-xmark\"></i>\n                  </button>\n                </div>\n                <div class=\"panel-body\" id=\"inspector-body\"></div>\n              </div>\n            </div>\n          </section>\n\n          <!-- Updates -->\n          <section class=\"screen\" id=\"screen-updates\">\n            <div class=\"grid\" style=\"gap: 6px\">\n              <div style=\"font-size: var(--text-2xl); font-weight: var(--font-semibold)\">Product Updates</div>\n              <div class=\"muted\" style=\"font-size: var(--text-sm)\">\n                Release notes for buyers. Customize these for your roadmap.\n              </div>\n            </div>\n            <div style=\"height: 14px\"></div>\n            <div class=\"grid\" id=\"updates-list\" style=\"gap: 12px\"></div>\n          </section>\n\n          <!-- Roadmap -->\n          <section class=\"screen\" id=\"screen-roadmap\">\n            <div class=\"grid\" style=\"gap: 6px\">\n              <div style=\"font-size: var(--text-2xl); font-weight: var(--font-semibold)\">Roadmap</div>\n              <div class=\"muted\" style=\"font-size: var(--text-sm)\">\n                Set expectations and communicate upcoming features.\n              </div>\n            </div>\n            <div style=\"height: 14px\"></div>\n            <div class=\"grid\" id=\"roadmap-list\" style=\"gap: 16px\"></div>\n          </section>\n\n          <!-- Settings -->\n          <section class=\"screen\" id=\"screen-settings\">\n            <div class=\"row space-between\">\n              <div class=\"grid\" style=\"gap: 6px\">\n                <div style=\"font-size: var(--text-2xl); font-weight: var(--font-semibold)\">Settings</div>\n                <div class=\"muted\" style=\"font-size: var(--text-sm)\">Preferences persist locally on this device.</div>\n              </div>\n            </div>\n            <div style=\"height: 14px\"></div>\n            <div class=\"card\" style=\"max-width: 820px\">\n              <div style=\"display: grid; gap: 18px\">\n                <div style=\"font-weight: var(--font-semibold)\">Units</div>\n                <div class=\"row\" style=\"gap: 12px\">\n                  <div class=\"field\" style=\"flex: 1; min-width: 240px\">\n                    <div class=\"label\">Length</div>\n                    <select class=\"select\" id=\"pref-length\">\n                      <option value=\"in\">Inches</option>\n                      <option value=\"ft\">Feet</option>\n                      <option value=\"mm\">Millimeters</option>\n                      <option value=\"cm\">Centimeters</option>\n                      <option value=\"m\">Meters</option>\n                    </select>\n                  </div>\n                  <div class=\"field\" style=\"flex: 1; min-width: 240px\">\n                    <div class=\"label\">Weight</div>\n                    <select class=\"select\" id=\"pref-weight\">\n                      <option value=\"lb\">Pounds</option>\n                      <option value=\"kg\">Kilograms</option>\n                    </select>\n                  </div>\n                </div>\n\n                <div style=\"font-weight: var(--font-semibold)\">Appearance</div>\n                <div class=\"row\" style=\"gap: 12px\">\n                  <div class=\"field\" style=\"flex: 1; min-width: 240px\">\n                    <div class=\"label\">Theme</div>\n                    <select class=\"select\" id=\"pref-theme\">\n                      <option value=\"light\">Light</option>\n                      <option value=\"dark\">Dark</option>\n                    </select>\n                  </div>\n                  <div class=\"field\" style=\"flex: 1; min-width: 240px\">\n                    <div class=\"label\">Label size (px)</div>\n                    <input class=\"input\" id=\"pref-label-size\" type=\"number\" min=\"8\" max=\"24\" step=\"1\" />\n                  </div>\n                </div>\n                <div class=\"row\" style=\"gap: 12px\">\n                  <div class=\"field\" style=\"flex: 1; min-width: 240px\">\n                    <div class=\"label\">Hidden case opacity</div>\n                    <input class=\"input\" id=\"pref-hidden-opacity\" type=\"number\" min=\"0\" max=\"1\" step=\"0.05\" />\n                  </div>\n                </div>\n\n                <div style=\"font-weight: var(--font-semibold)\">Editor</div>\n                <div class=\"row\" style=\"gap: 12px\">\n                  <div class=\"field\" style=\"flex: 1; min-width: 240px\">\n                    <div class=\"label\">Snapping</div>\n                    <select class=\"select\" id=\"pref-snapping-enabled\">\n                      <option value=\"true\">Enabled</option>\n                      <option value=\"false\">Disabled</option>\n                    </select>\n                  </div>\n                  <div class=\"field\" style=\"flex: 1; min-width: 240px\">\n                    <div class=\"label\">Grid size (in)</div>\n                    <input class=\"input\" id=\"pref-grid-size\" type=\"number\" min=\"0.25\" step=\"0.25\" />\n                  </div>\n                </div>\n\n                <div style=\"font-weight: var(--font-semibold)\">Export</div>\n                <div class=\"row\" style=\"gap: 12px\">\n                  <div class=\"field\" style=\"flex: 1; min-width: 240px\">\n                    <div class=\"label\">Screenshot resolution</div>\n                    <select class=\"select\" id=\"pref-shot-res\">\n                      <option value=\"1920x1080\">1920×1080</option>\n                      <option value=\"2560x1440\">2560×1440</option>\n                      <option value=\"3840x2160\">3840×2160</option>\n                    </select>\n                  </div>\n                  <div class=\"field\" style=\"flex: 1; min-width: 240px\">\n                    <div class=\"label\">Include stats in PDF</div>\n                    <select class=\"select\" id=\"pref-pdf-stats\">\n                      <option value=\"true\">Yes</option>\n                      <option value=\"false\">No</option>\n                    </select>\n                  </div>\n                </div>\n\n                <div class=\"row\" style=\"justify-content: flex-end; gap: 10px\">\n                  <button class=\"btn\" id=\"btn-reset-demo\" type=\"button\">\n                    <i class=\"fa-solid fa-rotate-left\"></i>\n                    Reset demo data\n                  </button>\n                  <button class=\"btn btn-primary\" id=\"btn-save-prefs\" type=\"button\">\n                    <i class=\"fa-solid fa-floppy-disk\"></i>\n                    Save changes\n                  </button>\n                </div>\n              </div>\n            </div>\n          </section>\n        </div>\n      </main>\n    </div>\n\n    <div id=\"modal-root\"></div>\n    <div id=\"toast-container\" aria-live=\"polite\" aria-atomic=\"true\"></div>\n\n    <div class=\"system-overlay\" id=\"system-overlay\">\n      <div class=\"system-card\">\n        <h2 id=\"system-title\">Truck Packer 3D</h2>\n        <p id=\"system-message\"></p>\n        <ul class=\"system-list\" id=\"system-list\"></ul>\n        <div style=\"height: 14px\"></div>\n        <div class=\"row\" style=\"justify-content: flex-end\">\n          <button class=\"btn btn-primary\" id=\"system-retry\" type=\"button\">\n            <i class=\"fa-solid fa-rotate\"></i>\n            Retry\n          </button>\n        </div>\n      </div>\n    </div>\n\n    <script type=\"module\">\n      (async function () {\n        try {\n          if (window.__TP3D_BOOT && window.__TP3D_BOOT.threeReady) {\n            await window.__TP3D_BOOT.threeReady;\n          }\n        } catch (_) {\n          // Ignore boot errors\n        }\n\n        console.info('[TruckPackerApp] threeReady resolved, bootstrapping app');\n\n        window.TruckPackerApp = (function () {\n          'use strict';\n\n          const APP_VERSION = '1.0.0';\n\n          const Utils = (() => {\n            const clamp = (value, min, max) => Math.min(max, Math.max(min, value));\n\n            function safeJsonParse(text, fallback = null) {\n              try {\n                return JSON.parse(text);\n              } catch (_) {\n                return fallback;\n              }\n            }\n\n            function deepClone(obj) {\n              return JSON.parse(JSON.stringify(obj));\n            }\n\n            function sanitizeJSON(value) {\n              // Prevent prototype pollution via imported JSON (__proto__/constructor/prototype keys).\n              if (Array.isArray(value)) return value.map(sanitizeJSON);\n              if (!value || typeof value !== 'object') return value;\n              const out = {};\n              Object.keys(value).forEach(key => {\n                if (key === '__proto__' || key === 'prototype' || key === 'constructor') return;\n                out[key] = sanitizeJSON(value[key]);\n              });\n              return out;\n            }\n\n            function uuid() {\n              if (window.crypto && window.crypto.randomUUID) return window.crypto.randomUUID();\n              const buf = new Uint8Array(16);\n              (window.crypto || window.msCrypto).getRandomValues(buf);\n              buf[6] = (buf[6] & 0x0f) | 0x40;\n              buf[8] = (buf[8] & 0x3f) | 0x80;\n              const hex = Array.from(buf).map(b => b.toString(16).padStart(2, '0'));\n              return (\n                hex.slice(0, 4).join('') +\n                '-' +\n                hex.slice(4, 6).join('') +\n                '-' +\n                hex.slice(6, 8).join('') +\n                '-' +\n                hex.slice(8, 10).join('') +\n                '-' +\n                hex.slice(10, 16).join('')\n              );\n            }\n\n            function debounce(fn, waitMs) {\n              let t = null;\n              return function (...args) {\n                window.clearTimeout(t);\n                t = window.setTimeout(() => fn.apply(this, args), waitMs);\n              };\n            }\n\n            function formatRelativeTime(ts) {\n              if (!ts) return '—';\n              const delta = Date.now() - ts;\n              const s = Math.floor(delta / 1000);\n              if (s < 10) return 'just now';\n              if (s < 60) return `${s}s ago`;\n              const m = Math.floor(s / 60);\n              if (m < 60) return `${m}m ago`;\n              const h = Math.floor(m / 60);\n              if (h < 24) return `${h}h ago`;\n              const d = Math.floor(h / 24);\n              if (d < 30) return `${d}d ago`;\n              return new Date(ts).toLocaleDateString();\n            }\n\n            function downloadText(filename, text, mime = 'application/json') {\n              const blob = new Blob([text], { type: mime });\n              const url = URL.createObjectURL(blob);\n              const a = document.createElement('a');\n              a.href = url;\n              a.download = filename;\n              document.body.appendChild(a);\n              a.click();\n              document.body.removeChild(a);\n              URL.revokeObjectURL(url);\n            }\n\n            function parseResolution(res) {\n              const m = String(res || '').match(/^(\\d+)x(\\d+)$/);\n              if (!m) return { width: 1920, height: 1080 };\n              return { width: Number(m[1]), height: Number(m[2]) };\n            }\n\n            const lengthUnits = ['in', 'ft', 'mm', 'cm', 'm'];\n            const weightUnits = ['lb', 'kg'];\n\n            function inchesToUnit(inches, unit) {\n              switch (unit) {\n                case 'in':\n                  return inches;\n                case 'ft':\n                  return inches / 12;\n                case 'mm':\n                  return inches * 25.4;\n                case 'cm':\n                  return inches * 2.54;\n                case 'm':\n                  return inches * 0.0254;\n                default:\n                  return inches;\n              }\n            }\n\n            function unitToInches(value, unit) {\n              switch (unit) {\n                case 'in':\n                  return value;\n                case 'ft':\n                  return value * 12;\n                case 'mm':\n                  return value / 25.4;\n                case 'cm':\n                  return value / 2.54;\n                case 'm':\n                  return value / 0.0254;\n                default:\n                  return value;\n              }\n            }\n\n            function poundsToUnit(lb, unit) {\n              switch (unit) {\n                case 'lb':\n                  return lb;\n                case 'kg':\n                  return lb * 0.45359237;\n                default:\n                  return lb;\n              }\n            }\n\n            function unitToPounds(value, unit) {\n              switch (unit) {\n                case 'lb':\n                  return value;\n                case 'kg':\n                  return value / 0.45359237;\n                default:\n                  return value;\n              }\n            }\n\n            function formatLength(inches, unit, digits = 1) {\n              const v = inchesToUnit(inches, unit);\n              const fixed = unit === 'in' ? 0 : digits;\n              return `${Number.isFinite(v) ? v.toFixed(fixed) : '—'} ${unit}`;\n            }\n\n            function formatWeight(lb, unit, digits = 1) {\n              const v = poundsToUnit(lb, unit);\n              const fixed = unit === 'lb' ? 0 : digits;\n              return `${Number.isFinite(v) ? v.toFixed(fixed) : '—'} ${unit}`;\n            }\n\n            function formatDims(dimInches, lengthUnit) {\n              const l = inchesToUnit(dimInches.length, lengthUnit);\n              const w = inchesToUnit(dimInches.width, lengthUnit);\n              const h = inchesToUnit(dimInches.height, lengthUnit);\n              const fixed = lengthUnit === 'in' ? 0 : 1;\n              return `${l.toFixed(fixed)}×${w.toFixed(fixed)}×${h.toFixed(fixed)} ${lengthUnit}`;\n            }\n\n            function volumeInCubicInches(dimInches) {\n              const { length, width, height } = dimInches;\n              return Math.max(0, Number(length) * Number(width) * Number(height));\n            }\n\n            function formatVolume(dimInches, lengthUnit) {\n              const in3 = volumeInCubicInches(dimInches);\n              if (!Number.isFinite(in3)) return '—';\n              const isImperial = lengthUnit === 'in' || lengthUnit === 'ft';\n              if (isImperial) {\n                const ft3 = in3 / 1728;\n                return `${ft3.toFixed(1)} ft³`;\n              }\n              const m3 = in3 * Math.pow(0.0254, 3);\n              return `${m3.toFixed(3)} m³`;\n            }\n\n            function hasWebGL() {\n              try {\n                const canvas = document.createElement('canvas');\n                return Boolean(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));\n              } catch (_) {\n                return false;\n              }\n            }\n\n            function cssHexToInt(hex) {\n              const s = String(hex || '').trim();\n              const m = s.match(/^#([0-9a-f]{6})$/i);\n              if (!m) return 0x000000;\n              return parseInt(m[1], 16);\n            }\n\n            function getCssVar(name) {\n              return getComputedStyle(document.documentElement).getPropertyValue(name).trim();\n            }\n\n            return {\n              APP_VERSION,\n              clamp,\n              safeJsonParse,\n              deepClone,\n              sanitizeJSON,\n              uuid,\n              debounce,\n              formatRelativeTime,\n              downloadText,\n              parseResolution,\n              lengthUnits,\n              weightUnits,\n              inchesToUnit,\n              unitToInches,\n              poundsToUnit,\n              unitToPounds,\n              formatLength,\n              formatWeight,\n              formatDims,\n              volumeInCubicInches,\n              formatVolume,\n              hasWebGL,\n              cssHexToInt,\n              getCssVar,\n            };\n          })();\n\n          const UIComponents = (() => {\n            const modalRoot = document.getElementById('modal-root');\n            const toastContainer = document.getElementById('toast-container');\n            let dropdownKeyDownListener = null;\n            let dropdownRepositionListener = null;\n\n            const toastTypes = {\n              success: { title: 'Success', color: 'var(--success)', icon: '✓' },\n              error: { title: 'Error', color: 'var(--error)', icon: '✕' },\n              warning: { title: 'Warning', color: 'var(--warning)', icon: '⚠' },\n              info: { title: 'Info', color: 'var(--info)', icon: 'ℹ' },\n            };\n\n            function showToast(message, type = 'info', options = {}) {\n              const cfg = toastTypes[type] || toastTypes.info;\n              const toast = document.createElement('div');\n              toast.className = 'toast';\n              toast.setAttribute('role', 'status');\n\n              const icon = document.createElement('div');\n              icon.className = 'toast-icon';\n              icon.style.background = cfg.color;\n              icon.textContent = cfg.icon;\n\n              const body = document.createElement('div');\n              body.className = 'toast-body';\n\n              const title = document.createElement('div');\n              title.className = 'toast-title';\n              title.textContent = options.title || cfg.title;\n\n              const msg = document.createElement('div');\n              msg.className = 'toast-message';\n              msg.textContent = String(message || '');\n\n              body.appendChild(title);\n              body.appendChild(msg);\n\n              if (Array.isArray(options.actions) && options.actions.length) {\n                const actions = document.createElement('div');\n                actions.className = 'toast-actions';\n                options.actions.forEach(action => {\n                  const btn = document.createElement('button');\n                  btn.className = 'toast-btn';\n                  btn.type = 'button';\n                  btn.textContent = action.label || 'Action';\n                  btn.addEventListener('click', ev => {\n                    ev.stopPropagation();\n                    try {\n                      action.onClick && action.onClick();\n                    } catch (_) {\n                      // Ignore errors from action handlers\n                    }\n                    removeToast(toast);\n                  });\n                  actions.appendChild(btn);\n                });\n                body.appendChild(actions);\n              }\n\n              toast.appendChild(icon);\n              toast.appendChild(body);\n\n              toast.addEventListener('click', () => removeToast(toast));\n              toastContainer.appendChild(toast);\n\n              while (toastContainer.children.length > 3) {\n                toastContainer.removeChild(toastContainer.firstChild);\n              }\n\n              const duration = Number.isFinite(options.duration) ? options.duration : 3200;\n              if (duration > 0) window.setTimeout(() => removeToast(toast), duration);\n            }\n\n            function removeToast(toast) {\n              if (!toast || !toast.parentElement) return;\n              toast.style.opacity = '0';\n              toast.style.transform = 'translateX(12px)';\n              window.setTimeout(() => {\n                if (toast.parentElement) toast.parentElement.removeChild(toast);\n              }, 180);\n            }\n\n            function showModal(config) {\n              const overlay = document.createElement('div');\n              overlay.className = 'modal-overlay';\n\n              const modal = document.createElement('div');\n              modal.className = 'modal';\n\n              const header = document.createElement('div');\n              header.className = 'modal-header';\n\n              const title = document.createElement('h3');\n              title.className = 'modal-title';\n              title.textContent = config.title || 'Dialog';\n\n              const closeBtn = document.createElement('button');\n              closeBtn.className = 'btn btn-ghost';\n              closeBtn.type = 'button';\n              closeBtn.innerHTML = '<i class=\"fa-solid fa-xmark\"></i>';\n              closeBtn.addEventListener('click', () => close());\n\n              header.appendChild(title);\n              header.appendChild(closeBtn);\n\n              const body = document.createElement('div');\n              body.className = 'modal-body';\n              if (typeof config.content === 'string') {\n                // SECURITY: Treat string content as trusted HTML only. For user-provided text, pass an HTMLElement and set textContent.\n                const div = document.createElement('div');\n                div.innerHTML = config.content;\n                body.appendChild(div);\n              } else if (config.content instanceof HTMLElement) {\n                body.appendChild(config.content);\n              }\n\n              const footer = document.createElement('div');\n              footer.className = 'modal-footer';\n              (config.actions || [{ label: 'Close' }]).forEach(action => {\n                const btn = document.createElement('button');\n                btn.className = `btn ${action.variant === 'primary' ? 'btn-primary' : ''} ${action.variant === 'danger' ? 'btn-danger' : ''}`;\n                btn.type = 'button';\n                btn.textContent = action.label || 'OK';\n                btn.addEventListener('click', () => {\n                  try {\n                    const res = action.onClick ? action.onClick() : undefined;\n                    if (res === false) return;\n                  } catch (_) {\n                    // Ignore errors from modal actions\n                  }\n                  close();\n                });\n                footer.appendChild(btn);\n              });\n\n              modal.appendChild(header);\n              modal.appendChild(body);\n              modal.appendChild(footer);\n              overlay.appendChild(modal);\n\n              overlay.addEventListener('click', ev => {\n                if (ev.target === overlay && config.dismissible !== false) close();\n              });\n\n              function close() {\n                if (overlay.parentElement) overlay.parentElement.removeChild(overlay);\n                try {\n                  config.onClose && config.onClose();\n                } catch (_) {\n                  // Ignore errors from onClose callback\n                }\n              }\n\n              modalRoot.appendChild(overlay);\n              return { close, overlay, modal, body };\n            }\n\n            function confirm(options) {\n              return new Promise(resolve => {\n                showModal({\n                  title: options.title || 'Confirm',\n                  content: options.message || 'Are you sure?',\n                  actions: [\n                    { label: options.cancelLabel || 'Cancel', onClick: () => resolve(false) },\n                    {\n                      label: options.okLabel || 'Confirm',\n                      variant: options.danger ? 'danger' : 'primary',\n                      onClick: () => resolve(true),\n                    },\n                  ],\n                });\n              });\n            }\n\n\t            function openDropdown(anchorEl, items, options = {}) {\n\t              closeAllDropdowns();\n\t              const wrap = document.createElement('div');\n\t              wrap.className = 'dropdown-menu';\n\t              // The stylesheet defines `.dropdown-menu` as `position:absolute` for inline dropdowns.\n\t              // For floating viewport-clamped dropdowns we make it participate in layout so the\n\t              // wrapper element has a measurable width/height.\n\t              wrap.style.position = 'static';\n\t              wrap.style.top = 'auto';\n\t              wrap.style.left = 'auto';\n\t              wrap.style.right = 'auto';\n\n\t              items.forEach(item => {\n\t                if (item && (item.type === 'divider' || item.divider === true)) {\n\t                  const divider = document.createElement('div');\n                  divider.setAttribute('role', 'separator');\n                  divider.style.height = '1px';\n                  divider.style.margin = `${8}px ${6}px`;\n                  divider.style.background = 'var(--border-subtle)';\n                  wrap.appendChild(divider);\n                  return;\n                }\n\n                // Add divider before this item if requested\n                if (item && item.dividerBefore) {\n                  const divider = document.createElement('div');\n                  divider.setAttribute('role', 'separator');\n                  divider.style.height = '1px';\n                  divider.style.margin = `${8}px ${6}px`;\n                  divider.style.background = 'var(--border-subtle)';\n                  wrap.appendChild(divider);\n                }\n\n                const btn = document.createElement('button');\n                btn.type = 'button';\n                btn.className = 'dropdown-item';\n                \n                // Apply variant (e.g., danger for delete actions)\n                if (item && item.variant) {\n                  btn.dataset.variant = item.variant;\n                }\n                \n                if (item && item.disabled) {\n                  btn.disabled = true;\n                  btn.style.opacity = '0.6';\n                  btn.style.cursor = 'not-allowed';\n                }\n\t                if (item.icon) {\n\t                  const icon = document.createElement('i');\n\t                  icon.className = item.icon;\n\t                  btn.appendChild(icon);\n\t                }\n                const text = document.createElement('span');\n                text.textContent = String(item.label || '');\n                text.style.flex = '1';\n                btn.appendChild(text);\n                if (item.rightIcon) {\n                  const iconRight = document.createElement('i');\n                  iconRight.className = item.rightIcon;\n                  iconRight.style.marginLeft = 'auto';\n                  iconRight.style.color = item.rightIconColor || 'var(--accent-primary)';\n                  btn.appendChild(iconRight);\n                }\n                btn.addEventListener('click', ev => {\n                  ev.stopPropagation();\n                  if (btn.disabled) return;\n                  closeAllDropdowns();\n                  item.onClick && item.onClick();\n                });\n                wrap.appendChild(btn);\n              });\n\n              const dropdown = document.createElement('div');\n              dropdown.className = 'dropdown';\n              dropdown.dataset.dropdown = '1';\n              dropdown.style.position = 'fixed';\n              dropdown.style.zIndex = '16000';\n              dropdown.style.visibility = 'hidden';\n\n              const preferredWidth = Math.max(180, Number(options.width) || 220);\n              dropdown.style.minWidth = `${preferredWidth}px`;\n              dropdown.appendChild(wrap);\n\n              document.body.appendChild(dropdown);\n\n\t              const positionDropdown = () => {\n\t                if (!dropdown.isConnected) return;\n\t                const pad = 8;\n\t                const gap = 6;\n\t                const vw = window.innerWidth || document.documentElement.clientWidth || 0;\n\t                const vh = window.innerHeight || document.documentElement.clientHeight || 0;\n\t                const rect = anchorEl.getBoundingClientRect();\n\n\t                dropdown.style.maxWidth = `${Math.max(0, vw - pad * 2)}px`;\n\t                dropdown.style.maxHeight = `${Math.max(0, vh - pad * 2)}px`;\n\t                dropdown.style.overflowY = 'auto';\n\n\t                // Measure after maxWidth/minWidth are applied.\n\t                const menuRect = dropdown.getBoundingClientRect();\n                const menuW = menuRect.width || preferredWidth;\n                const menuH = menuRect.height || 0;\n\n                // Default: open below the trigger.\n                let top = rect.bottom + gap;\n                if (top + menuH > vh - pad) top = rect.top - gap - menuH;\n                top = Math.max(pad, Math.min(top, Math.max(pad, vh - pad - menuH)));\n\n                // Backwards-compatible default: align dropdown's right edge with trigger's right edge.\n                let left = rect.right - menuW;\n                if (options.align === 'left') left = rect.left;\n                left = Math.max(pad, Math.min(left, Math.max(pad, vw - pad - menuW)));\n\n                dropdown.style.left = `${Math.round(left)}px`;\n                dropdown.style.top = `${Math.round(top)}px`;\n              };\n\n              positionDropdown();\n              dropdown.style.visibility = 'visible';\n              window.setTimeout(() => {\n                const onDocClick = () => closeAllDropdowns();\n                document.addEventListener('click', onDocClick, { once: true });\n              }, 0);\n\n              dropdownKeyDownListener = ev => {\n                if (ev.key === 'Escape') closeAllDropdowns();\n              };\n              document.addEventListener('keydown', dropdownKeyDownListener);\n\n              dropdownRepositionListener = () => positionDropdown();\n              window.addEventListener('resize', dropdownRepositionListener);\n              // Capture scroll events from nested scroll containers too.\n              window.addEventListener('scroll', dropdownRepositionListener, true);\n            }\n\n            function closeAllDropdowns() {\n              document.querySelectorAll('[data-dropdown=\"1\"]').forEach(el => el.remove());\n              if (dropdownKeyDownListener) {\n                document.removeEventListener('keydown', dropdownKeyDownListener);\n                dropdownKeyDownListener = null;\n              }\n              if (dropdownRepositionListener) {\n                window.removeEventListener('resize', dropdownRepositionListener);\n                window.removeEventListener('scroll', dropdownRepositionListener, true);\n                dropdownRepositionListener = null;\n              }\n            }\n\n            return { showToast, showModal, confirm, openDropdown, closeAllDropdowns };\n          })();\n\n          const SystemOverlay = (() => {\n            const overlay = document.getElementById('system-overlay');\n            const titleEl = document.getElementById('system-title');\n            const messageEl = document.getElementById('system-message');\n            const listEl = document.getElementById('system-list');\n            const retryBtn = document.getElementById('system-retry');\n            retryBtn.addEventListener('click', () => window.location.reload());\n\n            function show({ title, message, items }) {\n              titleEl.textContent = title || 'Truck Packer 3D';\n              messageEl.textContent = message || '';\n              listEl.innerHTML = '';\n              (items || []).forEach(text => {\n                const li = document.createElement('li');\n                li.textContent = text;\n                listEl.appendChild(li);\n              });\n              overlay.classList.add('active');\n            }\n\n            function hide() {\n              overlay.classList.remove('active');\n            }\n\n            return { show, hide };\n          })();\n\n          // Normalizer helper removed (unused). Keep utilities within modules if needed.\n            }\n\n            function replace(nextState, options = {}) {\n              state = Utils.deepClone(nextState);\n              if (!options.skipHistory) pushHistory(historySlice(state));\n              notify({ _replace: true }, state);\n            }\n\n            function snapshot() {\n              return Utils.deepClone(state);\n            }\n\n            function pushHistory(snapshot) {\n              history = history.slice(0, historyPointer + 1);\n              history.push(Utils.deepClone(snapshot));\n              if (history.length > MAX_HISTORY) history.shift();\n              historyPointer = history.length - 1;\n            }\n\n            function undo() {\n              if (historyPointer <= 0) return false;\n              historyPointer--;\n              state = { ...state, ...Utils.deepClone(history[historyPointer]) };\n              notify({ _undo: true }, state);\n              return true;\n            }\n\n            function redo() {\n              if (historyPointer >= history.length - 1) return false;\n              historyPointer++;\n              state = { ...state, ...Utils.deepClone(history[historyPointer]) };\n              notify({ _redo: true }, state);\n              return true;\n            }\n\n            function subscribe(fn) {\n              subscribers.push(fn);\n              return () => {\n                const idx = subscribers.indexOf(fn);\n                if (idx > -1) subscribers.splice(idx, 1);\n              };\n            }\n\n            function notify(changes, nextState) {\n              subscribers.forEach(fn => {\n                try {\n                  fn(changes, nextState);\n                } catch (err) {\n                  console.error('Subscriber error', err);\n                }\n              });\n            }\n\n            function isSignificantChange(patch) {\n              const keys = Object.keys(patch || {});\n              const significant = ['caseLibrary', 'packLibrary', 'preferences'];\n              return keys.some(k => significant.includes(k));\n            }\n\n            return { init, get, set, replace, snapshot, undo, redo, subscribe };\n          })();\n\n          const Storage = (() => {\n            const KEY = 'truckPacker3d:v1';\n            const saveDebounced = Utils.debounce(saveNow, 250);\n\n            function load() {\n              const raw = window.localStorage.getItem(KEY);\n              if (!raw) return null;\n              const parsed = Utils.sanitizeJSON(Utils.safeJsonParse(raw, null));\n              if (!parsed || typeof parsed !== 'object') return null;\n              if (parsed.version !== APP_VERSION) {\n                // Soft-migrate: allow older versions if shape matches.\n                return parsed;\n              }\n              return parsed;\n            }\n\n            function saveSoon() {\n              saveDebounced();\n            }\n\n            function saveNow() {\n              try {\n                const state = StateStore.get();\n                const payload = {\n                  version: APP_VERSION,\n                  savedAt: Date.now(),\n                  caseLibrary: state.caseLibrary,\n                  packLibrary: state.packLibrary,\n                  preferences: state.preferences,\n                  currentPackId: state.currentPackId,\n                };\n                window.localStorage.setItem(KEY, JSON.stringify(payload));\n              } catch (err) {\n                console.error('Save failed', err);\n                UIComponents.showToast('Save failed: ' + err.message, 'error', { title: 'Storage' });\n              }\n            }\n\n            function clearAll() {\n              window.localStorage.removeItem(KEY);\n            }\n\n            function exportAppJSON() {\n              const state = StateStore.get();\n              const payload = {\n                app: 'Truck Packer 3D',\n                version: APP_VERSION,\n                exportedAt: Date.now(),\n                data: {\n                  caseLibrary: state.caseLibrary,\n                  packLibrary: state.packLibrary,\n                  preferences: state.preferences,\n                },\n              };\n              return JSON.stringify(payload, null, 2);\n            }\n\n            function importAppJSON(jsonText) {\n              const parsed = Utils.sanitizeJSON(Utils.safeJsonParse(jsonText, null));\n              if (!parsed || typeof parsed !== 'object') throw new Error('Invalid JSON');\n              const data = parsed.data || parsed;\n              if (!data.caseLibrary || !data.packLibrary || !data.preferences) throw new Error('Missing required keys');\n              return {\n                caseLibrary: data.caseLibrary,\n                packLibrary: data.packLibrary,\n                preferences: data.preferences,\n              };\n            }\n\n            return { load, saveSoon, saveNow, clearAll, exportAppJSON, importAppJSON };\n          })();\n\n          const SessionManager = (() => {\n            const KEY = 'truckPacker3d:session:v1';\n            let session = null;\n            const subscribers = [];\n            const LEGACY = { name: 'Agro Felix', email: 'agrofelixbraganca@gmail.com' };\n            const DEMO = { name: 'Demo User', email: 'info@pxl360.com' };\n\n            function defaultDemoSession() {\n              return {\n                user: { name: 'Demo User', email: 'info@pxl360.com' },\n                currentAccount: { type: 'personal', name: 'Personal Account', role: 'Owner' },\n              };\n            }\n\n            function defaultSignedOutSession() {\n              return {\n                user: { name: 'Guest', email: '' },\n                currentAccount: { type: 'personal', name: 'Personal Account', role: '' },\n              };\n            }\n\n            function notify() {\n              subscribers.forEach(fn => {\n                try {\n                  fn(session);\n                } catch (err) {\n                  console.error('[Session] subscriber error', err);\n                }\n              });\n            }\n\n            function load() {\n              try {\n                const raw = window.localStorage.getItem(KEY);\n                if (!raw) return null;\n                const parsed = Utils.sanitizeJSON(Utils.safeJsonParse(raw, null));\n                return parsed && typeof parsed === 'object' ? parsed : null;\n              } catch {\n                return null;\n              }\n            }\n\n            function save(next) {\n              try {\n                window.localStorage.setItem(KEY, JSON.stringify(next));\n              } catch {\n                // ignore\n              }\n            }\n\n            function migrate(next) {\n              if (!next || typeof next !== 'object') return next;\n              next.user = next.user && typeof next.user === 'object' ? next.user : {};\n              const name = String(next.user.name || '');\n              const email = String(next.user.email || '');\n              if (name === LEGACY.name || email === LEGACY.email) {\n                next.user.name = DEMO.name;\n                next.user.email = DEMO.email;\n              }\n              return next;\n            }\n\n            function get() {\n              if (session) return session;\n              const stored = load();\n              session = migrate(stored || defaultDemoSession());\n              save(session);\n              return session;\n            }\n\n            function clear() {\n              try {\n                window.localStorage.removeItem(KEY);\n              } catch {\n                // ignore\n              }\n              session = defaultSignedOutSession();\n              notify();\n            }\n\n            function subscribe(fn) {\n              subscribers.push(fn);\n              return () => {\n                const idx = subscribers.indexOf(fn);\n                if (idx > -1) subscribers.splice(idx, 1);\n              };\n            }\n\n            return { get, clear, subscribe };\n          })();\n\n          const Defaults = (() => {\n            const defaultPreferences = {\n              units: { length: 'in', weight: 'lb' },\n              theme: 'light',\n              labelFontSize: 12,\n              hiddenCaseOpacity: 0.3,\n              snapping: { enabled: true, gridSize: 1 },\n              camera: { defaultView: 'perspective' },\n              export: { screenshotResolution: '1920x1080', pdfIncludeStats: true },\n              categories: [],\n            };\n\n            const categories = [\n              { key: 'all', name: 'All', color: '#9b9ba8' },\n              { key: 'audio', name: 'Audio', color: '#f59e0b' },\n              { key: 'lighting', name: 'Lighting', color: '#3b82f6' },\n              { key: 'stage', name: 'Stage', color: '#10b981' },\n              { key: 'backline', name: 'Backline', color: '#ec4899' },\n              { key: 'default', name: 'Default', color: '#9ca3af' },\n            ];\n\n            function seedCases() {\n              const now = Date.now();\n              return [\n                {\n                  id: Utils.uuid(),\n                  name: 'Line Array Case',\n                  manufacturer: 'L-Acoustics',\n                  category: 'audio',\n                  dimensions: { length: 48, width: 24, height: 32 },\n                  weight: 125,\n                  canFlip: false,\n                  notes: '',\n                  color: '#ff9f1c',\n                  createdAt: now,\n                  updatedAt: now,\n                },\n                {\n                  id: Utils.uuid(),\n                  name: 'Subwoofer Crate',\n                  manufacturer: 'JBL',\n                  category: 'audio',\n                  dimensions: { length: 36, width: 36, height: 24 },\n                  weight: 95,\n                  canFlip: true,\n                  notes: '',\n                  color: '#ff9f1c',\n                  createdAt: now,\n                  updatedAt: now,\n                },\n                {\n                  id: Utils.uuid(),\n                  name: 'Truss Section',\n                  manufacturer: 'Global Truss',\n                  category: 'lighting',\n                  dimensions: { length: 120, width: 12, height: 12 },\n                  weight: 45,\n                  canFlip: true,\n                  notes: '',\n                  color: '#3b82f6',\n                  createdAt: now,\n                  updatedAt: now,\n                },\n                {\n                  id: Utils.uuid(),\n                  name: 'Stage Deck',\n                  manufacturer: 'StagingCo',\n                  category: 'stage',\n                  dimensions: { length: 96, width: 48, height: 8 },\n                  weight: 80,\n                  canFlip: false,\n                  notes: '',\n                  color: '#10b981',\n                  createdAt: now,\n                  updatedAt: now,\n                },\n                {\n                  id: Utils.uuid(),\n                  name: 'Guitar Rack',\n                  manufacturer: 'Backline Inc',\n                  category: 'backline',\n                  dimensions: { length: 40, width: 22, height: 46 },\n                  weight: 110,\n                  canFlip: false,\n                  notes: '',\n                  color: '#ec4899',\n                  createdAt: now,\n                  updatedAt: now,\n                },\n              ];\n            }\n\n            function seedPack(caseLibrary) {\n              const now = Date.now();\n              const pick = name => caseLibrary.find(c => c.name === name)?.id;\n              const packId = Utils.uuid();\n              const instances = [];\n              const add = (caseId, x, y, z) => {\n                instances.push({\n                  id: Utils.uuid(),\n                  caseId,\n                  transform: { position: { x, y, z }, rotation: { x: 0, y: 0, z: 0 }, scale: { x: 1, y: 1, z: 1 } },\n                  hidden: false,\n                  groupId: null,\n                });\n              };\n              add(pick('Line Array Case'), -80, 16, 0);\n              add(pick('Subwoofer Crate'), -90, 12, 28);\n              add(pick('Truss Section'), -70, 6, -24);\n\n              return {\n                id: packId,\n                title: 'Demo Pack',\n                client: 'Example Client',\n                projectName: 'Envato Preview',\n                drawnBy: 'Truck Packer 3D',\n                notes: 'Tip: Use AutoPack (Ctrl/Cmd+P) to fill the truck.',\n                truck: { length: 636, width: 102, height: 98 },\n                cases: instances.filter(i => Boolean(i.caseId)),\n                groups: [],\n                stats: { totalCases: instances.length, packedCases: 0, volumeUsed: 0, totalWeight: 0 },\n                createdAt: now,\n                lastEdited: now,\n              };\n            }\n\n            return { defaultPreferences, categories, seedCases, seedPack };\n          })();\n\n          const Normalizer = (() => {\n            const DEFAULT_TRUCK = { length: 636, width: 102, height: 98 };\n\n            function finiteNumber(value, fallback) {\n              const n = Number(value);\n              return Number.isFinite(n) ? n : fallback;\n            }\n\n            function positiveNumber(value, fallback) {\n              const n = finiteNumber(value, fallback);\n              return n > 0 ? n : fallback;\n            }\n\n            function safeString(value, fallback = '') {\n              const s = value == null ? '' : String(value);\n              const t = s.trim();\n              return t || fallback;\n            }\n\n            function normalizePreferences(prefs) {\n              const base = Utils.deepClone(Defaults.defaultPreferences);\n              const next = { ...base, ...(prefs && typeof prefs === 'object' ? prefs : {}) };\n              next.units = next.units && typeof next.units === 'object' ? next.units : base.units;\n              next.units.length = Utils.lengthUnits.includes(next.units.length) ? next.units.length : base.units.length;\n              next.units.weight = Utils.weightUnits.includes(next.units.weight) ? next.units.weight : base.units.weight;\n              next.theme = next.theme === 'dark' ? 'dark' : 'light';\n              next.labelFontSize = Utils.clamp(finiteNumber(next.labelFontSize, base.labelFontSize), 8, 24);\n              next.hiddenCaseOpacity = Utils.clamp(finiteNumber(next.hiddenCaseOpacity, base.hiddenCaseOpacity), 0, 1);\n              next.snapping = next.snapping && typeof next.snapping === 'object' ? next.snapping : base.snapping;\n              next.snapping.enabled = Boolean(next.snapping.enabled);\n              next.snapping.gridSize = Math.max(0.25, finiteNumber(next.snapping.gridSize, base.snapping.gridSize));\n              next.camera = next.camera && typeof next.camera === 'object' ? next.camera : base.camera;\n              next.camera.defaultView = next.camera.defaultView === 'orthographic' ? 'orthographic' : 'perspective';\n              next.export = next.export && typeof next.export === 'object' ? next.export : base.export;\n              next.export.screenshotResolution = safeString(\n                next.export.screenshotResolution,\n                base.export.screenshotResolution\n              );\n              next.export.pdfIncludeStats = Boolean(next.export.pdfIncludeStats);\n              const normalizeCatKey = key =>\n                String(key || '')\n                  .trim()\n                  .toLowerCase();\n              const prefCats = Array.isArray(next.categories) ? next.categories : base.categories;\n              next.categories = (prefCats || [])\n                .map(c => ({\n                  key: normalizeCatKey(c.key || c.name),\n                  name: safeString(c.name, c.key || ''),\n                  color: safeString(c.color, ''),\n                }))\n                .filter(c => c.key);\n              if (!next.categories.length) {\n                next.categories = (Defaults.categories || [])\n                  .filter(c => c.key !== 'all')\n                  .map(c => ({ key: c.key, name: c.name, color: c.color }));\n              }\n              return next;\n            }\n\n            function normalizeCase(c, now) {\n              const createdAt = finiteNumber(c && c.createdAt, now);\n              const updatedAt = finiteNumber(c && c.updatedAt, now);\n              const dims = c && c.dimensions && typeof c.dimensions === 'object' ? c.dimensions : {};\n              const length = positiveNumber(dims.length, 48);\n              const width = positiveNumber(dims.width, 24);\n              const height = positiveNumber(dims.height, 24);\n              const category = safeString(c && c.category, 'default').toLowerCase();\n              const color = safeString(c && c.color, CategoryService.meta(category).color);\n              return {\n                id: safeString(c && c.id, Utils.uuid()),\n                name: safeString(c && c.name, 'Unnamed Case'),\n                manufacturer: safeString(c && c.manufacturer, ''),\n                category,\n                dimensions: { length, width, height },\n                weight: Math.max(0, finiteNumber(c && c.weight, 0)),\n                volume: Utils.volumeInCubicInches({ length, width, height }),\n                canFlip: Boolean(c && c.canFlip),\n                notes: safeString(c && c.notes, ''),\n                color,\n                createdAt,\n                updatedAt,\n              };\n            }\n\n            function normalizeTruck(truck) {\n              const t = truck && typeof truck === 'object' ? truck : {};\n              return {\n                length: positiveNumber(t.length, DEFAULT_TRUCK.length),\n                width: positiveNumber(t.width, DEFAULT_TRUCK.width),\n                height: positiveNumber(t.height, DEFAULT_TRUCK.height),\n              };\n            }\n\n            function normalizeInstance(inst, caseMap) {\n              const transform = inst && inst.transform && typeof inst.transform === 'object' ? inst.transform : {};\n              const pos = transform.position && typeof transform.position === 'object' ? transform.position : {};\n              const rot =\n                transform.rotation && typeof transform.rotation === 'object'\n                  ? transform.rotation\n                  : { x: 0, y: 0, z: 0 };\n              const scale =\n                transform.scale && typeof transform.scale === 'object' ? transform.scale : { x: 1, y: 1, z: 1 };\n              const caseId = safeString(inst && inst.caseId, '');\n              const caseData = caseMap.get(caseId) || null;\n              const halfY = caseData ? Math.max(1, (caseData.dimensions.height || 1) / 2) : 10;\n\n              return {\n                id: safeString(inst && inst.id, Utils.uuid()),\n                caseId,\n                transform: {\n                  position: {\n                    x: finiteNumber(pos.x, -80),\n                    y: finiteNumber(pos.y, halfY),\n                    z: finiteNumber(pos.z, 0),\n                  },\n                  rotation: {\n                    x: finiteNumber(rot.x, 0),\n                    y: finiteNumber(rot.y, 0),\n                    z: finiteNumber(rot.z, 0),\n                  },\n                  scale: {\n                    x: finiteNumber(scale.x, 1),\n                    y: finiteNumber(scale.y, 1),\n                    z: finiteNumber(scale.z, 1),\n                  },\n                },\n                hidden: Boolean(inst && inst.hidden),\n                groupId: inst && inst.groupId != null ? inst.groupId : null,\n              };\n            }\n\n            function normalizePack(p, caseMap, now) {\n              const truck = normalizeTruck(p && p.truck);\n              const rawCases = Array.isArray(p && p.cases) ? p.cases : [];\n              const instances = rawCases.map(i => normalizeInstance(i, caseMap)).filter(i => Boolean(i.caseId));\n              const thumbnail = typeof (p && p.thumbnail) === 'string' ? p.thumbnail : null;\n              const thumbnailUpdatedAt = Number.isFinite(p && p.thumbnailUpdatedAt) ? p.thumbnailUpdatedAt : null;\n              const thumbnailSource =\n                p && (p.thumbnailSource === 'auto' || p.thumbnailSource === 'manual') ? p.thumbnailSource : null;\n              const pack = {\n                id: safeString(p && p.id, Utils.uuid()),\n                title: safeString(p && p.title, 'Untitled Pack'),\n                client: safeString(p && p.client, ''),\n                projectName: safeString(p && p.projectName, ''),\n                drawnBy: safeString(p && p.drawnBy, ''),\n                notes: safeString(p && p.notes, ''),\n                truck,\n                cases: instances,\n                groups: Array.isArray(p && p.groups) ? p.groups : [],\n                stats: { totalCases: 0, packedCases: 0, volumeUsed: 0, totalWeight: 0 },\n                createdAt: finiteNumber(p && p.createdAt, now),\n                lastEdited: finiteNumber(p && p.lastEdited, now),\n                thumbnail,\n                thumbnailUpdatedAt,\n                thumbnailSource,\n              };\n              pack.stats = PackLibrary.computeStats(pack, Array.from(caseMap.values()));\n              return pack;\n            }\n\n            function normalizeAppData(data) {\n              const now = Date.now();\n              const rawCases = Array.isArray(data && data.caseLibrary) ? data.caseLibrary : [];\n              const cases = rawCases.map(c => normalizeCase(c, now));\n\n              // Deduplicate case ids if needed\n              const seenCaseIds = new Set();\n              cases.forEach(c => {\n                if (!seenCaseIds.has(c.id)) {\n                  seenCaseIds.add(c.id);\n                  return;\n                }\n                c.id = Utils.uuid();\n              });\n              const caseMap = new Map(cases.map(c => [c.id, c]));\n\n              const rawPacks = Array.isArray(data && data.packLibrary) ? data.packLibrary : [];\n              const packs = rawPacks.map(p => normalizePack(p, caseMap, now));\n\n              const prefs = normalizePreferences(data && data.preferences);\n              const currentPackId = safeString(data && data.currentPackId, '');\n              const current = packs.some(p => p.id === currentPackId) ? currentPackId : packs[0] ? packs[0].id : null;\n\n              return { caseLibrary: cases, packLibrary: packs, preferences: prefs, currentPackId: current };\n            }\n\n            return { normalizeAppData };\n          })();\n\n          const PreferencesManager = (() => {\n            function applyTheme(theme) {\n              document.documentElement.setAttribute('data-theme', theme === 'dark' ? 'dark' : 'light');\n            }\n\n            function get() {\n              return StateStore.get('preferences');\n            }\n\n            function set(nextPrefs) {\n              StateStore.set({ preferences: nextPrefs });\n            }\n\n            return { get, set, applyTheme };\n          })();\n\n          const SettingsOverlay = (() => {\n            let overlay = null;\n            let modal = null;\n            let leftPane = null;\n            let rightPane = null;\n            let activeTab = 'account';\n            let unmountAccountButton = null;\n\n            function isOpen() {\n              return Boolean(overlay);\n            }\n\n            function open(tab = 'preferences') {\n              activeTab = String(tab || 'account');\n              close();\n\n              overlay = document.createElement('div');\n              overlay.className = 'modal-overlay';\n              overlay.style.zIndex = '17000';\n\n              modal = document.createElement('div');\n              modal.className = 'modal';\n              modal.style.width = 'min(1120px, 96vw)';\n              modal.style.height = 'min(780px, 92vh)';\n              modal.style.display = 'grid';\n              modal.style.gridTemplateColumns = '320px 1fr';\n              modal.style.padding = '0';\n\n              leftPane = document.createElement('div');\n              leftPane.style.padding = 'var(--space-4)';\n              leftPane.style.borderRight = '1px solid var(--border-subtle)';\n              leftPane.style.display = 'flex';\n              leftPane.style.flexDirection = 'column';\n              leftPane.style.gap = 'var(--space-4)';\n\n              rightPane = document.createElement('div');\n              rightPane.style.display = 'flex';\n              rightPane.style.flexDirection = 'column';\n              rightPane.style.minWidth = '0';\n\n              modal.appendChild(leftPane);\n              modal.appendChild(rightPane);\n              overlay.appendChild(modal);\n\n              overlay.addEventListener('click', ev => {\n                if (ev.target === overlay) close();\n              });\n\n              function onKeyDown(ev) {\n                if (ev.key === 'Escape') close();\n              }\n              document.addEventListener('keydown', onKeyDown);\n\n              const root = document.getElementById('modal-root');\n              root.appendChild(overlay);\n\n              overlay._tp3dCleanup = () => {\n                document.removeEventListener('keydown', onKeyDown);\n              };\n\n              render();\n            }\n\n            function close() {\n              if (!overlay) return;\n              try {\n                if (typeof unmountAccountButton === 'function') unmountAccountButton();\n              } catch {\n                // ignore\n              }\n              unmountAccountButton = null;\n\n              try {\n                overlay._tp3dCleanup && overlay._tp3dCleanup();\n              } catch {\n                // ignore\n              }\n\n              try {\n                if (overlay.parentElement) overlay.parentElement.removeChild(overlay);\n              } catch {\n                // ignore\n              }\n              overlay = null;\n              modal = null;\n              leftPane = null;\n              rightPane = null;\n            }\n\n            function setActive(tab) {\n              activeTab = String(tab || 'account');\n              render();\n            }\n\n            function render() {\n              if (!overlay) return;\n              const session = SessionManager.get();\n              const prefs = PreferencesManager.get();\n\n              leftPane.innerHTML = '';\n              rightPane.innerHTML = '';\n\n              // Left: account switcher button\n              const accountBtn = document.createElement('button');\n              accountBtn.type = 'button';\n              accountBtn.className = 'btn';\n              accountBtn.style.width = '100%';\n              accountBtn.style.justifyContent = 'space-between';\n              accountBtn.style.padding = 'var(--space-2) var(--space-3)';\n              accountBtn.innerHTML = `\n                <span style=\"display:flex;align-items:center;gap:var(--space-3);min-width:0\">\n                  <span class=\"brand-mark\" aria-hidden=\"true\" style=\"width:34px;height:34px;border-radius:12px;flex:0 0 auto\"></span>\n                  <span style=\"display:flex;flex-direction:column;align-items:flex-start;min-width:0\">\n                    <span style=\"font-weight:var(--font-semibold);line-height:1.1\">${session.currentAccount?.name || 'Personal Account'}</span>\n                    <span class=\"muted\" data-account-name style=\"font-size:var(--text-sm);line-height:1.1\">${\n                      session.user?.name || '—'\n                    }</span>\n                  </span>\n                </span>\n                <i class=\"fa-solid fa-chevron-down\" aria-hidden=\"true\"></i>\n              `;\n              leftPane.appendChild(accountBtn);\n              unmountAccountButton = AccountSwitcher.bind(accountBtn, { align: 'left' });\n\n              // Left: settings navigation\n              const navWrap = document.createElement('div');\n              navWrap.style.display = 'grid';\n              navWrap.style.gap = '6px';\n\n              const makeHeader = text => {\n                const h = document.createElement('div');\n                h.className = 'muted';\n                h.style.marginTop = '10px';\n                h.style.fontSize = 'var(--text-sm)';\n                h.textContent = text;\n                return h;\n              };\n\n              const makeItem = ({ key, label, icon, indent }) => {\n                const btn = document.createElement('button');\n                btn.type = 'button';\n                btn.className = 'nav-btn';\n                btn.style.width = '100%';\n                btn.style.borderRadius = 'var(--radius-sm)';\n                btn.style.paddingLeft = '12px';\n                btn.style.paddingRight = '12px';\n                btn.style.gap = '12px';\n                btn.style.fontSize = 'var(--text-base)';\n                btn.dataset.settingsTab = key;\n\n                if (icon) {\n                  const i = document.createElement('i');\n                  i.className = icon;\n                  i.style.width = '20px';\n                  i.style.display = 'inline-flex';\n                  i.style.alignItems = 'center';\n                  i.style.justifyContent = 'center';\n                  i.style.color = activeTab === key ? 'var(--accent-primary)' : 'var(--text-secondary)';\n                  if (indent) i.style.marginLeft = '16px';\n                  btn.appendChild(i);\n                }\n\n                const text = document.createElement('span');\n                text.textContent = label;\n                text.style.flex = '1';\n                btn.appendChild(text);\n\n                btn.classList.toggle('active', activeTab === key);\n                btn.addEventListener('click', () => setActive(key));\n                return btn;\n              };\n\n              navWrap.appendChild(makeHeader('Account'));\n              navWrap.appendChild(makeItem({ key: 'account', label: 'Account', icon: 'fa-regular fa-user' }));\n              navWrap.appendChild(\n                makeItem({ key: 'preferences', label: 'Preferences', icon: 'fa-solid fa-gear' })\n              );\n              navWrap.appendChild(makeHeader('Organization'));\n              navWrap.appendChild(\n                makeItem({ key: 'org-general', label: 'General', icon: 'fa-regular fa-building', indent: true })\n              );\n              navWrap.appendChild(\n                makeItem({ key: 'org-billing', label: 'Billing', icon: 'fa-regular fa-credit-card', indent: true })\n              );\n              leftPane.appendChild(navWrap);\n\n              // Right: header\n              const header = document.createElement('div');\n              header.className = 'row space-between';\n              header.style.padding = 'var(--space-5) var(--space-6)';\n              header.style.borderBottom = '1px solid var(--border-subtle)';\n              header.style.alignItems = 'flex-start';\n              const title = document.createElement('div');\n              title.style.fontSize = 'var(--text-2xl)';\n              title.style.fontWeight = 'var(--font-semibold)';\n              title.textContent =\n                activeTab === 'account'\n                  ? 'Account'\n                  : activeTab === 'preferences'\n                    ? 'Display Units'\n                    : 'Organization';\n              const closeBtn = document.createElement('button');\n              closeBtn.type = 'button';\n              closeBtn.className = 'btn btn-ghost';\n              closeBtn.innerHTML = '<i class=\"fa-solid fa-xmark\"></i>';\n              closeBtn.addEventListener('click', () => close());\n              header.appendChild(title);\n              header.appendChild(closeBtn);\n              rightPane.appendChild(header);\n\n              const body = document.createElement('div');\n              body.style.padding = 'var(--space-6)';\n              body.style.overflow = 'auto';\n              body.style.minWidth = '0';\n              rightPane.appendChild(body);\n\n              function row(label, valueEl) {\n                const wrap = document.createElement('div');\n                wrap.style.display = 'grid';\n                wrap.style.gridTemplateColumns = '220px 1fr';\n                wrap.style.gap = '16px';\n                wrap.style.alignItems = 'center';\n                wrap.style.padding = '16px 0';\n                wrap.style.borderBottom = '1px solid var(--border-subtle)';\n                const l = document.createElement('div');\n                l.style.fontWeight = 'var(--font-semibold)';\n                l.textContent = label;\n                wrap.appendChild(l);\n                wrap.appendChild(valueEl);\n                return wrap;\n              }\n\n              function savePrefsFromForm({ length, weight, theme, labelSize, hiddenOpacity }) {\n                const prev = PreferencesManager.get();\n                const next = Utils.deepClone(prev);\n                next.units.length = length;\n                next.units.weight = weight;\n                next.theme = theme;\n                next.labelFontSize = Utils.clamp(Number(labelSize) || 12, 8, 24);\n                next.hiddenCaseOpacity = Utils.clamp(Number(hiddenOpacity) || 0.3, 0, 1);\n                PreferencesManager.set(next);\n                PreferencesManager.applyTheme(next.theme);\n                UIComponents.showToast('Preferences saved', 'success');\n              }\n\n              if (activeTab === 'account') {\n                const nameRow = document.createElement('div');\n                nameRow.className = 'row';\n                nameRow.style.gap = '12px';\n                nameRow.innerHTML = `<span class=\"brand-mark\" aria-hidden=\"true\" style=\"width:40px;height:40px;border-radius:14px\"></span><div style=\"font-weight:var(--font-semibold)\">${\n                  session.user?.name || '—'\n                }</div>`;\n                body.appendChild(nameRow);\n\n                const emailEl = document.createElement('div');\n                emailEl.textContent = session.user?.email || '—';\n                body.appendChild(row('Email', emailEl));\n\n                const danger = document.createElement('div');\n                danger.style.marginTop = '26px';\n                danger.innerHTML = `\n                  <div style=\"font-size:var(--text-xl);font-weight:var(--font-semibold);margin-bottom:10px\">Danger Zone</div>\n                  <div style=\"border-top:1px solid var(--border-subtle)\"></div>\n                `;\n                const dangerRow = document.createElement('div');\n                dangerRow.style.display = 'grid';\n                dangerRow.style.gridTemplateColumns = '220px 1fr';\n                dangerRow.style.gap = '16px';\n                dangerRow.style.alignItems = 'center';\n                dangerRow.style.padding = '16px 0';\n                const dLeft = document.createElement('div');\n                dLeft.style.color = 'var(--error)';\n                dLeft.style.fontWeight = 'var(--font-semibold)';\n                dLeft.textContent = 'Delete Account';\n                const dRight = document.createElement('div');\n                dRight.className = 'muted';\n                dRight.textContent = 'Contact support to delete your account. help@backlinelogic.com';\n                dangerRow.appendChild(dLeft);\n                dangerRow.appendChild(dRight);\n                danger.appendChild(dangerRow);\n                body.appendChild(danger);\n              } else if (activeTab === 'preferences') {\n                const length = document.createElement('select');\n                length.className = 'select';\n                length.innerHTML = `\n                  <option value=\"in\">Inches (in)</option>\n                  <option value=\"ft\">Feet (ft)</option>\n                  <option value=\"mm\">Millimeters (mm)</option>\n                  <option value=\"cm\">Centimeters (cm)</option>\n                  <option value=\"m\">Meters (m)</option>\n                `;\n                length.value = prefs.units.length;\n\n                const weight = document.createElement('select');\n                weight.className = 'select';\n                weight.innerHTML = `\n                  <option value=\"lb\">Pounds (lb)</option>\n                  <option value=\"kg\">Kilograms (kg)</option>\n                `;\n                weight.value = prefs.units.weight;\n\n                const hiddenOpacity = document.createElement('input');\n                hiddenOpacity.className = 'input';\n                hiddenOpacity.type = 'number';\n                hiddenOpacity.min = '0';\n                hiddenOpacity.max = '1';\n                hiddenOpacity.step = '0.05';\n                hiddenOpacity.value = String(prefs.hiddenCaseOpacity);\n\n                const labelSize = document.createElement('input');\n                labelSize.className = 'input';\n                labelSize.type = 'number';\n                labelSize.min = '8';\n                labelSize.max = '24';\n                labelSize.step = '1';\n                labelSize.value = String(prefs.labelFontSize);\n\n                const theme = document.createElement('select');\n                theme.className = 'select';\n                theme.innerHTML = `\n                  <option value=\"light\">Light</option>\n                  <option value=\"dark\">Dark</option>\n                `;\n                theme.value = prefs.theme;\n\n                body.appendChild(row('Length', length));\n                body.appendChild(row('Weight', weight));\n                body.appendChild(row('Hidden Case Opacity', hiddenOpacity));\n                body.appendChild(row('Label Font Size', labelSize));\n                body.appendChild(row('Theme', theme));\n\n                const actions = document.createElement('div');\n                actions.className = 'row';\n                actions.style.justifyContent = 'flex-end';\n                actions.style.marginTop = '18px';\n                const saveBtn = document.createElement('button');\n                saveBtn.type = 'button';\n                saveBtn.className = 'btn btn-primary';\n                saveBtn.textContent = 'Save changes';\n                saveBtn.addEventListener('click', () =>\n                  savePrefsFromForm({\n                    length: length.value,\n                    weight: weight.value,\n                    theme: theme.value,\n                    labelSize: labelSize.value,\n                    hiddenOpacity: hiddenOpacity.value,\n                  })\n                );\n                actions.appendChild(saveBtn);\n                body.appendChild(actions);\n              } else if (activeTab === 'org-general') {\n                const orgName = session.currentAccount?.name || 'Personal Account';\n                const orgRole = session.currentAccount?.role || 'Owner';\n                const slug = (session.user?.email || 'personal').replace(/[^a-z0-9]+/gi, '-').toLowerCase();\n\n                const orgCard = document.createElement('div');\n                orgCard.className = 'card';\n                orgCard.style.maxWidth = '820px';\n                orgCard.innerHTML = `\n                  <div style=\"display:grid;gap:18px\">\n                    <div style=\"font-size:var(--text-xl);font-weight:var(--font-semibold)\">Organization</div>\n                    <div style=\"border-top:1px solid var(--border-subtle)\"></div>\n                    <div style=\"display:grid;gap:0\">\n                      <div style=\"display:grid;grid-template-columns:220px 1fr;gap:16px;align-items:center;padding:16px 0;border-bottom:1px solid var(--border-subtle)\">\n                        <div style=\"font-weight:var(--font-semibold)\">Logo</div>\n                        <div><span class=\"brand-mark\" aria-hidden=\"true\" style=\"width:64px;height:64px;border-radius:18px;display:inline-block\"></span></div>\n                      </div>\n                      <div style=\"display:grid;grid-template-columns:220px 1fr;gap:16px;align-items:center;padding:16px 0;border-bottom:1px solid var(--border-subtle)\">\n                        <div style=\"font-weight:var(--font-semibold)\">Name</div>\n                        <div>${orgName}</div>\n                      </div>\n                      <div style=\"display:grid;grid-template-columns:220px 1fr;gap:16px;align-items:center;padding:16px 0;border-bottom:1px solid var(--border-subtle)\">\n                        <div style=\"font-weight:var(--font-semibold)\">Role</div>\n                        <div>${orgRole}</div>\n                      </div>\n                      <div style=\"display:grid;grid-template-columns:220px 1fr;gap:16px;align-items:center;padding:16px 0;border-bottom:1px solid var(--border-subtle)\">\n                        <div style=\"font-weight:var(--font-semibold)\">Slug</div>\n                        <div class=\"muted\" style=\"font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace\">${slug}</div>\n                      </div>\n                    </div>\n                  </div>\n                `;\n                body.appendChild(orgCard);\n              } else {\n                const billingCard = document.createElement('div');\n                billingCard.className = 'card';\n                billingCard.style.maxWidth = '820px';\n                billingCard.innerHTML = `\n                  <div style=\"display:grid;gap:12px\">\n                    <div style=\"font-size:var(--text-xl);font-weight:var(--font-semibold)\">Billing</div>\n                    <div class=\"muted\" style=\"font-size:var(--text-sm);line-height:var(--leading-relaxed)\">\n                      Coming soon. Billing and invoices will appear here when subscription management is enabled.\n                    </div>\n                  </div>\n                `;\n                body.appendChild(billingCard);\n\n                const subCard = document.createElement('div');\n                subCard.className = 'card';\n                subCard.style.maxWidth = '820px';\n                subCard.style.marginTop = '16px';\n                subCard.innerHTML = `\n                  <div style=\"display:grid;gap:18px\">\n                    <div style=\"font-size:var(--text-xl);font-weight:var(--font-semibold)\">Subscription</div>\n                    <div style=\"border-top:1px solid var(--border-subtle)\"></div>\n                    <div style=\"border:1px solid var(--border-subtle);border-radius:var(--radius-md);padding:var(--space-4);background:linear-gradient(180deg,var(--bg-elevated),var(--bg-secondary))\">\n                      <div class=\"row space-between\" style=\"align-items:flex-start;gap:12px\">\n                        <div>\n                          <div style=\"font-size:var(--text-xl);font-weight:var(--font-bold)\">Free Trial <span class=\"muted\" style=\"font-weight:var(--font-medium)\">| Current Plan</span></div>\n                          <div class=\"muted\" style=\"margin-top:8px;font-size:var(--text-sm)\">Subscribe to keep using Truck Packer after your free trial ends, cancel anytime.</div>\n                        </div>\n                        <div class=\"muted\" style=\"font-weight:var(--font-semibold)\">7 days left</div>\n                      </div>\n                      <div style=\"height:14px\"></div>\n                      <div class=\"row space-between\" style=\"gap:12px;background:rgba(59,130,246,0.08);border-radius:var(--radius-md);padding:var(--space-4)\">\n                        <div>\n                          <div style=\"font-weight:var(--font-semibold)\"><i class=\"fa-solid fa-bolt\" style=\"color:var(--accent-primary)\"></i> Truck Packer Pro</div>\n                          <div class=\"muted\" style=\"font-size:var(--text-sm);margin-top:4px\">Unlock Pro features (coming soon).</div>\n                        </div>\n                        <button class=\"btn btn-primary\" type=\"button\" data-subscribe-btn>Subscribe</button>\n                      </div>\n                    </div>\n                  </div>\n                `;\n                body.appendChild(subCard);\n                const subscribeBtn = subCard.querySelector('[data-subscribe-btn]');\n                if (subscribeBtn) {\n                  subscribeBtn.addEventListener('click', () => UIComponents.showToast('Coming soon', 'info'));\n                }\n              }\n            }\n\n            return { open, close, isOpen, setActive };\n          })();\n\n          const AccountSwitcher = (() => {\n            const mounts = new Map();\n\n            function getDisplay() {\n              const s = SessionManager.get();\n              const account = s.currentAccount || {};\n              const user = s.user || {};\n              return {\n                accountName: account.name || 'Personal Account',\n                role: account.role || 'Owner',\n                userName: user.name || '—',\n              };\n            }\n\n            function renderButton(buttonEl) {\n              if (!buttonEl) return;\n              const display = getDisplay();\n              const nameEl = buttonEl.querySelector('[data-account-name]');\n              if (nameEl) nameEl.textContent = display.userName;\n            }\n\n            function showComingSoon() {\n              UIComponents.showToast('Coming soon', 'info');\n            }\n\n            function logout() {\n              try {\n                UIComponents.closeAllDropdowns();\n                SettingsOverlay.close();\n              } catch {\n                // ignore\n              }\n\n              SessionManager.clear();\n              StateStore.set({ currentScreen: 'packs' }, { skipHistory: true });\n              UIComponents.showToast('Logged out', 'info');\n            }\n\n            function openMenu(anchorEl, { align } = {}) {\n              const display = getDisplay();\n              const items = [\n                {\n                  label: `${display.accountName} (${display.role})`,\n                  icon: 'fa-regular fa-user',\n                  rightIcon: 'fa-solid fa-check',\n                  disabled: true,\n                },\n                {\n                  label: 'Create Organization',\n                  icon: 'fa-solid fa-plus',\n                  onClick: () => showComingSoon(),\n                },\n                { type: 'divider' },\n                {\n                  label: 'Settings',\n                  icon: 'fa-solid fa-gear',\n                  onClick: () => SettingsOverlay.open('preferences'),\n                },\n                {\n                  label: 'Log out',\n                  icon: 'fa-solid fa-right-from-bracket',\n                  onClick: () => logout(),\n                },\n              ];\n\n              const rect = anchorEl.getBoundingClientRect();\n              UIComponents.openDropdown(anchorEl, items, { align: align || 'left', width: rect.width });\n            }\n\n            function bind(buttonEl, { align } = {}) {\n              if (!buttonEl) return () => {};\n              if (mounts.has(buttonEl)) return mounts.get(buttonEl);\n\n              renderButton(buttonEl);\n              const onClick = ev => {\n                ev.stopPropagation();\n                openMenu(buttonEl, { align });\n              };\n              buttonEl.addEventListener('click', onClick);\n              const unsub = SessionManager.subscribe(() => renderButton(buttonEl));\n\n              const unmount = () => {\n                try {\n                  unsub && unsub();\n                } catch {\n                  // ignore\n                }\n                buttonEl.removeEventListener('click', onClick);\n                mounts.delete(buttonEl);\n              };\n              mounts.set(buttonEl, unmount);\n              return unmount;\n            }\n\n            function init() {\n              const sidebarBtn = document.getElementById('btn-account-switcher');\n              bind(sidebarBtn, { align: 'left' });\n            }\n\n            return { init, bind };\n          })();\n\n          const CategoryService = (() => {\n            const normalize = key =>\n              String(key || '')\n                .trim()\n                .toLowerCase();\n\n            function hashHue(str) {\n              let h = 0;\n              const s = String(str || '');\n              for (let i = 0; i < s.length; i++) h = (h * 31 + s.charCodeAt(i)) % 360;\n              return h;\n            }\n\n            function colorFor(key, fallback) {\n              if (fallback) return fallback;\n              const hue = hashHue(key);\n              return `hsl(${hue}, 72%, 56%)`;\n            }\n\n            function all() {\n              const prefs = PreferencesManager.get();\n              const prefCats = Array.isArray(prefs && prefs.categories) ? prefs.categories : [];\n              const seeded = prefCats.length\n                ? prefCats\n                : (Defaults.categories || [])\n                    .filter(c => c.key !== 'all')\n                    .map(c => ({ key: c.key, name: c.name, color: c.color }));\n              const dedup = new Map();\n              seeded.forEach(c => {\n                const k = normalize(c.key || c.name);\n                if (!k) return;\n                dedup.set(k, {\n                  key: k,\n                  name: c.name || k.charAt(0).toUpperCase() + k.slice(1),\n                  color: c.color || colorFor(k),\n                });\n              });\n              return Array.from(dedup.values());\n            }\n\n            function save(list) {\n              const prefs = PreferencesManager.get() || {};\n              PreferencesManager.set({ ...prefs, categories: list });\n            }\n\n            function meta(key) {\n              const k = normalize(key);\n              const found = all().find(c => c.key === k);\n              if (found) return found;\n              return { key: k, name: k ? k.charAt(0).toUpperCase() + k.slice(1) : 'Uncategorized', color: colorFor(k) };\n            }\n\n            function listWithCounts(cases) {\n              const counts = {};\n              (cases || []).forEach(c => {\n                const k = normalize(c.category || 'default');\n                counts[k] = (counts[k] || 0) + 1;\n              });\n              const known = all();\n              const ordered = known\n                .map(c => c.key)\n                .filter(k => k)\n                .concat(Object.keys(counts).filter(k => !known.find(c => c.key === k)));\n              return ordered\n                .filter((k, idx, arr) => arr.indexOf(k) === idx)\n                .map(k => ({ ...meta(k), count: counts[k] || 0 }));\n            }\n\n            function upsert({ key, name, color }) {\n              const k = normalize(key || name);\n              if (!k) return meta('default');\n              const list = all();\n              const next = { key: k, name: name || meta(k).name, color: color || meta(k).color };\n              const idx = list.findIndex(c => c.key === k);\n              if (idx > -1) list[idx] = next;\n              else list.push(next);\n              save(list);\n              return next;\n            }\n\n            function remove(key) {\n              const k = normalize(key);\n              if (!k || k === 'default') return; // never remove default\n              const list = all().filter(c => c.key !== k);\n              save(list);\n              CaseLibrary.reassignCategory(k, 'default');\n            }\n\n            function rename(oldKey, name, color) {\n              const from = normalize(oldKey);\n              const to = normalize(name || oldKey);\n              if (!from) return meta('default');\n              const list = all().filter(c => c.key !== from);\n              const next = { key: to, name: name || meta(to).name, color: color || meta(to).color };\n              list.push(next);\n              save(list);\n              if (from !== to) CaseLibrary.reassignCategory(from, to);\n              return next;\n            }\n\n            return { meta, listWithCounts, upsert, remove, rename, all };\n          })();\n\n          const CaseLibrary = (() => {\n            function getCases() {\n              return StateStore.get('caseLibrary') || [];\n            }\n\n            function getById(caseId) {\n              return getCases().find(c => c.id === caseId) || null;\n            }\n\n            function upsert(caseData) {\n              const now = Date.now();\n              const cases = getCases();\n              const idx = cases.findIndex(c => c.id === caseData.id);\n              const next = { ...caseData };\n              next.updatedAt = now;\n              if (!next.createdAt) next.createdAt = now;\n              next.dimensions = {\n                length: Number(next.dimensions.length) || 0,\n                width: Number(next.dimensions.width) || 0,\n                height: Number(next.dimensions.height) || 0,\n              };\n              next.weight = Number(next.weight) || 0;\n              next.volume = Utils.volumeInCubicInches(next.dimensions);\n\n              const nextCases = idx > -1 ? cases.map((c, i) => (i === idx ? next : c)) : [...cases, next];\n\n              StateStore.set({ caseLibrary: nextCases });\n            }\n\n            function reassignCategory(oldKey, newKey) {\n              const from = oldKey ? oldKey.trim().toLowerCase() : '';\n              const to = newKey ? newKey.trim().toLowerCase() : 'default';\n              if (!from || from === to) return;\n              const next = getCases().map(c => (c.category === from ? { ...c, category: to } : c));\n              StateStore.set({ caseLibrary: next });\n            }\n\n            function remove(caseId) {\n              const cases = getCases().filter(c => c.id !== caseId);\n              StateStore.set({ caseLibrary: cases });\n            }\n\n            function duplicate(caseId) {\n              const original = getById(caseId);\n              if (!original) return null;\n              const now = Date.now();\n              const copy = {\n                ...Utils.deepClone(original),\n                id: Utils.uuid(),\n                name: original.name + ' (Copy)',\n                createdAt: now,\n                updatedAt: now,\n              };\n              upsert(copy);\n              return copy;\n            }\n\n            function search(query, categoryKeys) {\n              const q = String(query || '')\n                .trim()\n                .toLowerCase();\n              const cats = (categoryKeys || []).filter(k => k && k !== 'all');\n              return getCases().filter(c => {\n                const matchesQ =\n                  !q || (c.name || '').toLowerCase().includes(q) || (c.manufacturer || '').toLowerCase().includes(q);\n                const matchesCat = !cats.length || cats.includes(c.category);\n                return matchesQ && matchesCat;\n              });\n            }\n\n            function countsByCategory() {\n              const counts = {};\n              getCases().forEach(c => {\n                counts[c.category] = (counts[c.category] || 0) + 1;\n              });\n              return counts;\n            }\n\n            return {\n              getCases,\n              getById,\n              upsert,\n              remove,\n              duplicate,\n              search,\n              countsByCategory,\n              reassignCategory,\n            };\n          })();\n\n          const PackLibrary = (() => {\n            function getPacks() {\n              return StateStore.get('packLibrary') || [];\n            }\n\n            function getById(packId) {\n              return getPacks().find(p => p.id === packId) || null;\n            }\n\n            function create(packData) {\n              const now = Date.now();\n              const pack = {\n                id: Utils.uuid(),\n                title: packData.title || 'Untitled Pack',\n                client: packData.client || '',\n                projectName: packData.projectName || '',\n                drawnBy: packData.drawnBy || '',\n                notes: packData.notes || '',\n                truck: packData.truck || { length: 636, width: 102, height: 98 },\n                cases: [],\n                groups: [],\n                stats: { totalCases: 0, packedCases: 0, volumeUsed: 0, totalWeight: 0 },\n                createdAt: now,\n                lastEdited: now,\n                thumbnail: null,\n                thumbnailUpdatedAt: null,\n                thumbnailSource: null,\n              };\n              StateStore.set({ packLibrary: [...getPacks(), pack] });\n              return pack;\n            }\n\n            function update(packId, patch) {\n              const packs = getPacks();\n              const idx = packs.findIndex(p => p.id === packId);\n              if (idx === -1) return null;\n              const now = Date.now();\n              const cloned = Utils.deepClone(patch);\n              const prev = packs[idx];\n              const next = { ...prev, ...cloned };\n\n              const lastEditedKeys = ['title', 'client', 'projectName', 'drawnBy', 'notes', 'truck', 'cases', 'groups'];\n              const hasLastEditedKey = Object.keys(cloned || {}).some(k => lastEditedKeys.includes(k));\n              next.lastEdited = hasLastEditedKey ? now : prev.lastEdited || now;\n              next.stats = computeStats(next);\n              const nextPacks = packs.map((p, i) => (i === idx ? next : p));\n              StateStore.set({ packLibrary: nextPacks });\n              return next;\n            }\n\n            function remove(packId) {\n              const packs = getPacks().filter(p => p.id !== packId);\n              const current = StateStore.get('currentPackId');\n              StateStore.set(\n                { packLibrary: packs, currentPackId: current === packId ? null : current, selectedInstanceIds: [] },\n                { skipHistory: true }\n              );\n            }\n\n            function duplicate(packId) {\n              const pack = getById(packId);\n              if (!pack) return null;\n              const now = Date.now();\n              const copy = Utils.deepClone(pack);\n              copy.id = Utils.uuid();\n              copy.title = pack.title + ' (Copy)';\n              copy.createdAt = now;\n              copy.lastEdited = now;\n              copy.thumbnail = null;\n              copy.thumbnailUpdatedAt = null;\n              copy.thumbnailSource = null;\n              // New instance ids\n              copy.cases = (copy.cases || []).map(i => ({ ...i, id: Utils.uuid() }));\n              StateStore.set({ packLibrary: [...getPacks(), copy] });\n              return copy;\n            }\n\n            function open(packId) {\n              const pack = getById(packId);\n              if (!pack) return null;\n              StateStore.set({ currentPackId: packId, selectedInstanceIds: [] }, { skipHistory: true });\n              return pack;\n            }\n\n            function addInstance(packId, caseId, position) {\n              const pack = getById(packId);\n              if (!pack) return null;\n              const caseData = CaseLibrary.getById(caseId);\n              if (!caseData) return null;\n              const instance = {\n                id: Utils.uuid(),\n                caseId,\n                transform: {\n                  position: position || { x: -80, y: Math.max(1, caseData.dimensions.height / 2), z: 0 },\n                  rotation: { x: 0, y: 0, z: 0 },\n                  scale: { x: 1, y: 1, z: 1 },\n                },\n                hidden: false,\n                groupId: null,\n              };\n              const nextCases = [...(pack.cases || []), instance];\n              update(packId, { cases: nextCases });\n              return instance;\n            }\n\n            function updateInstance(packId, instanceId, patch) {\n              const pack = getById(packId);\n              if (!pack) return null;\n              const nextInstances = (pack.cases || []).map(i =>\n                i.id === instanceId ? { ...i, ...Utils.deepClone(patch) } : i\n              );\n              return update(packId, { cases: nextInstances });\n            }\n\n            function removeInstances(packId, instanceIds) {\n              const pack = getById(packId);\n              if (!pack) return null;\n              const idSet = new Set(instanceIds || []);\n              const nextInstances = (pack.cases || []).filter(i => !idSet.has(i.id));\n              return update(packId, { cases: nextInstances });\n            }\n\n            function computeStats(pack, caseLibraryOverride) {\n              const truckVol = pack.truck.length * pack.truck.width * pack.truck.height;\n              let usedIn3 = 0;\n              let totalWeight = 0;\n              let packedCases = 0;\n              const getCase = caseId => {\n                if (Array.isArray(caseLibraryOverride)) return caseLibraryOverride.find(c => c.id === caseId) || null;\n                return CaseLibrary.getById(caseId);\n              };\n              (pack.cases || []).forEach(inst => {\n                const c = getCase(inst.caseId);\n                if (!c) return;\n                if (inst.hidden) return;\n                const dims = c.dimensions || { length: 0, width: 0, height: 0 };\n                const pos = inst.transform && inst.transform.position ? inst.transform.position : { x: 0, y: 0, z: 0 };\n                const half = { x: dims.length / 2, y: dims.height / 2, z: dims.width / 2 };\n                const aabb = {\n                  min: { x: pos.x - half.x, y: pos.y - half.y, z: pos.z - half.z },\n                  max: { x: pos.x + half.x, y: pos.y + half.y, z: pos.z + half.z },\n                };\n                const insideTruck =\n                  aabb.min.x >= 0 &&\n                  aabb.max.x <= pack.truck.length &&\n                  aabb.min.y >= 0 &&\n                  aabb.max.y <= pack.truck.height &&\n                  aabb.min.z >= -pack.truck.width / 2 &&\n                  aabb.max.z <= pack.truck.width / 2;\n                if (!insideTruck) return;\n                packedCases++;\n                usedIn3 += c.volume || Utils.volumeInCubicInches(dims);\n                totalWeight += Number(c.weight) || 0;\n              });\n              const volumePercent = truckVol > 0 ? (usedIn3 / truckVol) * 100 : 0;\n              return {\n                totalCases: (pack.cases || []).length,\n                packedCases,\n                volumeUsed: usedIn3,\n                volumePercent,\n                totalWeight,\n              };\n            }\n\n            return {\n              getPacks,\n              getById,\n              create,\n              update,\n              remove,\n              duplicate,\n              open,\n              addInstance,\n              updateInstance,\n              removeInstances,\n              computeStats,\n            };\n          })();\n\n          const Data = (() => {\n            const updates = [\n              {\n                version: '1.0.0',\n                date: '2026-01-15',\n                features: [\n                  'Multi-screen workspace (Packs, Cases, Editor, Updates, Roadmap, Settings)',\n                  'Three.js 3D editor with drag placement',\n                  'CSV/XLSX import, PNG + PDF export',\n                ],\n                bugFixes: [],\n                breakingChanges: [],\n              },\n              {\n                version: '1.1.0',\n                date: '2026-03-01',\n                features: ['(Example) Weight balance view', '(Example) Case rotation'],\n                bugFixes: ['(Example) Improved collision edge cases'],\n                breakingChanges: [],\n              },\n            ];\n\n            const roadmap = [\n              {\n                quarter: 'Q1 2026',\n                items: [\n                  {\n                    title: 'Weight balance',\n                    status: 'Completed',\n                    badge: '✓',\n                    color: 'var(--success)',\n                    details: 'Add center-of-gravity and axle load estimates.',\n                  },\n                  {\n                    title: 'Rotation (MVP)',\n                    status: 'In Progress',\n                    badge: '⏱',\n                    color: 'var(--warning)',\n                    details: 'Allow 90° rotations and pack-time heuristics.',\n                  },\n                ],\n              },\n              {\n                quarter: 'Q2 2026',\n                items: [\n                  {\n                    title: 'Multi-user',\n                    status: 'Planned',\n                    badge: '📋',\n                    color: 'var(--info)',\n                    details: 'Presence + change tracking (no real-time yet).',\n                  },\n                  {\n                    title: '3D export',\n                    status: 'Planned',\n                    badge: '📋',\n                    color: 'var(--info)',\n                    details: 'GLB/GLTF export for downstream tools.',\n                  },\n                ],\n              },\n              {\n                quarter: 'Future',\n                items: [\n                  {\n                    title: 'AR view',\n                    status: 'Idea',\n                    badge: '💡',\n                    color: 'var(--text-muted)',\n                    details: 'Preview a load-out in real space on mobile.',\n                  },\n                ],\n              },\n            ];\n\n            return { updates, roadmap };\n          })();\n\n          const AppShell = (() => {\n            const appRoot = document.getElementById('app');\n            const sidebar = document.getElementById('sidebar');\n            const btnSidebar = document.getElementById('btn-sidebar');\n            const topbarTitle = document.getElementById('topbar-title');\n            const topbarSubtitle = document.getElementById('topbar-subtitle');\n            const contentRoot = document.querySelector('.content');\n            const navButtons = Array.from(document.querySelectorAll('[data-nav]'));\n\n            const screenTitles = {\n              packs: { title: 'Packs', subtitle: 'Project library' },\n              cases: { title: 'Cases', subtitle: 'Inventory management' },\n              editor: { title: 'Editor', subtitle: '3D workspace' },\n              updates: { title: 'Updates', subtitle: 'Release notes' },\n              roadmap: { title: 'Roadmap', subtitle: 'Product direction' },\n              settings: { title: 'Settings', subtitle: 'Preferences' },\n            };\n\n            function toggleSidebar() {\n              const isMobile = window.matchMedia('(max-width: 899px)').matches;\n              if (isMobile) {\n                sidebar.classList.toggle('open');\n              } else {\n                appRoot.classList.toggle('sidebar-collapsed');\n              }\n            }\n\n            function init() {\n              btnSidebar.addEventListener('click', toggleSidebar);\n              navButtons.forEach(btn => {\n                btn.addEventListener('click', () => {\n                  const target = btn.getAttribute('data-nav');\n                  navigate(target);\n                  if (window.matchMedia('(max-width: 899px)').matches) {\n                    sidebar.classList.remove('open');\n                  }\n                });\n              });\n\n              window.addEventListener('resize', () => {\n                if (!window.matchMedia('(max-width: 899px)').matches) {\n                  sidebar.classList.remove('open');\n                }\n              });\n            }\n\n            function navigate(screenKey) {\n              StateStore.set({ currentScreen: screenKey }, { skipHistory: true });\n            }\n\n            function renderShell() {\n              const screen = StateStore.get('currentScreen');\n              navButtons.forEach(btn => btn.classList.toggle('active', btn.getAttribute('data-nav') === screen));\n              document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));\n              const el = document.getElementById(`screen-${screen}`);\n              if (el) el.classList.add('active');\n              if (contentRoot) contentRoot.classList.toggle('editor-mode', screen === 'editor');\n\n              if (screen === 'editor') {\n                const pack = PackLibrary.getById(StateStore.get('currentPackId'));\n                topbarTitle.textContent = pack ? pack.title || 'Editor' : 'Editor';\n                topbarSubtitle.textContent = pack\n                  ? `Edited ${Utils.formatRelativeTime(pack.lastEdited)}`\n                  : '3D workspace';\n                return;\n              }\n\n              const meta = screenTitles[screen] || { title: 'Truck Packer 3D', subtitle: '' };\n              topbarTitle.textContent = meta.title;\n              topbarSubtitle.textContent = meta.subtitle;\n            }\n\n            return { init, navigate, renderShell };\n          })();\n\n          // ==== UI: Packs Screen ====\n          const PacksUI = (() => {\n            const searchEl = document.getElementById('packs-search');\n            const sortEl = document.getElementById('packs-sort');\n            const gridEl = document.getElementById('packs-grid');\n            const emptyEl = document.getElementById('packs-empty');\n            const filterEmptyEl = document.getElementById('packs-filter-empty');\n            const filterEmptyMsg = document.getElementById('packs-filter-empty-msg');\n            const btnNew = document.getElementById('btn-new-pack');\n            const btnImport = document.getElementById('btn-import-pack');\n            const chipEmpty = document.getElementById('packs-filter-chip-empty');\n            const chipPartial = document.getElementById('packs-filter-chip-partial');\n            const chipFull = document.getElementById('packs-filter-chip-full');\n\n            const filters = { empty: false, partial: false, full: false };\n\n            function init() {\n              searchEl.addEventListener('input', Utils.debounce(render, 200));\n              searchEl.addEventListener('keydown', ev => {\n                if (ev.key === 'Escape') {\n                  searchEl.value = '';\n                  render();\n                  searchEl.blur();\n                }\n              });\n              sortEl.addEventListener('change', () => render());\n              wireChip(chipEmpty, 'empty');\n              wireChip(chipPartial, 'partial');\n              wireChip(chipFull, 'full');\n              btnNew.addEventListener('click', () => openNewPackModal());\n              btnImport.addEventListener('click', () => openImportPackDialog());\n            }\n\n            function wireChip(el, key) {\n              if (!el) return;\n              const toggle = () => {\n                filters[key] = !filters[key];\n                el.classList.toggle('active', filters[key]);\n                render();\n              };\n              el.addEventListener('click', toggle);\n              el.addEventListener('keydown', ev => {\n                if (ev.key === 'Enter' || ev.key === ' ') toggle();\n              });\n            }\n\n            function render() {\n              const q = String(searchEl.value || '')\n                .trim()\n                .toLowerCase();\n              const allPacks = PackLibrary.getPacks().slice();\n\n              const sortKey = String(sortEl.value || 'edited-desc');\n              const compareTitle = (a, b) => (a.title || '').localeCompare(b.title || '');\n              const compareLastEdited = (a, b) => (a.lastEdited || 0) - (b.lastEdited || 0);\n              const compareCreated = (a, b) => (a.createdAt || 0) - (b.createdAt || 0);\n              const sorters = {\n                'edited-desc': (a, b) => compareLastEdited(b, a),\n                'edited-asc': (a, b) => compareLastEdited(a, b),\n                'title-asc': (a, b) => compareTitle(a, b),\n                'title-desc': (a, b) => compareTitle(b, a),\n                'created-desc': (a, b) => compareCreated(b, a),\n                'created-asc': (a, b) => compareCreated(a, b),\n              };\n              allPacks.sort(sorters[sortKey] || sorters['edited-desc']);\n\n              const packs = allPacks\n                .filter(p => !q || (p.title || '').toLowerCase().includes(q) || (p.client || '').toLowerCase().includes(q))\n                .filter(p => {\n                  if (!filters.empty && !filters.partial && !filters.full) return true;\n                  const total = (p.cases || []).length;\n                  const percent = p.stats && Number.isFinite(p.stats.volumePercent) ? p.stats.volumePercent : 0;\n                  const isEmpty = total === 0;\n                  const isFull = percent >= 99.999;\n                  const isPartial = !isEmpty && percent > 0 && !isFull;\n\n                  if (filters.empty && isEmpty) return true;\n                  if (filters.partial && isPartial) return true;\n                  if (filters.full && isFull) return true;\n                  return false;\n                });\n\n              gridEl.innerHTML = '';\n\n              if (!allPacks.length) {\n                emptyEl.style.display = 'block';\n                filterEmptyEl.style.display = 'none';\n                return;\n              }\n\n              if (!packs.length) {\n                emptyEl.style.display = 'none';\n                filterEmptyMsg.textContent = q ? `No matching packs for \"${q}\"` : 'No matching packs';\n                filterEmptyEl.style.display = 'block';\n                return;\n              }\n\n              filterEmptyEl.style.display = 'none';\n              emptyEl.style.display = 'none';\n\n              packs.forEach(pack => {\n                const card = document.createElement('div');\n                card.className = 'card pack-card';\n                card.tabIndex = 0;\n                card.addEventListener('click', ev => {\n                  if (ev.target && ev.target.closest && ev.target.closest('[data-pack-menu]')) return;\n                  openPack(pack.id);\n                });\n                card.addEventListener('keydown', ev => {\n                  if (ev.key === 'Enter') openPack(pack.id);\n                });\n\n                const preview = buildPreview(pack);\n\n                const title = document.createElement('h3');\n                title.textContent = pack.title || 'Untitled Pack';\n\n                const sub = document.createElement('div');\n                sub.className = 'muted';\n                sub.style.fontSize = 'var(--text-sm)';\n                sub.textContent = pack.client\n                  ? `${pack.client} • edited ${Utils.formatRelativeTime(pack.lastEdited)}`\n                  : `edited ${Utils.formatRelativeTime(pack.lastEdited)}`;\n\n                const meta = document.createElement('div');\n                meta.className = 'pack-meta';\n\n                const badgesWrap = document.createElement('div');\n                badgesWrap.className = 'pack-meta-badges';\n\n                const count = document.createElement('div');\n                count.className = 'badge';\n                count.textContent = `${(pack.cases || []).length} case(s)`;\n\n                const truck = document.createElement('div');\n                truck.className = 'badge';\n                truck.textContent = `Truck ${pack.truck.length}\"×${pack.truck.width}\"×${pack.truck.height}\"`;\n\n                badgesWrap.appendChild(count);\n                badgesWrap.appendChild(truck);\n\n                const kebabWrap = document.createElement('div');\n                kebabWrap.className = 'kebab';\n                kebabWrap.setAttribute('data-pack-menu', '1');\n                const kebabBtn = document.createElement('button');\n                kebabBtn.className = 'btn btn-ghost';\n                kebabBtn.type = 'button';\n                kebabBtn.innerHTML = '<i class=\"fa-solid fa-ellipsis-vertical\"></i>';\n                kebabBtn.addEventListener('click', ev => {\n                  ev.stopPropagation();\n                  UIComponents.openDropdown(kebabBtn, [\n                    { label: 'Open', icon: 'fa-solid fa-folder-open', onClick: () => openPack(pack.id) },\n                    { label: 'Rename', icon: 'fa-solid fa-pen', onClick: () => openRename(pack.id) },\n                    {\n                      label: 'Duplicate',\n                      icon: 'fa-solid fa-clone',\n                      onClick: () => {\n                        PackLibrary.duplicate(pack.id);\n                        UIComponents.showToast('Pack duplicated', 'success');\n                      },\n                    },\n                    {\n                      label: 'Capture Preview',\n                      icon: 'fa-solid fa-image',\n                      onClick: () => ExportService.capturePackPreview(pack.id, { source: 'manual' }),\n                    },\n                    {\n                      label: 'Clear Preview',\n                      icon: 'fa-solid fa-ban',\n                      disabled: !pack.thumbnail,\n                      onClick: () => ExportService.clearPackPreview(pack.id),\n                    },\n                    { label: 'Export JSON', icon: 'fa-solid fa-file-export', onClick: () => exportPack(pack.id) },\n                    { label: 'Delete', icon: 'fa-solid fa-trash', variant: 'danger', dividerBefore: true, onClick: () => deletePack(pack.id) },\n                  ]);\n                });\n                kebabWrap.appendChild(kebabBtn);\n\n                meta.appendChild(badgesWrap);\n                meta.appendChild(kebabWrap);\n\n                card.appendChild(preview);\n                card.appendChild(title);\n                card.appendChild(sub);\n                card.appendChild(meta);\n                gridEl.appendChild(card);\n              });\n            }\n\n            function buildPreview(pack) {\n              const preview = document.createElement('div');\n              if (pack && typeof pack.thumbnail === 'string' && pack.thumbnail) {\n                preview.className = 'pack-preview has-thumb';\n                const img = document.createElement('img');\n                img.loading = 'lazy';\n                img.alt = `${pack.title || 'Pack'} preview`;\n                img.src = pack.thumbnail;\n                preview.appendChild(img);\n                return preview;\n              }\n              const items = (pack.cases || []).slice(0, 12);\n\n              if (!items.length) {\n                preview.className = 'pack-preview empty';\n                preview.textContent = 'No items yet';\n                return preview;\n              }\n\n              preview.className = 'pack-preview';\n              items.forEach(inst => {\n                const cell = document.createElement('div');\n                cell.className = 'pack-preview-cell';\n                const meta = CaseLibrary.getById(inst.caseId);\n                if (meta && meta.color) cell.style.background = meta.color;\n                cell.title = meta ? meta.name : 'Case';\n                preview.appendChild(cell);\n              });\n              return preview;\n            }\n\n            function openPack(packId) {\n              const pack = PackLibrary.open(packId);\n              if (!pack) {\n                UIComponents.showToast('Pack not found', 'error');\n                return;\n              }\n              AppShell.navigate('editor');\n            }\n\n            function openNewPackModal() {\n              const content = document.createElement('div');\n              content.style.display = 'grid';\n              content.style.gap = '14px';\n              content.style.gridTemplateColumns = 'repeat(auto-fit, minmax(260px, 1fr))';\n              content.style.alignItems = 'flex-start';\n\n              const title = field('Title (required)', 'text', 'Summer Festival Tour', true);\n              const client = field('Client (optional)', 'text', 'Live Nation', false);\n              const projectName = field('Project name (optional)', 'text', 'Coachella 2024', false);\n              const drawnBy = field('Drawn by (optional)', 'text', 'John Smith', false);\n\n              const truckPresets = [\n                { label: '53ft Trailer (default)', truck: { length: 636, width: 102, height: 98 } },\n                { label: '26ft Box Truck', truck: { length: 312, width: 96, height: 96 } },\n                { label: 'Sprinter Van', truck: { length: 168, width: 70, height: 72 } },\n              ];\n\n              const presetWrap = document.createElement('div');\n              presetWrap.className = 'field';\n              const presetLabel = document.createElement('div');\n              presetLabel.className = 'label';\n              presetLabel.textContent = 'Truck preset';\n              const presetSelect = document.createElement('select');\n              presetSelect.className = 'select';\n              truckPresets.forEach((p, idx) => {\n                const opt = document.createElement('option');\n                opt.value = String(idx);\n                opt.textContent = p.label;\n                presetSelect.appendChild(opt);\n              });\n              presetWrap.appendChild(presetLabel);\n              presetWrap.appendChild(presetSelect);\n\n              const truckGrid = document.createElement('div');\n              truckGrid.className = 'row';\n              truckGrid.style.gap = '12px';\n              const tL = field('Truck length (in)', 'number', '636', true);\n              const tW = field('Truck width (in)', 'number', '102', true);\n              const tH = field('Truck height (in)', 'number', '98', true);\n              tL.wrap.style.flex = '1';\n              tW.wrap.style.flex = '1';\n              tH.wrap.style.flex = '1';\n              truckGrid.appendChild(tL.wrap);\n              truckGrid.appendChild(tW.wrap);\n              truckGrid.appendChild(tH.wrap);\n\n              presetSelect.addEventListener('change', () => {\n                const idx = Number(presetSelect.value);\n                const preset = truckPresets[idx] || truckPresets[0];\n                tL.input.value = String(preset.truck.length);\n                tW.input.value = String(preset.truck.width);\n                tH.input.value = String(preset.truck.height);\n              });\n\n              content.appendChild(title.wrap);\n              content.appendChild(client.wrap);\n              content.appendChild(projectName.wrap);\n              content.appendChild(drawnBy.wrap);\n              content.appendChild(presetWrap);\n              content.appendChild(truckGrid);\n\n              UIComponents.showModal({\n                title: 'New Pack',\n                content,\n                actions: [\n                  { label: 'Cancel' },\n                  {\n                    label: 'Create',\n                    variant: 'primary',\n                    onClick: () => {\n                      const t = String(title.input.value || '').trim();\n                      if (!t) {\n                        UIComponents.showToast('Title is required', 'warning');\n                        title.input.focus();\n                        return false;\n                      }\n                      const pack = PackLibrary.create({\n                        title: t,\n                        client: String(client.input.value || '').trim(),\n                        projectName: String(projectName.input.value || '').trim(),\n                        drawnBy: String(drawnBy.input.value || '').trim(),\n                        truck: {\n                          length: Number(tL.input.value) || 636,\n                          width: Number(tW.input.value) || 102,\n                          height: Number(tH.input.value) || 98,\n                        },\n                      });\n                      UIComponents.showToast('Pack created', 'success');\n                      PackLibrary.open(pack.id);\n                      AppShell.navigate('editor');\n                    },\n                  },\n                ],\n              });\n            }\n\n            function openRename(packId) {\n              const pack = PackLibrary.getById(packId);\n              if (!pack) return;\n              const content = document.createElement('div');\n              const f = field('Pack title', 'text', pack.title || '', true);\n              f.input.value = pack.title || '';\n              content.appendChild(f.wrap);\n              UIComponents.showModal({\n                title: 'Rename Pack',\n                content,\n                actions: [\n                  { label: 'Cancel' },\n                  {\n                    label: 'Save',\n                    variant: 'primary',\n                    onClick: () => {\n                      const nextTitle = String(f.input.value || '').trim();\n                      if (!nextTitle) return false;\n                      PackLibrary.update(packId, { title: nextTitle });\n                      UIComponents.showToast('Renamed', 'success');\n                    },\n                  },\n                ],\n              });\n            }\n\n            function exportPack(packId) {\n              const pack = PackLibrary.getById(packId);\n              if (!pack) return;\n              const payload = {\n                app: 'Truck Packer 3D',\n                version: APP_VERSION,\n                exportedAt: Date.now(),\n                pack,\n                bundledCases: (pack.cases || []).map(i => CaseLibrary.getById(i.caseId)).filter(Boolean),\n              };\n              Utils.downloadText(\n                `${(pack.title || 'pack').replace(/[^a-z0-9]+/gi, '-')}.json`,\n                JSON.stringify(payload, null, 2)\n              );\n              UIComponents.showToast('Pack JSON exported', 'success');\n            }\n\n            async function deletePack(packId) {\n              const ok = await UIComponents.confirm({\n                title: 'Delete pack?',\n                message: 'This cannot be undone.',\n                danger: true,\n                okLabel: 'Delete',\n              });\n              if (!ok) return;\n              PackLibrary.remove(packId);\n              UIComponents.showToast('Pack deleted', 'info');\n            }\n\n            function openImportPackDialog() {\n              const input = document.createElement('input');\n              input.type = 'file';\n              input.accept = '.json,application/json';\n              input.addEventListener('change', async () => {\n                const file = input.files && input.files[0];\n                if (!file) return;\n                try {\n                  const text = await file.text();\n                  const parsed = Utils.sanitizeJSON(Utils.safeJsonParse(text, null));\n                  if (!parsed) throw new Error('Invalid JSON');\n                  const payload = parsed.pack ? parsed : { pack: parsed };\n                  importPackPayload(payload);\n                  UIComponents.showToast('Pack imported', 'success');\n                } catch (err) {\n                  UIComponents.showToast('Import failed: ' + err.message, 'error');\n                }\n              });\n              input.click();\n            }\n\n            function importPackPayload(payload) {\n              const now = Date.now();\n              const incomingPack = payload.pack;\n              if (!incomingPack || !incomingPack.truck || !Array.isArray(incomingPack.cases))\n                {throw new Error('Invalid pack format');}\n\n              const bundled = Array.isArray(payload.bundledCases) ? payload.bundledCases : [];\n              const currentCases = CaseLibrary.getCases();\n              const currentPacks = PackLibrary.getPacks();\n\n              const caseById = new Map(currentCases.map(c => [c.id, c]));\n              const caseByName = new Map(\n                currentCases.map(c => [\n                  String(c.name || '')\n                    .trim()\n                    .toLowerCase(),\n                  c,\n                ])\n              );\n              const caseIdMap = new Map();\n              const nextCases = [...currentCases];\n\n              bundled.forEach(c => {\n                if (!c || !c.id) return;\n                const nameKey = String(c.name || '')\n                  .trim()\n                  .toLowerCase();\n                if (caseById.has(c.id)) {\n                  caseIdMap.set(c.id, c.id);\n                  return;\n                }\n                if (nameKey && caseByName.has(nameKey)) {\n                  caseIdMap.set(c.id, caseByName.get(nameKey).id);\n                  return;\n                }\n                const copy = Utils.deepClone(c);\n                copy.createdAt = copy.createdAt || now;\n                copy.updatedAt = now;\n                copy.volume =\n                  copy.volume || Utils.volumeInCubicInches(copy.dimensions || { length: 0, width: 0, height: 0 });\n                nextCases.push(copy);\n                caseById.set(copy.id, copy);\n                if (nameKey) caseByName.set(nameKey, copy);\n                caseIdMap.set(c.id, copy.id);\n              });\n\n              const pack = Utils.deepClone(incomingPack);\n              pack.id = currentPacks.some(p => p.id === pack.id) ? Utils.uuid() : pack.id || Utils.uuid();\n              pack.title = pack.title ? `${pack.title} (Imported)` : 'Imported Pack';\n              pack.createdAt = pack.createdAt || now;\n              pack.lastEdited = now;\n\n              // New instance ids + caseId remap\n              pack.cases = (pack.cases || []).map(inst => {\n                const next = Utils.deepClone(inst);\n                next.id = Utils.uuid();\n                next.caseId = caseIdMap.get(next.caseId) || next.caseId;\n                if (!next.transform)\n                  {next.transform = {\n              position: { x: -80, y: 10, z: 0 },\n              rotation: { x: 0, y: 0, z: 0 },\n              scale: { x: 1, y: 1, z: 1 },\n            };}\n                if (!next.transform.position) next.transform.position = { x: -80, y: 10, z: 0 };\n                return next;\n              });\n\n              pack.stats = PackLibrary.computeStats(pack, nextCases);\n\n              StateStore.set(\n                {\n                  caseLibrary: nextCases,\n                  packLibrary: [...currentPacks, pack],\n                  currentPackId: pack.id,\n                  currentScreen: 'editor',\n                  selectedInstanceIds: [],\n                },\n                { skipHistory: false }\n              );\n            }\n\n            function field(label, type, placeholder, required) {\n              const wrap = document.createElement('div');\n              wrap.className = 'field';\n              const l = document.createElement('div');\n              l.className = 'label';\n              l.textContent = required ? `${label}` : label;\n              const input = document.createElement('input');\n              input.className = 'input';\n              input.type = type;\n              input.placeholder = placeholder || '';\n              wrap.appendChild(l);\n              wrap.appendChild(input);\n              return { wrap, input };\n            }\n\n            return { init, render };\n          })();\n\n          // Placeholder modules for remaining screens; implemented in later steps.\n\t          const CasesUI = (() => {\n\t            const searchEl = document.getElementById('cases-search');\n\t            const filtersEl = document.getElementById('cases-filters');\n\t            const tbodyEl = document.getElementById('cases-tbody');\n\t            const emptyEl = document.getElementById('cases-empty');\n\t            const selectAllEl = document.getElementById('cases-select-all');\n\t            const btnNew = document.getElementById('btn-new-case');\n\t            const btnTemplate = document.getElementById('btn-cases-template');\n\t            const btnImport = document.getElementById('btn-cases-import');\n\t            const btnManageCats = document.getElementById('btn-manage-categories');\n\t            const actionsDefaultEl = document.getElementById('cases-actions-default');\n\t            const actionsBulkEl = document.getElementById('cases-actions-bulk');\n\t            const selectedCountEl = document.getElementById('cases-selected-count');\n\t            const btnBulkDelete = document.getElementById('btn-cases-bulk-delete');\n\t            const btnBulkTemplate = document.getElementById('btn-cases-bulk-template');\n\n\t            const activeCategories = new Set(); // empty = all\n\t            let sortBy = 'name'; // name, manufacturer, dimensions, volume, weight, category\n\t            let sortDir = 'asc'; // asc or desc\n\t            const selectedIds = new Set();\n\t            let lastDatasetKey = '';\n\t            let lastVisibleIds = [];\n\n\t            function init() {\n\t              searchEl.addEventListener('input', Utils.debounce(render, 300));\n\t              btnNew.addEventListener('click', () => openCaseModal(null));\n\t              btnTemplate.addEventListener('click', () => downloadTemplate());\n\t              btnImport.addEventListener('click', () => openImportModal());\n\t              btnManageCats.addEventListener('click', () => openCategoryManager());\n\t              btnBulkTemplate.addEventListener('click', () => {\n\t                UIComponents.showToast('Template feature coming soon', 'info');\n\t              });\n\t              btnBulkDelete.addEventListener('click', () => bulkDeleteSelected());\n\t              selectAllEl.addEventListener('change', () => toggleAllVisible(selectAllEl.checked));\n\t              initTableHeaders();\n\t            }\n\n\t            function clearSelection() {\n\t              selectedIds.clear();\n\t            }\n\n\t            function toggleAllVisible(checked) {\n\t              const ids = lastVisibleIds || [];\n\t              if (!ids.length) return;\n\t              if (checked) ids.forEach(id => selectedIds.add(id));\n\t              else ids.forEach(id => selectedIds.delete(id));\n\t              render();\n\t            }\n\n\t            function updateSelectionUI(visibleIds) {\n\t              lastVisibleIds = visibleIds || [];\n\t              const visibleCount = lastVisibleIds.length;\n\n\t              // Selected count is based on the current visible dataset after search/sort/category.\n\t              const selectedCount = selectedIds.size;\n\n\t              actionsDefaultEl.style.display = selectedCount ? 'none' : 'flex';\n\t              actionsBulkEl.style.display = selectedCount ? 'flex' : 'none';\n\t              selectedCountEl.textContent = `${selectedCount} of ${visibleCount} row(s) selected.`;\n\t              btnBulkDelete.innerHTML = `<i class=\"fa-solid fa-trash\"></i> Delete (${selectedCount})`;\n\n\t              if (!visibleCount) {\n\t                selectAllEl.checked = false;\n\t                selectAllEl.indeterminate = false;\n\t                selectAllEl.disabled = true;\n\t                return;\n\t              }\n\n\t              selectAllEl.disabled = false;\n\t              const allSelected = lastVisibleIds.every(id => selectedIds.has(id));\n\t              const someSelected = lastVisibleIds.some(id => selectedIds.has(id));\n\t              selectAllEl.checked = allSelected;\n\t              selectAllEl.indeterminate = !allSelected && someSelected;\n\t            }\n\n\t            async function bulkDeleteSelected() {\n\t              const ids = Array.from(selectedIds);\n\t              const count = ids.length;\n\t              if (!count) return;\n\n\t              const ok = await UIComponents.confirm({\n\t                title: 'Delete cases?',\n\t                message: `This will permanently delete ${count} case(s). This cannot be undone.`,\n\t                danger: true,\n\t                okLabel: 'Delete',\n\t              });\n\t              if (!ok) return;\n\n\t              const idSet = new Set(ids);\n\t              const nextCaseLibrary = CaseLibrary.getCases().filter(c => !idSet.has(c.id));\n\t              const nextPackLibrary = PackLibrary.getPacks().map(p => {\n\t                const prevCases = Array.isArray(p.cases) ? p.cases : [];\n\t                const nextCases = prevCases.filter(i => !idSet.has(i.caseId));\n\t                if (nextCases.length === prevCases.length) return p;\n\t                const next = { ...p, cases: nextCases, lastEdited: Date.now() };\n\t                next.stats = PackLibrary.computeStats(next);\n\t                return next;\n\t              });\n\n\t              StateStore.set({ caseLibrary: nextCaseLibrary, packLibrary: nextPackLibrary });\n\t              clearSelection();\n\t              render();\n\t              UIComponents.showToast(`Deleted ${count} case(s).`, 'info');\n\t            }\n\n\t            function initTableHeaders() {\n\t              const headers = document.querySelectorAll('#screen-cases table thead th[data-sort]');\n\t              headers.forEach(th => {\n\t                th.style.cursor = 'pointer';\n                th.style.userSelect = 'none';\n                th.addEventListener('click', () => {\n                  const field = th.getAttribute('data-sort');\n                  if (sortBy === field) {\n                    sortDir = sortDir === 'asc' ? 'desc' : 'asc';\n                  } else {\n                    sortBy = field;\n                    sortDir = 'asc';\n                  }\n                  render();\n                  updateHeaderIcons();\n                });\n              });\n              updateHeaderIcons();\n            }\n\n            function updateHeaderIcons() {\n              const headers = document.querySelectorAll('#screen-cases table thead th[data-sort]');\n              headers.forEach(th => {\n                const field = th.getAttribute('data-sort');\n                const existingIcon = th.querySelector('.sort-icon');\n                if (existingIcon) existingIcon.remove();\n                \n                if (sortBy === field) {\n                  const icon = document.createElement('i');\n                  icon.className = `fa-solid fa-${sortDir === 'asc' ? 'arrow-up' : 'arrow-down'} sort-icon`;\n                  icon.style.marginLeft = '6px';\n                  icon.style.fontSize = '12px';\n                  th.appendChild(icon);\n                }\n              });\n            }\n\n            function render() {\n              renderFilters();\n              renderTable();\n            }\n\n            function renderFilters() {\n              const cases = CaseLibrary.getCases();\n              const list = CategoryService.listWithCounts(cases);\n              filtersEl.innerHTML = '';\n\n              const allChip = chip(\n                'All',\n                'all',\n                activeCategories.size === 0,\n                () => {\n                  activeCategories.clear();\n                  render();\n                },\n                '#9b9ba8',\n                cases.length\n              );\n              filtersEl.appendChild(allChip);\n\n              list.forEach(cat => {\n                const isActive = activeCategories.has(cat.key);\n                const el = chip(\n                  cat.name,\n                  cat.key,\n                  isActive,\n                  () => {\n                    if (activeCategories.has(cat.key)) activeCategories.delete(cat.key);\n                    else activeCategories.add(cat.key);\n                    render();\n                  },\n                  cat.color,\n                  cat.count\n                );\n                filtersEl.appendChild(el);\n              });\n            }\n\n\t            function renderTable() {\n\t              const prefs = PreferencesManager.get();\n\t              const q = String(searchEl.value || '').trim();\n\t              const cats = Array.from(activeCategories).sort();\n\n\t              // Simplest stable behavior: clear selection when the visible dataset changes (search/sort/filter).\n\t              const datasetKey = `${q}::${sortBy}::${sortDir}::${cats.join(',')}`;\n\t              if (datasetKey !== lastDatasetKey) {\n\t                clearSelection();\n\t                lastDatasetKey = datasetKey;\n\t              }\n\n\t              const cases = CaseLibrary.search(q, Array.from(activeCategories));\n\n\t              // Sort cases\n\t              cases.sort((a, b) => {\n                let valA, valB;\n                switch (sortBy) {\n                  case 'name':\n                    valA = (a.name || '').toLowerCase();\n                    valB = (b.name || '').toLowerCase();\n                    break;\n                  case 'manufacturer':\n                    valA = (a.manufacturer || '').toLowerCase();\n                    valB = (b.manufacturer || '').toLowerCase();\n                    break;\n                  case 'volume':\n                    valA = a.volume || 0;\n                    valB = b.volume || 0;\n                    break;\n                  case 'weight':\n                    valA = a.weight || 0;\n                    valB = b.weight || 0;\n                    break;\n                  case 'category':\n                    valA = CategoryService.meta(a.category).name.toLowerCase();\n                    valB = CategoryService.meta(b.category).name.toLowerCase();\n                    break;\n                  default:\n                    valA = (a.name || '').toLowerCase();\n                    valB = (b.name || '').toLowerCase();\n                }\n                \n                if (typeof valA === 'number' && typeof valB === 'number') {\n                  return sortDir === 'asc' ? valA - valB : valB - valA;\n                }\n                \n                if (valA < valB) return sortDir === 'asc' ? -1 : 1;\n                if (valA > valB) return sortDir === 'asc' ? 1 : -1;\n                return 0;\n              });\n\n\t              tbodyEl.innerHTML = '';\n\t              const visibleIds = cases.map(c => c.id);\n\n\t              // Prune any stale selections (e.g. after deletes).\n\t              const visibleIdSet = new Set(visibleIds);\n\t              Array.from(selectedIds).forEach(id => {\n\t                if (!visibleIdSet.has(id)) selectedIds.delete(id);\n\t              });\n\n\t              updateSelectionUI(visibleIds);\n\n\t              if (!cases.length) {\n\t                emptyEl.style.display = 'block';\n\t                return;\n\t              }\n\t              emptyEl.style.display = 'none';\n\n\t              cases.forEach(c => {\n\t                const tr = document.createElement('tr');\n\n\t                const tdSelect = document.createElement('td');\n\t                tdSelect.style.width = '36px';\n\t                tdSelect.style.textAlign = 'center';\n\t                const cb = document.createElement('input');\n\t                cb.type = 'checkbox';\n\t                cb.checked = selectedIds.has(c.id);\n\t                cb.addEventListener('click', ev => ev.stopPropagation());\n\t                cb.addEventListener('change', ev => {\n\t                  if (ev.target.checked) selectedIds.add(c.id);\n\t                  else selectedIds.delete(c.id);\n\t                  render();\n\t                });\n\t                tdSelect.appendChild(cb);\n\t                tr.appendChild(tdSelect);\n\n\t                const tdName = document.createElement('td');\n\t                tdName.textContent = c.name || '—';\n\t                tr.appendChild(tdName);\n\n                const tdMfg = document.createElement('td');\n                tdMfg.textContent = c.manufacturer || '—';\n                tr.appendChild(tdMfg);\n\n                const tdDims = document.createElement('td');\n                tdDims.textContent = Utils.formatDims(c.dimensions, prefs.units.length);\n                tr.appendChild(tdDims);\n\n                const tdVol = document.createElement('td');\n                tdVol.textContent = Utils.formatVolume(c.dimensions, prefs.units.length);\n                tr.appendChild(tdVol);\n\n                const tdW = document.createElement('td');\n                const weight = Number(c.weight) || 0;\n                const formattedWeight = prefs.units.weight === 'kg' \n                  ? `${(weight * 0.453592).toFixed(2)} kg`\n                  : `${weight.toFixed(2)} lb`;\n                tdW.textContent = formattedWeight;\n                tr.appendChild(tdW);\n\n                const tdCat = document.createElement('td');\n                tdCat.appendChild(categoryChip(c.category));\n                tr.appendChild(tdCat);\n\n                const tdFlip = document.createElement('td');\n                tdFlip.innerHTML = c.canFlip\n                  ? '<i class=\"fa-solid fa-check\" style=\"color:var(--success)\"></i>'\n                  : '<i class=\"fa-solid fa-minus\" style=\"color:var(--text-muted)\"></i>';\n                tr.appendChild(tdFlip);\n\n                const tdActions = document.createElement('td');\n                tdActions.className = 'col-actions';\n                const btn = document.createElement('button');\n                btn.type = 'button';\n                btn.className = 'btn btn-ghost';\n                btn.innerHTML = '<i class=\"fa-solid fa-ellipsis\"></i>';\n                btn.addEventListener('click', ev => {\n                  ev.stopPropagation();\n                  UIComponents.openDropdown(btn, [\n                    { label: 'Edit', icon: 'fa-solid fa-pen', onClick: () => openCaseModal(c) },\n                    {\n                      label: 'Duplicate',\n                      icon: 'fa-solid fa-clone',\n                      onClick: () => {\n                        CaseLibrary.duplicate(c.id);\n                        UIComponents.showToast('Case duplicated', 'success');\n                      },\n                    },\n                    { label: 'Delete', icon: 'fa-solid fa-trash', variant: 'danger', dividerBefore: true, onClick: () => deleteCase(c.id) },\n                  ]);\n                });\n                tdActions.appendChild(btn);\n                tr.appendChild(tdActions);\n\n                tbodyEl.appendChild(tr);\n              });\n            }\n\n            function chip(label, key, active, onClick, color, count) {\n              const el = document.createElement('div');\n              el.className = `chip ${active ? 'active' : ''}`;\n              el.setAttribute('role', 'button');\n              el.tabIndex = 0;\n              const dot = document.createElement('span');\n              dot.className = 'chip-dot';\n              dot.style.background = color || 'var(--border-strong)';\n              const text = document.createElement('span');\n              text.textContent = `${label}${Number.isFinite(count) ? `: ${count}` : ''}`;\n              el.appendChild(dot);\n              el.appendChild(text);\n              el.addEventListener('click', onClick);\n              el.addEventListener('keydown', ev => {\n                if (ev.key === 'Enter') onClick();\n              });\n              return el;\n            }\n\n            function categoryChip(categoryKey) {\n              const meta = CategoryService.meta(categoryKey || 'default');\n              const el = document.createElement('span');\n              el.className = 'chip';\n              el.style.cursor = 'default';\n              const dot = document.createElement('span');\n              dot.className = 'chip-dot';\n              dot.style.background = meta.color;\n              const text = document.createElement('span');\n              text.textContent = meta.name;\n              el.appendChild(dot);\n              el.appendChild(text);\n              return el;\n            }\n\n            function openCaseModal(existing) {\n              const prefs = PreferencesManager.get();\n              const lengthUnit = prefs.units.length;\n              const weightUnit = prefs.units.weight;\n\n              const now = Date.now();\n              const isEdit = Boolean(existing);\n              const initial = existing\n                ? Utils.deepClone(existing)\n                : {\n                    id: Utils.uuid(),\n                    name: '',\n                    manufacturer: '',\n                    category: 'default',\n                    dimensions: { length: 48, width: 24, height: 24 },\n                    weight: 0,\n                    canFlip: true,\n                    notes: '',\n                    color: CategoryService.meta('default').color,\n                    createdAt: now,\n                    updatedAt: now,\n                  };\n\n              const content = document.createElement('div');\n              content.style.display = 'grid';\n              content.style.gridTemplateColumns = '1fr 1fr';\n              content.style.gap = '14px';\n\n              const fName = field('Name', 'text', 'Line Array Case', true);\n              fName.input.value = initial.name || '';\n\n              const fMfg = field('Manufacturer', 'text', 'L-Acoustics', false);\n              fMfg.input.value = initial.manufacturer || '';\n\n              const catWrap = document.createElement('div');\n              catWrap.className = 'field';\n              catWrap.style.gridColumn = '1 / -1';\n              const catLabel = document.createElement('div');\n              catLabel.className = 'label';\n              catLabel.textContent = 'Category';\n              const catRow = document.createElement('div');\n              catRow.style.display = 'flex';\n              catRow.style.gap = '8px';\n              catRow.style.alignItems = 'center';\n              const catColor = document.createElement('input');\n              catColor.type = 'color';\n              catColor.className = 'input';\n              catColor.style.width = '48px';\n              catColor.style.padding = '0';\n              catColor.value = CategoryService.meta(initial.category).color || '#9ca3af';\n              const catName = document.createElement('input');\n              catName.type = 'text';\n              catName.className = 'input';\n              catName.style.flex = '1';\n              catName.value = CategoryService.meta(initial.category).name;\n              catName.placeholder = 'Rename or create new';\n              const catSelect = document.createElement('select');\n              catSelect.className = 'select';\n              catSelect.style.display = 'none';\n              const catOptions = CategoryService.all();\n              const extraCat =\n                initial.category && !catOptions.find(c => c.key === initial.category)\n                  ? [{ ...CategoryService.meta(initial.category) }]\n                  : [];\n              [...catOptions, ...extraCat]\n                .filter((v, idx, arr) => arr.findIndex(x => x.key === v.key) === idx)\n                .forEach(c => {\n                  const opt = document.createElement('option');\n                  opt.value = c.key;\n                  opt.textContent = c.name || CategoryService.meta(c.key).name;\n                  catSelect.appendChild(opt);\n                });\n              catSelect.value = initial.category || 'default';\n              catRow.appendChild(catColor);\n              catRow.appendChild(catName);\n              catRow.appendChild(catSelect);\n              catWrap.appendChild(catLabel);\n              catWrap.appendChild(catRow);\n\n              const fL = field(`Length (${lengthUnit})`, 'number', '', true);\n              const fW = field(`Width (${lengthUnit})`, 'number', '', true);\n              const fH = field(`Height (${lengthUnit})`, 'number', '', true);\n              fL.input.value = String(Utils.inchesToUnit(initial.dimensions.length, lengthUnit));\n              fW.input.value = String(Utils.inchesToUnit(initial.dimensions.width, lengthUnit));\n              fH.input.value = String(Utils.inchesToUnit(initial.dimensions.height, lengthUnit));\n\n              const fWeight = field(`Weight (${weightUnit})`, 'number', '', false);\n              fWeight.input.step = '0.1';\n              const weightValue = Utils.poundsToUnit(Number(initial.weight) || 0, weightUnit);\n              fWeight.input.value = String(Math.round(weightValue * 100) / 100);\n\n              const flipRow = document.createElement('label');\n              flipRow.style.display = 'flex';\n              flipRow.style.alignItems = 'center';\n              flipRow.style.gap = '10px';\n              flipRow.style.fontSize = 'var(--text-sm)';\n              flipRow.style.gridColumn = '1 / -1';\n              const flip = document.createElement('input');\n              flip.type = 'checkbox';\n              flip.checked = Boolean(initial.canFlip);\n              const flipText = document.createElement('span');\n              flipText.textContent = 'Can be flipped';\n              flipRow.appendChild(flip);\n              flipRow.appendChild(flipText);\n\n              const notesWrap = document.createElement('div');\n              notesWrap.className = 'field';\n              notesWrap.style.gridColumn = '1 / -1';\n              const notesLabel = document.createElement('div');\n              notesLabel.className = 'label';\n              notesLabel.textContent = 'Notes';\n              const notes = document.createElement('textarea');\n              notes.className = 'input';\n              notes.style.minHeight = '60px';\n              notes.value = initial.notes || '';\n              notesWrap.appendChild(notesLabel);\n              notesWrap.appendChild(notes);\n\n              content.appendChild(fName.wrap);\n              content.appendChild(fMfg.wrap);\n              content.appendChild(catWrap);\n              content.appendChild(fL.wrap);\n              content.appendChild(fW.wrap);\n              content.appendChild(fH.wrap);\n              content.appendChild(fWeight.wrap);\n              content.appendChild(flipRow);\n              content.appendChild(notesWrap);\n\n              UIComponents.showModal({\n                title: isEdit ? 'Edit Case' : 'New Case',\n                content,\n                actions: [\n                  { label: 'Cancel' },\n                  {\n                    label: 'Save',\n                    variant: 'primary',\n                    onClick: () => {\n                      const name = String(fName.input.value || '').trim();\n                      if (!name) {\n                        UIComponents.showToast('Name is required', 'warning');\n                        fName.input.focus();\n                        return false;\n                      }\n                      const length = Utils.unitToInches(Number(fL.input.value) || 0, lengthUnit);\n                      const width = Utils.unitToInches(Number(fW.input.value) || 0, lengthUnit);\n                      const height = Utils.unitToInches(Number(fH.input.value) || 0, lengthUnit);\n                      if (length <= 0 || width <= 0 || height <= 0) {\n                        UIComponents.showToast('Dimensions must be > 0', 'warning');\n                        return false;\n                      }\n                      const weightLb = Utils.unitToPounds(Number(fWeight.input.value) || 0, weightUnit);\n                      const categoryName = String(catName.value || '').trim();\n                      const updatedCat = CategoryService.rename(catSelect.value, categoryName, catColor.value);\n                      const caseData = {\n                        ...initial,\n                        name,\n                        manufacturer: String(fMfg.input.value || '').trim(),\n                        category: updatedCat.key,\n                        dimensions: { length, width, height },\n                        weight: weightLb,\n                        canFlip: Boolean(flip.checked),\n                        notes: String(notes.value || '').trim(),\n                        color: catColor.value || '#ff9f1c',\n                      };\n                      CaseLibrary.upsert(caseData);\n                      UIComponents.showToast('Case saved', 'success');\n                      render();\n                    },\n                  },\n                ],\n              });\n            }\n\n            function openCategoryManager() {\n              const content = document.createElement('div');\n              content.style.display = 'grid';\n              content.style.gap = '14px';\n              content.style.minWidth = '480px';\n\n              const listEl = document.createElement('div');\n              listEl.style.display = 'grid';\n              listEl.style.gap = '8px';\n\n              const renderList = () => {\n                listEl.innerHTML = '';\n                CategoryService.all().forEach(cat => {\n                  const row = document.createElement('div');\n                  row.className = 'card';\n                  row.style.display = 'grid';\n                  row.style.gridTemplateColumns = '40px 1fr auto';\n                  row.style.gap = '12px';\n                  row.style.alignItems = 'center';\n                  row.style.padding = 'var(--space-3)';\n                  row.style.background = 'var(--bg-elevated)';\n                  row.style.boxShadow = 'none';\n\n                  const colorWrap = document.createElement('div');\n                  colorWrap.style.position = 'relative';\n                  const color = document.createElement('input');\n                  color.type = 'color';\n                  color.value = cat.color || '#9ca3af';\n                  color.className = 'input';\n                  color.style.width = '40px';\n                  color.style.height = '40px';\n                  color.style.padding = '0';\n                  color.style.cursor = 'pointer';\n                  color.style.border = '2px solid var(--border-subtle)';\n                  color.style.borderRadius = 'var(--radius-sm)';\n                  colorWrap.appendChild(color);\n\n                  const name = document.createElement('input');\n                  name.type = 'text';\n                  name.className = 'input';\n                  name.value = cat.name;\n                  name.placeholder = 'Category name';\n\n                  const actions = document.createElement('div');\n                  actions.style.display = 'flex';\n                  actions.style.gap = '6px';\n\n                  const saveBtn = document.createElement('button');\n                  saveBtn.type = 'button';\n                  saveBtn.className = 'btn btn-ghost';\n                  saveBtn.style.padding = '6px 10px';\n                  saveBtn.innerHTML = '<i class=\"fa-solid fa-floppy-disk\"></i>';\n                  saveBtn.title = 'Save changes';\n                  saveBtn.addEventListener('click', () => {\n                    const renamed = CategoryService.rename(cat.key, name.value, color.value);\n                    renderList();\n                    render();\n                    UIComponents.showToast(`Saved \"${renamed.name}\"`, 'success');\n                  });\n\n                  if (cat.key !== 'default') {\n                    const delBtn = document.createElement('button');\n                    delBtn.type = 'button';\n                    delBtn.className = 'btn btn-ghost';\n                    delBtn.style.padding = '6px 10px';\n                    delBtn.style.color = 'var(--error)';\n                    delBtn.innerHTML = '<i class=\"fa-solid fa-trash\"></i>';\n                    delBtn.title = 'Delete category';\n                    delBtn.addEventListener('click', async () => {\n                      const ok = await UIComponents.confirm({\n                        title: `Delete \"${cat.name}\"?`,\n                        message: 'All cases in this category will be moved to Default.',\n                        okLabel: 'Delete',\n                        danger: true,\n                      });\n                      if (!ok) return;\n                      CategoryService.remove(cat.key);\n                      renderList();\n                      render();\n                      UIComponents.showToast(`Deleted \"${cat.name}\"`, 'info');\n                    });\n                    actions.appendChild(delBtn);\n                  }\n\n                  actions.appendChild(saveBtn);\n                  row.appendChild(colorWrap);\n                  row.appendChild(name);\n                  row.appendChild(actions);\n                  listEl.appendChild(row);\n                });\n              };\n\n              const addBtn = document.createElement('button');\n              addBtn.type = 'button';\n              addBtn.className = 'btn btn-primary';\n              addBtn.style.width = '100%';\n              addBtn.innerHTML = '<i class=\"fa-solid fa-plus\"></i> New Category';\n              addBtn.addEventListener('click', () => {\n                const baseName = 'New Category';\n                let idx = 1;\n                let name = baseName;\n                const existing = new Set(CategoryService.all().map(c => c.name.toLowerCase()));\n                while (existing.has(name.toLowerCase())) {\n                  idx += 1;\n                  name = `${baseName} ${idx}`;\n                }\n                CategoryService.upsert({ name });\n                renderList();\n                render();\n              });\n\n              renderList();\n\n              content.appendChild(listEl);\n              content.appendChild(addBtn);\n\n              UIComponents.showModal({\n                title: 'Manage Categories',\n                content,\n                actions: [{ label: 'Close', variant: 'primary' }],\n              });\n            }\n\n            function normalizeHex(value) {\n              const s = String(value || '').trim();\n              const m = s.match(/^#([0-9a-f]{6})$/i);\n              return m ? `#${m[1].toLowerCase()}` : null;\n            }\n\n            function field(label, type, placeholder, required) {\n              const wrap = document.createElement('div');\n              wrap.className = 'field';\n              const l = document.createElement('div');\n              l.className = 'label';\n              l.textContent = required ? `${label} (required)` : label;\n              const input = document.createElement('input');\n              input.className = 'input';\n              input.type = type;\n              input.placeholder = placeholder || '';\n              wrap.appendChild(l);\n              wrap.appendChild(input);\n              return { wrap, input };\n            }\n\n            async function deleteCase(caseId) {\n              const caseData = CaseLibrary.getById(caseId);\n              if (!caseData) return;\n              const packsUsing = PackLibrary.getPacks().filter(p => (p.cases || []).some(i => i.caseId === caseId));\n              const msg = packsUsing.length\n                ? `This case is used in ${packsUsing.length} pack(s). Deleting it will remove it from those packs.`\n                : 'This cannot be undone.';\n              const ok = await UIComponents.confirm({\n                title: `Delete \"${caseData.name}\"?`,\n                message: msg,\n                danger: true,\n                okLabel: 'Delete',\n              });\n              if (!ok) return;\n\n              const nextCaseLibrary = CaseLibrary.getCases().filter(c => c.id !== caseId);\n              const nextPackLibrary = PackLibrary.getPacks().map(p => {\n                const nextCases = (p.cases || []).filter(i => i.caseId !== caseId);\n                if (nextCases.length === (p.cases || []).length) return p;\n                const next = { ...p, cases: nextCases, lastEdited: Date.now() };\n                next.stats = PackLibrary.computeStats(next);\n                return next;\n              });\n\n              StateStore.set({ caseLibrary: nextCaseLibrary, packLibrary: nextPackLibrary });\n              UIComponents.showToast('Case deleted', 'info');\n            }\n\n            function downloadTemplate() {\n              const csv = [\n                'name,manufacturer,category,length,width,height,weight,canFlip,notes',\n                'Line Array Case,L-Acoustics,audio,48,24,32,125,false,',\n                'Truss Section,Global Truss,lighting,120,12,12,45,true,',\n              ].join('\\n');\n              Utils.downloadText('cases_template.csv', csv, 'text/csv');\n              UIComponents.showToast('Template downloaded', 'success');\n            }\n\n            function openImportModal() {\n              const content = document.createElement('div');\n              content.style.display = 'grid';\n              content.style.gap = '14px';\n\n              const drop = document.createElement('div');\n              drop.className = 'card';\n              drop.style.borderStyle = 'dashed';\n              drop.style.background = 'var(--bg-elevated)';\n              drop.style.textAlign = 'center';\n              drop.style.padding = '22px';\n              drop.innerHTML = `\n              <div style=\"font-size:28px;margin-bottom:6px\">📄</div>\n              <div style=\"font-weight:var(--font-semibold);margin-bottom:6px\">Drag & Drop File Here</div>\n              <div class=\"muted\" style=\"font-size:var(--text-sm)\">Supported: .csv, .xlsx</div>\n              <div style=\"height:12px\"></div>\n            `;\n              const browseBtn = document.createElement('button');\n              browseBtn.className = 'btn';\n              browseBtn.type = 'button';\n              browseBtn.innerHTML = '<i class=\"fa-solid fa-folder-open\"></i> Browse files';\n              drop.appendChild(browseBtn);\n\n              const hint = document.createElement('div');\n              hint.className = 'muted';\n              hint.style.fontSize = 'var(--text-sm)';\n              hint.innerHTML =\n                'Required: <b>name</b>, <b>length</b>, <b>width</b>, <b>height</b><br>Optional: manufacturer, category, weight, canFlip, notes';\n\n              const results = document.createElement('div');\n              results.style.display = 'none';\n\n              content.appendChild(drop);\n              content.appendChild(hint);\n              content.appendChild(results);\n\n              const fileInput = document.createElement('input');\n              fileInput.type = 'file';\n              fileInput.accept =\n                '.csv,.xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/csv';\n\n              const modal = UIComponents.showModal({\n                title: 'Import Cases',\n                content,\n                actions: [{ label: 'Close', variant: 'primary' }],\n              });\n\n              browseBtn.addEventListener('click', () => fileInput.click());\n\n              drop.addEventListener('dragover', ev => {\n                ev.preventDefault();\n                drop.style.borderColor = 'rgba(255, 159, 28, 0.6)';\n              });\n              drop.addEventListener('dragleave', () => {\n                drop.style.borderColor = 'var(--border-subtle)';\n              });\n              drop.addEventListener('drop', ev => {\n                ev.preventDefault();\n                drop.style.borderColor = 'var(--border-subtle)';\n                const file = ev.dataTransfer && ev.dataTransfer.files && ev.dataTransfer.files[0];\n                if (file) handleFile(file, results, modal);\n              });\n\n              fileInput.addEventListener('change', () => {\n                const file = fileInput.files && fileInput.files[0];\n                if (file) handleFile(file, results, modal);\n              });\n            }\n\n            async function handleFile(file, resultsEl, modal) {\n              try {\n                const parsed = await parseAndValidateSpreadsheet(file);\n                resultsEl.style.display = 'block';\n                resultsEl.innerHTML = '';\n\n                const summary = document.createElement('div');\n                summary.className = 'card';\n                summary.innerHTML = `\n                <div style=\"font-weight:var(--font-semibold);margin-bottom:6px\">Import Preview</div>\n                <div class=\"muted\" style=\"font-size:var(--text-sm)\">File: ${escapeHtml(file.name)}</div>\n                <div style=\"height:8px\"></div>\n                <div style=\"display:flex;gap:12px;flex-wrap:wrap\">\n                  <div class=\"badge\" style=\"border-color:rgba(16,185,129,.25);background:rgba(16,185,129,.12);color:var(--text-primary)\">✓ Valid: ${parsed.valid.length}</div>\n                  <div class=\"badge\" style=\"border-color:rgba(245,158,11,.25);background:rgba(245,158,11,.12);color:var(--text-primary)\">↷ Duplicates skipped: ${parsed.duplicates.length}</div>\n                  <div class=\"badge\" style=\"border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.12);color:var(--text-primary)\">⚠ Invalid: ${parsed.errors.length}</div>\n                </div>\n              `;\n\n                const actionsRow = document.createElement('div');\n                actionsRow.className = 'row';\n                actionsRow.style.justifyContent = 'flex-end';\n                actionsRow.style.marginTop = '12px';\n                const btn = document.createElement('button');\n                btn.className = 'btn btn-primary';\n                btn.type = 'button';\n                btn.textContent = 'Import valid rows';\n                btn.disabled = parsed.valid.length === 0;\n                btn.addEventListener('click', () => {\n                  importRows(parsed.valid);\n                  modal.close();\n                });\n                actionsRow.appendChild(btn);\n                summary.appendChild(actionsRow);\n\n                resultsEl.appendChild(summary);\n\n                if (parsed.errors.length) {\n                  const err = document.createElement('div');\n                  err.className = 'card';\n                  err.innerHTML = '<div style=\"font-weight:var(--font-semibold);margin-bottom:6px\">Errors</div>';\n                  const ul = document.createElement('ul');\n                  ul.style.margin = '8px 0 0 16px';\n                  ul.style.color = 'var(--text-secondary)';\n                  ul.style.fontSize = 'var(--text-sm)';\n                  parsed.errors.slice(0, 12).forEach(e => {\n                    const li = document.createElement('li');\n                    li.textContent = e;\n                    ul.appendChild(li);\n                  });\n                  if (parsed.errors.length > 12) {\n                    const li = document.createElement('li');\n                    li.textContent = `...and ${parsed.errors.length - 12} more`;\n                    ul.appendChild(li);\n                  }\n                  err.appendChild(ul);\n                  resultsEl.appendChild(err);\n                }\n\n                const preview = document.createElement('div');\n                preview.className = 'card';\n                preview.innerHTML =\n                  '<div style=\"font-weight:var(--font-semibold);margin-bottom:6px\">Preview (first 5 valid rows)</div>';\n                const p = document.createElement('div');\n                p.className = 'muted';\n                p.style.fontSize = 'var(--text-sm)';\n                p.style.display = 'grid';\n                p.style.gap = '6px';\n                parsed.valid.slice(0, 5).forEach(r => {\n                  p.appendChild(\n                    document.createTextNode(`${r.name} • ${r.length}×${r.width}×${r.height} • ${r.category}`)\n                  );\n                  p.appendChild(document.createElement('br'));\n                });\n                preview.appendChild(p);\n                resultsEl.appendChild(preview);\n              } catch (err) {\n                UIComponents.showToast('Import failed: ' + err.message, 'error');\n              }\n            }\n\n            function escapeHtml(s) {\n              return String(s || '').replace(\n                /[&<>\"']/g,\n                c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '\"': '&quot;', \"'\": '&#39;' })[c]\n              );\n            }\n\n            function importRows(rows) {\n              const now = Date.now();\n              const existingNames = new Set(\n                CaseLibrary.getCases().map(c =>\n                  String(c.name || '')\n                    .trim()\n                    .toLowerCase()\n                )\n              );\n              const next = [...CaseLibrary.getCases()];\n              let added = 0;\n              rows.forEach(r => {\n                const nameKey = String(r.name || '')\n                  .trim()\n                  .toLowerCase();\n                if (!nameKey || existingNames.has(nameKey)) return;\n                existingNames.add(nameKey);\n                const meta = CategoryService.meta(r.category || 'default');\n                next.push({\n                  id: Utils.uuid(),\n                  name: String(r.name || '').trim(),\n                  manufacturer: String(r.manufacturer || '').trim(),\n                  category:\n                    String(r.category || 'default')\n                      .trim()\n                      .toLowerCase() || 'default',\n                  dimensions: { length: Number(r.length), width: Number(r.width), height: Number(r.height) },\n                  weight: Number(r.weight) || 0,\n                  volume: Utils.volumeInCubicInches({\n                    length: Number(r.length),\n                    width: Number(r.width),\n                    height: Number(r.height),\n                  }),\n                  canFlip: Boolean(r.canFlip),\n                  notes: String(r.notes || '').trim(),\n                  color: normalizeHex(r.color) || normalizeHex(meta.color) || '#ff9f1c',\n                  createdAt: now,\n                  updatedAt: now,\n                });\n                added++;\n              });\n              StateStore.set({ caseLibrary: next });\n              UIComponents.showToast(`Imported ${added} case(s)`, added ? 'success' : 'warning');\n            }\n\n            async function parseAndValidateSpreadsheet(file) {\n              if (!window.XLSX) throw new Error('XLSX library not available');\n              const ext = String(file.name || '')\n                .split('.')\n                .pop()\n                .toLowerCase();\n              let workbook;\n              if (ext === 'csv') {\n                const text = await file.text();\n                workbook = window.XLSX.read(text, { type: 'string' });\n              } else {\n                const buf = await file.arrayBuffer();\n                workbook = window.XLSX.read(buf, { type: 'array' });\n              }\n              const sheetName = workbook.SheetNames[0];\n              const sheet = workbook.Sheets[sheetName];\n              const rows = window.XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });\n              if (!rows || !rows.length) throw new Error('Empty file');\n\n              const headerRow = rows[0].map(h => String(h || '').trim());\n              const header = headerRow.map(normalizeHeader);\n              const idx = indexMap(header);\n\n              const required = ['name', 'length', 'width', 'height'];\n              const missing = required.filter(r => idx[r] == null);\n              if (missing.length) throw new Error('Missing required columns: ' + missing.join(', '));\n\n              const existingNames = new Set(\n                CaseLibrary.getCases().map(c =>\n                  String(c.name || '')\n                    .trim()\n                    .toLowerCase()\n                )\n              );\n              const errors = [];\n              const duplicates = [];\n              const valid = [];\n\n              for (let r = 1; r < rows.length; r++) {\n                const row = rows[r];\n                if (!row || row.every(v => String(v || '').trim() === '')) continue;\n                const rowNum = r + 1;\n                const record = {\n                  name: String(getField(row, idx.name)).trim(),\n                  manufacturer: String(getField(row, idx.manufacturer)).trim(),\n                  category: String(getField(row, idx.category)).trim().toLowerCase() || 'default',\n                  length: Number(getField(row, idx.length)),\n                  width: Number(getField(row, idx.width)),\n                  height: Number(getField(row, idx.height)),\n                  weight: Number(getField(row, idx.weight)),\n                  canFlip: parseBool(getField(row, idx.canFlip)),\n                  notes: String(getField(row, idx.notes)).trim(),\n                  color: String(getField(row, idx.color)).trim(),\n                };\n\n                const rowErrors = [];\n                if (!record.name) rowErrors.push(`Row ${rowNum}: Missing required field 'name'`);\n                if (!Number.isFinite(record.length) || record.length <= 0)\n                  {rowErrors.push(`Row ${rowNum}: Invalid number for 'length'`);}\n                if (!Number.isFinite(record.width) || record.width <= 0)\n                  {rowErrors.push(`Row ${rowNum}: Invalid number for 'width'`);}\n                if (!Number.isFinite(record.height) || record.height <= 0)\n                  {rowErrors.push(`Row ${rowNum}: Invalid number for 'height'`);}\n\n                const nameKey = record.name.toLowerCase();\n                if (record.name && existingNames.has(nameKey)) {\n                  duplicates.push(`Row ${rowNum}: Duplicate name \"${record.name}\" (skipped)`);\n                  continue;\n                }\n\n                if (rowErrors.length) {\n                  errors.push(...rowErrors);\n                  continue;\n                }\n                valid.push(record);\n              }\n\n              return { valid, errors, duplicates };\n            }\n\n            function normalizeHeader(s) {\n              return String(s || '')\n                .toLowerCase()\n                .replace(/[^a-z0-9]+/g, '');\n            }\n\n            function indexMap(headers) {\n              const find = candidates => {\n                for (const c of candidates) {\n                  const idx = headers.indexOf(c);\n                  if (idx > -1) return idx;\n                }\n                return null;\n              };\n              return {\n                name: find(['name', 'casename', 'item', 'title']),\n                manufacturer: find(['manufacturer', 'mfg', 'brand']),\n                category: find(['category', 'cat', 'type']),\n                length: find(['length', 'l']),\n                width: find(['width', 'w']),\n                height: find(['height', 'h']),\n                weight: find(['weight', 'wt']),\n                canFlip: find(['canflip', 'flippable', 'canrotate', 'flip']),\n                notes: find(['notes', 'note', 'description', 'desc']),\n                color: find(['color', 'hex', 'casecolor']),\n              };\n            }\n\n            function getField(row, idx) {\n              if (idx == null) return '';\n              return row[idx];\n            }\n\n            function parseBool(v) {\n              const s = String(v || '')\n                .trim()\n                .toLowerCase();\n              if (!s) return false;\n              return ['true', '1', 'yes', 'y', 'on'].includes(s);\n            }\n\n            return { init, render };\n          })();\n\n          const SceneManager = (() => {\n            const INCH_TO_WORLD = 0.05;\n            const WORLD_TO_INCH = 1 / INCH_TO_WORLD;\n            let containerEl = null;\n            let scene = null;\n            let camera = null;\n            let renderer = null;\n            let controls = null;\n            let truck = null;\n            let truckBoundsWorld = null;\n            let truckSignature = '';\n            let grid = null;\n            let ground = null;\n            let axisScene = null;\n            let axisCamera = null;\n            let axisHelper = null;\n            const perf = { lastTime: 0, lowMs: 0, perfMode: false, fps: 60 };\n            let viewSize = { width: 1, height: 1 };\n\n            // Dev-only performance overlay\n            const DevOverlay = (() => {\n              let overlayEl = null;\n              let visible = false;\n              const stats = { fps: 0, frameTime: 0, memory: 0, drawCalls: 0, triangles: 0, geometries: 0, textures: 0 };\n              let lastLogTime = 0;\n\n              function create() {\n                if (overlayEl) return;\n                overlayEl = document.createElement('div');\n                overlayEl.style.cssText = `\n                position: fixed;\n                top: 10px;\n                right: 10px;\n                background: rgba(0, 0, 0, 0.85);\n                color: #0f0;\n                font-family: 'Courier New', monospace;\n                font-size: 11px;\n                padding: 8px 12px;\n                border-radius: 4px;\n                z-index: 10000;\n                line-height: 1.5;\n                pointer-events: none;\n                display: none;\n                min-width: 180px;\n                box-shadow: 0 2px 8px rgba(0,0,0,0.5);\n              `;\n                document.body.appendChild(overlayEl);\n              }\n\n              function toggle() {\n                create();\n                visible = !visible;\n                overlayEl.style.display = visible ? 'block' : 'none';\n                if (visible) {\n                  console.log('[DevOverlay] Performance monitoring enabled (press P to toggle)');\n                }\n              }\n\n              function update(time, rendererInfo) {\n                if (!visible || !overlayEl) return;\n\n                stats.fps = Math.round(perf.fps);\n                stats.frameTime = Math.round((1000 / perf.fps) * 10) / 10;\n\n                if (rendererInfo) {\n                  stats.drawCalls = rendererInfo.render.calls;\n                  stats.triangles = rendererInfo.render.triangles;\n                  stats.geometries = rendererInfo.memory.geometries;\n                  stats.textures = rendererInfo.memory.textures;\n                }\n\n                if (performance.memory) {\n                  stats.memory = Math.round(performance.memory.usedJSHeapSize / 1048576);\n                }\n\n                const fpsColor = stats.fps >= 55 ? '#0f0' : stats.fps >= 30 ? '#ff0' : '#f00';\n                overlayEl.innerHTML = `\n                <div style=\"color: ${fpsColor}; font-weight: bold;\">FPS: ${stats.fps}</div>\n                <div>Frame: ${stats.frameTime}ms</div>\n                ${stats.memory ? `<div>Memory: ${stats.memory}MB</div>` : ''}\n                <div style=\"margin-top: 4px; border-top: 1px solid #333; padding-top: 4px;\">\n                  <div>Calls: ${stats.drawCalls}</div>\n                  <div>Tris: ${stats.triangles}</div>\n                  <div>Geom: ${stats.geometries}</div>\n                  <div>Tex: ${stats.textures}</div>\n                </div>\n              `;\n\n                // Log stats every 10 seconds\n                if (time - lastLogTime > 10000) {\n                  lastLogTime = time;\n                  console.log('[DevOverlay] Stats:', {\n                    fps: stats.fps,\n                    frameTime: stats.frameTime + 'ms',\n                    memory: stats.memory ? stats.memory + 'MB' : 'N/A',\n                    renderer: {\n                      drawCalls: stats.drawCalls,\n                      triangles: stats.triangles,\n                      geometries: stats.geometries,\n                      textures: stats.textures,\n                    },\n                  });\n                }\n              }\n\n              function isVisible() {\n                return visible;\n              }\n\n              return { toggle, update, isVisible };\n            })();\n\n            function toWorld(inches) {\n              return Number(inches) * INCH_TO_WORLD;\n            }\n\n            function toInches(worldUnits) {\n              return Number(worldUnits) * WORLD_TO_INCH;\n            }\n\n            function vecInchesToWorld(pos) {\n              return new THREE.Vector3(toWorld(pos.x), toWorld(pos.y), toWorld(pos.z));\n            }\n\n            function vecWorldToInches(vec) {\n              return { x: toInches(vec.x), y: toInches(vec.y), z: toInches(vec.z) };\n            }\n\n            function init(viewportEl) {\n              if (renderer) return;\n              containerEl = viewportEl;\n              containerEl.innerHTML = '';\n\n              scene = new THREE.Scene();\n              refreshTheme();\n\n              const { width, height } = getContainerSize();\n              camera = new THREE.PerspectiveCamera(50, width / height, 0.01, 5000);\n              camera.position.set(22, 16, 22);\n\n              renderer = new THREE.WebGLRenderer({\n                antialias: true,\n                alpha: false,\n                powerPreference: 'high-performance',\n              });\n              renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));\n              renderer.setSize(width, height);\n              viewSize = { width, height };\n              renderer.shadowMap.enabled = true;\n              renderer.shadowMap.type = THREE.PCFSoftShadowMap;\n              containerEl.appendChild(renderer.domElement);\n\n              controls = new THREE.OrbitControls(camera, renderer.domElement);\n              controls.enableDamping = true;\n              controls.dampingFactor = 0.06;\n              controls.minDistance = 6;\n              controls.maxDistance = 220;\n              controls.maxPolarAngle = Math.PI / 2 - 0.02;\n              controls.target.set(14, 2, 0);\n\n              addLighting();\n              addEnvironment();\n              addAxisWidget();\n\n              // Default truck size (53ft trailer)\n              setTruck({ length: 636, width: 102, height: 98 });\n\n              requestAnimationFrame(tick);\n            }\n\n            function getContainerSize() {\n              const rect = containerEl.getBoundingClientRect();\n              const width = Math.max(10, Math.floor(rect.width));\n              const height = Math.max(10, Math.floor(rect.height));\n              return { width, height };\n            }\n\n            function addLighting() {\n              const ambient = new THREE.AmbientLight(0xffffff, 0.62);\n              scene.add(ambient);\n\n              const dir = new THREE.DirectionalLight(0xffffff, 0.9);\n              dir.position.set(30, 60, 25);\n              dir.castShadow = true;\n              dir.shadow.mapSize.width = 1024;\n              dir.shadow.mapSize.height = 1024;\n              dir.shadow.camera.left = -80;\n              dir.shadow.camera.right = 80;\n              dir.shadow.camera.top = 80;\n              dir.shadow.camera.bottom = -80;\n              scene.add(dir);\n\n              const hemi = new THREE.HemisphereLight(0x87ceeb, 0x2d2d2d, 0.25);\n              scene.add(hemi);\n            }\n\n            function addEnvironment() {\n              const groundGeo = new THREE.PlaneGeometry(260, 260);\n              const groundMat = new THREE.ShadowMaterial({ opacity: 0.18 });\n              ground = new THREE.Mesh(groundGeo, groundMat);\n              ground.rotation.x = -Math.PI / 2;\n              ground.receiveShadow = true;\n              scene.add(ground);\n\n              grid = new THREE.GridHelper(220, 110);\n              grid.name = 'grid';\n              scene.add(grid);\n              refreshTheme();\n            }\n\n            function addAxisWidget() {\n              axisScene = new THREE.Scene();\n              axisCamera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);\n              axisHelper = new THREE.AxesHelper(3.2);\n              axisScene.add(axisHelper);\n            }\n\n            function tick(time) {\n              requestAnimationFrame(tick);\n              if (StateStore.get('currentScreen') !== 'editor') return;\n              if (controls) controls.update();\n              if (window.TWEEN) window.TWEEN.update(time);\n              updatePerf(time);\n              render();\n              if (DevOverlay.isVisible() && renderer) {\n                DevOverlay.update(time, renderer.info);\n              }\n            }\n\n            function updatePerf(time) {\n              if (!perf.lastTime) {\n                perf.lastTime = time;\n                return;\n              }\n              const dt = Math.max(1, time - perf.lastTime);\n              perf.lastTime = time;\n              const fps = 1000 / dt;\n              perf.fps = perf.fps * 0.9 + fps * 0.1;\n              if (perf.fps < 30) perf.lowMs += dt;\n              else perf.lowMs = 0;\n\n              if (!perf.perfMode && perf.lowMs > 5000) {\n                perf.perfMode = true;\n                renderer.shadowMap.enabled = false;\n                UIComponents.showToast('Performance mode enabled (shadows disabled)', 'warning', {\n                  title: 'Performance',\n                  actions: [\n                    {\n                      label: 'Restore',\n                      onClick: () => {\n                        perf.perfMode = false;\n                        perf.lowMs = 0;\n                        renderer.shadowMap.enabled = true;\n                      },\n                    },\n                  ],\n                });\n              }\n            }\n\n            function render() {\n              if (!renderer || !scene || !camera) return;\n              const width = viewSize.width;\n              const height = viewSize.height;\n              renderer.setViewport(0, 0, width, height);\n              renderer.setScissorTest(false);\n              renderer.render(scene, camera);\n\n              // Axis widget render (top-right)\n              renderer.clearDepth();\n              const size = Math.max(90, Math.floor(Math.min(width, height) * 0.2));\n              const pad = 12;\n              renderer.setScissorTest(true);\n              renderer.setViewport(width - size - pad, pad, size, size);\n              renderer.setScissor(width - size - pad, pad, size, size);\n              axisCamera.position.copy(camera.position).sub(controls.target).setLength(8);\n              axisCamera.lookAt(axisScene.position);\n              renderer.render(axisScene, axisCamera);\n              renderer.setScissorTest(false);\n            }\n\n            function resize() {\n              if (!renderer || !camera || !containerEl) return;\n              const { width, height } = getContainerSize();\n              if (width === viewSize.width && height === viewSize.height) return;\n              viewSize = { width, height };\n              camera.aspect = width / height;\n              camera.updateProjectionMatrix();\n              renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));\n              renderer.setSize(width, height);\n            }\n\n            function refreshTheme() {\n              if (!scene) return;\n              const bgHex = Utils.getCssVar('--bg-primary');\n              scene.background = new THREE.Color(Utils.cssHexToInt(bgHex));\n              if (grid && grid.material) {\n                const gridMat = grid.material;\n                const mainColor = new THREE.Color(Utils.cssHexToInt(Utils.getCssVar('--accent-primary')));\n                const subColor = new THREE.Color(Utils.cssHexToInt(Utils.getCssVar('--border-strong')));\n                if (Array.isArray(gridMat)) {\n                  if (gridMat[0]) gridMat[0].color = mainColor;\n                  if (gridMat[1]) gridMat[1].color = subColor;\n                } else {\n                  gridMat.color = subColor;\n                }\n              }\n            }\n\n            function setTruck(truckInches) {\n              if (!scene) return;\n              const sig = `${truckInches.length}x${truckInches.width}x${truckInches.height}`;\n              const lengthW = toWorld(truckInches.length);\n              const widthW = toWorld(truckInches.width);\n              const heightW = toWorld(truckInches.height);\n\n              if (truck && truckSignature === sig) {\n                truckBoundsWorld = new THREE.Box3(\n                  new THREE.Vector3(0, 0, -widthW / 2),\n                  new THREE.Vector3(lengthW, heightW, widthW / 2)\n                );\n                controls.target.set(lengthW / 2, Math.min(6, heightW / 2), 0);\n                return;\n              }\n              truckSignature = sig;\n\n              if (truck) {\n                scene.remove(truck);\n                truck.traverse(obj => {\n                  if (obj.geometry) obj.geometry.dispose();\n                  if (obj.material) obj.material.dispose();\n                });\n                truck = null;\n              }\n\n              truck = new THREE.Group();\n              truck.name = 'truck';\n\n              const geo = new THREE.BoxGeometry(lengthW, heightW, widthW);\n              const mat = new THREE.MeshStandardMaterial({\n                color: new THREE.Color(Utils.cssHexToInt(Utils.getCssVar('--accent-primary'))),\n                transparent: true,\n                opacity: 0.09,\n                side: THREE.DoubleSide,\n              });\n              const mesh = new THREE.Mesh(geo, mat);\n              mesh.position.set(lengthW / 2, heightW / 2, 0);\n              mesh.receiveShadow = false;\n              truck.add(mesh);\n\n              const edges = new THREE.EdgesGeometry(geo);\n              const lineMat = new THREE.LineBasicMaterial({\n                color: new THREE.Color(Utils.cssHexToInt(Utils.getCssVar('--accent-primary'))),\n              });\n              const wire = new THREE.LineSegments(edges, lineMat);\n              wire.position.copy(mesh.position);\n              truck.add(wire);\n\n              scene.add(truck);\n\n              truckBoundsWorld = new THREE.Box3(\n                new THREE.Vector3(0, 0, -widthW / 2),\n                new THREE.Vector3(lengthW, heightW, widthW / 2)\n              );\n\n              // Move camera target near the center of the truck\n              controls.target.set(lengthW / 2, Math.min(6, heightW / 2), 0);\n            }\n\n            function focusOnWorldPoint(targetWorld, options = {}) {\n              if (!controls || !camera) return;\n              const duration = Number(options.duration) || 700;\n              const nextTarget = targetWorld.clone();\n              const dir = camera.position.clone().sub(controls.target);\n              const nextPos = nextTarget.clone().add(dir);\n              new TWEEN.Tween(controls.target)\n                .to({ x: nextTarget.x, y: nextTarget.y, z: nextTarget.z }, duration)\n                .easing(TWEEN.Easing.Cubic.InOut)\n                .start();\n              new TWEEN.Tween(camera.position)\n                .to({ x: nextPos.x, y: nextPos.y, z: nextPos.z }, duration)\n                .easing(TWEEN.Easing.Cubic.InOut)\n                .start();\n            }\n\n            function getTruckBoundsWorld() {\n              return truckBoundsWorld;\n            }\n\n            function toggleGrid() {\n              if (!grid) return false;\n              grid.visible = !grid.visible;\n              return grid.visible;\n            }\n\n            function toggleShadows() {\n              if (!renderer) return false;\n              renderer.shadowMap.enabled = !renderer.shadowMap.enabled;\n              return renderer.shadowMap.enabled;\n            }\n\n            return {\n              init,\n              resize,\n              refreshTheme,\n              setTruck,\n              focusOnWorldPoint,\n              toggleGrid,\n              toggleShadows,\n              toggleDevOverlay: () => DevOverlay.toggle(),\n              getScene: () => scene,\n              getCamera: () => camera,\n              getRenderer: () => renderer,\n              getControls: () => controls,\n              getTruckBoundsWorld,\n              toWorld,\n              toInches,\n              vecInchesToWorld,\n              vecWorldToInches,\n              getPerf: () => ({ ...perf }),\n            };\n          })();\n\n          const CaseScene = (() => {\n            const instances = new Map(); // instanceId -> THREE.Group\n            let hoveredId = null;\n            let draggedId = null;\n            let selectedIds = new Set();\n\n            function clear() {\n              const scene = SceneManager.getScene();\n              if (!scene) return;\n              instances.forEach(group => disposeGroup(scene, group));\n              instances.clear();\n              hoveredId = null;\n              draggedId = null;\n              selectedIds = new Set();\n            }\n\n            function sync(pack) {\n              const scene = SceneManager.getScene();\n              if (!scene) return;\n              if (!pack) {\n                clear();\n                return;\n              }\n\n              const keep = new Set();\n              (pack.cases || []).forEach(inst => {\n                keep.add(inst.id);\n                const caseData = CaseLibrary.getById(inst.caseId);\n                if (!caseData) return;\n\n                const signature = buildSignature(inst, caseData);\n                const existing = instances.get(inst.id);\n                if (!existing || existing.userData.signature !== signature) {\n                  if (existing) disposeGroup(scene, existing);\n                  const group = createInstanceGroup(inst, caseData);\n                  instances.set(inst.id, group);\n                  scene.add(group);\n                }\n\n                const group = instances.get(inst.id);\n                applyTransform(group, inst);\n                applyHidden(group, inst.hidden);\n              });\n\n              // Remove old\n              Array.from(instances.keys()).forEach(id => {\n                if (keep.has(id)) return;\n                disposeGroup(scene, instances.get(id));\n                instances.delete(id);\n              });\n\n              applySelection(Array.from(selectedIds));\n              applyHover(hoveredId);\n              applyDragging(draggedId);\n            }\n\n            function buildSignature(inst, caseData) {\n              const d = caseData.dimensions || { length: 0, width: 0, height: 0 };\n              const color = String(caseData.color || CategoryService.meta(caseData.category).color || '#ff9f1c');\n              return `${caseData.id}:${d.length}x${d.width}x${d.height}:${color}`;\n            }\n\n            function createInstanceGroup(inst, caseData) {\n              const group = new THREE.Group();\n              group.userData.instanceId = inst.id;\n              group.userData.caseId = inst.caseId;\n              group.userData.signature = buildSignature(inst, caseData);\n\n              const dims = caseData.dimensions || { length: 1, width: 1, height: 1 };\n              const lengthW = SceneManager.toWorld(dims.length);\n              const widthW = SceneManager.toWorld(dims.width);\n              const heightW = SceneManager.toWorld(dims.height);\n              group.userData.halfWorld = { x: lengthW / 2, y: heightW / 2, z: widthW / 2 };\n\n              const baseColor = String(caseData.color || CategoryService.meta(caseData.category).color || '#ff9f1c');\n              group.userData.baseColor = baseColor;\n\n              const geo = new THREE.BoxGeometry(lengthW, heightW, widthW);\n              const mat = new THREE.MeshStandardMaterial({\n                color: new THREE.Color(baseColor),\n                roughness: 0.65,\n                metalness: 0.12,\n                emissive: new THREE.Color(0x000000),\n              });\n              const mesh = new THREE.Mesh(geo, mat);\n              mesh.castShadow = true;\n              mesh.receiveShadow = true;\n              mesh.userData.instanceId = inst.id;\n              group.userData.mesh = mesh;\n              group.add(mesh);\n\n              const edges = new THREE.EdgesGeometry(geo);\n              const edgeColor = new THREE.Color(baseColor);\n              edgeColor.multiplyScalar(0.68);\n              const lineMat = new THREE.LineBasicMaterial({ color: edgeColor, transparent: true, opacity: 0.95 });\n              const lines = new THREE.LineSegments(edges, lineMat);\n              group.userData.lines = lines;\n              group.add(lines);\n\n              return group;\n            }\n\n            function disposeGroup(scene, group) {\n              if (!group) return;\n              scene.remove(group);\n              group.traverse(obj => {\n                if (obj.geometry) obj.geometry.dispose();\n                if (obj.material) obj.material.dispose();\n              });\n            }\n\n            function applyTransform(group, inst) {\n              if (!group || !inst || !inst.transform) return;\n              const pos = inst.transform.position || { x: 0, y: 0, z: 0 };\n              const rot = inst.transform.rotation || { x: 0, y: 0, z: 0 };\n              group.position.copy(SceneManager.vecInchesToWorld(pos));\n              group.rotation.set(Number(rot.x) || 0, Number(rot.y) || 0, Number(rot.z) || 0);\n            }\n\n            function applyHidden(group, hidden) {\n              if (!group || !group.userData.mesh) return;\n              const prefs = PreferencesManager.get();\n              const mesh = group.userData.mesh;\n              const lines = group.userData.lines;\n              if (hidden) {\n                mesh.material.transparent = true;\n                mesh.material.opacity = Utils.clamp(Number(prefs.hiddenCaseOpacity) || 0.3, 0, 1);\n                mesh.material.depthWrite = false;\n                if (lines && lines.material) {\n                  lines.material.transparent = true;\n                  lines.material.opacity = Math.max(0.25, mesh.material.opacity);\n                }\n              } else {\n                mesh.material.transparent = false;\n                mesh.material.opacity = 1;\n                mesh.material.depthWrite = true;\n                if (lines && lines.material) {\n                  lines.material.transparent = true;\n                  lines.material.opacity = 0.95;\n                }\n              }\n            }\n\n            function applySelection(ids) {\n              selectedIds = new Set(ids || []);\n              instances.forEach(group => {\n                const mesh = group.userData.mesh;\n                if (!mesh || !mesh.material) return;\n                const isSelected = selectedIds.has(group.userData.instanceId);\n                mesh.material.emissive.setHex(\n                  isSelected ? Utils.cssHexToInt(Utils.getCssVar('--accent-primary')) : 0x000000\n                );\n              });\n            }\n\n            function applyHover(instanceId) {\n              hoveredId = instanceId || null;\n              instances.forEach(group => {\n                const mesh = group.userData.mesh;\n                if (!mesh || !mesh.material) return;\n                if (\n                  group.userData.instanceId === hoveredId &&\n                  !selectedIds.has(hoveredId) &&\n                  group.userData.instanceId !== draggedId\n                ) {\n                  mesh.material.emissive.setHex(0x333333);\n                } else if (!selectedIds.has(group.userData.instanceId) && group.userData.instanceId !== draggedId) {\n                  mesh.material.emissive.setHex(0x000000);\n                }\n              });\n            }\n\n            function applyDragging(instanceId) {\n              draggedId = instanceId || null;\n              instances.forEach(group => {\n                const mesh = group.userData.mesh;\n                if (!mesh || !mesh.material) return;\n                if (group.userData.instanceId === draggedId) {\n                  mesh.material.transparent = true;\n                  mesh.material.opacity = 0.72;\n                  mesh.material.emissive.setHex(0x111111);\n                }\n              });\n            }\n\n            function setCollision(instanceId, isCollision) {\n              const group = instances.get(instanceId);\n              if (!group || !group.userData.mesh) return;\n              const mesh = group.userData.mesh;\n              if (isCollision) {mesh.material.emissive.setHex(0xff0000);}\n              else if (selectedIds.has(instanceId))\n                {mesh.material.emissive.setHex(Utils.cssHexToInt(Utils.getCssVar('--accent-primary')));}\n              else {mesh.material.emissive.setHex(0x000000);}\n            }\n\n            function setHover(instanceId) {\n              applyHover(instanceId);\n            }\n\n            function setSelected(instanceIds) {\n              applySelection(instanceIds);\n              applyHover(hoveredId);\n            }\n\n            function setDragging(instanceId) {\n              applyDragging(instanceId);\n              applyHover(hoveredId);\n              applySelection(Array.from(selectedIds));\n            }\n\n            function getObject(instanceId) {\n              return instances.get(instanceId) || null;\n            }\n\n            function getRaycastMeshes() {\n              const meshes = [];\n              instances.forEach(group => {\n                if (group.userData.mesh) meshes.push(group.userData.mesh);\n              });\n              return meshes;\n            }\n\n            function getAabbWorld(instanceId, positionOverrideWorld) {\n              const group = instances.get(instanceId);\n              if (!group) return null;\n              const half = group.userData.halfWorld;\n              if (!half) return null;\n              const p = positionOverrideWorld || group.position;\n              return {\n                min: { x: p.x - half.x, y: p.y - half.y, z: p.z - half.z },\n                max: { x: p.x + half.x, y: p.y + half.y, z: p.z + half.z },\n              };\n            }\n\n            function aabbIntersects(a, b) {\n              const EPS = 1e-6;\n              return (\n                a.min.x < b.max.x - EPS &&\n                a.max.x > b.min.x + EPS &&\n                a.min.y < b.max.y - EPS &&\n                a.max.y > b.min.y + EPS &&\n                a.min.z < b.max.z - EPS &&\n                a.max.z > b.min.z + EPS\n              );\n            }\n\n            function isInsideTruck(aabb) {\n              const bounds = SceneManager.getTruckBoundsWorld();\n              if (!bounds) return false;\n              return (\n                aabb.min.x >= bounds.min.x &&\n                aabb.max.x <= bounds.max.x &&\n                aabb.min.y >= bounds.min.y &&\n                aabb.max.y <= bounds.max.y &&\n                aabb.min.z >= bounds.min.z &&\n                aabb.max.z <= bounds.max.z\n              );\n            }\n\n            function checkCollision(instanceId, candidateWorldPos) {\n              const aabb = getAabbWorld(instanceId, candidateWorldPos);\n              if (!aabb) return { collides: false, insideTruck: false };\n              const insideTruck = isInsideTruck(aabb);\n              for (const [otherId] of instances.entries()) {\n                if (otherId === instanceId) continue;\n                const otherAabb = getAabbWorld(otherId);\n                if (!otherAabb) continue;\n                if (aabbIntersects(aabb, otherAabb)) return { collides: true, insideTruck };\n              }\n              return { collides: false, insideTruck };\n            }\n\n            return {\n              clear,\n              sync,\n              setHover,\n              setSelected,\n              setDragging,\n              setCollision,\n              getObject,\n              getRaycastMeshes,\n              getAabbWorld,\n              checkCollision,\n              isInsideTruck,\n            };\n          })();\n\n          const InteractionManager = (() => {\n            const raycaster = new THREE.Raycaster();\n            const pointer = new THREE.Vector2();\n            const dragPlane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);\n            const dragOffset = new THREE.Vector3();\n            const tmpVec3 = new THREE.Vector3();\n\n            let domEl = null;\n            let hoveredId = null;\n            let pressed = null;\n            let draggingId = null;\n            let dragStartPosWorld = null;\n            let lastRaycastTime = 0;\n            const RAYCAST_THROTTLE = 50; // ms - throttle hover raycasts\n\n            function init(canvasEl) {\n              domEl = canvasEl;\n              domEl.style.touchAction = 'none';\n              domEl.addEventListener('pointermove', onMove);\n              domEl.addEventListener('pointerdown', onDown);\n              window.addEventListener('pointerup', onUp);\n              domEl.addEventListener('dblclick', onDblClick);\n            }\n\n            function onMove(ev) {\n              if (!isEditorActive()) return;\n              updatePointer(ev);\n\n              if (pressed && !draggingId) {\n                const dx = ev.clientX - pressed.clientX;\n                const dy = ev.clientY - pressed.clientY;\n                if (Math.hypot(dx, dy) > 3) startDrag();\n              }\n\n              if (draggingId) {\n                updateDrag();\n                return;\n              }\n\n              // Throttle hover raycasts to avoid performance hits\n              const now = performance.now();\n              if (now - lastRaycastTime < RAYCAST_THROTTLE) return;\n              lastRaycastTime = now;\n\n              const hit = raycastFirst();\n              const nextHover = hit ? hit.instanceId : null;\n              if (nextHover !== hoveredId) {\n                hoveredId = nextHover;\n                CaseScene.setHover(hoveredId);\n                domEl.style.cursor = hoveredId ? 'grab' : 'default';\n              }\n            }\n\n            function onDown(ev) {\n              if (!isEditorActive()) return;\n              if (ev.button !== 0) return;\n              updatePointer(ev);\n              const hit = raycastFirst();\n\n              if (hit) {\n                const instanceId = hit.instanceId;\n                pressed = {\n                  instanceId,\n                  pointWorld: hit.pointWorld.clone(),\n                  clientX: ev.clientX,\n                  clientY: ev.clientY,\n                  shift: Boolean(ev.shiftKey),\n                };\n                domEl.setPointerCapture(ev.pointerId);\n                domEl.style.cursor = 'grabbing';\n              } else {\n                pressed = {\n                  instanceId: null,\n                  clientX: ev.clientX,\n                  clientY: ev.clientY,\n                  shift: Boolean(ev.shiftKey),\n                };\n              }\n            }\n\n            function onUp() {\n              if (!isEditorActive()) return;\n              if (!pressed && !draggingId) return;\n\n              if (draggingId) {\n                finishDrag();\n                return;\n              }\n\n              // Click selection\n              if (!pressed.instanceId) {\n                if (!pressed.shift) setSelection([]);\n                pressed = null;\n                return;\n              }\n              const current = getSelection();\n              const id = pressed.instanceId;\n              if (pressed.shift) {\n                if (current.includes(id)) setSelection(current.filter(x => x !== id));\n                else setSelection([...current, id]);\n              } else {\n                setSelection([id]);\n              }\n              pressed = null;\n            }\n\n            function onDblClick(ev) {\n              if (!isEditorActive()) return;\n              updatePointer(ev);\n              const hit = raycastFirst();\n              if (!hit) return;\n              SceneManager.focusOnWorldPoint(hit.pointWorld, { duration: 700 });\n            }\n\n            function startDrag() {\n              if (!pressed || !pressed.instanceId) return;\n              draggingId = pressed.instanceId;\n              dragStartPosWorld = CaseScene.getObject(draggingId).position.clone();\n\n              // Ensure selected\n              const current = getSelection();\n              if (!current.includes(draggingId)) {\n                if (pressed.shift) setSelection([...current, draggingId]);\n                else setSelection([draggingId]);\n              }\n\n              const controls = SceneManager.getControls();\n              if (controls) controls.enabled = false;\n\n              dragPlane.set(new THREE.Vector3(0, 1, 0), -dragStartPosWorld.y);\n              dragOffset.copy(CaseScene.getObject(draggingId).position).sub(pressed.pointWorld);\n\n              CaseScene.setDragging(draggingId);\n            }\n\n            function updateDrag() {\n              const camera = SceneManager.getCamera();\n              if (!camera) return;\n              raycaster.setFromCamera(pointer, camera);\n              const intersection = tmpVec3;\n              const ok = raycaster.ray.intersectPlane(dragPlane, intersection);\n              if (!ok) return;\n\n              const next = intersection.clone().add(dragOffset);\n\n              // Snap (X/Z) when enabled\n              const prefs = PreferencesManager.get();\n              if (prefs.snapping && prefs.snapping.enabled) {\n                const gridIn = Math.max(0.25, Number(prefs.snapping.gridSize) || 1);\n                const gridW = SceneManager.toWorld(gridIn);\n                next.x = Math.round(next.x / gridW) * gridW;\n                next.z = Math.round(next.z / gridW) * gridW;\n              }\n\n              const check = CaseScene.checkCollision(draggingId, next);\n              CaseScene.setCollision(draggingId, check.collides);\n\n              const obj = CaseScene.getObject(draggingId);\n              if (obj) obj.position.copy(next);\n            }\n\n            function finishDrag() {\n              const instanceId = draggingId;\n              const obj = CaseScene.getObject(instanceId);\n              if (!obj) {\n                resetDrag();\n                return;\n              }\n\n              const check = CaseScene.checkCollision(instanceId, obj.position);\n              if (check.collides) {\n                new TWEEN.Tween(obj.position)\n                  .to({ x: dragStartPosWorld.x, y: dragStartPosWorld.y, z: dragStartPosWorld.z }, 240)\n                  .easing(TWEEN.Easing.Cubic.Out)\n                  .onComplete(() => {\n                    CaseScene.setCollision(instanceId, false);\n                    CaseScene.setDragging(null);\n                    CaseScene.setHover(hoveredId);\n                  })\n                  .start();\n                UIComponents.showToast('Cannot place here: collision detected', 'error');\n                resetDrag();\n                return;\n              }\n\n              const packId = StateStore.get('currentPackId');\n              const pack = PackLibrary.getById(packId);\n              if (!pack) {\n                resetDrag();\n                return;\n              }\n              const inst = (pack.cases || []).find(i => i.id === instanceId);\n              if (!inst) {\n                resetDrag();\n                return;\n              }\n\n              const posInches = SceneManager.vecWorldToInches(obj.position);\n              PackLibrary.updateInstance(packId, instanceId, {\n                transform: { ...inst.transform, position: posInches },\n              });\n\n              UIComponents.showToast(\n                check.insideTruck ? 'Case placed' : 'Placed in staging (outside truck)',\n                check.insideTruck ? 'success' : 'info'\n              );\n              resetDrag();\n            }\n\n            function resetDrag() {\n              const controls = SceneManager.getControls();\n              if (controls) controls.enabled = true;\n              draggingId = null;\n              dragStartPosWorld = null;\n              pressed = null;\n              domEl.style.cursor = hoveredId ? 'grab' : 'default';\n              CaseScene.setDragging(null);\n            }\n\n            function updatePointer(ev) {\n              if (!domEl) return;\n              const rect = domEl.getBoundingClientRect();\n              pointer.x = ((ev.clientX - rect.left) / rect.width) * 2 - 1;\n              pointer.y = -((ev.clientY - rect.top) / rect.height) * 2 + 1;\n            }\n\n            function raycastFirst() {\n              const camera = SceneManager.getCamera();\n              if (!camera) return null;\n              raycaster.setFromCamera(pointer, camera);\n              const meshes = CaseScene.getRaycastMeshes();\n              const hits = raycaster.intersectObjects(meshes, false);\n              if (!hits.length) return null;\n              const hit = hits[0];\n              const instanceId = hit.object && hit.object.userData ? hit.object.userData.instanceId : null;\n              if (!instanceId) return null;\n              return { instanceId, pointWorld: hit.point.clone() };\n            }\n\n            function isEditorActive() {\n              return StateStore.get('currentScreen') === 'editor';\n            }\n\n            function getSelection() {\n              return StateStore.get('selectedInstanceIds') || [];\n            }\n\n            function setSelection(nextIds) {\n              StateStore.set({ selectedInstanceIds: nextIds }, { skipHistory: true });\n              CaseScene.setSelected(nextIds);\n            }\n\n            function selectAllInPack() {\n              const pack = PackLibrary.getById(StateStore.get('currentPackId'));\n              if (!pack) return;\n              setSelection((pack.cases || []).map(i => i.id));\n              UIComponents.showToast(`Selected ${(pack.cases || []).length} case(s)`, 'info');\n            }\n\n            function deleteSelection() {\n              const ids = getSelection();\n              if (!ids.length) return;\n              const packId = StateStore.get('currentPackId');\n              PackLibrary.removeInstances(packId, ids);\n              setSelection([]);\n              UIComponents.showToast(`Deleted ${ids.length} case(s)`, 'info');\n            }\n\n            return { init, setSelection, selectAllInPack, deleteSelection };\n          })();\n\n          const AutoPackEngine = (() => {\n            let isRunning = false;\n\n            /**\n             * MVP AutoPack: First-Fit Decreasing in 3D (no rotation).\n             * - Sort by volume (largest first)\n             * - Place into the first available space\n             * - Subdivide remaining space into candidate regions\n             */\n            async function pack() {\n              if (isRunning) return;\n              const packId = StateStore.get('currentPackId');\n              const packData = PackLibrary.getById(packId);\n              if (!packData) {\n                UIComponents.showToast('Open a pack first', 'warning');\n                return;\n              }\n              if (!(packData.cases || []).length) {\n                UIComponents.showToast('No cases to pack', 'warning');\n                return;\n              }\n\n              isRunning = true;\n              UIComponents.showToast('AutoPack starting…', 'info', { title: 'AutoPack', duration: 1800 });\n\n              const truck = packData.truck;\n              const packItems = (packData.cases || [])\n                .filter(inst => !inst.hidden)\n                .map(inst => {\n                  const c = CaseLibrary.getById(inst.caseId);\n                  if (!c) return null;\n                  const vol = c.volume || Utils.volumeInCubicInches(c.dimensions);\n                  return { inst, caseData: c, volume: vol };\n                })\n                .filter(Boolean)\n                .sort((a, b) => b.volume - a.volume);\n\n              // Step 1: move to staging (visual clarity)\n              const stagingMap = buildStagingMap(packItems, truck);\n              await stage(stagingMap);\n\n              // Step 2: compute packing\n              const spaces = [\n                {\n                  x: 0,\n                  y: 0,\n                  z: -truck.width / 2,\n                  length: truck.length,\n                  width: truck.width,\n                  height: truck.height,\n                },\n              ];\n\n              const placements = new Map(); // instanceId -> position inches\n              const packed = [];\n              const unpacked = [];\n\n              for (const item of packItems) {\n                const dims = item.caseData.dimensions;\n                let placed = false;\n                for (let i = 0; i < spaces.length; i++) {\n                  const s = spaces[i];\n                  if (dims.length <= s.length && dims.width <= s.width && dims.height <= s.height) {\n                    const pos = {\n                      x: s.x + dims.length / 2,\n                      y: s.y + dims.height / 2,\n                      z: s.z + dims.width / 2,\n                    };\n                    if (!hasPackingCollision(pos, dims, packed)) {\n                      placements.set(item.inst.id, pos);\n                      packed.push({ position: pos, dimensions: dims });\n                      const nextSpaces = subdivideSpace(s, dims);\n                      spaces.splice(i, 1, ...nextSpaces);\n                      spaces.sort((a, b) => b.length * b.width * b.height - a.length * a.width * a.height);\n                      placed = true;\n                      break;\n                    }\n                  }\n                }\n                if (!placed) unpacked.push(item.inst.id);\n              }\n\n              // Step 3: animate to placements\n              await animatePlacements(placements);\n\n              // Step 4: persist to state (single update)\n              const nextCases = (packData.cases || []).map(inst => {\n                if (inst.hidden) return inst;\n                const p = placements.get(inst.id) || stagingMap.get(inst.id);\n                if (!p) return inst;\n                return { ...inst, transform: { ...inst.transform, position: p }, hidden: false };\n              });\n              PackLibrary.update(packId, { cases: nextCases });\n\n              const stats = PackLibrary.computeStats(PackLibrary.getById(packId));\n              const totalPackable = (packData.cases || []).filter(i => !i.hidden).length;\n              UIComponents.showToast(\n                `Packed ${stats.packedCases} of ${totalPackable} (${stats.volumePercent.toFixed(1)}%)`,\n                stats.packedCases === totalPackable ? 'success' : 'warning',\n                { title: 'AutoPack' }\n              );\n              if (unpacked.length)\n                {UIComponents.showToast(`${unpacked.length} case(s) could not fit`, 'warning', { title: 'AutoPack' });}\n\n              isRunning = false;\n\n              // Auto-capture a pack preview thumbnail after AutoPack completes.\n              window.setTimeout(() => {\n                ExportService.capturePackPreview(packId, { source: 'auto' });\n              }, 60);\n            }\n\n            function buildStagingMap(packItems, truck) {\n              const baseX = -Math.max(60, truck.length * 0.12);\n              const spacing = 28;\n              const map = new Map();\n              packItems.forEach((item, idx) => {\n                const row = Math.floor(idx / 5);\n                const col = idx % 5;\n                const y = Math.max(\n                  1,\n                  item.caseData.dimensions && item.caseData.dimensions.height ? item.caseData.dimensions.height / 2 : 1\n                );\n                map.set(item.inst.id, { x: baseX - col * spacing, y, z: (row - 2) * spacing });\n              });\n              return map;\n            }\n\n            async function stage(stagingMap) {\n              const targets = Array.from(stagingMap.entries()).map(([id, pos]) => ({ id, pos }));\n              await Promise.all(targets.map(t => tweenInstanceToPosition(t.id, t.pos, 260)));\n            }\n\n            function hasPackingCollision(position, dims, packed) {\n              const EPS = 1e-6;\n              const box = {\n                min: {\n                  x: position.x - dims.length / 2,\n                  y: position.y - dims.height / 2,\n                  z: position.z - dims.width / 2,\n                },\n                max: {\n                  x: position.x + dims.length / 2,\n                  y: position.y + dims.height / 2,\n                  z: position.z + dims.width / 2,\n                },\n              };\n              for (const p of packed) {\n                const other = {\n                  min: {\n                    x: p.position.x - p.dimensions.length / 2,\n                    y: p.position.y - p.dimensions.height / 2,\n                    z: p.position.z - p.dimensions.width / 2,\n                  },\n                  max: {\n                    x: p.position.x + p.dimensions.length / 2,\n                    y: p.position.y + p.dimensions.height / 2,\n                    z: p.position.z + p.dimensions.width / 2,\n                  },\n                };\n                if (\n                  box.min.x < other.max.x - EPS &&\n                  box.max.x > other.min.x + EPS &&\n                  box.min.y < other.max.y - EPS &&\n                  box.max.y > other.min.y + EPS &&\n                  box.min.z < other.max.z - EPS &&\n                  box.max.z > other.min.z + EPS\n                )\n                  {return true;}\n              }\n              return false;\n            }\n\n            function subdivideSpace(space, dims) {\n              const out = [];\n              const minVol = 10;\n\n              // Right (X+)\n              const rightLen = space.length - dims.length;\n              if (rightLen > 0)\n                {out.push({\n            x: space.x + dims.length,\n            y: space.y,\n            z: space.z,\n            length: rightLen,\n            width: space.width,\n            height: space.height,\n          });}\n\n              // Top (Y+)\n              const topH = space.height - dims.height;\n              if (topH > 0)\n                {out.push({\n            x: space.x,\n            y: space.y + dims.height,\n            z: space.z,\n            length: dims.length,\n            width: dims.width,\n            height: topH,\n          });}\n\n              // Back (Z+)\n              const backW = space.width - dims.width;\n              if (backW > 0)\n                {out.push({\n            x: space.x,\n            y: space.y,\n            z: space.z + dims.width,\n            length: dims.length,\n            width: backW,\n            height: dims.height,\n          });}\n\n              return out.filter(s => s.length * s.width * s.height > minVol);\n            }\n\n            async function animatePlacements(placements) {\n              for (const [id, pos] of placements.entries()) {\n                await tweenInstanceToPosition(id, pos, 240);\n                await sleep(35);\n              }\n            }\n\n            function tweenInstanceToPosition(instanceId, positionInches, duration) {\n              const obj = CaseScene.getObject(instanceId);\n              if (!obj) return Promise.resolve();\n              const target = SceneManager.vecInchesToWorld(positionInches);\n              return new Promise(resolve => {\n                new TWEEN.Tween(obj.position)\n                  .to({ x: target.x, y: target.y, z: target.z }, duration)\n                  .easing(TWEEN.Easing.Cubic.InOut)\n                  .onComplete(resolve)\n                  .start();\n              });\n            }\n\n            function sleep(ms) {\n              return new Promise(r => setTimeout(r, ms));\n            }\n\n            return {\n              pack,\n              get running() {\n                return isRunning;\n              },\n            };\n          })();\n\n          const ExportService = (() => {\n            function estimateDataUrlBytes(dataUrl) {\n              const str = String(dataUrl || '');\n              const comma = str.indexOf(',');\n              if (comma === -1) return 0;\n              const b64 = str.slice(comma + 1);\n              const padding = b64.endsWith('==') ? 2 : b64.endsWith('=') ? 1 : 0;\n              return Math.max(0, Math.floor((b64.length * 3) / 4) - padding);\n            }\n\n            async function capturePackPreview(packId, { source = 'auto', quiet = false } = {}) {\n              try {\n                const pack = PackLibrary.getById(packId);\n                if (!pack) throw new Error('Pack not found');\n\n                // Ensure the latest transforms are rendered before capture.\n                await new Promise(resolve => requestAnimationFrame(() => requestAnimationFrame(resolve)));\n\n                const width = 320;\n                const height = 180;\n                const dataUrl = renderCameraToDataUrl(SceneManager.getCamera(), width, height, {\n                  mimeType: 'image/jpeg',\n                  quality: 0.72,\n                  hideGrid: true,\n                });\n\n                const bytes = estimateDataUrlBytes(dataUrl);\n                const maxBytes = 150 * 1024;\n                if (bytes > maxBytes) {\n                  throw new Error(`Preview too large (${Math.round(bytes / 1024)}KB)`);\n                }\n\n                PackLibrary.update(packId, {\n                  thumbnail: dataUrl,\n                  thumbnailUpdatedAt: Date.now(),\n                  thumbnailSource: source === 'manual' ? 'manual' : 'auto',\n                });\n\n                if (!quiet) UIComponents.showToast('Preview captured', 'success', { title: 'Preview' });\n                return true;\n              } catch (err) {\n                if (!quiet)\n                  {UIComponents.showToast(`Preview failed: ${err.message || err}`, 'warning', { title: 'Preview' });}\n                return false;\n              }\n            }\n\n            function clearPackPreview(packId) {\n              const pack = PackLibrary.getById(packId);\n              if (!pack) return false;\n              if (!pack.thumbnail) return false;\n              PackLibrary.update(packId, { thumbnail: null, thumbnailUpdatedAt: null, thumbnailSource: null });\n              UIComponents.showToast('Preview cleared', 'info', { title: 'Preview' });\n              return true;\n            }\n\n            function captureScreenshot() {\n              try {\n                const pack = getCurrentPack();\n                if (!pack) {\n                  UIComponents.showToast('Open a pack first', 'warning', { title: 'Export' });\n                  return;\n                }\n                const prefs = PreferencesManager.get();\n                const res = Utils.parseResolution(prefs.export && prefs.export.screenshotResolution);\n                const dataUrl = renderCameraToDataUrl(SceneManager.getCamera(), res.width, res.height, {\n                  mimeType: 'image/png',\n                  hideGrid: true,\n                });\n                downloadDataUrl(dataUrl, `truck-pack-${safeName(pack.title)}-${Date.now()}.png`);\n                UIComponents.showToast('Screenshot saved', 'success', { title: 'Export' });\n              } catch (err) {\n                console.error(err);\n                UIComponents.showToast('Screenshot failed: ' + err.message, 'error', { title: 'Export' });\n              }\n            }\n\n            function generatePDF() {\n              try {\n                if (!window.jspdf || !window.jspdf.jsPDF) throw new Error('jsPDF not available');\n                const pack = getCurrentPack();\n                if (!pack) {\n                  UIComponents.showToast('Open a pack first', 'warning', { title: 'Export' });\n                  return;\n                }\n\n                const prefs = PreferencesManager.get();\n                const { jsPDF } = window.jspdf;\n                const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });\n\n                const pageWidth = doc.internal.pageSize.getWidth();\n                const pageHeight = doc.internal.pageSize.getHeight();\n                const margin = 40;\n                let y = margin;\n\n                // Header\n                doc.setFontSize(22);\n                doc.setFont('helvetica', 'bold');\n                doc.text(pack.title || 'Pack', margin, y);\n                y += 22;\n\n                doc.setFontSize(10);\n                doc.setFont('helvetica', 'normal');\n                doc.text(`Generated: ${new Date().toLocaleString()}`, margin, y);\n                y += 16;\n\n                const details = [\n                  pack.client ? `Client: ${pack.client}` : null,\n                  pack.projectName ? `Project: ${pack.projectName}` : null,\n                  pack.drawnBy ? `Drawn by: ${pack.drawnBy}` : null,\n                ].filter(Boolean);\n                details.forEach(line => {\n                  doc.text(line, margin, y);\n                  y += 14;\n                });\n                if (details.length) y += 8;\n\n                // Notes\n                if (pack.notes) {\n                  doc.setFont('helvetica', 'bold');\n                  doc.text('NOTES', margin, y);\n                  y += 14;\n                  doc.setFont('helvetica', 'normal');\n                  const lines = doc.splitTextToSize(pack.notes, pageWidth - margin * 2);\n                  doc.text(lines, margin, y);\n                  y += lines.length * 12 + 10;\n                }\n\n                // Views\n                const viewWPt = pageWidth - margin * 2;\n                const viewWpx = 960;\n                const viewHpx = 540;\n                const perspective = renderCameraToDataUrl(SceneManager.getCamera(), viewWpx, viewHpx, {\n                  mimeType: 'image/jpeg',\n                  quality: 0.92,\n                  hideGrid: true,\n                });\n\n                const { topCam, sideCam } = buildOrthoCameras(pack);\n                const topView = renderCameraToDataUrl(topCam, 960, 520, {\n                  mimeType: 'image/jpeg',\n                  quality: 0.9,\n                  hideGrid: true,\n                });\n                const sideView = renderCameraToDataUrl(sideCam, 960, 420, {\n                  mimeType: 'image/jpeg',\n                  quality: 0.9,\n                  hideGrid: true,\n                });\n\n                doc.setFont('helvetica', 'bold');\n                doc.setFontSize(12);\n                doc.text('PERSPECTIVE VIEW', margin, y);\n                y += 10;\n                y += 6;\n                const pvH = viewWPt * (viewHpx / viewWpx);\n                doc.addImage(perspective, 'JPEG', margin, y, viewWPt, pvH);\n                y += pvH + 16;\n\n                if (y + 220 > pageHeight - margin) {\n                  doc.addPage();\n                  y = margin;\n                }\n\n                doc.text('TOP VIEW', margin, y);\n                y += 10;\n                y += 6;\n                const tvH = viewWPt * (520 / 960);\n                doc.addImage(topView, 'JPEG', margin, y, viewWPt, tvH);\n                y += tvH + 16;\n\n                if (y + 200 > pageHeight - margin) {\n                  doc.addPage();\n                  y = margin;\n                }\n\n                doc.text('SIDE VIEW', margin, y);\n                y += 10;\n                y += 6;\n                const svH = viewWPt * (420 / 960);\n                doc.addImage(sideView, 'JPEG', margin, y, viewWPt, svH);\n\n                // Checklist page\n                doc.addPage();\n                y = margin;\n\n                doc.setFont('helvetica', 'bold');\n                doc.setFontSize(16);\n                doc.text('CASE CHECKLIST', margin, y);\n                y += 22;\n\n                const entries = buildChecklist(pack);\n\n                doc.setFontSize(9);\n                doc.setFont('helvetica', 'bold');\n                const x0 = margin;\n                const x1 = margin + 24;\n                const x2 = margin + 260;\n                const x3 = margin + 360;\n                const x4 = margin + 470;\n                doc.text('#', x0, y);\n                doc.text('Name', x1, y);\n                doc.text('Category', x2, y);\n                doc.text('Dims', x3, y);\n                doc.text('Weight', x4, y);\n                y += 8;\n                doc.line(margin, y, pageWidth - margin, y);\n                y += 14;\n\n                doc.setFont('helvetica', 'normal');\n                entries.forEach((e, idx) => {\n                  if (y > pageHeight - margin) {\n                    doc.addPage();\n                    y = margin;\n                    doc.setFont('helvetica', 'bold');\n                    doc.text('#', x0, y);\n                    doc.text('Name', x1, y);\n                    doc.text('Category', x2, y);\n                    doc.text('Dims', x3, y);\n                    doc.text('Weight', x4, y);\n                    y += 8;\n                    doc.line(margin, y, pageWidth - margin, y);\n                    y += 14;\n                    doc.setFont('helvetica', 'normal');\n                  }\n\n                  const lineHeight = 14;\n                  doc.text(String(idx + 1), x0, y);\n                  doc.text(e.name, x1, y);\n                  doc.text(e.category, x2, y);\n                  doc.text(e.dims, x3, y);\n                  doc.text(e.weight, x4, y);\n                  y += lineHeight;\n                });\n\n                // Summary\n                const includeStats = Boolean(prefs.export && prefs.export.pdfIncludeStats);\n                if (includeStats) {\n                  const stats = PackLibrary.computeStats(pack);\n                  if (y + 90 > pageHeight - margin) {\n                    doc.addPage();\n                    y = margin;\n                  } else {\n                    y += 16;\n                  }\n                  doc.setFont('helvetica', 'bold');\n                  doc.setFontSize(12);\n                  doc.text('SUMMARY', margin, y);\n                  y += 16;\n                  doc.setFont('helvetica', 'normal');\n                  doc.setFontSize(10);\n                  doc.text(`Cases loaded: ${stats.totalCases}`, margin, y);\n                  y += 14;\n                  doc.text(`Packed (in truck): ${stats.packedCases}`, margin, y);\n                  y += 14;\n                  doc.text(`Volume used: ${stats.volumePercent.toFixed(1)}%`, margin, y);\n                  y += 14;\n                  doc.text(`Total weight: ${Utils.formatWeight(stats.totalWeight, prefs.units.weight)}`, margin, y);\n                  y += 14;\n                  doc.text(`Truck (in): ${pack.truck.length}×${pack.truck.width}×${pack.truck.height}`, margin, y);\n                }\n\n                doc.save(`${safeName(pack.title)}-plan.pdf`);\n                UIComponents.showToast('PDF exported', 'success', { title: 'Export' });\n              } catch (err) {\n                console.error(err);\n                UIComponents.showToast('PDF export failed: ' + err.message, 'error', { title: 'Export' });\n              }\n            }\n\n            function getCurrentPack() {\n              const packId = StateStore.get('currentPackId');\n              return packId ? PackLibrary.getById(packId) : null;\n            }\n\n            function safeName(name) {\n              return (\n                String(name || 'pack')\n                  .trim()\n                  .toLowerCase()\n                  .replace(/[^a-z0-9]+/g, '-')\n                  .replace(/^-+|-+$/g, '') || 'pack'\n              );\n            }\n\n            function downloadDataUrl(dataUrl, filename) {\n              const link = document.createElement('a');\n              link.href = dataUrl;\n              link.download = filename;\n              document.body.appendChild(link);\n              link.click();\n              document.body.removeChild(link);\n            }\n\n            function buildOrthoCameras(pack) {\n              const lengthW = SceneManager.toWorld(pack.truck.length);\n              const widthW = SceneManager.toWorld(pack.truck.width);\n              const heightW = SceneManager.toWorld(pack.truck.height);\n              const centerX = lengthW / 2;\n              const centerY = heightW / 2;\n              const margin = 3;\n\n              const topCam = new THREE.OrthographicCamera(\n                -(lengthW / 2 + margin),\n                lengthW / 2 + margin,\n                widthW / 2 + margin,\n                -(widthW / 2 + margin),\n                0.1,\n                2000\n              );\n              topCam.position.set(centerX, heightW + 40, 0);\n              topCam.up.set(0, 0, -1);\n              topCam.lookAt(centerX, 0, 0);\n              topCam.updateProjectionMatrix();\n\n              const sideCam = new THREE.OrthographicCamera(\n                -(lengthW / 2 + margin),\n                lengthW / 2 + margin,\n                heightW / 2 + margin,\n                -(heightW / 2 + margin),\n                0.1,\n                2000\n              );\n              sideCam.position.set(centerX, centerY, widthW / 2 + 60);\n              sideCam.lookAt(centerX, centerY, 0);\n              sideCam.updateProjectionMatrix();\n\n              return { topCam, sideCam };\n            }\n\n            function buildChecklist(pack) {\n              const prefs = PreferencesManager.get();\n              const truck = pack.truck;\n              const unitLen = prefs.units.length;\n              const unitWt = prefs.units.weight;\n              return (pack.cases || []).map(inst => {\n                const c = CaseLibrary.getById(inst.caseId);\n                if (!c) return { name: 'Missing case', category: '—', dims: '—', weight: '—' };\n                const meta = CategoryService.meta(c.category);\n                return {\n                  name: c.name,\n                  category: meta.name,\n                  dims: Utils.formatDims(c.dimensions, unitLen),\n                  weight: Utils.formatWeight(Number(c.weight) || 0, unitWt),\n                  packed: isInsideTruckInstance(inst, c, truck) && !inst.hidden,\n                };\n              });\n            }\n\n            function isInsideTruckInstance(inst, c, truck) {\n              if (!inst || !c || !truck) return false;\n              const dims = c.dimensions || { length: 0, width: 0, height: 0 };\n              const pos = inst.transform && inst.transform.position ? inst.transform.position : { x: 0, y: 0, z: 0 };\n              const half = { x: dims.length / 2, y: dims.height / 2, z: dims.width / 2 };\n              const aabb = {\n                min: { x: pos.x - half.x, y: pos.y - half.y, z: pos.z - half.z },\n                max: { x: pos.x + half.x, y: pos.y + half.y, z: pos.z + half.z },\n              };\n              return (\n                aabb.min.x >= 0 &&\n                aabb.max.x <= truck.length &&\n                aabb.min.y >= 0 &&\n                aabb.max.y <= truck.height &&\n                aabb.min.z >= -truck.width / 2 &&\n                aabb.max.z <= truck.width / 2\n              );\n            }\n\n            function renderCameraToDataUrl(camera, width, height, options = {}) {\n              const renderer = SceneManager.getRenderer();\n              const scene = SceneManager.getScene();\n              if (!renderer || !scene || !camera) throw new Error('3D viewport not ready');\n\n              const mimeType = options.mimeType || 'image/png';\n              const quality = Number.isFinite(options.quality) ? options.quality : 0.92;\n\n              const prevTarget = renderer.getRenderTarget();\n              const prevViewport = new THREE.Vector4();\n              const prevScissor = new THREE.Vector4();\n              renderer.getViewport(prevViewport);\n              renderer.getScissor(prevScissor);\n              const prevScissorTest = renderer.getScissorTest ? renderer.getScissorTest() : false;\n              const prevPixelRatio = renderer.getPixelRatio();\n              const prevBg = scene.background;\n\n              const gridObj = scene.getObjectByName('grid');\n              const prevGridVisible = gridObj ? gridObj.visible : null;\n\n              const prevAspect = camera.isPerspectiveCamera ? camera.aspect : null;\n\n              const rt = new THREE.WebGLRenderTarget(width, height, { format: THREE.RGBAFormat });\n              const pixels = new Uint8Array(width * height * 4);\n\n              try {\n                if (options.hideGrid && gridObj) gridObj.visible = false;\n                renderer.setPixelRatio(1);\n                renderer.setRenderTarget(rt);\n                renderer.setViewport(0, 0, width, height);\n                renderer.setScissorTest(false);\n                if (camera.isPerspectiveCamera) {\n                  camera.aspect = width / height;\n                  camera.updateProjectionMatrix();\n                }\n                renderer.render(scene, camera);\n                renderer.readRenderTargetPixels(rt, 0, 0, width, height, pixels);\n              } finally {\n                renderer.setRenderTarget(prevTarget);\n                renderer.setPixelRatio(prevPixelRatio);\n                renderer.setViewport(prevViewport.x, prevViewport.y, prevViewport.z, prevViewport.w);\n                renderer.setScissor(prevScissor.x, prevScissor.y, prevScissor.z, prevScissor.w);\n                renderer.setScissorTest(prevScissorTest);\n                scene.background = prevBg;\n                if (gridObj && prevGridVisible != null) gridObj.visible = prevGridVisible;\n                if (camera.isPerspectiveCamera && prevAspect != null) {\n                  camera.aspect = prevAspect;\n                  camera.updateProjectionMatrix();\n                }\n                rt.dispose();\n              }\n\n              // Flip Y and encode\n              const canvas = document.createElement('canvas');\n              canvas.width = width;\n              canvas.height = height;\n              const ctx = canvas.getContext('2d');\n              const img = ctx.createImageData(width, height);\n              for (let y = 0; y < height; y++) {\n                const src = (height - y - 1) * width * 4;\n                const dst = y * width * 4;\n                img.data.set(pixels.subarray(src, src + width * 4), dst);\n              }\n              ctx.putImageData(img, 0, 0);\n              return canvas.toDataURL(mimeType, quality);\n            }\n\n            return { captureScreenshot, generatePDF, capturePackPreview, clearPackPreview };\n          })();\n\n          const EditorUI = (() => {\n            const shellEl = document.querySelector('.editor-shell');\n            const leftEl = document.getElementById('editor-left');\n            const rightEl = document.getElementById('editor-right');\n            const btnLeft = document.getElementById('btn-editor-left');\n            const btnRight = document.getElementById('btn-editor-right');\n            const btnLeftClose = document.getElementById('btn-left-close');\n            const btnRightClose = document.getElementById('btn-right-close');\n            const viewportEl = document.getElementById('viewport');\n            const inspectorEl = document.getElementById('inspector-body');\n            const caseSearchEl = document.getElementById('editor-case-search');\n            const caseChipsEl = document.getElementById('editor-case-chips');\n            const caseListEl = document.getElementById('editor-case-list');\n            const btnAutopack = document.getElementById('btn-autopack');\n            const btnPng = document.getElementById('btn-screenshot');\n            const btnPdf = document.getElementById('btn-pdf');\n            const btnPreview = document.getElementById('btn-capture-preview');\n\n            let initialized = false;\n            const browserCats = new Set();\n\n            function init() {\n              caseSearchEl.addEventListener('input', Utils.debounce(renderCaseBrowser, 250));\n              btnLeft.addEventListener('click', () => togglePanel('left'));\n              btnRight.addEventListener('click', () => togglePanel('right'));\n              btnLeftClose.addEventListener('click', () => setPanelVisible('left', false));\n              btnRightClose.addEventListener('click', () => setPanelVisible('right', false));\n\n              btnAutopack.addEventListener('click', async () => {\n                btnAutopack.disabled = true;\n                await AutoPackEngine.pack();\n                render();\n              });\n              btnPng.addEventListener('click', () => ExportService.captureScreenshot());\n              btnPdf.addEventListener('click', () => ExportService.generatePDF());\n              btnPreview.addEventListener('click', async () => {\n                const packId = StateStore.get('currentPackId');\n                if (!packId) return;\n                btnPreview.disabled = true;\n                await ExportService.capturePackPreview(packId, { source: 'manual' });\n                btnPreview.disabled = false;\n              });\n\n              window.addEventListener(\n                'resize',\n                Utils.debounce(() => {\n                  if (StateStore.get('currentScreen') === 'editor') SceneManager.resize();\n                }, 120)\n              );\n            }\n\n            function ensureScene() {\n              if (initialized) return;\n              SceneManager.init(viewportEl);\n              InteractionManager.init(SceneManager.getRenderer().domElement);\n              wireDropToViewport(SceneManager.getRenderer().domElement);\n              initialized = true;\n            }\n\n            function render() {\n              if (StateStore.get('currentScreen') !== 'editor') return;\n              ensureScene();\n\n              const packId = StateStore.get('currentPackId');\n              const pack = PackLibrary.getById(packId);\n\n              btnAutopack.disabled = !pack || AutoPackEngine.running;\n              btnPng.disabled = !pack;\n              btnPdf.disabled = !pack;\n              btnPreview.disabled = !pack;\n\n              if (!pack) {\n                SceneManager.setTruck({ length: 636, width: 102, height: 98 });\n                CaseScene.sync(null);\n                renderCaseBrowser();\n                renderInspectorNoPack();\n                SceneManager.resize();\n                return;\n              }\n\n              SceneManager.setTruck(pack.truck);\n              CaseScene.sync(pack);\n              CaseScene.setSelected(StateStore.get('selectedInstanceIds') || []);\n\n              renderCaseBrowser();\n              renderInspector(pack);\n              SceneManager.resize();\n            }\n\n            function renderCaseBrowser() {\n              const q = String(caseSearchEl.value || '').trim();\n              const cases = CaseLibrary.search(q, Array.from(browserCats)).sort((a, b) =>\n                (a.name || '').localeCompare(b.name || '')\n              );\n              const counts = CategoryService.listWithCounts(CaseLibrary.getCases());\n\n              caseChipsEl.innerHTML = '';\n              caseChipsEl.appendChild(\n                makeBrowserChip(\n                  'All',\n                  'all',\n                  browserCats.size === 0,\n                  () => {\n                    browserCats.clear();\n                    renderCaseBrowser();\n                  },\n                  '#9b9ba8'\n                )\n              );\n              counts.forEach(c => {\n                const active = browserCats.has(c.key);\n                caseChipsEl.appendChild(\n                  makeBrowserChip(\n                    `${c.name}: ${c.count}`,\n                    c.key,\n                    active,\n                    () => {\n                      if (browserCats.has(c.key)) browserCats.delete(c.key);\n                      else browserCats.add(c.key);\n                      renderCaseBrowser();\n                    },\n                    c.color\n                  )\n                );\n              });\n\n              caseListEl.innerHTML = '';\n              cases.forEach(c => {\n                const card = document.createElement('div');\n                card.className = 'card';\n                card.style.padding = '12px';\n                card.style.display = 'grid';\n                card.style.gap = '8px';\n                card.draggable = true;\n                card.addEventListener('dragstart', ev => {\n                  ev.dataTransfer.setData('text/plain', c.id);\n                  ev.dataTransfer.effectAllowed = 'copy';\n                });\n\n                const header = document.createElement('div');\n                header.className = 'row space-between';\n                const left = document.createElement('div');\n                left.style.display = 'grid';\n                left.style.gap = '2px';\n                const name = document.createElement('div');\n                name.style.fontWeight = 'var(--font-semibold)';\n                name.textContent = c.name;\n                const dims = document.createElement('div');\n                dims.className = 'muted';\n                dims.style.fontSize = 'var(--text-xs)';\n                dims.textContent = `${c.dimensions.length}×${c.dimensions.width}×${c.dimensions.height} in`;\n                left.appendChild(name);\n                left.appendChild(dims);\n                header.appendChild(left);\n\n                const addBtn = document.createElement('button');\n                addBtn.className = 'btn btn-primary';\n                addBtn.type = 'button';\n                addBtn.style.padding = '6px 10px';\n                addBtn.style.boxShadow = 'none';\n                addBtn.innerHTML = '<i class=\"fa-solid fa-plus\"></i> Add';\n                addBtn.addEventListener('click', () => addCaseToPack(c.id));\n                header.appendChild(addBtn);\n\n                const metaRow = document.createElement('div');\n                metaRow.className = 'row';\n                metaRow.style.gap = '8px';\n                metaRow.appendChild(makeMiniCategoryChip(c.category));\n\n                card.appendChild(header);\n                card.appendChild(metaRow);\n                caseListEl.appendChild(card);\n              });\n            }\n\n            function makeBrowserChip(label, key, active, onClick, color) {\n              const el = document.createElement('div');\n              el.className = `chip ${active ? 'active' : ''}`;\n              el.tabIndex = 0;\n              const dot = document.createElement('span');\n              dot.className = 'chip-dot';\n              dot.style.background = color || 'var(--border-strong)';\n              const text = document.createElement('span');\n              text.textContent = label;\n              el.appendChild(dot);\n              el.appendChild(text);\n              el.addEventListener('click', onClick);\n              el.addEventListener('keydown', ev => {\n                if (ev.key === 'Enter') onClick();\n              });\n              return el;\n            }\n\n            function makeMiniCategoryChip(categoryKey) {\n              const meta = CategoryService.meta(categoryKey || 'default');\n              const el = document.createElement('span');\n              el.className = 'chip';\n              el.style.cursor = 'default';\n              el.style.padding = '4px 10px';\n              const dot = document.createElement('span');\n              dot.className = 'chip-dot';\n              dot.style.background = meta.color;\n              const text = document.createElement('span');\n              text.textContent = meta.name;\n              el.appendChild(dot);\n              el.appendChild(text);\n              return el;\n            }\n\n            function addCaseToPack(caseId, positionInches) {\n              const packId = StateStore.get('currentPackId');\n              const pack = PackLibrary.getById(packId);\n              if (!pack) {\n                UIComponents.showToast('Create or open a pack first', 'warning');\n                AppShell.navigate('packs');\n                return;\n              }\n\n              const count = (pack.cases || []).length;\n              const caseData = CaseLibrary.getById(caseId);\n              if (!caseData) return;\n              const stageX = -90 - (count % 4) * 40;\n              const stageZ = (Math.floor(count / 4) - 2) * 34;\n              const pos = positionInches || { x: stageX, y: Math.max(1, caseData.dimensions.height / 2), z: stageZ };\n              const inst = PackLibrary.addInstance(packId, caseId, pos);\n              if (inst) {\n                StateStore.set({ selectedInstanceIds: [inst.id] }, { skipHistory: true });\n                UIComponents.showToast('Case added to pack', 'success');\n              }\n            }\n\n            function renderInspectorNoPack() {\n              inspectorEl.innerHTML = '';\n              const card = document.createElement('div');\n              card.className = 'card';\n              card.innerHTML = `\n              <div style=\"font-weight:var(--font-semibold);margin-bottom:6px\">No pack open</div>\n              <div class=\"muted\" style=\"font-size:var(--text-sm);margin-bottom:12px\">Open a pack from the Packs screen to use the 3D editor.</div>\n            `;\n              const btn = document.createElement('button');\n              btn.className = 'btn btn-primary';\n              btn.type = 'button';\n              btn.innerHTML = '<i class=\"fa-solid fa-layer-group\"></i> Go to Packs';\n              btn.addEventListener('click', () => AppShell.navigate('packs'));\n              card.appendChild(btn);\n              inspectorEl.appendChild(card);\n            }\n\n            function renderInspector(pack) {\n              const prefs = PreferencesManager.get();\n              const sel = StateStore.get('selectedInstanceIds') || [];\n              inspectorEl.innerHTML = '';\n\n              if (!sel.length) {\n                renderTruckInspector(pack, prefs);\n                return;\n              }\n\n              if (sel.length > 1) {\n                renderMultiInspector(pack, sel);\n                return;\n              }\n\n              const instanceId = sel[0];\n              const inst = (pack.cases || []).find(i => i.id === instanceId);\n              if (!inst) {\n                StateStore.set({ selectedInstanceIds: [] }, { skipHistory: true });\n                renderTruckInspector(pack, prefs);\n                return;\n              }\n              const c = CaseLibrary.getById(inst.caseId);\n              if (!c) return;\n              renderSingleInspector(pack, inst, c, prefs);\n            }\n\n            function renderTruckInspector(pack, prefs) {\n              const card = document.createElement('div');\n              card.className = 'card';\n              card.style.display = 'grid';\n              card.style.gap = '12px';\n\n              const stats = PackLibrary.computeStats(pack);\n              card.innerHTML = `\n              <div style=\"font-weight:var(--font-semibold)\">Truck</div>\n              <div class=\"muted\" style=\"font-size:var(--text-sm)\">Edit dimensions in inches (internal units). Display units follow Settings.</div>\n            `;\n\n              const dimsRow = document.createElement('div');\n              dimsRow.className = 'row';\n              dimsRow.style.gap = '10px';\n              const fL = smallField('Length (in)', pack.truck.length);\n              const fW = smallField('Width (in)', pack.truck.width);\n              const fH = smallField('Height (in)', pack.truck.height);\n              dimsRow.appendChild(fL.wrap);\n              dimsRow.appendChild(fW.wrap);\n              dimsRow.appendChild(fH.wrap);\n\n              const btnSave = document.createElement('button');\n              btnSave.className = 'btn btn-primary';\n              btnSave.type = 'button';\n              btnSave.innerHTML = '<i class=\"fa-solid fa-floppy-disk\"></i> Update truck';\n              btnSave.addEventListener('click', () => {\n                const next = {\n                  length: Math.max(24, Number(fL.input.value) || pack.truck.length),\n                  width: Math.max(24, Number(fW.input.value) || pack.truck.width),\n                  height: Math.max(24, Number(fH.input.value) || pack.truck.height),\n                };\n                PackLibrary.update(pack.id, { truck: next });\n                UIComponents.showToast('Truck updated', 'success');\n              });\n\n              const statsEl = document.createElement('div');\n              statsEl.className = 'card';\n              statsEl.style.background = 'var(--bg-elevated)';\n              statsEl.style.boxShadow = 'none';\n              statsEl.style.display = 'grid';\n              statsEl.style.gap = '8px';\n              statsEl.innerHTML = `\n              <div style=\"font-weight:var(--font-semibold)\">Stats</div>\n              <div class=\"muted\" style=\"font-size:var(--text-sm)\">Cases loaded: <b style=\"color:var(--text-primary)\">${stats.totalCases}</b></div>\n              <div class=\"muted\" style=\"font-size:var(--text-sm)\">Packed (in truck): <b style=\"color:var(--text-primary)\">${stats.packedCases}</b></div>\n              <div class=\"muted\" style=\"font-size:var(--text-sm)\">Volume used: <b style=\"color:var(--text-primary)\">${stats.volumePercent.toFixed(1)}%</b></div>\n              <div class=\"muted\" style=\"font-size:var(--text-sm)\">Total weight: <b style=\"color:var(--text-primary)\">${Utils.formatWeight(stats.totalWeight, prefs.units.weight)}</b></div>\n            `;\n\n              card.appendChild(dimsRow);\n              card.appendChild(btnSave);\n              inspectorEl.appendChild(card);\n              inspectorEl.appendChild(statsEl);\n            }\n\n            function renderMultiInspector(pack, selected) {\n              const card = document.createElement('div');\n              card.className = 'card';\n              card.style.display = 'grid';\n              card.style.gap = '12px';\n              card.innerHTML = `\n              <div style=\"font-weight:var(--font-semibold)\">${selected.length} selected</div>\n              <div class=\"muted\" style=\"font-size:var(--text-sm)\">Use keyboard shortcuts: Delete, Esc, Ctrl/Cmd+A.</div>\n            `;\n\n              const row = document.createElement('div');\n              row.className = 'row';\n              row.style.justifyContent = 'flex-end';\n              const btnDelete = document.createElement('button');\n              btnDelete.className = 'btn btn-danger';\n              btnDelete.type = 'button';\n              btnDelete.innerHTML = '<i class=\"fa-solid fa-trash\"></i> Delete';\n              btnDelete.addEventListener('click', () => InteractionManager.deleteSelection());\n              const btnClear = document.createElement('button');\n              btnClear.className = 'btn';\n              btnClear.type = 'button';\n              btnClear.innerHTML = '<i class=\"fa-solid fa-xmark\"></i> Deselect';\n              btnClear.addEventListener('click', () =>\n                StateStore.set({ selectedInstanceIds: [] }, { skipHistory: true })\n              );\n              row.appendChild(btnClear);\n              row.appendChild(btnDelete);\n              card.appendChild(row);\n              inspectorEl.appendChild(card);\n            }\n\n            function renderSingleInspector(pack, inst, caseData, prefs) {\n              const card = document.createElement('div');\n              card.className = 'card';\n              card.style.display = 'grid';\n              card.style.gap = '12px';\n\n              const header = document.createElement('div');\n              const title = document.createElement('div');\n              title.style.fontWeight = 'var(--font-semibold)';\n              title.style.fontSize = 'var(--text-lg)';\n              title.textContent = caseData.name || '—';\n              const sub = document.createElement('div');\n              sub.className = 'muted';\n              sub.style.fontSize = 'var(--text-sm)';\n              const mfg = caseData.manufacturer ? caseData.manufacturer : '—';\n              const d = caseData.dimensions || { length: 0, width: 0, height: 0 };\n              sub.textContent = `${mfg} • ${d.length}×${d.width}×${d.height} in`;\n              header.appendChild(title);\n              header.appendChild(sub);\n              card.appendChild(header);\n              card.appendChild(makeMiniCategoryChip(caseData.category));\n\n              const posRow = document.createElement('div');\n              posRow.className = 'row';\n              posRow.style.gap = '10px';\n              const pos = inst.transform.position || { x: 0, y: 0, z: 0 };\n              const fX = smallField(`X (${prefs.units.length})`, Utils.inchesToUnit(pos.x, prefs.units.length));\n              const fY = smallField(`Y (${prefs.units.length})`, Utils.inchesToUnit(pos.y, prefs.units.length));\n              const fZ = smallField(`Z (${prefs.units.length})`, Utils.inchesToUnit(pos.z, prefs.units.length));\n              posRow.appendChild(fX.wrap);\n              posRow.appendChild(fY.wrap);\n              posRow.appendChild(fZ.wrap);\n\n              const row2 = document.createElement('div');\n              row2.className = 'row';\n              row2.style.gap = '10px';\n              const hide = document.createElement('button');\n              hide.className = 'btn';\n              hide.type = 'button';\n              hide.innerHTML = inst.hidden\n                ? '<i class=\"fa-solid fa-eye\"></i> Unhide'\n                : '<i class=\"fa-solid fa-eye-slash\"></i> Hide';\n              hide.addEventListener('click', () =>\n                PackLibrary.updateInstance(pack.id, inst.id, { hidden: !inst.hidden })\n              );\n              const remove = document.createElement('button');\n              remove.className = 'btn btn-danger';\n              remove.type = 'button';\n              remove.innerHTML = '<i class=\"fa-solid fa-trash\"></i> Remove';\n              remove.addEventListener('click', () => {\n                PackLibrary.removeInstances(pack.id, [inst.id]);\n                StateStore.set({ selectedInstanceIds: [] }, { skipHistory: true });\n              });\n              row2.appendChild(hide);\n              row2.appendChild(remove);\n\n              const savePos = document.createElement('button');\n              savePos.className = 'btn btn-primary';\n              savePos.type = 'button';\n              savePos.innerHTML = '<i class=\"fa-solid fa-location-crosshairs\"></i> Apply position';\n              savePos.addEventListener('click', () => {\n                const nextPos = {\n                  x: Utils.unitToInches(Number(fX.input.value) || 0, prefs.units.length),\n                  y: Utils.unitToInches(Number(fY.input.value) || 0, prefs.units.length),\n                  z: Utils.unitToInches(Number(fZ.input.value) || 0, prefs.units.length),\n                };\n                PackLibrary.updateInstance(pack.id, inst.id, { transform: { ...inst.transform, position: nextPos } });\n                SceneManager.focusOnWorldPoint(SceneManager.vecInchesToWorld(nextPos), { duration: 420 });\n                UIComponents.showToast('Position updated', 'success');\n              });\n\n              card.appendChild(posRow);\n              card.appendChild(savePos);\n              card.appendChild(row2);\n              inspectorEl.appendChild(card);\n            }\n\n            function smallField(label, value) {\n              const wrap = document.createElement('div');\n              wrap.className = 'field';\n              wrap.style.minWidth = '90px';\n              const l = document.createElement('div');\n              l.className = 'label';\n              l.textContent = label;\n              const input = document.createElement('input');\n              input.className = 'input';\n              input.type = 'number';\n              input.step = '0.1';\n              input.value = String(Number(value).toFixed(1));\n              wrap.appendChild(l);\n              wrap.appendChild(input);\n              return { wrap, input };\n            }\n\n            function setPanelVisible(side, visible) {\n              const isMobile = window.matchMedia('(max-width: 899px)').matches;\n              const defaultCol = which => {\n                const compact = window.matchMedia('(max-width: 1279px)').matches;\n                if (which === 'left') return compact ? '270px' : '290px';\n                return compact ? '300px' : '340px';\n              };\n              if (side === 'left') {\n                if (isMobile) leftEl.classList.toggle('open', visible);\n                else shellEl.style.setProperty('--left-col', visible ? defaultCol('left') : '0px');\n              }\n              if (side === 'right') {\n                if (isMobile) rightEl.classList.toggle('open', visible);\n                else shellEl.style.setProperty('--right-col', visible ? defaultCol('right') : '0px');\n              }\n            }\n\n            function togglePanel(side) {\n              const isMobile = window.matchMedia('(max-width: 899px)').matches;\n              if (side === 'left') {\n                if (isMobile) {setPanelVisible('left', !leftEl.classList.contains('open'));}\n                else {\n                  const current = getComputedStyle(shellEl).getPropertyValue('--left-col').trim() || '290px';\n                  setPanelVisible('left', current === '0px');\n                }\n              }\n              if (side === 'right') {\n                if (isMobile) {setPanelVisible('right', !rightEl.classList.contains('open'));}\n                else {\n                  const current = getComputedStyle(shellEl).getPropertyValue('--right-col').trim() || '340px';\n                  setPanelVisible('right', current === '0px');\n                }\n              }\n            }\n\n            function wireDropToViewport(canvasEl) {\n              canvasEl.addEventListener('dragover', ev => {\n                ev.preventDefault();\n                ev.dataTransfer.dropEffect = 'copy';\n              });\n              canvasEl.addEventListener('drop', ev => {\n                ev.preventDefault();\n                const caseId = ev.dataTransfer.getData('text/plain');\n                if (!caseId) return;\n                const world = worldPointOnGround(ev.clientX, ev.clientY, canvasEl);\n                if (!world) {\n                  addCaseToPack(caseId);\n                  return;\n                }\n                const inches = SceneManager.vecWorldToInches(world);\n                const c = CaseLibrary.getById(caseId);\n                if (c && c.dimensions && c.dimensions.height) inches.y = Math.max(1, c.dimensions.height / 2);\n                addCaseToPack(caseId, inches);\n              });\n            }\n\n            function worldPointOnGround(clientX, clientY, canvasEl) {\n              const camera = SceneManager.getCamera();\n              if (!camera) return null;\n              const rect = canvasEl.getBoundingClientRect();\n              const x = ((clientX - rect.left) / rect.width) * 2 - 1;\n              const y = -((clientY - rect.top) / rect.height) * 2 + 1;\n              const raycaster = new THREE.Raycaster();\n              raycaster.setFromCamera({ x, y }, camera);\n              const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);\n              const out = new THREE.Vector3();\n              const ok = raycaster.ray.intersectPlane(plane, out);\n              return ok ? out : null;\n            }\n\n            return { init, render };\n          })();\n\n          const UpdatesUI = (() => {\n            const listEl = document.getElementById('updates-list');\n            function init() {}\n            function render() {\n              listEl.innerHTML = '';\n              Data.updates.forEach(u => {\n                const card = document.createElement('div');\n                card.className = 'card';\n                const header = document.createElement('div');\n                header.className = 'row space-between';\n                header.style.alignItems = 'flex-start';\n                const left = document.createElement('div');\n                left.innerHTML = `<div style=\"font-weight:var(--font-semibold);font-size:var(--text-lg)\">Version ${u.version}</div><div class=\"muted\" style=\"font-size:var(--text-xs)\">${new Date(u.date).toLocaleDateString()}</div>`;\n                header.appendChild(left);\n                card.appendChild(header);\n\n                const sections = [\n                  { title: 'New Features', items: u.features || [] },\n                  { title: 'Bug Fixes', items: u.bugFixes || [] },\n                  { title: 'Breaking Changes', items: u.breakingChanges || [] },\n                ].filter(s => s.items.length);\n                sections.forEach(s => {\n                  const t = document.createElement('div');\n                  t.style.marginTop = '12px';\n                  t.style.fontWeight = 'var(--font-semibold)';\n                  t.textContent = s.title;\n                  card.appendChild(t);\n                  const ul = document.createElement('ul');\n                  ul.style.margin = '8px 0 0 16px';\n                  ul.style.color = 'var(--text-secondary)';\n                  ul.style.fontSize = 'var(--text-sm)';\n                  s.items.forEach(it => {\n                    const li = document.createElement('li');\n                    li.textContent = it;\n                    ul.appendChild(li);\n                  });\n                  card.appendChild(ul);\n                });\n                listEl.appendChild(card);\n              });\n            }\n            return { init, render };\n          })();\n\n          const RoadmapUI = (() => {\n            const listEl = document.getElementById('roadmap-list');\n            function init() {}\n            function render() {\n              listEl.innerHTML = '';\n              Data.roadmap.forEach(group => {\n                const wrap = document.createElement('div');\n                wrap.className = 'grid';\n                wrap.style.gap = '10px';\n                const h = document.createElement('div');\n                h.style.fontSize = 'var(--text-lg)';\n                h.style.fontWeight = 'var(--font-semibold)';\n                h.textContent = group.quarter;\n                wrap.appendChild(h);\n                const grid = document.createElement('div');\n                grid.className = 'pack-grid';\n                grid.style.gridTemplateColumns = 'repeat(2, minmax(0, 1fr))';\n                group.items.forEach(item => {\n                  const card = document.createElement('div');\n                  card.className = 'card';\n                  card.style.cursor = 'pointer';\n                  card.innerHTML = `\n                  <div class=\"row space-between\" style=\"gap:10px\">\n                    <div style=\"font-weight:var(--font-semibold)\">${item.title}</div>\n                    <div class=\"badge\" style=\"border-color:transparent;background:${item.color};color:white\">${item.badge} ${item.status}</div>\n                  </div>\n                  <div class=\"muted\" style=\"font-size:var(--text-sm);margin-top:8px\">${item.details}</div>\n                `;\n                  card.addEventListener('click', () => {\n                    UIComponents.showModal({\n                      title: item.title,\n                      content: `<div class=\"muted\" style=\"font-size:var(--text-sm)\">${item.details}</div>`,\n                      actions: [{ label: 'Close', variant: 'primary' }],\n                    });\n                  });\n                  grid.appendChild(card);\n                });\n                wrap.appendChild(grid);\n                listEl.appendChild(wrap);\n              });\n            }\n            return { init, render };\n          })();\n\n          const SettingsUI = (() => {\n            const elLength = document.getElementById('pref-length');\n            const elWeight = document.getElementById('pref-weight');\n            const elTheme = document.getElementById('pref-theme');\n            const elLabel = document.getElementById('pref-label-size');\n            const elHidden = document.getElementById('pref-hidden-opacity');\n            const elSnap = document.getElementById('pref-snapping-enabled');\n            const elGrid = document.getElementById('pref-grid-size');\n            const elShot = document.getElementById('pref-shot-res');\n            const elPdfStats = document.getElementById('pref-pdf-stats');\n            const btnSave = document.getElementById('btn-save-prefs');\n            const btnReset = document.getElementById('btn-reset-demo');\n\n            function init() {\n              btnSave.addEventListener('click', () => save());\n              btnReset.addEventListener('click', async () => {\n                const ok = await UIComponents.confirm({\n                  title: 'Reset demo data?',\n                  message: 'This replaces your local data with the demo set.',\n                  danger: true,\n                  okLabel: 'Reset',\n                });\n                if (!ok) return;\n                Storage.clearAll();\n                window.location.reload();\n              });\n            }\n\n            function loadForm() {\n              const p = PreferencesManager.get();\n              elLength.value = p.units.length;\n              elWeight.value = p.units.weight;\n              elTheme.value = p.theme;\n              elLabel.value = String(p.labelFontSize);\n              elHidden.value = String(p.hiddenCaseOpacity);\n              elSnap.value = String(Boolean(p.snapping.enabled));\n              elGrid.value = String(p.snapping.gridSize);\n              elShot.value = p.export.screenshotResolution;\n              elPdfStats.value = String(Boolean(p.export.pdfIncludeStats));\n            }\n\n            function save() {\n              const prev = PreferencesManager.get();\n              const next = Utils.deepClone(prev);\n              next.units.length = elLength.value;\n              next.units.weight = elWeight.value;\n              next.theme = elTheme.value;\n              next.labelFontSize = Utils.clamp(Number(elLabel.value) || 12, 8, 24);\n              next.hiddenCaseOpacity = Utils.clamp(Number(elHidden.value) || 0.3, 0, 1);\n              next.snapping.enabled = elSnap.value === 'true';\n              next.snapping.gridSize = Math.max(0.25, Number(elGrid.value) || 1);\n              next.export.screenshotResolution = elShot.value;\n              next.export.pdfIncludeStats = elPdfStats.value === 'true';\n              PreferencesManager.set(next);\n              PreferencesManager.applyTheme(next.theme);\n              UIComponents.showToast('Preferences saved', 'success');\n            }\n\n            return { init, loadForm };\n          })();\n\n          const KeyboardManager = (() => {\n            let clipboard = null;\n\n            function init() {\n              document.addEventListener('keydown', handleKeyDown);\n            }\n\n            function handleKeyDown(event) {\n              if (isTypingContext(event)) return;\n              const key = buildKeyString(event);\n              const handler = shortcuts[key];\n              if (!handler) return;\n              const handled = handler(event);\n              if (handled === false) return;\n              event.preventDefault();\n            }\n\n            function isTypingContext(event) {\n              const el = event.target;\n              if (!el) return false;\n              if (el.isContentEditable) return true;\n              return el.matches && el.matches('input, textarea, select');\n            }\n\n            function buildKeyString(event) {\n              const parts = [];\n              if (event.metaKey) parts.push('meta');\n              if (event.ctrlKey && !event.metaKey) parts.push('ctrl');\n              if (event.shiftKey) parts.push('shift');\n              if (event.altKey) parts.push('alt');\n              parts.push(String(event.key || '').toLowerCase());\n              return parts.join('+');\n            }\n\n            function inEditor() {\n              return StateStore.get('currentScreen') === 'editor';\n            }\n\n            function save() {\n              Storage.saveNow();\n              UIComponents.showToast('Saved locally', 'success', { title: 'Storage' });\n            }\n\n            function undo() {\n              const ok = StateStore.undo();\n              UIComponents.showToast(ok ? 'Undone' : 'Nothing to undo', ok ? 'info' : 'warning', { title: 'Edit' });\n            }\n\n            function redo() {\n              const ok = StateStore.redo();\n              UIComponents.showToast(ok ? 'Redone' : 'Nothing to redo', ok ? 'info' : 'warning', { title: 'Edit' });\n            }\n\n            function deselectAll() {\n              StateStore.set({ selectedInstanceIds: [] }, { skipHistory: true });\n              CaseScene.setSelected([]);\n            }\n\n            function selectAll() {\n              if (!inEditor()) return false;\n              InteractionManager.selectAllInPack();\n            }\n\n            function deleteSelected() {\n              if (!inEditor()) return false;\n              InteractionManager.deleteSelection();\n            }\n\n            function duplicateSelected() {\n              if (!inEditor()) return false;\n              const packId = StateStore.get('currentPackId');\n              const pack = PackLibrary.getById(packId);\n              const selected = StateStore.get('selectedInstanceIds') || [];\n              if (!pack || !selected.length) return;\n\n              const nextCases = [...(pack.cases || [])];\n              const newIds = [];\n              selected.forEach(id => {\n                const inst = (pack.cases || []).find(i => i.id === id);\n                if (!inst) return;\n                const pos =\n                  inst.transform && inst.transform.position ? inst.transform.position : { x: -80, y: 10, z: 0 };\n                nextCases.push({\n                  ...Utils.deepClone(inst),\n                  id: Utils.uuid(),\n                  transform: {\n                    ...Utils.deepClone(inst.transform || {}),\n                    position: { x: pos.x + 12, y: pos.y, z: pos.z + 12 },\n                  },\n                  hidden: false,\n                });\n                newIds.push(nextCases[nextCases.length - 1].id);\n              });\n\n              PackLibrary.update(packId, { cases: nextCases });\n              StateStore.set({ selectedInstanceIds: newIds }, { skipHistory: true });\n              UIComponents.showToast(`Duplicated ${newIds.length} case(s)`, 'success', { title: 'Edit' });\n            }\n\n            function copySelected() {\n              if (!inEditor()) return false;\n              const packId = StateStore.get('currentPackId');\n              const pack = PackLibrary.getById(packId);\n              const selected = StateStore.get('selectedInstanceIds') || [];\n              if (!pack || !selected.length) return;\n              clipboard = selected\n                .map(id => (pack.cases || []).find(i => i.id === id))\n                .filter(Boolean)\n                .map(i => ({ caseId: i.caseId, transform: Utils.deepClone(i.transform || {}) }));\n              UIComponents.showToast(`Copied ${clipboard.length} case(s)`, 'info', { title: 'Clipboard' });\n            }\n\n            function pasteClipboard() {\n              if (!inEditor()) return false;\n              const packId = StateStore.get('currentPackId');\n              const pack = PackLibrary.getById(packId);\n              if (!pack || !clipboard || !clipboard.length) return;\n\n              const nextCases = [...(pack.cases || [])];\n              const newIds = [];\n              clipboard.forEach(item => {\n                const pos =\n                  item.transform && item.transform.position ? item.transform.position : { x: -80, y: 10, z: 0 };\n                nextCases.push({\n                  id: Utils.uuid(),\n                  caseId: item.caseId,\n                  transform: {\n                    position: { x: pos.x + 12, y: pos.y, z: pos.z + 12 },\n                    rotation: Utils.deepClone((item.transform && item.transform.rotation) || { x: 0, y: 0, z: 0 }),\n                    scale: Utils.deepClone((item.transform && item.transform.scale) || { x: 1, y: 1, z: 1 }),\n                  },\n                  hidden: false,\n                  groupId: null,\n                });\n                newIds.push(nextCases[nextCases.length - 1].id);\n              });\n\n              PackLibrary.update(packId, { cases: nextCases });\n              StateStore.set({ selectedInstanceIds: newIds }, { skipHistory: true });\n              UIComponents.showToast(`Pasted ${newIds.length} case(s)`, 'success', { title: 'Clipboard' });\n            }\n\n            function focusSelected() {\n              if (!inEditor()) return false;\n              const selected = StateStore.get('selectedInstanceIds') || [];\n              if (!selected.length) return;\n              const obj = CaseScene.getObject(selected[0]);\n              if (!obj) return;\n              SceneManager.focusOnWorldPoint(obj.position.clone(), { duration: 600 });\n            }\n\n            function toggleGrid() {\n              if (!inEditor()) return false;\n              const visible = SceneManager.toggleGrid();\n              UIComponents.showToast(visible ? 'Grid shown' : 'Grid hidden', 'info', { title: 'View', duration: 1200 });\n            }\n\n            function toggleShadows() {\n              if (!inEditor()) return false;\n              const enabled = SceneManager.toggleShadows();\n              UIComponents.showToast(enabled ? 'Shadows enabled' : 'Shadows disabled', 'info', {\n                title: 'View',\n                duration: 1200,\n              });\n            }\n\n            function openPackDialog() {\n              const packs = PackLibrary.getPacks()\n                .slice()\n                .sort((a, b) => (b.lastEdited || 0) - (a.lastEdited || 0));\n              const content = document.createElement('div');\n              content.className = 'grid';\n              content.style.gap = '10px';\n              if (!packs.length) {\n                const empty = document.createElement('div');\n                empty.className = 'muted';\n                empty.style.fontSize = 'var(--text-sm)';\n                empty.textContent = 'No packs available.';\n                content.appendChild(empty);\n              } else {\n                packs.forEach(p => {\n                  const row = document.createElement('button');\n                  row.type = 'button';\n                  row.className = 'btn';\n                  row.style.justifyContent = 'space-between';\n                  row.style.width = '100%';\n                  const name = document.createElement('span');\n                  name.style.fontWeight = 'var(--font-semibold)';\n                  name.textContent = p.title || 'Untitled';\n                  const meta = document.createElement('span');\n                  meta.className = 'muted';\n                  meta.style.fontSize = 'var(--text-xs)';\n                  meta.textContent = `edited ${Utils.formatRelativeTime(p.lastEdited)}`;\n                  row.appendChild(name);\n                  row.appendChild(meta);\n                  row.addEventListener('click', () => {\n                    PackLibrary.open(p.id);\n                    AppShell.navigate('editor');\n                    modal.close();\n                  });\n                  content.appendChild(row);\n                });\n              }\n\n              const modal = UIComponents.showModal({\n                title: 'Open Pack',\n                content,\n                actions: [{ label: 'Close', variant: 'primary' }],\n              });\n            }\n\n            const shortcuts = {\n              'meta+s': save,\n              'ctrl+s': save,\n              'meta+z': undo,\n              'ctrl+z': undo,\n              'meta+shift+z': redo,\n              'ctrl+shift+z': redo,\n              'meta+a': selectAll,\n              'ctrl+a': selectAll,\n              'meta+shift+a': deselectAll,\n              'ctrl+shift+a': deselectAll,\n              escape: deselectAll,\n              delete: deleteSelected,\n              backspace: deleteSelected,\n              'meta+d': duplicateSelected,\n              'ctrl+d': duplicateSelected,\n              'meta+c': copySelected,\n              'ctrl+c': copySelected,\n              'meta+v': pasteClipboard,\n              'ctrl+v': pasteClipboard,\n              'meta+p': () => {\n                if (!inEditor()) return false;\n                AutoPackEngine.pack();\n              },\n              'ctrl+p': () => {\n                if (!inEditor()) return false;\n                AutoPackEngine.pack();\n              },\n              'meta+o': openPackDialog,\n              'ctrl+o': openPackDialog,\n              g: toggleGrid,\n              s: toggleShadows,\n              f: focusSelected,\n              p: () => {\n                if (!inEditor()) return false;\n                SceneManager.toggleDevOverlay();\n              },\n            };\n\n            return { init };\n          })();\n\n          function wireGlobalButtons() {\n            const btnExport = document.getElementById('btn-export-app');\n            const btnImport = document.getElementById('btn-import-app');\n            const btnHelp = document.getElementById('btn-help');\n\n            btnExport.addEventListener('click', () => {\n              const json = Storage.exportAppJSON();\n              Utils.downloadText(`truck-packer-3d-${Date.now()}.json`, json);\n              UIComponents.showToast('Exported app JSON', 'success');\n            });\n\n            btnImport.addEventListener('click', () => {\n              const input = document.createElement('input');\n              input.type = 'file';\n              input.accept = '.json,application/json';\n              input.addEventListener('change', async () => {\n                const file = input.files && input.files[0];\n                if (!file) return;\n                const text = await file.text();\n                try {\n                  const imported = Storage.importAppJSON(text);\n                  const prev = StateStore.get();\n                  const nextState = {\n                    ...prev,\n                    caseLibrary: imported.caseLibrary,\n                    packLibrary: imported.packLibrary,\n                    preferences: imported.preferences,\n                    currentPackId: null,\n                    currentScreen: 'packs',\n                    selectedInstanceIds: [],\n                  };\n                  StateStore.replace(nextState, { skipHistory: false });\n                  Storage.saveNow();\n                  PreferencesManager.applyTheme(nextState.preferences.theme);\n                  UIComponents.showToast('Imported app JSON', 'success');\n                } catch (err) {\n                  UIComponents.showToast('Import failed: ' + err.message, 'error');\n                }\n              });\n              input.click();\n            });\n\n            if (btnHelp) {\n              btnHelp.addEventListener('click', () => {\n                UIComponents.showModal({\n                  title: 'Help — Export / Import',\n                  content: `\n                  <div class=\"muted\" style=\"font-size:var(--text-sm);line-height:var(--leading-relaxed)\">\n                    <strong>Export</strong>: Downloads data as JSON. Use the topbar <em>Export</em> to save a full app backup, or use a pack's <em>Export JSON</em> from the pack menu to export a single pack.<br><br>\n                    <strong>Import</strong>: Loads a full-app JSON backup. Click the topbar <em>Import</em>, choose a previously exported app JSON, and the app state will be restored/merged.<br><br>\n                    <strong>Import Pack</strong>: Adds a single pack to your library. Use when someone shares a pack JSON (exported from the pack kebab menu).<br><br>\n                    Tip: Always use <em>Export</em> to make a backup before importing.\n                  </div>\n                `,\n                  actions: [{ label: 'Close', variant: 'primary' }],\n                });\n              });\n            }\n          }\n\n          function seedIfEmpty() {\n            const stored = Storage.load();\n            if (stored && stored.caseLibrary && stored.packLibrary && stored.preferences) {\n              const initialState = {\n                currentScreen: 'packs',\n                currentPackId: stored.currentPackId || null,\n                selectedInstanceIds: [],\n                caseLibrary: stored.caseLibrary,\n                packLibrary: stored.packLibrary,\n                preferences: stored.preferences,\n              };\n              StateStore.init(initialState);\n              return;\n            }\n\n            const cases = Defaults.seedCases();\n            cases.forEach(c => {\n              c.volume = Utils.volumeInCubicInches(c.dimensions);\n            });\n            const demoPack = Defaults.seedPack(cases);\n            demoPack.stats = PackLibrary.computeStats(demoPack, cases);\n            const initialState = {\n              currentScreen: 'packs',\n              currentPackId: demoPack.id,\n              selectedInstanceIds: [],\n              caseLibrary: cases,\n              packLibrary: [demoPack],\n              preferences: Defaults.defaultPreferences,\n            };\n            StateStore.init(initialState);\n            Storage.saveNow();\n          }\n\n          function validateRuntime() {\n            const failures = window.__TP3D_BOOT && window.__TP3D_BOOT.cdnFailures ? window.__TP3D_BOOT.cdnFailures : [];\n            failures.forEach(f => {\n              UIComponents.showToast(`${f.name} failed to load`, 'error', {\n                title: 'CDN',\n                actions: [{ label: 'Retry', onClick: () => window.location.reload() }],\n              });\n            });\n\n            if (!Utils.hasWebGL()) {\n              SystemOverlay.show({\n                title: 'WebGL required',\n                message: 'This app requires WebGL. Please update your browser or enable hardware acceleration.',\n                items: ['Chrome/Edge: Settings → System → Use hardware acceleration', 'Safari: Update to Safari 14+'],\n              });\n              return false;\n            }\n\n            const missing = [];\n            if (!window.THREE) missing.push('three@0.160.0');\n            if (!window.THREE || !window.THREE.OrbitControls) missing.push('OrbitControls');\n            if (!window.TWEEN) missing.push('@tweenjs/tween.js');\n            if (!window.XLSX) missing.push('xlsx');\n            if (!window.jspdf) missing.push('jsPDF');\n            if (missing.length) {\n              SystemOverlay.show({\n                title: 'Missing dependencies',\n                message: 'Some required CDN libraries did not load. Check your connection or allowlisted CDNs.',\n                items: missing.map(m => `Missing: ${m}`),\n              });\n              return false;\n            }\n\n            return true;\n          }\n\n          function renderAll() {\n            AppShell.renderShell();\n            PacksUI.render();\n            CasesUI.render();\n            EditorUI.render();\n            UpdatesUI.render();\n            RoadmapUI.render();\n            SettingsUI.loadForm();\n          }\n\n          function init() {\n            console.info('[TruckPackerApp] init start');\n            if (!validateRuntime()) return;\n            seedIfEmpty();\n\n            PreferencesManager.applyTheme(StateStore.get('preferences').theme);\n\n            AppShell.init();\n            PacksUI.init();\n            CasesUI.init();\n            EditorUI.init();\n            UpdatesUI.init();\n            RoadmapUI.init();\n            SettingsUI.init();\n            AccountSwitcher.init();\n            wireGlobalButtons();\n            KeyboardManager.init();\n\n            let prevScreen = StateStore.get('currentScreen');\n\n            StateStore.subscribe(changes => {\n              if (\n                changes.preferences ||\n                changes.caseLibrary ||\n                changes.packLibrary ||\n                changes.currentPackId ||\n                changes._undo ||\n                changes._redo ||\n                changes._replace\n              ) {\n                Storage.saveSoon();\n              }\n              if (changes.preferences || changes._undo || changes._redo || changes._replace) {\n                const prefs = StateStore.get('preferences');\n                if (prefs && prefs.theme) PreferencesManager.applyTheme(prefs.theme);\n                SceneManager.refreshTheme();\n                SettingsUI.loadForm();\n              }\n\n              if (changes.currentScreen) {\n                const nextScreen = StateStore.get('currentScreen');\n                if (prevScreen === 'editor' && nextScreen !== 'editor') {\n                  const packId = StateStore.get('currentPackId');\n                  const pack = packId ? PackLibrary.getById(packId) : null;\n                  const lastEdited = pack && Number.isFinite(pack.lastEdited) ? pack.lastEdited : 0;\n                  const thumbAt = pack && Number.isFinite(pack.thumbnailUpdatedAt) ? pack.thumbnailUpdatedAt : 0;\n                  const totalCases = pack && Array.isArray(pack.cases) ? pack.cases.length : 0;\n                  if (pack && totalCases > 0 && lastEdited > thumbAt) {\n                    ExportService.capturePackPreview(packId, { source: 'auto', quiet: true });\n                  }\n                }\n                prevScreen = nextScreen;\n\n                AppShell.renderShell();\n                if (StateStore.get('currentScreen') === 'editor') EditorUI.render();\n              }\n\n              if (changes.caseLibrary || changes.packLibrary || changes._undo || changes._redo || changes._replace) {\n                PacksUI.render();\n                CasesUI.render();\n                EditorUI.render();\n                if (StateStore.get('currentScreen') === 'editor') AppShell.renderShell();\n              }\n              if (changes.currentPackId) {\n                AppShell.renderShell();\n                EditorUI.render();\n              }\n              if (changes.selectedInstanceIds) {\n                EditorUI.render();\n              }\n            });\n\n            renderAll();\n            UIComponents.showToast('Ready', 'success', { title: 'Truck Packer 3D' });\n          }\n\n          return {\n            init,\n            ui: {\n              showToast: UIComponents.showToast,\n              showModal: UIComponents.showModal,\n              confirm: UIComponents.confirm,\n            },\n            _debug: { Utils, StateStore, Storage, CaseLibrary, PackLibrary, Defaults },\n          };\n        })();\n\n        const boot = () => {\n          console.info('[TruckPackerApp] boot -> init');\n          window.TruckPackerApp.init();\n        };\n\n        if (document.readyState === 'loading') {\n          document.addEventListener('DOMContentLoaded', boot);\n        } else {\n          boot();\n        }\n      })();\n    </script>\n  </body>\n</html>\n","usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/app.js","messages":[{"ruleId":"no-shadow","severity":1,"message":"'init' is already declared in the upper scope on line 5874 column 14.","line":564,"column":16,"nodeType":"Identifier","messageId":"noShadow","endLine":564,"endColumn":20},{"ruleId":"no-shadow","severity":1,"message":"'snapshot' is already declared in the upper scope on line 590 column 16.","line":594,"column":28,"nodeType":"Identifier","messageId":"noShadow","endLine":594,"endColumn":36},{"ruleId":"no-use-before-define","severity":1,"message":"'Defaults' was used before it was defined.","line":657,"column":46,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":657,"endColumn":54},{"ruleId":"no-use-before-define","severity":1,"message":"'Defaults' was used before it was defined.","line":681,"column":33,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":681,"endColumn":41},{"ruleId":"no-use-before-define","severity":1,"message":"'Defaults' was used before it was defined.","line":695,"column":44,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":695,"endColumn":52},{"ruleId":"no-use-before-define","severity":1,"message":"'Defaults' was used before it was defined.","line":741,"column":91,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":741,"endColumn":99},{"ruleId":"no-use-before-define","severity":1,"message":"'Defaults' was used before it was defined.","line":752,"column":24,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":752,"endColumn":32},{"ruleId":"no-use-before-define","severity":1,"message":"'CategoryService' was used before it was defined.","line":997,"column":48,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":997,"endColumn":63},{"ruleId":"no-use-before-define","severity":1,"message":"'PackLibrary' was used before it was defined.","line":1076,"column":22,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":1076,"endColumn":33},{"ruleId":"no-use-before-define","severity":1,"message":"'CaseLibrary' was used before it was defined.","line":1210,"column":9,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":1210,"endColumn":20},{"ruleId":"no-use-before-define","severity":1,"message":"'CaseLibrary' was used before it was defined.","line":1221,"column":26,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":1221,"endColumn":37},{"ruleId":"no-shadow","severity":1,"message":"'init' is already declared in the upper scope on line 5874 column 14.","line":1589,"column":16,"nodeType":"Identifier","messageId":"noShadow","endLine":1589,"endColumn":20},{"ruleId":"no-shadow","severity":1,"message":"'init' is already declared in the upper scope on line 5874 column 14.","line":1645,"column":16,"nodeType":"Identifier","messageId":"noShadow","endLine":1645,"endColumn":20},{"ruleId":"consistent-return","severity":1,"message":"Expected to return a value at the end of method 'onClick'.","line":1871,"column":27,"nodeType":"ArrowFunctionExpression","messageId":"missingReturn","endLine":1871,"endColumn":29},{"ruleId":"consistent-return","severity":1,"message":"Expected to return a value at the end of method 'onClick'.","line":1913,"column":27,"nodeType":"ArrowFunctionExpression","messageId":"missingReturn","endLine":1913,"endColumn":29},{"ruleId":"no-shadow","severity":1,"message":"'init' is already declared in the upper scope on line 5874 column 14.","line":2087,"column":16,"nodeType":"Identifier","messageId":"noShadow","endLine":2087,"endColumn":20},{"ruleId":"no-shadow","severity":1,"message":"'field' is already declared in the upper scope on line 2626 column 16.","line":2102,"column":19,"nodeType":"Identifier","messageId":"noShadow","endLine":2102,"endColumn":24},{"ruleId":"no-shadow","severity":1,"message":"'field' is already declared in the upper scope on line 2626 column 16.","line":2119,"column":17,"nodeType":"Identifier","messageId":"noShadow","endLine":2119,"endColumn":22},{"ruleId":"consistent-return","severity":1,"message":"Expected to return a value at the end of method 'onClick'.","line":2460,"column":27,"nodeType":"ArrowFunctionExpression","messageId":"missingReturn","endLine":2460,"endColumn":29},{"ruleId":"no-shadow","severity":1,"message":"'init' is already declared in the upper scope on line 5874 column 14.","line":3130,"column":16,"nodeType":"Identifier","messageId":"noShadow","endLine":3130,"endColumn":20},{"ruleId":"no-shadow","severity":1,"message":"'init' is already declared in the upper scope on line 5874 column 14.","line":3725,"column":16,"nodeType":"Identifier","messageId":"noShadow","endLine":3725,"endColumn":20},{"ruleId":"no-await-in-loop","severity":1,"message":"Unexpected `await` inside a loop.","line":4194,"column":11,"nodeType":"AwaitExpression","messageId":"unexpectedAwait","endLine":4194,"endColumn":54},{"ruleId":"no-await-in-loop","severity":1,"message":"Unexpected `await` inside a loop.","line":4195,"column":11,"nodeType":"AwaitExpression","messageId":"unexpectedAwait","endLine":4195,"endColumn":26},{"ruleId":"no-shadow","severity":1,"message":"'init' is already declared in the upper scope on line 5874 column 14.","line":4639,"column":16,"nodeType":"Identifier","messageId":"noShadow","endLine":4639,"endColumn":20},{"ruleId":"no-shadow","severity":1,"message":"'init' is already declared in the upper scope on line 5874 column 14.","line":5181,"column":16,"nodeType":"Identifier","messageId":"noShadow","endLine":5181,"endColumn":20},{"ruleId":"no-shadow","severity":1,"message":"'init' is already declared in the upper scope on line 5874 column 14.","line":5225,"column":16,"nodeType":"Identifier","messageId":"noShadow","endLine":5225,"endColumn":20},{"ruleId":"no-shadow","severity":1,"message":"'init' is already declared in the upper scope on line 5874 column 14.","line":5280,"column":16,"nodeType":"Identifier","messageId":"noShadow","endLine":5280,"endColumn":20},{"ruleId":"no-shadow","severity":1,"message":"'init' is already declared in the upper scope on line 5874 column 14.","line":5332,"column":16,"nodeType":"Identifier","messageId":"noShadow","endLine":5332,"endColumn":20},{"ruleId":"no-use-before-define","severity":1,"message":"'shortcuts' was used before it was defined.","line":5339,"column":25,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":5339,"endColumn":34},{"ruleId":"consistent-return","severity":1,"message":"Expected to return a value at the end of function 'selectAll'.","line":5387,"column":16,"nodeType":"FunctionDeclaration","messageId":"missingReturn","endLine":5387,"endColumn":25},{"ruleId":"consistent-return","severity":1,"message":"Expected to return a value at the end of function 'deleteSelected'.","line":5392,"column":16,"nodeType":"FunctionDeclaration","messageId":"missingReturn","endLine":5392,"endColumn":30},{"ruleId":"consistent-return","severity":1,"message":"Expected to return a value at the end of function 'duplicateSelected'.","line":5397,"column":16,"nodeType":"FunctionDeclaration","messageId":"missingReturn","endLine":5397,"endColumn":33},{"ruleId":"consistent-return","severity":1,"message":"Function 'duplicateSelected' expected a return value.","line":5402,"column":40,"nodeType":"ReturnStatement","messageId":"missingReturnValue","endLine":5402,"endColumn":47},{"ruleId":"consistent-return","severity":1,"message":"Expected to return a value at the end of function 'copySelected'.","line":5427,"column":16,"nodeType":"FunctionDeclaration","messageId":"missingReturn","endLine":5427,"endColumn":28},{"ruleId":"consistent-return","severity":1,"message":"Function 'copySelected' expected a return value.","line":5432,"column":40,"nodeType":"ReturnStatement","messageId":"missingReturnValue","endLine":5432,"endColumn":47},{"ruleId":"consistent-return","severity":1,"message":"Expected to return a value at the end of function 'pasteClipboard'.","line":5440,"column":16,"nodeType":"FunctionDeclaration","messageId":"missingReturn","endLine":5440,"endColumn":30},{"ruleId":"consistent-return","severity":1,"message":"Function 'pasteClipboard' expected a return value.","line":5444,"column":55,"nodeType":"ReturnStatement","messageId":"missingReturnValue","endLine":5444,"endColumn":62},{"ruleId":"consistent-return","severity":1,"message":"Expected to return a value at the end of function 'focusSelected'.","line":5469,"column":16,"nodeType":"FunctionDeclaration","messageId":"missingReturn","endLine":5469,"endColumn":29},{"ruleId":"consistent-return","severity":1,"message":"Function 'focusSelected' expected a return value.","line":5472,"column":31,"nodeType":"ReturnStatement","messageId":"missingReturnValue","endLine":5472,"endColumn":38},{"ruleId":"consistent-return","severity":1,"message":"Function 'focusSelected' expected a return value.","line":5474,"column":19,"nodeType":"ReturnStatement","messageId":"missingReturnValue","endLine":5474,"endColumn":26},{"ruleId":"consistent-return","severity":1,"message":"Expected to return a value at the end of function 'toggleGrid'.","line":5478,"column":16,"nodeType":"FunctionDeclaration","messageId":"missingReturn","endLine":5478,"endColumn":26},{"ruleId":"consistent-return","severity":1,"message":"Expected to return a value at the end of function 'toggleShadows'.","line":5484,"column":16,"nodeType":"FunctionDeclaration","messageId":"missingReturn","endLine":5484,"endColumn":29},{"ruleId":"no-use-before-define","severity":1,"message":"'modal' was used before it was defined.","line":5525,"column":15,"nodeType":"Identifier","messageId":"usedBeforeDefined","endLine":5525,"endColumn":20},{"ruleId":"consistent-return","severity":1,"message":"Expected to return a value at the end of method 'meta+p'.","line":5558,"column":22,"nodeType":"ArrowFunctionExpression","messageId":"missingReturn","endLine":5558,"endColumn":24},{"ruleId":"consistent-return","severity":1,"message":"Expected to return a value at the end of method 'ctrl+p'.","line":5567,"column":22,"nodeType":"ArrowFunctionExpression","messageId":"missingReturn","endLine":5567,"endColumn":24},{"ruleId":"consistent-return","severity":1,"message":"Expected to return a value at the end of method 'p'.","line":5581,"column":15,"nodeType":"ArrowFunctionExpression","messageId":"missingReturn","endLine":5581,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":46,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { clearSession, getSession, initSession, setCurrentOrgId, upsertOrg } from './auth/session.js';\nimport { canUseFeature } from './config/features.js';\nimport { BillingService } from './data/services/billing.service.js';\nimport { Router } from './router.js';\nimport { mountAccountSwitcher } from './ui/components/account-switcher.js';\n\n(async function () {\n  try {\n    if (window.__TP3D_BOOT && window.__TP3D_BOOT.threeReady) {\n      await window.__TP3D_BOOT.threeReady;\n    }\n  } catch (_) {\n    // Ignore boot errors\n  }\n\n  console.info('[TruckPackerApp] threeReady resolved, bootstrapping app');\n\n  window.TruckPackerApp = (function () {\n    'use strict';\n\n    const APP_VERSION = '1.0.0';\n\n    const Utils = (() => {\n      const clamp = (value, min, max) => Math.min(max, Math.max(min, value));\n\n      function safeJsonParse(text, fallback = null) {\n        try {\n          return JSON.parse(text);\n        } catch (_) {\n          return fallback;\n        }\n      }\n\n      function deepClone(obj) {\n        return JSON.parse(JSON.stringify(obj));\n      }\n\n      function sanitizeJSON(value) {\n        // Prevent prototype pollution via imported JSON (__proto__/constructor/prototype keys).\n        if (Array.isArray(value)) return value.map(sanitizeJSON);\n        if (!value || typeof value !== 'object') return value;\n        const out = {};\n        Object.keys(value).forEach(key => {\n          if (key === '__proto__' || key === 'prototype' || key === 'constructor') return;\n          out[key] = sanitizeJSON(value[key]);\n        });\n        return out;\n      }\n\n      function uuid() {\n        if (window.crypto && window.crypto.randomUUID) return window.crypto.randomUUID();\n        const buf = new Uint8Array(16);\n        (window.crypto || window.msCrypto).getRandomValues(buf);\n        buf[6] = (buf[6] & 0x0f) | 0x40;\n        buf[8] = (buf[8] & 0x3f) | 0x80;\n        const hex = Array.from(buf).map(b => b.toString(16).padStart(2, '0'));\n        return (\n          hex.slice(0, 4).join('') +\n          '-' +\n          hex.slice(4, 6).join('') +\n          '-' +\n          hex.slice(6, 8).join('') +\n          '-' +\n          hex.slice(8, 10).join('') +\n          '-' +\n          hex.slice(10, 16).join('')\n        );\n      }\n\n      function debounce(fn, waitMs) {\n        let t = null;\n        return function (...args) {\n          window.clearTimeout(t);\n          t = window.setTimeout(() => fn.apply(this, args), waitMs);\n        };\n      }\n\n      function formatRelativeTime(ts) {\n        if (!ts) return '—';\n        const delta = Date.now() - ts;\n        const s = Math.floor(delta / 1000);\n        if (s < 10) return 'just now';\n        if (s < 60) return `${s}s ago`;\n        const m = Math.floor(s / 60);\n        if (m < 60) return `${m}m ago`;\n        const h = Math.floor(m / 60);\n        if (h < 24) return `${h}h ago`;\n        const d = Math.floor(h / 24);\n        if (d < 30) return `${d}d ago`;\n        return new Date(ts).toLocaleDateString();\n      }\n\n      function downloadText(filename, text, mime = 'application/json') {\n        const blob = new Blob([text], { type: mime });\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = filename;\n        document.body.appendChild(a);\n        a.click();\n        document.body.removeChild(a);\n        URL.revokeObjectURL(url);\n      }\n\n      function parseResolution(res) {\n        const m = String(res || '').match(/^(\\d+)x(\\d+)$/);\n        if (!m) return { width: 1920, height: 1080 };\n        return { width: Number(m[1]), height: Number(m[2]) };\n      }\n\n      const lengthUnits = ['in', 'ft', 'mm', 'cm', 'm'];\n      const weightUnits = ['lb', 'kg'];\n\n      function inchesToUnit(inches, unit) {\n        switch (unit) {\n          case 'in':\n            return inches;\n          case 'ft':\n            return inches / 12;\n          case 'mm':\n            return inches * 25.4;\n          case 'cm':\n            return inches * 2.54;\n          case 'm':\n            return inches * 0.0254;\n          default:\n            return inches;\n        }\n      }\n\n      function unitToInches(value, unit) {\n        switch (unit) {\n          case 'in':\n            return value;\n          case 'ft':\n            return value * 12;\n          case 'mm':\n            return value / 25.4;\n          case 'cm':\n            return value / 2.54;\n          case 'm':\n            return value / 0.0254;\n          default:\n            return value;\n        }\n      }\n\n      function poundsToUnit(lb, unit) {\n        switch (unit) {\n          case 'lb':\n            return lb;\n          case 'kg':\n            return lb * 0.45359237;\n          default:\n            return lb;\n        }\n      }\n\n      function unitToPounds(value, unit) {\n        switch (unit) {\n          case 'lb':\n            return value;\n          case 'kg':\n            return value / 0.45359237;\n          default:\n            return value;\n        }\n      }\n\n      function formatLength(inches, unit, digits = 1) {\n        const v = inchesToUnit(inches, unit);\n        const fixed = unit === 'in' ? 0 : digits;\n        return `${Number.isFinite(v) ? v.toFixed(fixed) : '—'} ${unit}`;\n      }\n\n      function formatWeight(lb, unit, digits = 1) {\n        const v = poundsToUnit(lb, unit);\n        const fixed = unit === 'lb' ? 0 : digits;\n        return `${Number.isFinite(v) ? v.toFixed(fixed) : '—'} ${unit}`;\n      }\n\n      function formatDims(dimInches, lengthUnit) {\n        const l = inchesToUnit(dimInches.length, lengthUnit);\n        const w = inchesToUnit(dimInches.width, lengthUnit);\n        const h = inchesToUnit(dimInches.height, lengthUnit);\n        const fixed = lengthUnit === 'in' ? 0 : 1;\n        return `${l.toFixed(fixed)}×${w.toFixed(fixed)}×${h.toFixed(fixed)} ${lengthUnit}`;\n      }\n\n      function volumeInCubicInches(dimInches) {\n        const { length, width, height } = dimInches;\n        return Math.max(0, Number(length) * Number(width) * Number(height));\n      }\n\n      function formatVolume(dimInches, lengthUnit) {\n        const in3 = volumeInCubicInches(dimInches);\n        if (!Number.isFinite(in3)) return '—';\n        const isImperial = lengthUnit === 'in' || lengthUnit === 'ft';\n        if (isImperial) {\n          const ft3 = in3 / 1728;\n          return `${ft3.toFixed(1)} ft³`;\n        }\n        const m3 = in3 * Math.pow(0.0254, 3);\n        return `${m3.toFixed(3)} m³`;\n      }\n\n      function hasWebGL() {\n        try {\n          const canvas = document.createElement('canvas');\n          return Boolean(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));\n        } catch (_) {\n          return false;\n        }\n      }\n\n      function cssHexToInt(hex) {\n        const s = String(hex || '').trim();\n        const m = s.match(/^#([0-9a-f]{6})$/i);\n        if (!m) return 0x000000;\n        return parseInt(m[1], 16);\n      }\n\n      function getCssVar(name) {\n        return getComputedStyle(document.documentElement).getPropertyValue(name).trim();\n      }\n\n      return {\n        APP_VERSION,\n        clamp,\n        safeJsonParse,\n        deepClone,\n        sanitizeJSON,\n        uuid,\n        debounce,\n        formatRelativeTime,\n        downloadText,\n        parseResolution,\n        lengthUnits,\n        weightUnits,\n        inchesToUnit,\n        unitToInches,\n        poundsToUnit,\n        unitToPounds,\n        formatLength,\n        formatWeight,\n        formatDims,\n        volumeInCubicInches,\n        formatVolume,\n        hasWebGL,\n        cssHexToInt,\n        getCssVar,\n      };\n    })();\n\n    const UIComponents = (() => {\n      const modalRoot = document.getElementById('modal-root');\n      const toastContainer = document.getElementById('toast-container');\n      let dropdownKeyDownListener = null;\n\n      const toastTypes = {\n        success: { title: 'Success', color: 'var(--success)', icon: '✓' },\n        error: { title: 'Error', color: 'var(--error)', icon: '✕' },\n        warning: { title: 'Warning', color: 'var(--warning)', icon: '⚠' },\n        info: { title: 'Info', color: 'var(--info)', icon: 'ℹ' },\n      };\n\n      function showToast(message, type = 'info', options = {}) {\n        const cfg = toastTypes[type] || toastTypes.info;\n        const toast = document.createElement('div');\n        toast.className = 'toast';\n        toast.setAttribute('role', 'status');\n\n        const icon = document.createElement('div');\n        icon.className = 'toast-icon';\n        icon.style.background = cfg.color;\n        icon.textContent = cfg.icon;\n\n        const body = document.createElement('div');\n        body.className = 'toast-body';\n\n        const title = document.createElement('div');\n        title.className = 'toast-title';\n        title.textContent = options.title || cfg.title;\n\n        const msg = document.createElement('div');\n        msg.className = 'toast-message';\n        msg.textContent = String(message || '');\n\n        body.appendChild(title);\n        body.appendChild(msg);\n\n        if (Array.isArray(options.actions) && options.actions.length) {\n          const actions = document.createElement('div');\n          actions.className = 'toast-actions';\n          options.actions.forEach(action => {\n            const btn = document.createElement('button');\n            btn.className = 'toast-btn';\n            btn.type = 'button';\n            btn.textContent = action.label || 'Action';\n            btn.addEventListener('click', ev => {\n              ev.stopPropagation();\n              try {\n                action.onClick && action.onClick();\n              } catch (_) {\n                // Ignore errors from action handlers\n              }\n              removeToast(toast);\n            });\n            actions.appendChild(btn);\n          });\n          body.appendChild(actions);\n        }\n\n        toast.appendChild(icon);\n        toast.appendChild(body);\n\n        toast.addEventListener('click', () => removeToast(toast));\n        toastContainer.appendChild(toast);\n\n        while (toastContainer.children.length > 3) {\n          toastContainer.removeChild(toastContainer.firstChild);\n        }\n\n        const duration = Number.isFinite(options.duration) ? options.duration : 3200;\n        if (duration > 0) window.setTimeout(() => removeToast(toast), duration);\n      }\n\n      function removeToast(toast) {\n        if (!toast || !toast.parentElement) return;\n        toast.style.opacity = '0';\n        toast.style.transform = 'translateX(12px)';\n        window.setTimeout(() => {\n          if (toast.parentElement) toast.parentElement.removeChild(toast);\n        }, 180);\n      }\n\n      function showModal(config) {\n        const overlay = document.createElement('div');\n        overlay.className = 'modal-overlay';\n\n        const modal = document.createElement('div');\n        modal.className = 'modal';\n\n        const header = document.createElement('div');\n        header.className = 'modal-header';\n\n        const title = document.createElement('h3');\n        title.className = 'modal-title';\n        title.textContent = config.title || 'Dialog';\n\n        const closeBtn = document.createElement('button');\n        closeBtn.className = 'btn btn-ghost';\n        closeBtn.type = 'button';\n        closeBtn.innerHTML = '<i class=\"fa-solid fa-xmark\"></i>';\n        closeBtn.addEventListener('click', () => close());\n\n        header.appendChild(title);\n        header.appendChild(closeBtn);\n\n        const body = document.createElement('div');\n        body.className = 'modal-body';\n        if (typeof config.content === 'string') {\n          // SECURITY: Treat string content as trusted HTML only. For user-provided text, pass an HTMLElement and set textContent.\n          const div = document.createElement('div');\n          div.innerHTML = config.content;\n          body.appendChild(div);\n        } else if (config.content instanceof HTMLElement) {\n          body.appendChild(config.content);\n        }\n\n        const footer = document.createElement('div');\n        footer.className = 'modal-footer';\n        (config.actions || [{ label: 'Close' }]).forEach(action => {\n          const btn = document.createElement('button');\n          btn.className = `btn ${action.variant === 'primary' ? 'btn-primary' : ''} ${action.variant === 'danger' ? 'btn-danger' : ''}`;\n          btn.type = 'button';\n          btn.textContent = action.label || 'OK';\n          btn.addEventListener('click', () => {\n            try {\n              const res = action.onClick ? action.onClick() : undefined;\n              if (res === false) return;\n            } catch (_) {\n              // Ignore errors from modal actions\n            }\n            close();\n          });\n          footer.appendChild(btn);\n        });\n\n        modal.appendChild(header);\n        modal.appendChild(body);\n        modal.appendChild(footer);\n        overlay.appendChild(modal);\n\n        overlay.addEventListener('click', ev => {\n          if (ev.target === overlay && config.dismissible !== false) close();\n        });\n\n        function close() {\n          if (overlay.parentElement) overlay.parentElement.removeChild(overlay);\n          try {\n            config.onClose && config.onClose();\n          } catch (_) {\n            // Ignore errors from onClose callback\n          }\n        }\n\n        modalRoot.appendChild(overlay);\n        return { close, overlay, modal, body };\n      }\n\n      function confirm(options) {\n        return new Promise(resolve => {\n          showModal({\n            title: options.title || 'Confirm',\n            content: options.message || 'Are you sure?',\n            actions: [\n              { label: options.cancelLabel || 'Cancel', onClick: () => resolve(false) },\n              {\n                label: options.okLabel || 'Confirm',\n                variant: options.danger ? 'danger' : 'primary',\n                onClick: () => resolve(true),\n              },\n            ],\n          });\n        });\n      }\n\n      function openDropdown(anchorEl, items, options = {}) {\n        closeAllDropdowns();\n        const wrap = document.createElement('div');\n        wrap.className = 'dropdown-menu';\n\n        items.forEach(item => {\n          if (item && (item.type === 'divider' || item.divider === true)) {\n            const divider = document.createElement('div');\n            divider.setAttribute('role', 'separator');\n            divider.style.height = '1px';\n            divider.style.margin = `${8}px ${6}px`;\n            divider.style.background = 'var(--border-subtle)';\n            wrap.appendChild(divider);\n            return;\n          }\n\n          const btn = document.createElement('button');\n          btn.type = 'button';\n          btn.className = 'dropdown-item';\n          if (item && item.disabled) {\n            btn.disabled = true;\n            btn.style.opacity = '0.6';\n            btn.style.cursor = 'not-allowed';\n          }\n          if (item.icon) {\n            const icon = document.createElement('i');\n            icon.className = item.icon;\n            icon.style.width = '18px';\n            icon.style.display = 'inline-flex';\n            icon.style.alignItems = 'center';\n            icon.style.justifyContent = 'center';\n            icon.style.color = 'var(--text-secondary)';\n            btn.appendChild(icon);\n          }\n          const text = document.createElement('span');\n          text.textContent = String(item.label || '');\n          text.style.flex = '1';\n          btn.appendChild(text);\n          if (item.rightIcon) {\n            const iconRight = document.createElement('i');\n            iconRight.className = item.rightIcon;\n            iconRight.style.marginLeft = 'auto';\n            iconRight.style.color = item.rightIconColor || 'var(--accent-primary)';\n            btn.appendChild(iconRight);\n          }\n          btn.addEventListener('click', ev => {\n            ev.stopPropagation();\n            if (btn.disabled) return;\n            closeAllDropdowns();\n            item.onClick && item.onClick();\n          });\n          wrap.appendChild(btn);\n        });\n\n        const dropdown = document.createElement('div');\n        dropdown.className = 'dropdown';\n        dropdown.dataset.dropdown = '1';\n        dropdown.style.position = 'fixed';\n        dropdown.style.zIndex = '16000';\n\n        const rect = anchorEl.getBoundingClientRect();\n        const width = Math.max(180, Number(options.width) || 220);\n        let left = rect.right - width;\n        if (options.align === 'left') left = rect.left;\n        left = Math.max(8, Math.min(left, window.innerWidth - width - 8));\n        dropdown.style.left = `${left}px`;\n        dropdown.style.top = `${rect.bottom + 6}px`;\n        dropdown.style.minWidth = `${width}px`;\n        dropdown.appendChild(wrap);\n\n        document.body.appendChild(dropdown);\n        window.setTimeout(() => {\n          const onDocClick = () => closeAllDropdowns();\n          document.addEventListener('click', onDocClick, { once: true });\n        }, 0);\n\n        dropdownKeyDownListener = ev => {\n          if (ev.key === 'Escape') closeAllDropdowns();\n        };\n        document.addEventListener('keydown', dropdownKeyDownListener);\n      }\n\n      function closeAllDropdowns() {\n        document.querySelectorAll('[data-dropdown=\"1\"]').forEach(el => el.remove());\n        if (dropdownKeyDownListener) {\n          document.removeEventListener('keydown', dropdownKeyDownListener);\n          dropdownKeyDownListener = null;\n        }\n      }\n\n      return { showToast, showModal, confirm, openDropdown, closeAllDropdowns };\n    })();\n\n    const SystemOverlay = (() => {\n      const overlay = document.getElementById('system-overlay');\n      const titleEl = document.getElementById('system-title');\n      const messageEl = document.getElementById('system-message');\n      const listEl = document.getElementById('system-list');\n      const retryBtn = document.getElementById('system-retry');\n      retryBtn.addEventListener('click', () => window.location.reload());\n\n      function show({ title, message, items }) {\n        titleEl.textContent = title || 'Truck Packer 3D';\n        messageEl.textContent = message || '';\n        listEl.innerHTML = '';\n        (items || []).forEach(text => {\n          const li = document.createElement('li');\n          li.textContent = text;\n          listEl.appendChild(li);\n        });\n        overlay.classList.add('active');\n      }\n\n      function hide() {\n        overlay.classList.remove('active');\n      }\n\n      return { show, hide };\n    })();\n\n    const StateStore = (() => {\n      const MAX_HISTORY = 50;\n      let state = null;\n      let history = [];\n      let historyPointer = -1;\n      const subscribers = [];\n\n      function historySlice(s) {\n        return Utils.deepClone({\n          caseLibrary: s.caseLibrary,\n          packLibrary: s.packLibrary,\n          preferences: s.preferences,\n        });\n      }\n\n      function init(initialState) {\n        state = Utils.deepClone(initialState);\n        history = [historySlice(state)];\n        historyPointer = 0;\n      }\n\n      function get(key) {\n        if (!state) return key ? undefined : null;\n        if (!key) return state;\n        return state[key];\n      }\n\n      function set(patch, options = {}) {\n        const next = { ...state, ...patch };\n        const significant = options.skipHistory ? false : isSignificantChange(patch);\n        state = next;\n        if (significant) pushHistory(historySlice(next));\n        if (!options.skipNotify) notify(patch, state);\n      }\n\n      function replace(nextState, options = {}) {\n        state = Utils.deepClone(nextState);\n        if (!options.skipHistory) pushHistory(historySlice(state));\n        notify({ _replace: true }, state);\n      }\n\n      function snapshot() {\n        return Utils.deepClone(state);\n      }\n\n      function pushHistory(snapshot) {\n        history = history.slice(0, historyPointer + 1);\n        history.push(Utils.deepClone(snapshot));\n        if (history.length > MAX_HISTORY) history.shift();\n        historyPointer = history.length - 1;\n      }\n\n      function undo() {\n        if (historyPointer <= 0) return false;\n        historyPointer--;\n        state = { ...state, ...Utils.deepClone(history[historyPointer]) };\n        notify({ _undo: true }, state);\n        return true;\n      }\n\n      function redo() {\n        if (historyPointer >= history.length - 1) return false;\n        historyPointer++;\n        state = { ...state, ...Utils.deepClone(history[historyPointer]) };\n        notify({ _redo: true }, state);\n        return true;\n      }\n\n      function subscribe(fn) {\n        subscribers.push(fn);\n        return () => {\n          const idx = subscribers.indexOf(fn);\n          if (idx > -1) subscribers.splice(idx, 1);\n        };\n      }\n\n      function notify(changes, nextState) {\n        subscribers.forEach(fn => {\n          try {\n            fn(changes, nextState);\n          } catch (err) {\n            console.error('Subscriber error', err);\n          }\n        });\n      }\n\n      function isSignificantChange(patch) {\n        const keys = Object.keys(patch || {});\n        const significant = ['caseLibrary', 'packLibrary', 'preferences'];\n        return keys.some(k => significant.includes(k));\n      }\n\n      return { init, get, set, replace, snapshot, undo, redo, subscribe };\n    })();\n\n    const Storage = (() => {\n      const KEY = 'truckPacker3d:v2:data';\n      const LEGACY_KEY = 'truckPacker3d:v1';\n      const saveDebounced = Utils.debounce(saveNow, 250);\n\n      function migrateLegacy() {\n        const raw = window.localStorage.getItem(LEGACY_KEY);\n        if (!raw) return null;\n        const legacy = Utils.sanitizeJSON(Utils.safeJsonParse(raw, null));\n        if (!legacy || typeof legacy !== 'object') return null;\n        const migrated = {\n          version: APP_VERSION,\n          savedAt: Date.now(),\n          preferences: legacy.preferences || Defaults.defaultPreferences,\n          orgData: {\n            personal: {\n              caseLibrary: Array.isArray(legacy.caseLibrary) ? legacy.caseLibrary : [],\n              packLibrary: Array.isArray(legacy.packLibrary) ? legacy.packLibrary : [],\n              currentPackId: legacy.currentPackId || null,\n            },\n          },\n        };\n        try {\n          window.localStorage.setItem(KEY, JSON.stringify(migrated));\n        } catch (_) {\n          // Ignore migration write failures\n        }\n        return migrated;\n      }\n\n      function load() {\n        const raw = window.localStorage.getItem(KEY);\n        if (!raw) return migrateLegacy();\n        const parsed = Utils.sanitizeJSON(Utils.safeJsonParse(raw, null));\n        if (!parsed || typeof parsed !== 'object') return migrateLegacy();\n        if (!parsed.orgData || typeof parsed.orgData !== 'object') parsed.orgData = {};\n        if (!parsed.preferences || typeof parsed.preferences !== 'object')\n          {parsed.preferences = Defaults.defaultPreferences;}\n        return parsed;\n      }\n\n      function loadOrg(orgId) {\n        const data = load();\n        if (!data) return null;\n        const orgKey = String(orgId || '').trim() || 'personal';\n        const org = data.orgData && data.orgData[orgKey] ? data.orgData[orgKey] : null;\n        if (!org) return null;\n        return {\n          caseLibrary: Array.isArray(org.caseLibrary) ? org.caseLibrary : [],\n          packLibrary: Array.isArray(org.packLibrary) ? org.packLibrary : [],\n          currentPackId: org.currentPackId || null,\n          preferences: data.preferences || Defaults.defaultPreferences,\n        };\n      }\n\n      function saveSoon() {\n        saveDebounced();\n      }\n\n      function saveNow() {\n        try {\n          const session = getSession();\n          const orgId = session && session.user && session.user.currentOrgId ? session.user.currentOrgId : 'personal';\n          const state = StateStore.get();\n          const existing = load() || {\n            version: APP_VERSION,\n            savedAt: Date.now(),\n            preferences: state.preferences,\n            orgData: {},\n          };\n          const next = {\n            version: APP_VERSION,\n            savedAt: Date.now(),\n            preferences: state.preferences,\n            orgData: existing.orgData && typeof existing.orgData === 'object' ? existing.orgData : {},\n          };\n          next.orgData[orgId] = {\n            caseLibrary: state.caseLibrary,\n            packLibrary: state.packLibrary,\n            currentPackId: state.currentPackId,\n          };\n          window.localStorage.setItem(KEY, JSON.stringify(next));\n        } catch (err) {\n          console.error('Save failed', err);\n          UIComponents.showToast('Save failed: ' + err.message, 'error', { title: 'Storage' });\n        }\n      }\n\n      function clearAll() {\n        window.localStorage.removeItem(KEY);\n        window.localStorage.removeItem(LEGACY_KEY);\n      }\n\n      function replaceAll(nextData) {\n        const data = Utils.sanitizeJSON(nextData);\n        if (!data || typeof data !== 'object') throw new Error('Invalid data');\n        if (!data.orgData || typeof data.orgData !== 'object') data.orgData = {};\n        if (!data.preferences || typeof data.preferences !== 'object') data.preferences = Defaults.defaultPreferences;\n        data.version = APP_VERSION;\n        data.savedAt = Date.now();\n        window.localStorage.setItem(KEY, JSON.stringify(data));\n      }\n\n      function exportAppJSON() {\n        saveNow();\n        const data = load() || {\n          version: APP_VERSION,\n          savedAt: Date.now(),\n          preferences: Defaults.defaultPreferences,\n          orgData: {},\n        };\n        const payload = {\n          app: 'Truck Packer 3D',\n          version: APP_VERSION,\n          exportedAt: Date.now(),\n          session: getSession(),\n          data,\n        };\n        return JSON.stringify(payload, null, 2);\n      }\n\n      function importAppJSON(jsonText) {\n        const parsed = Utils.sanitizeJSON(Utils.safeJsonParse(jsonText, null));\n        if (!parsed || typeof parsed !== 'object') throw new Error('Invalid JSON');\n        if (parsed.data && parsed.data.orgData) {\n          return {\n            session: parsed.session && typeof parsed.session === 'object' ? parsed.session : null,\n            data: parsed.data,\n          };\n        }\n\n        // Backward-compatible: legacy app export (single org)\n        const legacyData = parsed.data || parsed;\n        if (!legacyData.caseLibrary || !legacyData.packLibrary || !legacyData.preferences)\n          {throw new Error('Missing required keys');}\n        const session = getSession();\n        const orgId = session && session.user && session.user.currentOrgId ? session.user.currentOrgId : 'personal';\n        return {\n          session: null,\n          data: {\n            version: APP_VERSION,\n            savedAt: Date.now(),\n            preferences: legacyData.preferences,\n            orgData: {\n              [orgId]: {\n                caseLibrary: legacyData.caseLibrary,\n                packLibrary: legacyData.packLibrary,\n                currentPackId: null,\n              },\n            },\n          },\n        };\n      }\n\n      return { load, loadOrg, saveSoon, saveNow, clearAll, replaceAll, exportAppJSON, importAppJSON };\n    })();\n\n    const Defaults = (() => {\n      const defaultPreferences = {\n        units: { length: 'in', weight: 'lb' },\n        theme: 'light',\n        labelFontSize: 12,\n        hiddenCaseOpacity: 0.3,\n        snapping: { enabled: true, gridSize: 1 },\n        camera: { defaultView: 'perspective' },\n        export: { screenshotResolution: '1920x1080', pdfIncludeStats: true },\n        categories: [],\n      };\n\n      const categories = [\n        { key: 'all', name: 'All', color: '#9b9ba8' },\n        { key: 'audio', name: 'Audio', color: '#f59e0b' },\n        { key: 'lighting', name: 'Lighting', color: '#3b82f6' },\n        { key: 'stage', name: 'Stage', color: '#10b981' },\n        { key: 'backline', name: 'Backline', color: '#ec4899' },\n        { key: 'default', name: 'Default', color: '#9ca3af' },\n      ];\n\n      function seedCases() {\n        const now = Date.now();\n        return [\n          {\n            id: Utils.uuid(),\n            name: 'Line Array Case',\n            manufacturer: 'L-Acoustics',\n            category: 'audio',\n            dimensions: { length: 48, width: 24, height: 32 },\n            weight: 125,\n            canFlip: false,\n            notes: '',\n            color: '#ff9f1c',\n            createdAt: now,\n            updatedAt: now,\n          },\n          {\n            id: Utils.uuid(),\n            name: 'Subwoofer Crate',\n            manufacturer: 'JBL',\n            category: 'audio',\n            dimensions: { length: 36, width: 36, height: 24 },\n            weight: 95,\n            canFlip: true,\n            notes: '',\n            color: '#ff9f1c',\n            createdAt: now,\n            updatedAt: now,\n          },\n          {\n            id: Utils.uuid(),\n            name: 'Truss Section',\n            manufacturer: 'Global Truss',\n            category: 'lighting',\n            dimensions: { length: 120, width: 12, height: 12 },\n            weight: 45,\n            canFlip: true,\n            notes: '',\n            color: '#3b82f6',\n            createdAt: now,\n            updatedAt: now,\n          },\n          {\n            id: Utils.uuid(),\n            name: 'Stage Deck',\n            manufacturer: 'StagingCo',\n            category: 'stage',\n            dimensions: { length: 96, width: 48, height: 8 },\n            weight: 80,\n            canFlip: false,\n            notes: '',\n            color: '#10b981',\n            createdAt: now,\n            updatedAt: now,\n          },\n          {\n            id: Utils.uuid(),\n            name: 'Guitar Rack',\n            manufacturer: 'Backline Inc',\n            category: 'backline',\n            dimensions: { length: 40, width: 22, height: 46 },\n            weight: 110,\n            canFlip: false,\n            notes: '',\n            color: '#ec4899',\n            createdAt: now,\n            updatedAt: now,\n          },\n        ];\n      }\n\n      function seedPack(caseLibrary) {\n        const now = Date.now();\n        const pick = name => caseLibrary.find(c => c.name === name)?.id;\n        const packId = Utils.uuid();\n        const instances = [];\n        const add = (caseId, x, y, z) => {\n          instances.push({\n            id: Utils.uuid(),\n            caseId,\n            transform: { position: { x, y, z }, rotation: { x: 0, y: 0, z: 0 }, scale: { x: 1, y: 1, z: 1 } },\n            hidden: false,\n            groupId: null,\n          });\n        };\n        add(pick('Line Array Case'), -80, 16, 0);\n        add(pick('Subwoofer Crate'), -90, 12, 28);\n        add(pick('Truss Section'), -70, 6, -24);\n\n        return {\n          id: packId,\n          title: 'Demo Pack',\n          client: 'Example Client',\n          projectName: 'Envato Preview',\n          drawnBy: 'Truck Packer 3D',\n          notes: 'Tip: Use AutoPack (Ctrl/Cmd+P) to fill the truck.',\n          truck: { length: 636, width: 102, height: 98 },\n          cases: instances.filter(i => Boolean(i.caseId)),\n          groups: [],\n          stats: { totalCases: instances.length, packedCases: 0, volumeUsed: 0, totalWeight: 0 },\n          createdAt: now,\n          lastEdited: now,\n        };\n      }\n\n      return { defaultPreferences, categories, seedCases, seedPack };\n    })();\n\n    const Normalizer = (() => {\n      const DEFAULT_TRUCK = { length: 636, width: 102, height: 98 };\n\n      function finiteNumber(value, fallback) {\n        const n = Number(value);\n        return Number.isFinite(n) ? n : fallback;\n      }\n\n      function positiveNumber(value, fallback) {\n        const n = finiteNumber(value, fallback);\n        return n > 0 ? n : fallback;\n      }\n\n      function safeString(value, fallback = '') {\n        const s = value == null ? '' : String(value);\n        const t = s.trim();\n        return t || fallback;\n      }\n\n      function normalizePreferences(prefs) {\n        const base = Utils.deepClone(Defaults.defaultPreferences);\n        const next = { ...base, ...(prefs && typeof prefs === 'object' ? prefs : {}) };\n        next.units = next.units && typeof next.units === 'object' ? next.units : base.units;\n        next.units.length = Utils.lengthUnits.includes(next.units.length) ? next.units.length : base.units.length;\n        next.units.weight = Utils.weightUnits.includes(next.units.weight) ? next.units.weight : base.units.weight;\n        next.theme = next.theme === 'dark' ? 'dark' : 'light';\n        next.labelFontSize = Utils.clamp(finiteNumber(next.labelFontSize, base.labelFontSize), 8, 24);\n        next.hiddenCaseOpacity = Utils.clamp(finiteNumber(next.hiddenCaseOpacity, base.hiddenCaseOpacity), 0, 1);\n        next.snapping = next.snapping && typeof next.snapping === 'object' ? next.snapping : base.snapping;\n        next.snapping.enabled = Boolean(next.snapping.enabled);\n        next.snapping.gridSize = Math.max(0.25, finiteNumber(next.snapping.gridSize, base.snapping.gridSize));\n        next.camera = next.camera && typeof next.camera === 'object' ? next.camera : base.camera;\n        next.camera.defaultView = next.camera.defaultView === 'orthographic' ? 'orthographic' : 'perspective';\n        next.export = next.export && typeof next.export === 'object' ? next.export : base.export;\n        next.export.screenshotResolution = safeString(\n          next.export.screenshotResolution,\n          base.export.screenshotResolution\n        );\n        next.export.pdfIncludeStats = Boolean(next.export.pdfIncludeStats);\n        const normalizeCatKey = key =>\n          String(key || '')\n            .trim()\n            .toLowerCase();\n        const prefCats = Array.isArray(next.categories) ? next.categories : base.categories;\n        next.categories = (prefCats || [])\n          .map(c => ({\n            key: normalizeCatKey(c.key || c.name),\n            name: safeString(c.name, c.key || ''),\n            color: safeString(c.color, ''),\n          }))\n          .filter(c => c.key);\n        if (!next.categories.length) {\n          next.categories = (Defaults.categories || [])\n            .filter(c => c.key !== 'all')\n            .map(c => ({ key: c.key, name: c.name, color: c.color }));\n        }\n        return next;\n      }\n\n      function normalizeCase(c, now) {\n        const createdAt = finiteNumber(c && c.createdAt, now);\n        const updatedAt = finiteNumber(c && c.updatedAt, now);\n        const dims = c && c.dimensions && typeof c.dimensions === 'object' ? c.dimensions : {};\n        const length = positiveNumber(dims.length, 48);\n        const width = positiveNumber(dims.width, 24);\n        const height = positiveNumber(dims.height, 24);\n        const category = safeString(c && c.category, 'default').toLowerCase();\n        const color = safeString(c && c.color, CategoryService.meta(category).color);\n        return {\n          id: safeString(c && c.id, Utils.uuid()),\n          name: safeString(c && c.name, 'Unnamed Case'),\n          manufacturer: safeString(c && c.manufacturer, ''),\n          category,\n          dimensions: { length, width, height },\n          weight: Math.max(0, finiteNumber(c && c.weight, 0)),\n          volume: Utils.volumeInCubicInches({ length, width, height }),\n          canFlip: Boolean(c && c.canFlip),\n          notes: safeString(c && c.notes, ''),\n          color,\n          createdAt,\n          updatedAt,\n        };\n      }\n\n      function normalizeTruck(truck) {\n        const t = truck && typeof truck === 'object' ? truck : {};\n        return {\n          length: positiveNumber(t.length, DEFAULT_TRUCK.length),\n          width: positiveNumber(t.width, DEFAULT_TRUCK.width),\n          height: positiveNumber(t.height, DEFAULT_TRUCK.height),\n        };\n      }\n\n      function normalizeInstance(inst, caseMap) {\n        const transform = inst && inst.transform && typeof inst.transform === 'object' ? inst.transform : {};\n        const pos = transform.position && typeof transform.position === 'object' ? transform.position : {};\n        const rot =\n          transform.rotation && typeof transform.rotation === 'object' ? transform.rotation : { x: 0, y: 0, z: 0 };\n        const scale = transform.scale && typeof transform.scale === 'object' ? transform.scale : { x: 1, y: 1, z: 1 };\n        const caseId = safeString(inst && inst.caseId, '');\n        const caseData = caseMap.get(caseId) || null;\n        const halfY = caseData ? Math.max(1, (caseData.dimensions.height || 1) / 2) : 10;\n\n        return {\n          id: safeString(inst && inst.id, Utils.uuid()),\n          caseId,\n          transform: {\n            position: {\n              x: finiteNumber(pos.x, -80),\n              y: finiteNumber(pos.y, halfY),\n              z: finiteNumber(pos.z, 0),\n            },\n            rotation: {\n              x: finiteNumber(rot.x, 0),\n              y: finiteNumber(rot.y, 0),\n              z: finiteNumber(rot.z, 0),\n            },\n            scale: {\n              x: finiteNumber(scale.x, 1),\n              y: finiteNumber(scale.y, 1),\n              z: finiteNumber(scale.z, 1),\n            },\n          },\n          hidden: Boolean(inst && inst.hidden),\n          groupId: inst && inst.groupId != null ? inst.groupId : null,\n        };\n      }\n\n      function normalizePack(p, caseMap, now) {\n        const truck = normalizeTruck(p && p.truck);\n        const rawCases = Array.isArray(p && p.cases) ? p.cases : [];\n        const instances = rawCases.map(i => normalizeInstance(i, caseMap)).filter(i => Boolean(i.caseId));\n        const pack = {\n          id: safeString(p && p.id, Utils.uuid()),\n          title: safeString(p && p.title, 'Untitled Pack'),\n          client: safeString(p && p.client, ''),\n          projectName: safeString(p && p.projectName, ''),\n          drawnBy: safeString(p && p.drawnBy, ''),\n          notes: safeString(p && p.notes, ''),\n          truck,\n          cases: instances,\n          groups: Array.isArray(p && p.groups) ? p.groups : [],\n          stats: { totalCases: 0, packedCases: 0, volumeUsed: 0, totalWeight: 0 },\n          createdAt: finiteNumber(p && p.createdAt, now),\n          lastEdited: finiteNumber(p && p.lastEdited, now),\n        };\n        pack.stats = PackLibrary.computeStats(pack, Array.from(caseMap.values()));\n        return pack;\n      }\n\n      function normalizeAppData(data) {\n        const now = Date.now();\n        const rawCases = Array.isArray(data && data.caseLibrary) ? data.caseLibrary : [];\n        const cases = rawCases.map(c => normalizeCase(c, now));\n\n        // Deduplicate case ids if needed\n        const seenCaseIds = new Set();\n        cases.forEach(c => {\n          if (!seenCaseIds.has(c.id)) {\n            seenCaseIds.add(c.id);\n            return;\n          }\n          c.id = Utils.uuid();\n        });\n        const caseMap = new Map(cases.map(c => [c.id, c]));\n\n        const rawPacks = Array.isArray(data && data.packLibrary) ? data.packLibrary : [];\n        const packs = rawPacks.map(p => normalizePack(p, caseMap, now));\n\n        const prefs = normalizePreferences(data && data.preferences);\n        const currentPackId = safeString(data && data.currentPackId, '');\n        const current = packs.some(p => p.id === currentPackId) ? currentPackId : packs[0] ? packs[0].id : null;\n\n        return { caseLibrary: cases, packLibrary: packs, preferences: prefs, currentPackId: current };\n      }\n\n      return { normalizeAppData };\n    })();\n\n    const PreferencesManager = (() => {\n      function applyTheme(theme) {\n        document.documentElement.setAttribute('data-theme', theme === 'dark' ? 'dark' : 'light');\n      }\n\n      function get() {\n        return StateStore.get('preferences');\n      }\n\n      function set(nextPrefs) {\n        StateStore.set({ preferences: nextPrefs });\n      }\n\n      return { get, set, applyTheme };\n    })();\n\n    const CategoryService = (() => {\n      const normalize = key =>\n        String(key || '')\n          .trim()\n          .toLowerCase();\n\n      function hashHue(str) {\n        let h = 0;\n        const s = String(str || '');\n        for (let i = 0; i < s.length; i++) h = (h * 31 + s.charCodeAt(i)) % 360;\n        return h;\n      }\n\n      function colorFor(key, fallback) {\n        if (fallback) return fallback;\n        const hue = hashHue(key);\n        return `hsl(${hue}, 72%, 56%)`;\n      }\n\n      function all() {\n        const prefs = PreferencesManager.get();\n        const prefCats = Array.isArray(prefs && prefs.categories) ? prefs.categories : [];\n        const seeded = prefCats.length\n          ? prefCats\n          : (Defaults.categories || [])\n              .filter(c => c.key !== 'all')\n              .map(c => ({ key: c.key, name: c.name, color: c.color }));\n        const dedup = new Map();\n        seeded.forEach(c => {\n          const k = normalize(c.key || c.name);\n          if (!k) return;\n          dedup.set(k, {\n            key: k,\n            name: c.name || k.charAt(0).toUpperCase() + k.slice(1),\n            color: c.color || colorFor(k),\n          });\n        });\n        return Array.from(dedup.values());\n      }\n\n      function save(list) {\n        const prefs = PreferencesManager.get() || {};\n        PreferencesManager.set({ ...prefs, categories: list });\n      }\n\n      function meta(key) {\n        const k = normalize(key);\n        const found = all().find(c => c.key === k);\n        if (found) return found;\n        return { key: k, name: k ? k.charAt(0).toUpperCase() + k.slice(1) : 'Uncategorized', color: colorFor(k) };\n      }\n\n      function listWithCounts(cases) {\n        const counts = {};\n        (cases || []).forEach(c => {\n          const k = normalize(c.category || 'default');\n          counts[k] = (counts[k] || 0) + 1;\n        });\n        const known = all();\n        const ordered = known\n          .map(c => c.key)\n          .filter(k => k)\n          .concat(Object.keys(counts).filter(k => !known.find(c => c.key === k)));\n        return ordered\n          .filter((k, idx, arr) => arr.indexOf(k) === idx)\n          .map(k => ({ ...meta(k), count: counts[k] || 0 }));\n      }\n\n      function upsert({ key, name, color }) {\n        const k = normalize(key || name);\n        if (!k) return meta('default');\n        const list = all();\n        const next = { key: k, name: name || meta(k).name, color: color || meta(k).color };\n        const idx = list.findIndex(c => c.key === k);\n        if (idx > -1) list[idx] = next;\n        else list.push(next);\n        save(list);\n        return next;\n      }\n\n      function remove(key) {\n        const k = normalize(key);\n        if (!k || k === 'default') return; // never remove default\n        const list = all().filter(c => c.key !== k);\n        save(list);\n        CaseLibrary.reassignCategory(k, 'default');\n      }\n\n      function rename(oldKey, name, color) {\n        const from = normalize(oldKey);\n        const to = normalize(name || oldKey);\n        if (!from) return meta('default');\n        const list = all().filter(c => c.key !== from);\n        const next = { key: to, name: name || meta(to).name, color: color || meta(to).color };\n        list.push(next);\n        save(list);\n        if (from !== to) CaseLibrary.reassignCategory(from, to);\n        return next;\n      }\n\n      return { meta, listWithCounts, upsert, remove, rename, all };\n    })();\n\n    const CaseLibrary = (() => {\n      function getCases() {\n        return StateStore.get('caseLibrary') || [];\n      }\n\n      function getById(caseId) {\n        return getCases().find(c => c.id === caseId) || null;\n      }\n\n      function upsert(caseData) {\n        const now = Date.now();\n        const cases = getCases();\n        const idx = cases.findIndex(c => c.id === caseData.id);\n        const next = { ...caseData };\n        next.updatedAt = now;\n        if (!next.createdAt) next.createdAt = now;\n        next.dimensions = {\n          length: Number(next.dimensions.length) || 0,\n          width: Number(next.dimensions.width) || 0,\n          height: Number(next.dimensions.height) || 0,\n        };\n        next.weight = Number(next.weight) || 0;\n        next.volume = Utils.volumeInCubicInches(next.dimensions);\n\n        const nextCases = idx > -1 ? cases.map((c, i) => (i === idx ? next : c)) : [...cases, next];\n\n        StateStore.set({ caseLibrary: nextCases });\n      }\n\n      function reassignCategory(oldKey, newKey) {\n        const from = oldKey ? oldKey.trim().toLowerCase() : '';\n        const to = newKey ? newKey.trim().toLowerCase() : 'default';\n        if (!from || from === to) return;\n        const next = getCases().map(c => (c.category === from ? { ...c, category: to } : c));\n        StateStore.set({ caseLibrary: next });\n      }\n\n      function remove(caseId) {\n        const cases = getCases().filter(c => c.id !== caseId);\n        StateStore.set({ caseLibrary: cases });\n      }\n\n      function duplicate(caseId) {\n        const original = getById(caseId);\n        if (!original) return null;\n        const now = Date.now();\n        const copy = {\n          ...Utils.deepClone(original),\n          id: Utils.uuid(),\n          name: original.name + ' (Copy)',\n          createdAt: now,\n          updatedAt: now,\n        };\n        upsert(copy);\n        return copy;\n      }\n\n      function search(query, categoryKeys) {\n        const q = String(query || '')\n          .trim()\n          .toLowerCase();\n        const cats = (categoryKeys || []).filter(k => k && k !== 'all');\n        return getCases().filter(c => {\n          const matchesQ =\n            !q || (c.name || '').toLowerCase().includes(q) || (c.manufacturer || '').toLowerCase().includes(q);\n          const matchesCat = !cats.length || cats.includes(c.category);\n          return matchesQ && matchesCat;\n        });\n      }\n\n      function countsByCategory() {\n        const counts = {};\n        getCases().forEach(c => {\n          counts[c.category] = (counts[c.category] || 0) + 1;\n        });\n        return counts;\n      }\n\n      return {\n        getCases,\n        getById,\n        upsert,\n        remove,\n        duplicate,\n        search,\n        countsByCategory,\n        reassignCategory,\n      };\n    })();\n\n    const PackLibrary = (() => {\n      function getPacks() {\n        return StateStore.get('packLibrary') || [];\n      }\n\n      function getById(packId) {\n        return getPacks().find(p => p.id === packId) || null;\n      }\n\n      function create(packData) {\n        const now = Date.now();\n        const pack = {\n          id: Utils.uuid(),\n          title: packData.title || 'Untitled Pack',\n          client: packData.client || '',\n          projectName: packData.projectName || '',\n          drawnBy: packData.drawnBy || '',\n          notes: packData.notes || '',\n          truck: packData.truck || { length: 636, width: 102, height: 98 },\n          cases: [],\n          groups: [],\n          stats: { totalCases: 0, packedCases: 0, volumeUsed: 0, totalWeight: 0 },\n          createdAt: now,\n          lastEdited: now,\n        };\n        StateStore.set({ packLibrary: [...getPacks(), pack] });\n        return pack;\n      }\n\n      function update(packId, patch) {\n        const packs = getPacks();\n        const idx = packs.findIndex(p => p.id === packId);\n        if (idx === -1) return null;\n        const next = { ...packs[idx], ...Utils.deepClone(patch), lastEdited: Date.now() };\n        next.stats = computeStats(next);\n        const nextPacks = packs.map((p, i) => (i === idx ? next : p));\n        StateStore.set({ packLibrary: nextPacks });\n        return next;\n      }\n\n      function remove(packId) {\n        const packs = getPacks().filter(p => p.id !== packId);\n        const current = StateStore.get('currentPackId');\n        StateStore.set(\n          { packLibrary: packs, currentPackId: current === packId ? null : current, selectedInstanceIds: [] },\n          { skipHistory: true }\n        );\n      }\n\n      function duplicate(packId) {\n        const pack = getById(packId);\n        if (!pack) return null;\n        const now = Date.now();\n        const copy = Utils.deepClone(pack);\n        copy.id = Utils.uuid();\n        copy.title = pack.title + ' (Copy)';\n        copy.createdAt = now;\n        copy.lastEdited = now;\n        // New instance ids\n        copy.cases = (copy.cases || []).map(i => ({ ...i, id: Utils.uuid() }));\n        StateStore.set({ packLibrary: [...getPacks(), copy] });\n        return copy;\n      }\n\n      function open(packId) {\n        const pack = getById(packId);\n        if (!pack) return null;\n        StateStore.set({ currentPackId: packId, selectedInstanceIds: [] }, { skipHistory: true });\n        return pack;\n      }\n\n      function addInstance(packId, caseId, position) {\n        const pack = getById(packId);\n        if (!pack) return null;\n        const caseData = CaseLibrary.getById(caseId);\n        if (!caseData) return null;\n        const instance = {\n          id: Utils.uuid(),\n          caseId,\n          transform: {\n            position: position || { x: -80, y: Math.max(1, caseData.dimensions.height / 2), z: 0 },\n            rotation: { x: 0, y: 0, z: 0 },\n            scale: { x: 1, y: 1, z: 1 },\n          },\n          hidden: false,\n          groupId: null,\n        };\n        const nextCases = [...(pack.cases || []), instance];\n        update(packId, { cases: nextCases });\n        return instance;\n      }\n\n      function updateInstance(packId, instanceId, patch) {\n        const pack = getById(packId);\n        if (!pack) return null;\n        const nextInstances = (pack.cases || []).map(i =>\n          i.id === instanceId ? { ...i, ...Utils.deepClone(patch) } : i\n        );\n        return update(packId, { cases: nextInstances });\n      }\n\n      function removeInstances(packId, instanceIds) {\n        const pack = getById(packId);\n        if (!pack) return null;\n        const idSet = new Set(instanceIds || []);\n        const nextInstances = (pack.cases || []).filter(i => !idSet.has(i.id));\n        return update(packId, { cases: nextInstances });\n      }\n\n      function computeStats(pack, caseLibraryOverride) {\n        const truckVol = pack.truck.length * pack.truck.width * pack.truck.height;\n        let usedIn3 = 0;\n        let totalWeight = 0;\n        let packedCases = 0;\n        const getCase = caseId => {\n          if (Array.isArray(caseLibraryOverride)) return caseLibraryOverride.find(c => c.id === caseId) || null;\n          return CaseLibrary.getById(caseId);\n        };\n        (pack.cases || []).forEach(inst => {\n          const c = getCase(inst.caseId);\n          if (!c) return;\n          if (inst.hidden) return;\n          const dims = c.dimensions || { length: 0, width: 0, height: 0 };\n          const pos = inst.transform && inst.transform.position ? inst.transform.position : { x: 0, y: 0, z: 0 };\n          const half = { x: dims.length / 2, y: dims.height / 2, z: dims.width / 2 };\n          const aabb = {\n            min: { x: pos.x - half.x, y: pos.y - half.y, z: pos.z - half.z },\n            max: { x: pos.x + half.x, y: pos.y + half.y, z: pos.z + half.z },\n          };\n          const insideTruck =\n            aabb.min.x >= 0 &&\n            aabb.max.x <= pack.truck.length &&\n            aabb.min.y >= 0 &&\n            aabb.max.y <= pack.truck.height &&\n            aabb.min.z >= -pack.truck.width / 2 &&\n            aabb.max.z <= pack.truck.width / 2;\n          if (!insideTruck) return;\n          packedCases++;\n          usedIn3 += c.volume || Utils.volumeInCubicInches(dims);\n          totalWeight += Number(c.weight) || 0;\n        });\n        const volumePercent = truckVol > 0 ? (usedIn3 / truckVol) * 100 : 0;\n        return {\n          totalCases: (pack.cases || []).length,\n          packedCases,\n          volumeUsed: usedIn3,\n          volumePercent,\n          totalWeight,\n        };\n      }\n\n      return {\n        getPacks,\n        getById,\n        create,\n        update,\n        remove,\n        duplicate,\n        open,\n        addInstance,\n        updateInstance,\n        removeInstances,\n        computeStats,\n      };\n    })();\n\n    const Data = (() => {\n      const updates = [\n        {\n          version: '1.0.0',\n          date: '2026-01-15',\n          features: [\n            'Multi-screen workspace (Packs, Cases, Editor, Updates, Roadmap, Settings)',\n            'Three.js 3D editor with drag placement',\n            'CSV/XLSX import, PNG + PDF export',\n          ],\n          bugFixes: [],\n          breakingChanges: [],\n        },\n        {\n          version: '1.1.0',\n          date: '2026-03-01',\n          features: ['(Example) Weight balance view', '(Example) Case rotation'],\n          bugFixes: ['(Example) Improved collision edge cases'],\n          breakingChanges: [],\n        },\n      ];\n\n      const roadmap = [\n        {\n          quarter: 'Q1 2026',\n          items: [\n            {\n              title: 'Weight balance',\n              status: 'Completed',\n              badge: '✓',\n              color: 'var(--success)',\n              details: 'Add center-of-gravity and axle load estimates.',\n            },\n            {\n              title: 'Rotation (MVP)',\n              status: 'In Progress',\n              badge: '⏱',\n              color: 'var(--warning)',\n              details: 'Allow 90° rotations and pack-time heuristics.',\n            },\n          ],\n        },\n        {\n          quarter: 'Q2 2026',\n          items: [\n            {\n              title: 'Multi-user',\n              status: 'Planned',\n              badge: '📋',\n              color: 'var(--info)',\n              details: 'Presence + change tracking (no real-time yet).',\n            },\n            {\n              title: '3D export',\n              status: 'Planned',\n              badge: '📋',\n              color: 'var(--info)',\n              details: 'GLB/GLTF export for downstream tools.',\n            },\n          ],\n        },\n        {\n          quarter: 'Future',\n          items: [\n            {\n              title: 'AR view',\n              status: 'Idea',\n              badge: '💡',\n              color: 'var(--text-muted)',\n              details: 'Preview a load-out in real space on mobile.',\n            },\n          ],\n        },\n      ];\n\n      return { updates, roadmap };\n    })();\n\n    const AppShell = (() => {\n      const appRoot = document.getElementById('app');\n      const sidebar = document.getElementById('sidebar');\n      const btnSidebar = document.getElementById('btn-sidebar');\n      const topbarTitle = document.getElementById('topbar-title');\n      const topbarSubtitle = document.getElementById('topbar-subtitle');\n      const contentRoot = document.querySelector('.content');\n      const navButtons = Array.from(document.querySelectorAll('[data-nav]'));\n\n      const screenTitles = {\n        packs: { title: 'Packs', subtitle: 'Project library' },\n        cases: { title: 'Cases', subtitle: 'Inventory management' },\n        editor: { title: 'Editor', subtitle: '3D workspace' },\n        updates: { title: 'Updates', subtitle: 'Release notes' },\n        roadmap: { title: 'Roadmap', subtitle: 'Product direction' },\n        settings: { title: 'Settings', subtitle: 'Preferences' },\n      };\n\n      function toggleSidebar() {\n        const isMobile = window.matchMedia('(max-width: 899px)').matches;\n        if (isMobile) {\n          sidebar.classList.toggle('open');\n        } else {\n          appRoot.classList.toggle('sidebar-collapsed');\n        }\n      }\n\n      function init() {\n        btnSidebar.addEventListener('click', toggleSidebar);\n        navButtons.forEach(btn => {\n          btn.addEventListener('click', () => {\n            const target = btn.getAttribute('data-nav');\n            navigate(target);\n            if (window.matchMedia('(max-width: 899px)').matches) {\n              sidebar.classList.remove('open');\n            }\n          });\n        });\n\n        window.addEventListener('resize', () => {\n          if (!window.matchMedia('(max-width: 899px)').matches) {\n            sidebar.classList.remove('open');\n          }\n        });\n      }\n\n      function navigate(screenKey) {\n        StateStore.set({ currentScreen: screenKey }, { skipHistory: true });\n      }\n\n      function renderShell() {\n        const screen = StateStore.get('currentScreen');\n        navButtons.forEach(btn => btn.classList.toggle('active', btn.getAttribute('data-nav') === screen));\n        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));\n        const el = document.getElementById(`screen-${screen}`);\n        if (el) el.classList.add('active');\n        if (contentRoot) contentRoot.classList.toggle('editor-mode', screen === 'editor');\n\n        if (screen === 'editor') {\n          const pack = PackLibrary.getById(StateStore.get('currentPackId'));\n          topbarTitle.textContent = pack ? pack.title || 'Editor' : 'Editor';\n          topbarSubtitle.textContent = pack ? `Edited ${Utils.formatRelativeTime(pack.lastEdited)}` : '3D workspace';\n          return;\n        }\n\n        const meta = screenTitles[screen] || { title: 'Truck Packer 3D', subtitle: '' };\n        topbarTitle.textContent = meta.title;\n        topbarSubtitle.textContent = meta.subtitle;\n      }\n\n      return { init, navigate, renderShell };\n    })();\n\n    // ==== UI: Packs Screen ====\n    const PacksUI = (() => {\n      const searchEl = document.getElementById('packs-search');\n      const gridEl = document.getElementById('packs-grid');\n      const emptyEl = document.getElementById('packs-empty');\n      const filterEmptyEl = document.getElementById('packs-filter-empty');\n      const filterEmptyMsg = document.getElementById('packs-filter-empty-msg');\n      const btnNew = document.getElementById('btn-new-pack');\n      const btnImport = document.getElementById('btn-import-pack');\n\n      function init() {\n        searchEl.addEventListener('input', Utils.debounce(render, 200));\n        searchEl.addEventListener('keydown', ev => {\n          if (ev.key === 'Escape') {\n            searchEl.value = '';\n            render();\n            searchEl.blur();\n          }\n        });\n        btnNew.addEventListener('click', () => openNewPackModal());\n        btnImport.addEventListener('click', () => openImportPackDialog());\n      }\n\n      function render() {\n        const q = String(searchEl.value || '')\n          .trim()\n          .toLowerCase();\n        const allPacks = PackLibrary.getPacks()\n          .slice()\n          .sort((a, b) => (b.lastEdited || 0) - (a.lastEdited || 0));\n\n        const packs = allPacks.filter(\n          p => !q || (p.title || '').toLowerCase().includes(q) || (p.client || '').toLowerCase().includes(q)\n        );\n\n        gridEl.innerHTML = '';\n\n        if (!allPacks.length) {\n          emptyEl.style.display = 'block';\n          filterEmptyEl.style.display = 'none';\n          return;\n        }\n\n        if (!packs.length) {\n          emptyEl.style.display = 'none';\n          filterEmptyMsg.textContent = q ? `No matching packs for \"${q}\"` : 'No matching packs';\n          filterEmptyEl.style.display = 'block';\n          return;\n        }\n\n        filterEmptyEl.style.display = 'none';\n        emptyEl.style.display = 'none';\n\n        packs.forEach(pack => {\n          const card = document.createElement('div');\n          card.className = 'card pack-card';\n          card.tabIndex = 0;\n          card.addEventListener('click', ev => {\n            if (ev.target && ev.target.closest && ev.target.closest('[data-pack-menu]')) return;\n            openPack(pack.id);\n          });\n          card.addEventListener('keydown', ev => {\n            if (ev.key === 'Enter') openPack(pack.id);\n          });\n\n          const preview = buildPreview(pack);\n\n          const title = document.createElement('h3');\n          title.textContent = pack.title || 'Untitled Pack';\n\n          const sub = document.createElement('div');\n          sub.className = 'muted';\n          sub.style.fontSize = 'var(--text-sm)';\n          sub.textContent = pack.client\n            ? `${pack.client} • edited ${Utils.formatRelativeTime(pack.lastEdited)}`\n            : `edited ${Utils.formatRelativeTime(pack.lastEdited)}`;\n\n          const meta = document.createElement('div');\n          meta.className = 'pack-meta';\n\n          const badgesWrap = document.createElement('div');\n          badgesWrap.className = 'pack-meta-badges';\n\n          const count = document.createElement('div');\n          count.className = 'badge';\n          count.textContent = `${(pack.cases || []).length} case(s)`;\n\n          const truck = document.createElement('div');\n          truck.className = 'badge';\n          const t = pack.truck || { length: 636, width: 102, height: 98 };\n          truck.textContent = `Truck ${t.length}\"×${t.width}\"×${t.height}\"`;\n\n          badgesWrap.appendChild(count);\n          badgesWrap.appendChild(truck);\n\n          const kebabWrap = document.createElement('div');\n          kebabWrap.className = 'kebab';\n          kebabWrap.setAttribute('data-pack-menu', '1');\n          const kebabBtn = document.createElement('button');\n          kebabBtn.className = 'btn btn-ghost';\n          kebabBtn.type = 'button';\n          kebabBtn.innerHTML = '<i class=\"fa-solid fa-ellipsis-vertical\"></i>';\n          kebabBtn.addEventListener('click', ev => {\n            ev.stopPropagation();\n            UIComponents.openDropdown(kebabBtn, [\n              { label: 'Open', icon: 'fa-solid fa-folder-open', onClick: () => openPack(pack.id) },\n              { label: 'Rename', icon: 'fa-solid fa-pen', onClick: () => openRename(pack.id) },\n              {\n                label: 'Duplicate',\n                icon: 'fa-solid fa-clone',\n                onClick: () => {\n                  PackLibrary.duplicate(pack.id);\n                  UIComponents.showToast('Pack duplicated', 'success');\n                },\n              },\n              { label: 'Export JSON', icon: 'fa-solid fa-file-export', onClick: () => exportPack(pack.id) },\n              { label: 'Delete', icon: 'fa-solid fa-trash', onClick: () => deletePack(pack.id) },\n            ]);\n          });\n          kebabWrap.appendChild(kebabBtn);\n\n          meta.appendChild(badgesWrap);\n          meta.appendChild(kebabWrap);\n\n          card.appendChild(preview);\n          card.appendChild(title);\n          card.appendChild(sub);\n          card.appendChild(meta);\n          gridEl.appendChild(card);\n        });\n      }\n\n      function buildPreview(pack) {\n        // TODO: Replace with actual canvas snapshot rendering\n        // Should use SceneManager to render pack contents off-screen\n        // and capture via canvas.toDataURL() for realistic preview\n        const preview = document.createElement('div');\n        const items = (pack.cases || []).slice(0, 12);\n\n        if (!items.length) {\n          preview.className = 'pack-preview empty';\n          preview.textContent = 'No items yet';\n          return preview;\n        }\n\n        preview.className = 'pack-preview';\n        items.forEach(inst => {\n          const cell = document.createElement('div');\n          cell.className = 'pack-preview-cell';\n          const meta = CaseLibrary.getById(inst.caseId);\n          if (meta && meta.color) cell.style.background = meta.color;\n          cell.title = meta ? meta.name : 'Case';\n          preview.appendChild(cell);\n        });\n        return preview;\n      }\n\n      function openPack(packId) {\n        const pack = PackLibrary.open(packId);\n        if (!pack) {\n          UIComponents.showToast('Pack not found', 'error');\n          return;\n        }\n        AppShell.navigate('editor');\n      }\n\n      function openNewPackModal() {\n        const content = document.createElement('div');\n        content.style.display = 'grid';\n        content.style.gap = '14px';\n        content.style.gridTemplateColumns = 'repeat(auto-fit, minmax(260px, 1fr))';\n        content.style.alignItems = 'flex-start';\n\n        const title = field('Title (required)', 'text', 'Summer Festival Tour', true);\n        const client = field('Client (optional)', 'text', 'Live Nation', false);\n        const projectName = field('Project name (optional)', 'text', 'Coachella 2024', false);\n        const drawnBy = field('Drawn by (optional)', 'text', 'John Smith', false);\n\n        const truckPresets = [\n          { label: '53ft Trailer (default)', truck: { length: 636, width: 102, height: 98 } },\n          { label: '26ft Box Truck', truck: { length: 312, width: 96, height: 96 } },\n          { label: 'Sprinter Van', truck: { length: 168, width: 70, height: 72 } },\n        ];\n\n        const presetWrap = document.createElement('div');\n        presetWrap.className = 'field';\n        const presetLabel = document.createElement('div');\n        presetLabel.className = 'label';\n        presetLabel.textContent = 'Truck preset';\n        const presetSelect = document.createElement('select');\n        presetSelect.className = 'select';\n        truckPresets.forEach((p, idx) => {\n          const opt = document.createElement('option');\n          opt.value = String(idx);\n          opt.textContent = p.label;\n          presetSelect.appendChild(opt);\n        });\n        presetWrap.appendChild(presetLabel);\n        presetWrap.appendChild(presetSelect);\n\n        const truckGrid = document.createElement('div');\n        truckGrid.className = 'row';\n        truckGrid.style.gap = '12px';\n        const tL = field('Truck length (in)', 'number', '636', true);\n        const tW = field('Truck width (in)', 'number', '102', true);\n        const tH = field('Truck height (in)', 'number', '98', true);\n        tL.wrap.style.flex = '1';\n        tW.wrap.style.flex = '1';\n        tH.wrap.style.flex = '1';\n        truckGrid.appendChild(tL.wrap);\n        truckGrid.appendChild(tW.wrap);\n        truckGrid.appendChild(tH.wrap);\n\n        presetSelect.addEventListener('change', () => {\n          const idx = Number(presetSelect.value);\n          const preset = truckPresets[idx] || truckPresets[0];\n          tL.input.value = String(preset.truck.length);\n          tW.input.value = String(preset.truck.width);\n          tH.input.value = String(preset.truck.height);\n        });\n\n        content.appendChild(title.wrap);\n        content.appendChild(client.wrap);\n        content.appendChild(projectName.wrap);\n        content.appendChild(drawnBy.wrap);\n        content.appendChild(presetWrap);\n        content.appendChild(truckGrid);\n\n        UIComponents.showModal({\n          title: 'New Pack',\n          content,\n          actions: [\n            { label: 'Cancel' },\n            {\n              label: 'Create',\n              variant: 'primary',\n              onClick: () => {\n                const t = String(title.input.value || '').trim();\n                if (!t) {\n                  UIComponents.showToast('Title is required', 'warning');\n                  title.input.focus();\n                  return false;\n                }\n                const pack = PackLibrary.create({\n                  title: t,\n                  client: String(client.input.value || '').trim(),\n                  projectName: String(projectName.input.value || '').trim(),\n                  drawnBy: String(drawnBy.input.value || '').trim(),\n                  truck: {\n                    length: Number(tL.input.value) || 636,\n                    width: Number(tW.input.value) || 102,\n                    height: Number(tH.input.value) || 98,\n                  },\n                });\n                UIComponents.showToast('Pack created', 'success');\n                PackLibrary.open(pack.id);\n                AppShell.navigate('editor');\n              },\n            },\n          ],\n        });\n      }\n\n      function openRename(packId) {\n        const pack = PackLibrary.getById(packId);\n        if (!pack) return;\n        const content = document.createElement('div');\n        const f = field('Pack title', 'text', pack.title || '', true);\n        f.input.value = pack.title || '';\n        content.appendChild(f.wrap);\n        UIComponents.showModal({\n          title: 'Rename Pack',\n          content,\n          actions: [\n            { label: 'Cancel' },\n            {\n              label: 'Save',\n              variant: 'primary',\n              onClick: () => {\n                const nextTitle = String(f.input.value || '').trim();\n                if (!nextTitle) return false;\n                PackLibrary.update(packId, { title: nextTitle });\n                UIComponents.showToast('Renamed', 'success');\n              },\n            },\n          ],\n        });\n      }\n\n      function exportPack(packId) {\n        const pack = PackLibrary.getById(packId);\n        if (!pack) return;\n        const payload = {\n          app: 'Truck Packer 3D',\n          version: APP_VERSION,\n          exportedAt: Date.now(),\n          pack,\n          bundledCases: (pack.cases || []).map(i => CaseLibrary.getById(i.caseId)).filter(Boolean),\n        };\n        Utils.downloadText(\n          `${(pack.title || 'pack').replace(/[^a-z0-9]+/gi, '-')}.json`,\n          JSON.stringify(payload, null, 2)\n        );\n        UIComponents.showToast('Pack JSON exported', 'success');\n      }\n\n      async function deletePack(packId) {\n        const ok = await UIComponents.confirm({\n          title: 'Delete pack?',\n          message: 'This cannot be undone.',\n          danger: true,\n          okLabel: 'Delete',\n        });\n        if (!ok) return;\n        PackLibrary.remove(packId);\n        UIComponents.showToast('Pack deleted', 'info');\n      }\n\n      function openImportPackDialog() {\n        const input = document.createElement('input');\n        input.type = 'file';\n        input.accept = '.json,application/json';\n        input.addEventListener('change', async () => {\n          const file = input.files && input.files[0];\n          if (!file) return;\n          try {\n            const text = await file.text();\n            const parsed = Utils.sanitizeJSON(Utils.safeJsonParse(text, null));\n            if (!parsed) throw new Error('Invalid JSON');\n            const payload = parsed.pack ? parsed : { pack: parsed };\n            importPackPayload(payload);\n            UIComponents.showToast('Pack imported', 'success');\n          } catch (err) {\n            UIComponents.showToast('Import failed: ' + err.message, 'error');\n          }\n        });\n        input.click();\n      }\n\n      function importPackPayload(payload) {\n        const now = Date.now();\n        const incomingPack = payload.pack;\n        if (!incomingPack || !incomingPack.truck || !Array.isArray(incomingPack.cases))\n          {throw new Error('Invalid pack format');}\n\n        const bundled = Array.isArray(payload.bundledCases) ? payload.bundledCases : [];\n        const currentCases = CaseLibrary.getCases();\n        const currentPacks = PackLibrary.getPacks();\n\n        const caseById = new Map(currentCases.map(c => [c.id, c]));\n        const caseByName = new Map(\n          currentCases.map(c => [\n            String(c.name || '')\n              .trim()\n              .toLowerCase(),\n            c,\n          ])\n        );\n        const caseIdMap = new Map();\n        const nextCases = [...currentCases];\n\n        bundled.forEach(c => {\n          if (!c || !c.id) return;\n          const nameKey = String(c.name || '')\n            .trim()\n            .toLowerCase();\n          if (caseById.has(c.id)) {\n            caseIdMap.set(c.id, c.id);\n            return;\n          }\n          if (nameKey && caseByName.has(nameKey)) {\n            caseIdMap.set(c.id, caseByName.get(nameKey).id);\n            return;\n          }\n          const copy = Utils.deepClone(c);\n          copy.createdAt = copy.createdAt || now;\n          copy.updatedAt = now;\n          copy.volume = copy.volume || Utils.volumeInCubicInches(copy.dimensions || { length: 0, width: 0, height: 0 });\n          nextCases.push(copy);\n          caseById.set(copy.id, copy);\n          if (nameKey) caseByName.set(nameKey, copy);\n          caseIdMap.set(c.id, copy.id);\n        });\n\n        const pack = Utils.deepClone(incomingPack);\n        pack.id = currentPacks.some(p => p.id === pack.id) ? Utils.uuid() : pack.id || Utils.uuid();\n        pack.title = pack.title ? `${pack.title} (Imported)` : 'Imported Pack';\n        pack.createdAt = pack.createdAt || now;\n        pack.lastEdited = now;\n\n        // New instance ids + caseId remap\n        pack.cases = (pack.cases || []).map(inst => {\n          const next = Utils.deepClone(inst);\n          next.id = Utils.uuid();\n          next.caseId = caseIdMap.get(next.caseId) || next.caseId;\n          if (!next.transform)\n            {next.transform = {\n              position: { x: -80, y: 10, z: 0 },\n              rotation: { x: 0, y: 0, z: 0 },\n              scale: { x: 1, y: 1, z: 1 },\n            };}\n          if (!next.transform.position) next.transform.position = { x: -80, y: 10, z: 0 };\n          return next;\n        });\n\n        pack.stats = PackLibrary.computeStats(pack, nextCases);\n\n        StateStore.set(\n          {\n            caseLibrary: nextCases,\n            packLibrary: [...currentPacks, pack],\n            currentPackId: pack.id,\n            currentScreen: 'editor',\n            selectedInstanceIds: [],\n          },\n          { skipHistory: false }\n        );\n      }\n\n      function field(label, type, placeholder, required) {\n        const wrap = document.createElement('div');\n        wrap.className = 'field';\n        const l = document.createElement('div');\n        l.className = 'label';\n        l.textContent = required ? `${label}` : label;\n        const input = document.createElement('input');\n        input.className = 'input';\n        input.type = type;\n        input.placeholder = placeholder || '';\n        wrap.appendChild(l);\n        wrap.appendChild(input);\n        return { wrap, input };\n      }\n\n      return { init, render };\n    })();\n\n    // Placeholder modules for remaining screens; implemented in later steps.\n    const CasesUI = (() => {\n      const searchEl = document.getElementById('cases-search');\n      const filtersEl = document.getElementById('cases-filters');\n      const tbodyEl = document.getElementById('cases-tbody');\n      const emptyEl = document.getElementById('cases-empty');\n      const btnNew = document.getElementById('btn-new-case');\n      const btnTemplate = document.getElementById('btn-cases-template');\n      const btnImport = document.getElementById('btn-cases-import');\n      const btnManageCats = document.getElementById('btn-manage-categories');\n\n      const activeCategories = new Set(); // empty = all\n      let sortBy = 'name'; // name, manufacturer, dimensions, volume, weight, category\n      let sortDir = 'asc'; // asc or desc\n\n      function init() {\n        searchEl.addEventListener('input', Utils.debounce(render, 300));\n        btnNew.addEventListener('click', () => openCaseModal(null));\n        btnTemplate.addEventListener('click', () => downloadTemplate());\n        btnImport.addEventListener('click', () => openImportModal());\n        btnManageCats.addEventListener('click', () => openCategoryManager());\n        initTableHeaders();\n      }\n\n      function initTableHeaders() {\n        const headers = document.querySelectorAll('#screen-cases table thead th[data-sort]');\n        headers.forEach(th => {\n          th.style.cursor = 'pointer';\n          th.style.userSelect = 'none';\n          th.addEventListener('click', () => {\n            const field = th.getAttribute('data-sort');\n            if (sortBy === field) {\n              sortDir = sortDir === 'asc' ? 'desc' : 'asc';\n            } else {\n              sortBy = field;\n              sortDir = 'asc';\n            }\n            render();\n            updateHeaderIcons();\n          });\n        });\n        updateHeaderIcons();\n      }\n\n      function updateHeaderIcons() {\n        const headers = document.querySelectorAll('#screen-cases table thead th[data-sort]');\n        headers.forEach(th => {\n          const field = th.getAttribute('data-sort');\n          const existingIcon = th.querySelector('.sort-icon');\n          if (existingIcon) existingIcon.remove();\n\n          if (sortBy === field) {\n            const icon = document.createElement('i');\n            icon.className = `fa-solid fa-${sortDir === 'asc' ? 'arrow-up' : 'arrow-down'} sort-icon`;\n            icon.style.marginLeft = '6px';\n            icon.style.fontSize = '12px';\n            icon.style.opacity = '0.7';\n            th.appendChild(icon);\n          }\n        });\n      }\n\n      function render() {\n        renderFilters();\n        renderTable();\n      }\n\n      function renderFilters() {\n        const cases = CaseLibrary.getCases();\n        const list = CategoryService.listWithCounts(cases);\n        filtersEl.innerHTML = '';\n\n        const allChip = chip(\n          'All',\n          'all',\n          activeCategories.size === 0,\n          () => {\n            activeCategories.clear();\n            render();\n          },\n          '#9b9ba8',\n          cases.length\n        );\n        filtersEl.appendChild(allChip);\n\n        list.forEach(cat => {\n          const isActive = activeCategories.has(cat.key);\n          const el = chip(\n            cat.name,\n            cat.key,\n            isActive,\n            () => {\n              if (activeCategories.has(cat.key)) activeCategories.delete(cat.key);\n              else activeCategories.add(cat.key);\n              render();\n            },\n            cat.color,\n            cat.count\n          );\n          filtersEl.appendChild(el);\n        });\n      }\n\n      function renderTable() {\n        const prefs = PreferencesManager.get();\n        const q = String(searchEl.value || '').trim();\n        const cases = CaseLibrary.search(q, Array.from(activeCategories));\n\n        // Sort cases\n        cases.sort((a, b) => {\n          let valA, valB;\n          switch (sortBy) {\n            case 'name':\n              valA = (a.name || '').toLowerCase();\n              valB = (b.name || '').toLowerCase();\n              break;\n            case 'manufacturer':\n              valA = (a.manufacturer || '').toLowerCase();\n              valB = (b.manufacturer || '').toLowerCase();\n              break;\n            case 'volume':\n              valA = a.volume || 0;\n              valB = b.volume || 0;\n              break;\n            case 'weight':\n              valA = a.weight || 0;\n              valB = b.weight || 0;\n              break;\n            case 'category':\n              valA = CategoryService.meta(a.category).name.toLowerCase();\n              valB = CategoryService.meta(b.category).name.toLowerCase();\n              break;\n            default:\n              valA = (a.name || '').toLowerCase();\n              valB = (b.name || '').toLowerCase();\n          }\n\n          if (typeof valA === 'number' && typeof valB === 'number') {\n            return sortDir === 'asc' ? valA - valB : valB - valA;\n          }\n\n          if (valA < valB) return sortDir === 'asc' ? -1 : 1;\n          if (valA > valB) return sortDir === 'asc' ? 1 : -1;\n          return 0;\n        });\n\n        tbodyEl.innerHTML = '';\n\n        if (!cases.length) {\n          emptyEl.style.display = 'block';\n          return;\n        }\n        emptyEl.style.display = 'none';\n\n        cases.forEach(c => {\n          const tr = document.createElement('tr');\n\n          const tdName = document.createElement('td');\n          tdName.textContent = c.name || '—';\n          tr.appendChild(tdName);\n\n          const tdMfg = document.createElement('td');\n          tdMfg.textContent = c.manufacturer || '—';\n          tr.appendChild(tdMfg);\n\n          const tdDims = document.createElement('td');\n          tdDims.textContent = Utils.formatDims(c.dimensions, prefs.units.length);\n          tr.appendChild(tdDims);\n\n          const tdVol = document.createElement('td');\n          tdVol.textContent = Utils.formatVolume(c.dimensions, prefs.units.length);\n          tr.appendChild(tdVol);\n\n          const tdW = document.createElement('td');\n          const weight = Number(c.weight) || 0;\n          const formattedWeight =\n            prefs.units.weight === 'kg' ? `${(weight * 0.453592).toFixed(2)} kg` : `${weight.toFixed(2)} lb`;\n          tdW.textContent = formattedWeight;\n          tr.appendChild(tdW);\n\n          const tdCat = document.createElement('td');\n          tdCat.appendChild(categoryChip(c.category));\n          tr.appendChild(tdCat);\n\n          const tdFlip = document.createElement('td');\n          tdFlip.innerHTML = c.canFlip\n            ? '<i class=\"fa-solid fa-check\" style=\"color:var(--success)\"></i>'\n            : '<i class=\"fa-solid fa-minus\" style=\"color:var(--text-muted)\"></i>';\n          tr.appendChild(tdFlip);\n\n          const tdActions = document.createElement('td');\n          tdActions.className = 'col-actions';\n          const btn = document.createElement('button');\n          btn.type = 'button';\n          btn.className = 'btn btn-ghost';\n          btn.innerHTML = '<i class=\"fa-solid fa-ellipsis\"></i>';\n          btn.addEventListener('click', ev => {\n            ev.stopPropagation();\n            UIComponents.openDropdown(btn, [\n              { label: 'Edit', icon: 'fa-solid fa-pen', onClick: () => openCaseModal(c) },\n              {\n                label: 'Duplicate',\n                icon: 'fa-solid fa-clone',\n                onClick: () => {\n                  CaseLibrary.duplicate(c.id);\n                  UIComponents.showToast('Case duplicated', 'success');\n                },\n              },\n              { label: 'Delete', icon: 'fa-solid fa-trash', onClick: () => deleteCase(c.id) },\n            ]);\n          });\n          tdActions.appendChild(btn);\n          tr.appendChild(tdActions);\n\n          tbodyEl.appendChild(tr);\n        });\n      }\n\n      function chip(label, key, active, onClick, color, count) {\n        const el = document.createElement('div');\n        el.className = `chip ${active ? 'active' : ''}`;\n        el.setAttribute('role', 'button');\n        el.tabIndex = 0;\n        const dot = document.createElement('span');\n        dot.className = 'chip-dot';\n        dot.style.background = color || 'var(--border-strong)';\n        const text = document.createElement('span');\n        text.textContent = `${label}${Number.isFinite(count) ? `: ${count}` : ''}`;\n        el.appendChild(dot);\n        el.appendChild(text);\n        el.addEventListener('click', onClick);\n        el.addEventListener('keydown', ev => {\n          if (ev.key === 'Enter') onClick();\n        });\n        return el;\n      }\n\n      function categoryChip(categoryKey) {\n        const meta = CategoryService.meta(categoryKey || 'default');\n        const el = document.createElement('span');\n        el.className = 'chip';\n        el.style.cursor = 'default';\n        const dot = document.createElement('span');\n        dot.className = 'chip-dot';\n        dot.style.background = meta.color;\n        const text = document.createElement('span');\n        text.textContent = meta.name;\n        el.appendChild(dot);\n        el.appendChild(text);\n        return el;\n      }\n\n      function openCaseModal(existing) {\n        const prefs = PreferencesManager.get();\n        const lengthUnit = prefs.units.length;\n        const weightUnit = prefs.units.weight;\n\n        const now = Date.now();\n        const isEdit = Boolean(existing);\n        const initial = existing\n          ? Utils.deepClone(existing)\n          : {\n              id: Utils.uuid(),\n              name: '',\n              manufacturer: '',\n              category: 'default',\n              dimensions: { length: 48, width: 24, height: 24 },\n              weight: 0,\n              canFlip: true,\n              notes: '',\n              color: CategoryService.meta('default').color,\n              createdAt: now,\n              updatedAt: now,\n            };\n\n        const content = document.createElement('div');\n        content.style.display = 'grid';\n        content.style.gridTemplateColumns = '1fr 1fr';\n        content.style.gap = '14px';\n\n        const fName = field('Name', 'text', 'Line Array Case', true);\n        fName.input.value = initial.name || '';\n\n        const fMfg = field('Manufacturer', 'text', 'L-Acoustics', false);\n        fMfg.input.value = initial.manufacturer || '';\n\n        const catWrap = document.createElement('div');\n        catWrap.className = 'field';\n        catWrap.style.gridColumn = '1 / -1';\n        const catLabel = document.createElement('div');\n        catLabel.className = 'label';\n        catLabel.textContent = 'Category';\n        const catRow = document.createElement('div');\n        catRow.style.display = 'flex';\n        catRow.style.gap = '8px';\n        catRow.style.alignItems = 'center';\n        const catColor = document.createElement('input');\n        catColor.type = 'color';\n        catColor.className = 'input';\n        catColor.style.width = '48px';\n        catColor.style.padding = '0';\n        catColor.value = CategoryService.meta(initial.category).color || '#9ca3af';\n        const catName = document.createElement('input');\n        catName.type = 'text';\n        catName.className = 'input';\n        catName.style.flex = '1';\n        catName.value = CategoryService.meta(initial.category).name;\n        catName.placeholder = 'Rename or create new';\n        const catSelect = document.createElement('select');\n        catSelect.className = 'select';\n        catSelect.style.display = 'none';\n        const catOptions = CategoryService.all();\n        const extraCat =\n          initial.category && !catOptions.find(c => c.key === initial.category)\n            ? [{ ...CategoryService.meta(initial.category) }]\n            : [];\n        [...catOptions, ...extraCat]\n          .filter((v, idx, arr) => arr.findIndex(x => x.key === v.key) === idx)\n          .forEach(c => {\n            const opt = document.createElement('option');\n            opt.value = c.key;\n            opt.textContent = c.name || CategoryService.meta(c.key).name;\n            catSelect.appendChild(opt);\n          });\n        catSelect.value = initial.category || 'default';\n        catRow.appendChild(catColor);\n        catRow.appendChild(catName);\n        catRow.appendChild(catSelect);\n        catWrap.appendChild(catLabel);\n        catWrap.appendChild(catRow);\n\n        const fL = field(`Length (${lengthUnit})`, 'number', '', true);\n        const fW = field(`Width (${lengthUnit})`, 'number', '', true);\n        const fH = field(`Height (${lengthUnit})`, 'number', '', true);\n        fL.input.value = String(Utils.inchesToUnit(initial.dimensions.length, lengthUnit));\n        fW.input.value = String(Utils.inchesToUnit(initial.dimensions.width, lengthUnit));\n        fH.input.value = String(Utils.inchesToUnit(initial.dimensions.height, lengthUnit));\n\n        const fWeight = field(`Weight (${weightUnit})`, 'number', '', false);\n        fWeight.input.step = '0.1';\n        const weightValue = Utils.poundsToUnit(Number(initial.weight) || 0, weightUnit);\n        fWeight.input.value = String(Math.round(weightValue * 100) / 100);\n\n        const flipRow = document.createElement('label');\n        flipRow.style.display = 'flex';\n        flipRow.style.alignItems = 'center';\n        flipRow.style.gap = '10px';\n        flipRow.style.fontSize = 'var(--text-sm)';\n        flipRow.style.gridColumn = '1 / -1';\n        const flip = document.createElement('input');\n        flip.type = 'checkbox';\n        flip.checked = Boolean(initial.canFlip);\n        const flipText = document.createElement('span');\n        flipText.textContent = 'Can be flipped';\n        flipRow.appendChild(flip);\n        flipRow.appendChild(flipText);\n\n        const notesWrap = document.createElement('div');\n        notesWrap.className = 'field';\n        notesWrap.style.gridColumn = '1 / -1';\n        const notesLabel = document.createElement('div');\n        notesLabel.className = 'label';\n        notesLabel.textContent = 'Notes';\n        const notes = document.createElement('textarea');\n        notes.className = 'input';\n        notes.style.minHeight = '60px';\n        notes.value = initial.notes || '';\n        notesWrap.appendChild(notesLabel);\n        notesWrap.appendChild(notes);\n\n        content.appendChild(fName.wrap);\n        content.appendChild(fMfg.wrap);\n        content.appendChild(catWrap);\n        content.appendChild(fL.wrap);\n        content.appendChild(fW.wrap);\n        content.appendChild(fH.wrap);\n        content.appendChild(fWeight.wrap);\n        content.appendChild(flipRow);\n        content.appendChild(notesWrap);\n\n        UIComponents.showModal({\n          title: isEdit ? 'Edit Case' : 'New Case',\n          content,\n          actions: [\n            { label: 'Cancel' },\n            {\n              label: 'Save',\n              variant: 'primary',\n              onClick: () => {\n                const name = String(fName.input.value || '').trim();\n                if (!name) {\n                  UIComponents.showToast('Name is required', 'warning');\n                  fName.input.focus();\n                  return false;\n                }\n                const length = Utils.unitToInches(Number(fL.input.value) || 0, lengthUnit);\n                const width = Utils.unitToInches(Number(fW.input.value) || 0, lengthUnit);\n                const height = Utils.unitToInches(Number(fH.input.value) || 0, lengthUnit);\n                if (length <= 0 || width <= 0 || height <= 0) {\n                  UIComponents.showToast('Dimensions must be > 0', 'warning');\n                  return false;\n                }\n                const weightLb = Utils.unitToPounds(Number(fWeight.input.value) || 0, weightUnit);\n                const categoryName = String(catName.value || '').trim();\n                const updatedCat = CategoryService.rename(catSelect.value, categoryName, catColor.value);\n                const caseData = {\n                  ...initial,\n                  name,\n                  manufacturer: String(fMfg.input.value || '').trim(),\n                  category: updatedCat.key,\n                  dimensions: { length, width, height },\n                  weight: weightLb,\n                  canFlip: Boolean(flip.checked),\n                  notes: String(notes.value || '').trim(),\n                  color: catColor.value || '#ff9f1c',\n                };\n                CaseLibrary.upsert(caseData);\n                UIComponents.showToast('Case saved', 'success');\n                render();\n              },\n            },\n          ],\n        });\n      }\n\n      function openCategoryManager() {\n        const content = document.createElement('div');\n        content.style.display = 'grid';\n        content.style.gap = '14px';\n        content.style.minWidth = '480px';\n\n        const listEl = document.createElement('div');\n        listEl.style.display = 'grid';\n        listEl.style.gap = '8px';\n\n        const renderList = () => {\n          listEl.innerHTML = '';\n          CategoryService.all().forEach(cat => {\n            const row = document.createElement('div');\n            row.className = 'card';\n            row.style.display = 'grid';\n            row.style.gridTemplateColumns = '40px 1fr auto';\n            row.style.gap = '12px';\n            row.style.alignItems = 'center';\n            row.style.padding = 'var(--space-3)';\n            row.style.background = 'var(--bg-elevated)';\n            row.style.boxShadow = 'none';\n\n            const colorWrap = document.createElement('div');\n            colorWrap.style.position = 'relative';\n            const color = document.createElement('input');\n            color.type = 'color';\n            color.value = cat.color || '#9ca3af';\n            color.className = 'input';\n            color.style.width = '40px';\n            color.style.height = '40px';\n            color.style.padding = '0';\n            color.style.cursor = 'pointer';\n            color.style.border = '2px solid var(--border-subtle)';\n            color.style.borderRadius = 'var(--radius-sm)';\n            colorWrap.appendChild(color);\n\n            const name = document.createElement('input');\n            name.type = 'text';\n            name.className = 'input';\n            name.value = cat.name;\n            name.placeholder = 'Category name';\n\n            const actions = document.createElement('div');\n            actions.style.display = 'flex';\n            actions.style.gap = '6px';\n\n            const saveBtn = document.createElement('button');\n            saveBtn.type = 'button';\n            saveBtn.className = 'btn btn-ghost';\n            saveBtn.style.padding = '6px 10px';\n            saveBtn.innerHTML = '<i class=\"fa-solid fa-floppy-disk\"></i>';\n            saveBtn.title = 'Save changes';\n            saveBtn.addEventListener('click', () => {\n              const renamed = CategoryService.rename(cat.key, name.value, color.value);\n              renderList();\n              render();\n              UIComponents.showToast(`Saved \"${renamed.name}\"`, 'success');\n            });\n\n            if (cat.key !== 'default') {\n              const delBtn = document.createElement('button');\n              delBtn.type = 'button';\n              delBtn.className = 'btn btn-ghost';\n              delBtn.style.padding = '6px 10px';\n              delBtn.style.color = 'var(--error)';\n              delBtn.innerHTML = '<i class=\"fa-solid fa-trash\"></i>';\n              delBtn.title = 'Delete category';\n              delBtn.addEventListener('click', async () => {\n                const ok = await UIComponents.confirm({\n                  title: `Delete \"${cat.name}\"?`,\n                  message: 'All cases in this category will be moved to Default.',\n                  okLabel: 'Delete',\n                  danger: true,\n                });\n                if (!ok) return;\n                CategoryService.remove(cat.key);\n                renderList();\n                render();\n                UIComponents.showToast(`Deleted \"${cat.name}\"`, 'info');\n              });\n              actions.appendChild(delBtn);\n            }\n\n            actions.appendChild(saveBtn);\n            row.appendChild(colorWrap);\n            row.appendChild(name);\n            row.appendChild(actions);\n            listEl.appendChild(row);\n          });\n        };\n\n        const addBtn = document.createElement('button');\n        addBtn.type = 'button';\n        addBtn.className = 'btn btn-primary';\n        addBtn.style.width = '100%';\n        addBtn.innerHTML = '<i class=\"fa-solid fa-plus\"></i> New Category';\n        addBtn.addEventListener('click', () => {\n          const baseName = 'New Category';\n          let idx = 1;\n          let name = baseName;\n          const existing = new Set(CategoryService.all().map(c => c.name.toLowerCase()));\n          while (existing.has(name.toLowerCase())) {\n            idx += 1;\n            name = `${baseName} ${idx}`;\n          }\n          CategoryService.upsert({ name });\n          renderList();\n          render();\n        });\n\n        renderList();\n\n        content.appendChild(listEl);\n        content.appendChild(addBtn);\n\n        UIComponents.showModal({\n          title: 'Manage Categories',\n          content,\n          actions: [{ label: 'Close', variant: 'primary' }],\n        });\n      }\n\n      function normalizeHex(value) {\n        const s = String(value || '').trim();\n        const m = s.match(/^#([0-9a-f]{6})$/i);\n        return m ? `#${m[1].toLowerCase()}` : null;\n      }\n\n      function field(label, type, placeholder, required) {\n        const wrap = document.createElement('div');\n        wrap.className = 'field';\n        const l = document.createElement('div');\n        l.className = 'label';\n        l.textContent = required ? `${label} (required)` : label;\n        const input = document.createElement('input');\n        input.className = 'input';\n        input.type = type;\n        input.placeholder = placeholder || '';\n        wrap.appendChild(l);\n        wrap.appendChild(input);\n        return { wrap, input };\n      }\n\n      async function deleteCase(caseId) {\n        const caseData = CaseLibrary.getById(caseId);\n        if (!caseData) return;\n        const packsUsing = PackLibrary.getPacks().filter(p => (p.cases || []).some(i => i.caseId === caseId));\n        const msg = packsUsing.length\n          ? `This case is used in ${packsUsing.length} pack(s). Deleting it will remove it from those packs.`\n          : 'This cannot be undone.';\n        const ok = await UIComponents.confirm({\n          title: `Delete \"${caseData.name}\"?`,\n          message: msg,\n          danger: true,\n          okLabel: 'Delete',\n        });\n        if (!ok) return;\n\n        const nextCaseLibrary = CaseLibrary.getCases().filter(c => c.id !== caseId);\n        const nextPackLibrary = PackLibrary.getPacks().map(p => {\n          const nextCases = (p.cases || []).filter(i => i.caseId !== caseId);\n          if (nextCases.length === (p.cases || []).length) return p;\n          const next = { ...p, cases: nextCases, lastEdited: Date.now() };\n          next.stats = PackLibrary.computeStats(next);\n          return next;\n        });\n\n        StateStore.set({ caseLibrary: nextCaseLibrary, packLibrary: nextPackLibrary });\n        UIComponents.showToast('Case deleted', 'info');\n      }\n\n      function downloadTemplate() {\n        const csv = [\n          'name,manufacturer,category,length,width,height,weight,canFlip,notes',\n          'Line Array Case,L-Acoustics,audio,48,24,32,125,false,',\n          'Truss Section,Global Truss,lighting,120,12,12,45,true,',\n        ].join('\\n');\n        Utils.downloadText('cases_template.csv', csv, 'text/csv');\n        UIComponents.showToast('Template downloaded', 'success');\n      }\n\n      function openImportModal() {\n        const content = document.createElement('div');\n        content.style.display = 'grid';\n        content.style.gap = '14px';\n\n        const drop = document.createElement('div');\n        drop.className = 'card';\n        drop.style.borderStyle = 'dashed';\n        drop.style.background = 'var(--bg-elevated)';\n        drop.style.textAlign = 'center';\n        drop.style.padding = '22px';\n        drop.innerHTML = `\n              <div style=\"font-size:28px;margin-bottom:6px\">📄</div>\n              <div style=\"font-weight:var(--font-semibold);margin-bottom:6px\">Drag & Drop File Here</div>\n              <div class=\"muted\" style=\"font-size:var(--text-sm)\">Supported: .csv, .xlsx</div>\n              <div style=\"height:12px\"></div>\n            `;\n        const browseBtn = document.createElement('button');\n        browseBtn.className = 'btn';\n        browseBtn.type = 'button';\n        browseBtn.innerHTML = '<i class=\"fa-solid fa-folder-open\"></i> Browse files';\n        drop.appendChild(browseBtn);\n\n        const hint = document.createElement('div');\n        hint.className = 'muted';\n        hint.style.fontSize = 'var(--text-sm)';\n        hint.innerHTML =\n          'Required: <b>name</b>, <b>length</b>, <b>width</b>, <b>height</b><br>Optional: manufacturer, category, weight, canFlip, notes';\n\n        const results = document.createElement('div');\n        results.style.display = 'none';\n\n        content.appendChild(drop);\n        content.appendChild(hint);\n        content.appendChild(results);\n\n        const fileInput = document.createElement('input');\n        fileInput.type = 'file';\n        fileInput.accept = '.csv,.xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/csv';\n\n        const modal = UIComponents.showModal({\n          title: 'Import Cases',\n          content,\n          actions: [{ label: 'Close', variant: 'primary' }],\n        });\n\n        browseBtn.addEventListener('click', () => fileInput.click());\n\n        drop.addEventListener('dragover', ev => {\n          ev.preventDefault();\n          drop.style.borderColor = 'rgba(255, 159, 28, 0.6)';\n        });\n        drop.addEventListener('dragleave', () => {\n          drop.style.borderColor = 'var(--border-subtle)';\n        });\n        drop.addEventListener('drop', ev => {\n          ev.preventDefault();\n          drop.style.borderColor = 'var(--border-subtle)';\n          const file = ev.dataTransfer && ev.dataTransfer.files && ev.dataTransfer.files[0];\n          if (file) handleFile(file, results, modal);\n        });\n\n        fileInput.addEventListener('change', () => {\n          const file = fileInput.files && fileInput.files[0];\n          if (file) handleFile(file, results, modal);\n        });\n      }\n\n      async function handleFile(file, resultsEl, modal) {\n        try {\n          const parsed = await parseAndValidateSpreadsheet(file);\n          resultsEl.style.display = 'block';\n          resultsEl.innerHTML = '';\n\n          const summary = document.createElement('div');\n          summary.className = 'card';\n          summary.innerHTML = `\n                <div style=\"font-weight:var(--font-semibold);margin-bottom:6px\">Import Preview</div>\n                <div class=\"muted\" style=\"font-size:var(--text-sm)\">File: ${escapeHtml(file.name)}</div>\n                <div style=\"height:8px\"></div>\n                <div style=\"display:flex;gap:12px;flex-wrap:wrap\">\n                  <div class=\"badge\" style=\"border-color:rgba(16,185,129,.25);background:rgba(16,185,129,.12);color:var(--text-primary)\">✓ Valid: ${parsed.valid.length}</div>\n                  <div class=\"badge\" style=\"border-color:rgba(245,158,11,.25);background:rgba(245,158,11,.12);color:var(--text-primary)\">↷ Duplicates skipped: ${parsed.duplicates.length}</div>\n                  <div class=\"badge\" style=\"border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.12);color:var(--text-primary)\">⚠ Invalid: ${parsed.errors.length}</div>\n                </div>\n              `;\n\n          const actionsRow = document.createElement('div');\n          actionsRow.className = 'row';\n          actionsRow.style.justifyContent = 'flex-end';\n          actionsRow.style.marginTop = '12px';\n          const btn = document.createElement('button');\n          btn.className = 'btn btn-primary';\n          btn.type = 'button';\n          btn.textContent = 'Import valid rows';\n          btn.disabled = parsed.valid.length === 0;\n          btn.addEventListener('click', () => {\n            importRows(parsed.valid);\n            modal.close();\n          });\n          actionsRow.appendChild(btn);\n          summary.appendChild(actionsRow);\n\n          resultsEl.appendChild(summary);\n\n          if (parsed.errors.length) {\n            const err = document.createElement('div');\n            err.className = 'card';\n            err.innerHTML = '<div style=\"font-weight:var(--font-semibold);margin-bottom:6px\">Errors</div>';\n            const ul = document.createElement('ul');\n            ul.style.margin = '8px 0 0 16px';\n            ul.style.color = 'var(--text-secondary)';\n            ul.style.fontSize = 'var(--text-sm)';\n            parsed.errors.slice(0, 12).forEach(e => {\n              const li = document.createElement('li');\n              li.textContent = e;\n              ul.appendChild(li);\n            });\n            if (parsed.errors.length > 12) {\n              const li = document.createElement('li');\n              li.textContent = `...and ${parsed.errors.length - 12} more`;\n              ul.appendChild(li);\n            }\n            err.appendChild(ul);\n            resultsEl.appendChild(err);\n          }\n\n          const preview = document.createElement('div');\n          preview.className = 'card';\n          preview.innerHTML =\n            '<div style=\"font-weight:var(--font-semibold);margin-bottom:6px\">Preview (first 5 valid rows)</div>';\n          const p = document.createElement('div');\n          p.className = 'muted';\n          p.style.fontSize = 'var(--text-sm)';\n          p.style.display = 'grid';\n          p.style.gap = '6px';\n          parsed.valid.slice(0, 5).forEach(r => {\n            p.appendChild(document.createTextNode(`${r.name} • ${r.length}×${r.width}×${r.height} • ${r.category}`));\n            p.appendChild(document.createElement('br'));\n          });\n          preview.appendChild(p);\n          resultsEl.appendChild(preview);\n        } catch (err) {\n          UIComponents.showToast('Import failed: ' + err.message, 'error');\n        }\n      }\n\n      function escapeHtml(s) {\n        return String(s || '').replace(\n          /[&<>\"']/g,\n          c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '\"': '&quot;', \"'\": '&#39;' })[c]\n        );\n      }\n\n      function importRows(rows) {\n        const now = Date.now();\n        const existingNames = new Set(\n          CaseLibrary.getCases().map(c =>\n            String(c.name || '')\n              .trim()\n              .toLowerCase()\n          )\n        );\n        const next = [...CaseLibrary.getCases()];\n        let added = 0;\n        rows.forEach(r => {\n          const nameKey = String(r.name || '')\n            .trim()\n            .toLowerCase();\n          if (!nameKey || existingNames.has(nameKey)) return;\n          existingNames.add(nameKey);\n          const meta = CategoryService.meta(r.category || 'default');\n          next.push({\n            id: Utils.uuid(),\n            name: String(r.name || '').trim(),\n            manufacturer: String(r.manufacturer || '').trim(),\n            category:\n              String(r.category || 'default')\n                .trim()\n                .toLowerCase() || 'default',\n            dimensions: { length: Number(r.length), width: Number(r.width), height: Number(r.height) },\n            weight: Number(r.weight) || 0,\n            volume: Utils.volumeInCubicInches({\n              length: Number(r.length),\n              width: Number(r.width),\n              height: Number(r.height),\n            }),\n            canFlip: Boolean(r.canFlip),\n            notes: String(r.notes || '').trim(),\n            color: normalizeHex(r.color) || normalizeHex(meta.color) || '#ff9f1c',\n            createdAt: now,\n            updatedAt: now,\n          });\n          added++;\n        });\n        StateStore.set({ caseLibrary: next });\n        UIComponents.showToast(`Imported ${added} case(s)`, added ? 'success' : 'warning');\n      }\n\n      async function parseAndValidateSpreadsheet(file) {\n        if (!window.XLSX) throw new Error('XLSX library not available');\n        const ext = String(file.name || '')\n          .split('.')\n          .pop()\n          .toLowerCase();\n        let workbook;\n        if (ext === 'csv') {\n          const text = await file.text();\n          workbook = window.XLSX.read(text, { type: 'string' });\n        } else {\n          const buf = await file.arrayBuffer();\n          workbook = window.XLSX.read(buf, { type: 'array' });\n        }\n        const sheetName = workbook.SheetNames[0];\n        const sheet = workbook.Sheets[sheetName];\n        const rows = window.XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });\n        if (!rows || !rows.length) throw new Error('Empty file');\n\n        const headerRow = rows[0].map(h => String(h || '').trim());\n        const header = headerRow.map(normalizeHeader);\n        const idx = indexMap(header);\n\n        const required = ['name', 'length', 'width', 'height'];\n        const missing = required.filter(r => idx[r] == null);\n        if (missing.length) throw new Error('Missing required columns: ' + missing.join(', '));\n\n        const existingNames = new Set(\n          CaseLibrary.getCases().map(c =>\n            String(c.name || '')\n              .trim()\n              .toLowerCase()\n          )\n        );\n        const errors = [];\n        const duplicates = [];\n        const valid = [];\n\n        for (let r = 1; r < rows.length; r++) {\n          const row = rows[r];\n          if (!row || row.every(v => String(v || '').trim() === '')) continue;\n          const rowNum = r + 1;\n          const record = {\n            name: String(getField(row, idx.name)).trim(),\n            manufacturer: String(getField(row, idx.manufacturer)).trim(),\n            category: String(getField(row, idx.category)).trim().toLowerCase() || 'default',\n            length: Number(getField(row, idx.length)),\n            width: Number(getField(row, idx.width)),\n            height: Number(getField(row, idx.height)),\n            weight: Number(getField(row, idx.weight)),\n            canFlip: parseBool(getField(row, idx.canFlip)),\n            notes: String(getField(row, idx.notes)).trim(),\n            color: String(getField(row, idx.color)).trim(),\n          };\n\n          const rowErrors = [];\n          if (!record.name) rowErrors.push(`Row ${rowNum}: Missing required field 'name'`);\n          if (!Number.isFinite(record.length) || record.length <= 0)\n            {rowErrors.push(`Row ${rowNum}: Invalid number for 'length'`);}\n          if (!Number.isFinite(record.width) || record.width <= 0)\n            {rowErrors.push(`Row ${rowNum}: Invalid number for 'width'`);}\n          if (!Number.isFinite(record.height) || record.height <= 0)\n            {rowErrors.push(`Row ${rowNum}: Invalid number for 'height'`);}\n\n          const nameKey = record.name.toLowerCase();\n          if (record.name && existingNames.has(nameKey)) {\n            duplicates.push(`Row ${rowNum}: Duplicate name \"${record.name}\" (skipped)`);\n            continue;\n          }\n\n          if (rowErrors.length) {\n            errors.push(...rowErrors);\n            continue;\n          }\n          valid.push(record);\n        }\n\n        return { valid, errors, duplicates };\n      }\n\n      function normalizeHeader(s) {\n        return String(s || '')\n          .toLowerCase()\n          .replace(/[^a-z0-9]+/g, '');\n      }\n\n      function indexMap(headers) {\n        const find = candidates => {\n          for (const c of candidates) {\n            const idx = headers.indexOf(c);\n            if (idx > -1) return idx;\n          }\n          return null;\n        };\n        return {\n          name: find(['name', 'casename', 'item', 'title']),\n          manufacturer: find(['manufacturer', 'mfg', 'brand']),\n          category: find(['category', 'cat', 'type']),\n          length: find(['length', 'l']),\n          width: find(['width', 'w']),\n          height: find(['height', 'h']),\n          weight: find(['weight', 'wt']),\n          canFlip: find(['canflip', 'flippable', 'canrotate', 'flip']),\n          notes: find(['notes', 'note', 'description', 'desc']),\n          color: find(['color', 'hex', 'casecolor']),\n        };\n      }\n\n      function getField(row, idx) {\n        if (idx == null) return '';\n        return row[idx];\n      }\n\n      function parseBool(v) {\n        const s = String(v || '')\n          .trim()\n          .toLowerCase();\n        if (!s) return false;\n        return ['true', '1', 'yes', 'y', 'on'].includes(s);\n      }\n\n      return { init, render };\n    })();\n\n    const SceneManager = (() => {\n      const INCH_TO_WORLD = 0.05;\n      const WORLD_TO_INCH = 1 / INCH_TO_WORLD;\n      let containerEl = null;\n      let scene = null;\n      let camera = null;\n      let renderer = null;\n      let controls = null;\n      let truck = null;\n      let truckBoundsWorld = null;\n      let truckSignature = '';\n      let grid = null;\n      let ground = null;\n      let axisScene = null;\n      let axisCamera = null;\n      let axisHelper = null;\n      const perf = { lastTime: 0, lowMs: 0, perfMode: false, fps: 60 };\n      let viewSize = { width: 1, height: 1 };\n\n      // Dev-only performance overlay\n      const DevOverlay = (() => {\n        let overlayEl = null;\n        let visible = false;\n        const stats = { fps: 0, frameTime: 0, memory: 0, drawCalls: 0, triangles: 0, geometries: 0, textures: 0 };\n        let lastLogTime = 0;\n\n        function create() {\n          if (overlayEl) return;\n          overlayEl = document.createElement('div');\n          overlayEl.style.cssText = `\n                position: fixed;\n                top: 10px;\n                right: 10px;\n                background: rgba(0, 0, 0, 0.85);\n                color: #0f0;\n                font-family: 'Courier New', monospace;\n                font-size: 11px;\n                padding: 8px 12px;\n                border-radius: 4px;\n                z-index: 10000;\n                line-height: 1.5;\n                pointer-events: none;\n                display: none;\n                min-width: 180px;\n                box-shadow: 0 2px 8px rgba(0,0,0,0.5);\n              `;\n          document.body.appendChild(overlayEl);\n        }\n\n        function toggle() {\n          create();\n          visible = !visible;\n          overlayEl.style.display = visible ? 'block' : 'none';\n          if (visible) {\n            console.log('[DevOverlay] Performance monitoring enabled (press P to toggle)');\n          }\n        }\n\n        function update(time, rendererInfo) {\n          if (!visible || !overlayEl) return;\n\n          stats.fps = Math.round(perf.fps);\n          stats.frameTime = Math.round((1000 / perf.fps) * 10) / 10;\n\n          if (rendererInfo) {\n            stats.drawCalls = rendererInfo.render.calls;\n            stats.triangles = rendererInfo.render.triangles;\n            stats.geometries = rendererInfo.memory.geometries;\n            stats.textures = rendererInfo.memory.textures;\n          }\n\n          if (performance.memory) {\n            stats.memory = Math.round(performance.memory.usedJSHeapSize / 1048576);\n          }\n\n          const fpsColor = stats.fps >= 55 ? '#0f0' : stats.fps >= 30 ? '#ff0' : '#f00';\n          overlayEl.innerHTML = `\n                <div style=\"color: ${fpsColor}; font-weight: bold;\">FPS: ${stats.fps}</div>\n                <div>Frame: ${stats.frameTime}ms</div>\n                ${stats.memory ? `<div>Memory: ${stats.memory}MB</div>` : ''}\n                <div style=\"margin-top: 4px; border-top: 1px solid #333; padding-top: 4px;\">\n                  <div>Calls: ${stats.drawCalls}</div>\n                  <div>Tris: ${stats.triangles}</div>\n                  <div>Geom: ${stats.geometries}</div>\n                  <div>Tex: ${stats.textures}</div>\n                </div>\n              `;\n\n          // Log stats every 10 seconds\n          if (time - lastLogTime > 10000) {\n            lastLogTime = time;\n            console.log('[DevOverlay] Stats:', {\n              fps: stats.fps,\n              frameTime: stats.frameTime + 'ms',\n              memory: stats.memory ? stats.memory + 'MB' : 'N/A',\n              renderer: {\n                drawCalls: stats.drawCalls,\n                triangles: stats.triangles,\n                geometries: stats.geometries,\n                textures: stats.textures,\n              },\n            });\n          }\n        }\n\n        function isVisible() {\n          return visible;\n        }\n\n        return { toggle, update, isVisible };\n      })();\n\n      function toWorld(inches) {\n        return Number(inches) * INCH_TO_WORLD;\n      }\n\n      function toInches(worldUnits) {\n        return Number(worldUnits) * WORLD_TO_INCH;\n      }\n\n      function vecInchesToWorld(pos) {\n        return new THREE.Vector3(toWorld(pos.x), toWorld(pos.y), toWorld(pos.z));\n      }\n\n      function vecWorldToInches(vec) {\n        return { x: toInches(vec.x), y: toInches(vec.y), z: toInches(vec.z) };\n      }\n\n      function init(viewportEl) {\n        if (renderer) return;\n        containerEl = viewportEl;\n        containerEl.innerHTML = '';\n\n        scene = new THREE.Scene();\n        refreshTheme();\n\n        const { width, height } = getContainerSize();\n        camera = new THREE.PerspectiveCamera(50, width / height, 0.01, 5000);\n        camera.position.set(22, 16, 22);\n\n        renderer = new THREE.WebGLRenderer({\n          antialias: true,\n          alpha: false,\n          powerPreference: 'high-performance',\n        });\n        renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));\n        renderer.setSize(width, height);\n        viewSize = { width, height };\n        renderer.shadowMap.enabled = true;\n        renderer.shadowMap.type = THREE.PCFSoftShadowMap;\n        containerEl.appendChild(renderer.domElement);\n\n        controls = new THREE.OrbitControls(camera, renderer.domElement);\n        controls.enableDamping = true;\n        controls.dampingFactor = 0.06;\n        controls.minDistance = 6;\n        controls.maxDistance = 220;\n        controls.maxPolarAngle = Math.PI / 2 - 0.02;\n        controls.target.set(14, 2, 0);\n\n        addLighting();\n        addEnvironment();\n        addAxisWidget();\n\n        // Default truck size (53ft trailer)\n        setTruck({ length: 636, width: 102, height: 98 });\n\n        requestAnimationFrame(tick);\n      }\n\n      function getContainerSize() {\n        const rect = containerEl.getBoundingClientRect();\n        const width = Math.max(10, Math.floor(rect.width));\n        const height = Math.max(10, Math.floor(rect.height));\n        return { width, height };\n      }\n\n      function addLighting() {\n        const ambient = new THREE.AmbientLight(0xffffff, 0.62);\n        scene.add(ambient);\n\n        const dir = new THREE.DirectionalLight(0xffffff, 0.9);\n        dir.position.set(30, 60, 25);\n        dir.castShadow = true;\n        dir.shadow.mapSize.width = 1024;\n        dir.shadow.mapSize.height = 1024;\n        dir.shadow.camera.left = -80;\n        dir.shadow.camera.right = 80;\n        dir.shadow.camera.top = 80;\n        dir.shadow.camera.bottom = -80;\n        scene.add(dir);\n\n        const hemi = new THREE.HemisphereLight(0x87ceeb, 0x2d2d2d, 0.25);\n        scene.add(hemi);\n      }\n\n      function addEnvironment() {\n        const groundGeo = new THREE.PlaneGeometry(260, 260);\n        const groundMat = new THREE.ShadowMaterial({ opacity: 0.18 });\n        ground = new THREE.Mesh(groundGeo, groundMat);\n        ground.rotation.x = -Math.PI / 2;\n        ground.receiveShadow = true;\n        scene.add(ground);\n\n        grid = new THREE.GridHelper(220, 110);\n        grid.name = 'grid';\n        scene.add(grid);\n        refreshTheme();\n      }\n\n      function addAxisWidget() {\n        axisScene = new THREE.Scene();\n        axisCamera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);\n        axisHelper = new THREE.AxesHelper(3.2);\n        axisScene.add(axisHelper);\n      }\n\n      function tick(time) {\n        requestAnimationFrame(tick);\n        if (StateStore.get('currentScreen') !== 'editor') return;\n        if (controls) controls.update();\n        if (window.TWEEN) window.TWEEN.update(time);\n        updatePerf(time);\n        render();\n        if (DevOverlay.isVisible() && renderer) {\n          DevOverlay.update(time, renderer.info);\n        }\n      }\n\n      function updatePerf(time) {\n        if (!perf.lastTime) {\n          perf.lastTime = time;\n          return;\n        }\n        const dt = Math.max(1, time - perf.lastTime);\n        perf.lastTime = time;\n        const fps = 1000 / dt;\n        perf.fps = perf.fps * 0.9 + fps * 0.1;\n        if (perf.fps < 30) perf.lowMs += dt;\n        else perf.lowMs = 0;\n\n        if (!perf.perfMode && perf.lowMs > 5000) {\n          perf.perfMode = true;\n          renderer.shadowMap.enabled = false;\n          UIComponents.showToast('Performance mode enabled (shadows disabled)', 'warning', {\n            title: 'Performance',\n            actions: [\n              {\n                label: 'Restore',\n                onClick: () => {\n                  perf.perfMode = false;\n                  perf.lowMs = 0;\n                  renderer.shadowMap.enabled = true;\n                },\n              },\n            ],\n          });\n        }\n      }\n\n      function render() {\n        if (!renderer || !scene || !camera) return;\n        const width = viewSize.width;\n        const height = viewSize.height;\n        renderer.setViewport(0, 0, width, height);\n        renderer.setScissorTest(false);\n        renderer.render(scene, camera);\n\n        // Axis widget render (top-right)\n        renderer.clearDepth();\n        const size = Math.max(90, Math.floor(Math.min(width, height) * 0.2));\n        const pad = 12;\n        renderer.setScissorTest(true);\n        renderer.setViewport(width - size - pad, pad, size, size);\n        renderer.setScissor(width - size - pad, pad, size, size);\n        axisCamera.position.copy(camera.position).sub(controls.target).setLength(8);\n        axisCamera.lookAt(axisScene.position);\n        renderer.render(axisScene, axisCamera);\n        renderer.setScissorTest(false);\n      }\n\n      function resize() {\n        if (!renderer || !camera || !containerEl) return;\n        const { width, height } = getContainerSize();\n        if (width === viewSize.width && height === viewSize.height) return;\n        viewSize = { width, height };\n        camera.aspect = width / height;\n        camera.updateProjectionMatrix();\n        renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));\n        renderer.setSize(width, height);\n      }\n\n      function refreshTheme() {\n        if (!scene) return;\n        const bgHex = Utils.getCssVar('--bg-primary');\n        scene.background = new THREE.Color(Utils.cssHexToInt(bgHex));\n        if (grid && grid.material) {\n          const gridMat = grid.material;\n          const mainColor = new THREE.Color(Utils.cssHexToInt(Utils.getCssVar('--accent-primary')));\n          const subColor = new THREE.Color(Utils.cssHexToInt(Utils.getCssVar('--border-strong')));\n          if (Array.isArray(gridMat)) {\n            if (gridMat[0]) gridMat[0].color = mainColor;\n            if (gridMat[1]) gridMat[1].color = subColor;\n          } else {\n            gridMat.color = subColor;\n          }\n        }\n      }\n\n      function setTruck(truckInches) {\n        if (!scene) return;\n        const sig = `${truckInches.length}x${truckInches.width}x${truckInches.height}`;\n        const lengthW = toWorld(truckInches.length);\n        const widthW = toWorld(truckInches.width);\n        const heightW = toWorld(truckInches.height);\n\n        if (truck && truckSignature === sig) {\n          truckBoundsWorld = new THREE.Box3(\n            new THREE.Vector3(0, 0, -widthW / 2),\n            new THREE.Vector3(lengthW, heightW, widthW / 2)\n          );\n          controls.target.set(lengthW / 2, Math.min(6, heightW / 2), 0);\n          return;\n        }\n        truckSignature = sig;\n\n        if (truck) {\n          scene.remove(truck);\n          truck.traverse(obj => {\n            if (obj.geometry) obj.geometry.dispose();\n            if (obj.material) obj.material.dispose();\n          });\n          truck = null;\n        }\n\n        truck = new THREE.Group();\n        truck.name = 'truck';\n\n        const geo = new THREE.BoxGeometry(lengthW, heightW, widthW);\n        const mat = new THREE.MeshStandardMaterial({\n          color: new THREE.Color(Utils.cssHexToInt(Utils.getCssVar('--accent-primary'))),\n          transparent: true,\n          opacity: 0.09,\n          side: THREE.DoubleSide,\n        });\n        const mesh = new THREE.Mesh(geo, mat);\n        mesh.position.set(lengthW / 2, heightW / 2, 0);\n        mesh.receiveShadow = false;\n        truck.add(mesh);\n\n        const edges = new THREE.EdgesGeometry(geo);\n        const lineMat = new THREE.LineBasicMaterial({\n          color: new THREE.Color(Utils.cssHexToInt(Utils.getCssVar('--accent-primary'))),\n        });\n        const wire = new THREE.LineSegments(edges, lineMat);\n        wire.position.copy(mesh.position);\n        truck.add(wire);\n\n        scene.add(truck);\n\n        truckBoundsWorld = new THREE.Box3(\n          new THREE.Vector3(0, 0, -widthW / 2),\n          new THREE.Vector3(lengthW, heightW, widthW / 2)\n        );\n\n        // Move camera target near the center of the truck\n        controls.target.set(lengthW / 2, Math.min(6, heightW / 2), 0);\n      }\n\n      function focusOnWorldPoint(targetWorld, options = {}) {\n        if (!controls || !camera) return;\n        const duration = Number(options.duration) || 700;\n        const nextTarget = targetWorld.clone();\n        const dir = camera.position.clone().sub(controls.target);\n        const nextPos = nextTarget.clone().add(dir);\n        new TWEEN.Tween(controls.target)\n          .to({ x: nextTarget.x, y: nextTarget.y, z: nextTarget.z }, duration)\n          .easing(TWEEN.Easing.Cubic.InOut)\n          .start();\n        new TWEEN.Tween(camera.position)\n          .to({ x: nextPos.x, y: nextPos.y, z: nextPos.z }, duration)\n          .easing(TWEEN.Easing.Cubic.InOut)\n          .start();\n      }\n\n      function getTruckBoundsWorld() {\n        return truckBoundsWorld;\n      }\n\n      function toggleGrid() {\n        if (!grid) return false;\n        grid.visible = !grid.visible;\n        return grid.visible;\n      }\n\n      function toggleShadows() {\n        if (!renderer) return false;\n        renderer.shadowMap.enabled = !renderer.shadowMap.enabled;\n        return renderer.shadowMap.enabled;\n      }\n\n      return {\n        init,\n        resize,\n        refreshTheme,\n        setTruck,\n        focusOnWorldPoint,\n        toggleGrid,\n        toggleShadows,\n        toggleDevOverlay: () => DevOverlay.toggle(),\n        getScene: () => scene,\n        getCamera: () => camera,\n        getRenderer: () => renderer,\n        getControls: () => controls,\n        getTruckBoundsWorld,\n        toWorld,\n        toInches,\n        vecInchesToWorld,\n        vecWorldToInches,\n        getPerf: () => ({ ...perf }),\n      };\n    })();\n\n    const CaseScene = (() => {\n      const instances = new Map(); // instanceId -> THREE.Group\n      let hoveredId = null;\n      let draggedId = null;\n      let selectedIds = new Set();\n\n      function clear() {\n        const scene = SceneManager.getScene();\n        if (!scene) return;\n        instances.forEach(group => disposeGroup(scene, group));\n        instances.clear();\n        hoveredId = null;\n        draggedId = null;\n        selectedIds = new Set();\n      }\n\n      function sync(pack) {\n        const scene = SceneManager.getScene();\n        if (!scene) return;\n        if (!pack) {\n          clear();\n          return;\n        }\n\n        const keep = new Set();\n        (pack.cases || []).forEach(inst => {\n          keep.add(inst.id);\n          const caseData = CaseLibrary.getById(inst.caseId);\n          if (!caseData) return;\n\n          const signature = buildSignature(inst, caseData);\n          const existing = instances.get(inst.id);\n          if (!existing || existing.userData.signature !== signature) {\n            if (existing) disposeGroup(scene, existing);\n            const group = createInstanceGroup(inst, caseData);\n            instances.set(inst.id, group);\n            scene.add(group);\n          }\n\n          const group = instances.get(inst.id);\n          applyTransform(group, inst);\n          applyHidden(group, inst.hidden);\n        });\n\n        // Remove old\n        Array.from(instances.keys()).forEach(id => {\n          if (keep.has(id)) return;\n          disposeGroup(scene, instances.get(id));\n          instances.delete(id);\n        });\n\n        applySelection(Array.from(selectedIds));\n        applyHover(hoveredId);\n        applyDragging(draggedId);\n      }\n\n      function buildSignature(inst, caseData) {\n        const d = caseData.dimensions || { length: 0, width: 0, height: 0 };\n        const color = String(caseData.color || CategoryService.meta(caseData.category).color || '#ff9f1c');\n        return `${caseData.id}:${d.length}x${d.width}x${d.height}:${color}`;\n      }\n\n      function createInstanceGroup(inst, caseData) {\n        const group = new THREE.Group();\n        group.userData.instanceId = inst.id;\n        group.userData.caseId = inst.caseId;\n        group.userData.signature = buildSignature(inst, caseData);\n\n        const dims = caseData.dimensions || { length: 1, width: 1, height: 1 };\n        const lengthW = SceneManager.toWorld(dims.length);\n        const widthW = SceneManager.toWorld(dims.width);\n        const heightW = SceneManager.toWorld(dims.height);\n        group.userData.halfWorld = { x: lengthW / 2, y: heightW / 2, z: widthW / 2 };\n\n        const baseColor = String(caseData.color || CategoryService.meta(caseData.category).color || '#ff9f1c');\n        group.userData.baseColor = baseColor;\n\n        const geo = new THREE.BoxGeometry(lengthW, heightW, widthW);\n        const mat = new THREE.MeshStandardMaterial({\n          color: new THREE.Color(baseColor),\n          roughness: 0.65,\n          metalness: 0.12,\n          emissive: new THREE.Color(0x000000),\n        });\n        const mesh = new THREE.Mesh(geo, mat);\n        mesh.castShadow = true;\n        mesh.receiveShadow = true;\n        mesh.userData.instanceId = inst.id;\n        group.userData.mesh = mesh;\n        group.add(mesh);\n\n        const edges = new THREE.EdgesGeometry(geo);\n        const edgeColor = new THREE.Color(baseColor);\n        edgeColor.multiplyScalar(0.68);\n        const lineMat = new THREE.LineBasicMaterial({ color: edgeColor, transparent: true, opacity: 0.95 });\n        const lines = new THREE.LineSegments(edges, lineMat);\n        group.userData.lines = lines;\n        group.add(lines);\n\n        return group;\n      }\n\n      function disposeGroup(scene, group) {\n        if (!group) return;\n        scene.remove(group);\n        group.traverse(obj => {\n          if (obj.geometry) obj.geometry.dispose();\n          if (obj.material) obj.material.dispose();\n        });\n      }\n\n      function applyTransform(group, inst) {\n        if (!group || !inst || !inst.transform) return;\n        const pos = inst.transform.position || { x: 0, y: 0, z: 0 };\n        const rot = inst.transform.rotation || { x: 0, y: 0, z: 0 };\n        group.position.copy(SceneManager.vecInchesToWorld(pos));\n        group.rotation.set(Number(rot.x) || 0, Number(rot.y) || 0, Number(rot.z) || 0);\n      }\n\n      function applyHidden(group, hidden) {\n        if (!group || !group.userData.mesh) return;\n        const prefs = PreferencesManager.get();\n        const mesh = group.userData.mesh;\n        const lines = group.userData.lines;\n        if (hidden) {\n          mesh.material.transparent = true;\n          mesh.material.opacity = Utils.clamp(Number(prefs.hiddenCaseOpacity) || 0.3, 0, 1);\n          mesh.material.depthWrite = false;\n          if (lines && lines.material) {\n            lines.material.transparent = true;\n            lines.material.opacity = Math.max(0.25, mesh.material.opacity);\n          }\n        } else {\n          mesh.material.transparent = false;\n          mesh.material.opacity = 1;\n          mesh.material.depthWrite = true;\n          if (lines && lines.material) {\n            lines.material.transparent = true;\n            lines.material.opacity = 0.95;\n          }\n        }\n      }\n\n      function applySelection(ids) {\n        selectedIds = new Set(ids || []);\n        instances.forEach(group => {\n          const mesh = group.userData.mesh;\n          if (!mesh || !mesh.material) return;\n          const isSelected = selectedIds.has(group.userData.instanceId);\n          mesh.material.emissive.setHex(isSelected ? Utils.cssHexToInt(Utils.getCssVar('--accent-primary')) : 0x000000);\n        });\n      }\n\n      function applyHover(instanceId) {\n        hoveredId = instanceId || null;\n        instances.forEach(group => {\n          const mesh = group.userData.mesh;\n          if (!mesh || !mesh.material) return;\n          if (\n            group.userData.instanceId === hoveredId &&\n            !selectedIds.has(hoveredId) &&\n            group.userData.instanceId !== draggedId\n          ) {\n            mesh.material.emissive.setHex(0x333333);\n          } else if (!selectedIds.has(group.userData.instanceId) && group.userData.instanceId !== draggedId) {\n            mesh.material.emissive.setHex(0x000000);\n          }\n        });\n      }\n\n      function applyDragging(instanceId) {\n        draggedId = instanceId || null;\n        instances.forEach(group => {\n          const mesh = group.userData.mesh;\n          if (!mesh || !mesh.material) return;\n          if (group.userData.instanceId === draggedId) {\n            mesh.material.transparent = true;\n            mesh.material.opacity = 0.72;\n            mesh.material.emissive.setHex(0x111111);\n          }\n        });\n      }\n\n      function setCollision(instanceId, isCollision) {\n        const group = instances.get(instanceId);\n        if (!group || !group.userData.mesh) return;\n        const mesh = group.userData.mesh;\n        if (isCollision) {mesh.material.emissive.setHex(0xff0000);}\n        else if (selectedIds.has(instanceId))\n          {mesh.material.emissive.setHex(Utils.cssHexToInt(Utils.getCssVar('--accent-primary')));}\n        else {mesh.material.emissive.setHex(0x000000);}\n      }\n\n      function setHover(instanceId) {\n        applyHover(instanceId);\n      }\n\n      function setSelected(instanceIds) {\n        applySelection(instanceIds);\n        applyHover(hoveredId);\n      }\n\n      function setDragging(instanceId) {\n        applyDragging(instanceId);\n        applyHover(hoveredId);\n        applySelection(Array.from(selectedIds));\n      }\n\n      function getObject(instanceId) {\n        return instances.get(instanceId) || null;\n      }\n\n      function getRaycastMeshes() {\n        const meshes = [];\n        instances.forEach(group => {\n          if (group.userData.mesh) meshes.push(group.userData.mesh);\n        });\n        return meshes;\n      }\n\n      function getAabbWorld(instanceId, positionOverrideWorld) {\n        const group = instances.get(instanceId);\n        if (!group) return null;\n        const half = group.userData.halfWorld;\n        if (!half) return null;\n        const p = positionOverrideWorld || group.position;\n        return {\n          min: { x: p.x - half.x, y: p.y - half.y, z: p.z - half.z },\n          max: { x: p.x + half.x, y: p.y + half.y, z: p.z + half.z },\n        };\n      }\n\n      function aabbIntersects(a, b) {\n        const EPS = 1e-6;\n        return (\n          a.min.x < b.max.x - EPS &&\n          a.max.x > b.min.x + EPS &&\n          a.min.y < b.max.y - EPS &&\n          a.max.y > b.min.y + EPS &&\n          a.min.z < b.max.z - EPS &&\n          a.max.z > b.min.z + EPS\n        );\n      }\n\n      function isInsideTruck(aabb) {\n        const bounds = SceneManager.getTruckBoundsWorld();\n        if (!bounds) return false;\n        return (\n          aabb.min.x >= bounds.min.x &&\n          aabb.max.x <= bounds.max.x &&\n          aabb.min.y >= bounds.min.y &&\n          aabb.max.y <= bounds.max.y &&\n          aabb.min.z >= bounds.min.z &&\n          aabb.max.z <= bounds.max.z\n        );\n      }\n\n      function checkCollision(instanceId, candidateWorldPos) {\n        const aabb = getAabbWorld(instanceId, candidateWorldPos);\n        if (!aabb) return { collides: false, insideTruck: false };\n        const insideTruck = isInsideTruck(aabb);\n        for (const [otherId] of instances.entries()) {\n          if (otherId === instanceId) continue;\n          const otherAabb = getAabbWorld(otherId);\n          if (!otherAabb) continue;\n          if (aabbIntersects(aabb, otherAabb)) return { collides: true, insideTruck };\n        }\n        return { collides: false, insideTruck };\n      }\n\n      return {\n        clear,\n        sync,\n        setHover,\n        setSelected,\n        setDragging,\n        setCollision,\n        getObject,\n        getRaycastMeshes,\n        getAabbWorld,\n        checkCollision,\n        isInsideTruck,\n      };\n    })();\n\n    const InteractionManager = (() => {\n      const raycaster = new THREE.Raycaster();\n      const pointer = new THREE.Vector2();\n      const dragPlane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);\n      const dragOffset = new THREE.Vector3();\n      const tmpVec3 = new THREE.Vector3();\n\n      let domEl = null;\n      let hoveredId = null;\n      let pressed = null;\n      let draggingId = null;\n      let dragStartPosWorld = null;\n      let lastRaycastTime = 0;\n      const RAYCAST_THROTTLE = 50; // ms - throttle hover raycasts\n\n      function init(canvasEl) {\n        domEl = canvasEl;\n        domEl.style.touchAction = 'none';\n        domEl.addEventListener('pointermove', onMove);\n        domEl.addEventListener('pointerdown', onDown);\n        window.addEventListener('pointerup', onUp);\n        domEl.addEventListener('dblclick', onDblClick);\n      }\n\n      function onMove(ev) {\n        if (!isEditorActive()) return;\n        updatePointer(ev);\n\n        if (pressed && !draggingId) {\n          const dx = ev.clientX - pressed.clientX;\n          const dy = ev.clientY - pressed.clientY;\n          if (Math.hypot(dx, dy) > 3) startDrag();\n        }\n\n        if (draggingId) {\n          updateDrag();\n          return;\n        }\n\n        // Throttle hover raycasts to avoid performance hits\n        const now = performance.now();\n        if (now - lastRaycastTime < RAYCAST_THROTTLE) return;\n        lastRaycastTime = now;\n\n        const hit = raycastFirst();\n        const nextHover = hit ? hit.instanceId : null;\n        if (nextHover !== hoveredId) {\n          hoveredId = nextHover;\n          CaseScene.setHover(hoveredId);\n          domEl.style.cursor = hoveredId ? 'grab' : 'default';\n        }\n      }\n\n      function onDown(ev) {\n        if (!isEditorActive()) return;\n        if (ev.button !== 0) return;\n        updatePointer(ev);\n        const hit = raycastFirst();\n\n        if (hit) {\n          const instanceId = hit.instanceId;\n          pressed = {\n            instanceId,\n            pointWorld: hit.pointWorld.clone(),\n            clientX: ev.clientX,\n            clientY: ev.clientY,\n            shift: Boolean(ev.shiftKey),\n          };\n          domEl.setPointerCapture(ev.pointerId);\n          domEl.style.cursor = 'grabbing';\n        } else {\n          pressed = {\n            instanceId: null,\n            clientX: ev.clientX,\n            clientY: ev.clientY,\n            shift: Boolean(ev.shiftKey),\n          };\n        }\n      }\n\n      function onUp() {\n        if (!isEditorActive()) return;\n        if (!pressed && !draggingId) return;\n\n        if (draggingId) {\n          finishDrag();\n          return;\n        }\n\n        // Click selection\n        if (!pressed.instanceId) {\n          if (!pressed.shift) setSelection([]);\n          pressed = null;\n          return;\n        }\n        const current = getSelection();\n        const id = pressed.instanceId;\n        if (pressed.shift) {\n          if (current.includes(id)) setSelection(current.filter(x => x !== id));\n          else setSelection([...current, id]);\n        } else {\n          setSelection([id]);\n        }\n        pressed = null;\n      }\n\n      function onDblClick(ev) {\n        if (!isEditorActive()) return;\n        updatePointer(ev);\n        const hit = raycastFirst();\n        if (!hit) return;\n        SceneManager.focusOnWorldPoint(hit.pointWorld, { duration: 700 });\n      }\n\n      function startDrag() {\n        if (!pressed || !pressed.instanceId) return;\n        draggingId = pressed.instanceId;\n        dragStartPosWorld = CaseScene.getObject(draggingId).position.clone();\n\n        // Ensure selected\n        const current = getSelection();\n        if (!current.includes(draggingId)) {\n          if (pressed.shift) setSelection([...current, draggingId]);\n          else setSelection([draggingId]);\n        }\n\n        const controls = SceneManager.getControls();\n        if (controls) controls.enabled = false;\n\n        dragPlane.set(new THREE.Vector3(0, 1, 0), -dragStartPosWorld.y);\n        dragOffset.copy(CaseScene.getObject(draggingId).position).sub(pressed.pointWorld);\n\n        CaseScene.setDragging(draggingId);\n      }\n\n      function updateDrag() {\n        const camera = SceneManager.getCamera();\n        if (!camera) return;\n        raycaster.setFromCamera(pointer, camera);\n        const intersection = tmpVec3;\n        const ok = raycaster.ray.intersectPlane(dragPlane, intersection);\n        if (!ok) return;\n\n        const next = intersection.clone().add(dragOffset);\n\n        // Snap (X/Z) when enabled\n        const prefs = PreferencesManager.get();\n        if (prefs.snapping && prefs.snapping.enabled) {\n          const gridIn = Math.max(0.25, Number(prefs.snapping.gridSize) || 1);\n          const gridW = SceneManager.toWorld(gridIn);\n          next.x = Math.round(next.x / gridW) * gridW;\n          next.z = Math.round(next.z / gridW) * gridW;\n        }\n\n        const check = CaseScene.checkCollision(draggingId, next);\n        CaseScene.setCollision(draggingId, check.collides);\n\n        const obj = CaseScene.getObject(draggingId);\n        if (obj) obj.position.copy(next);\n      }\n\n      function finishDrag() {\n        const instanceId = draggingId;\n        const obj = CaseScene.getObject(instanceId);\n        if (!obj) {\n          resetDrag();\n          return;\n        }\n\n        const check = CaseScene.checkCollision(instanceId, obj.position);\n        if (check.collides) {\n          new TWEEN.Tween(obj.position)\n            .to({ x: dragStartPosWorld.x, y: dragStartPosWorld.y, z: dragStartPosWorld.z }, 240)\n            .easing(TWEEN.Easing.Cubic.Out)\n            .onComplete(() => {\n              CaseScene.setCollision(instanceId, false);\n              CaseScene.setDragging(null);\n              CaseScene.setHover(hoveredId);\n            })\n            .start();\n          UIComponents.showToast('Cannot place here: collision detected', 'error');\n          resetDrag();\n          return;\n        }\n\n        const packId = StateStore.get('currentPackId');\n        const pack = PackLibrary.getById(packId);\n        if (!pack) {\n          resetDrag();\n          return;\n        }\n        const inst = (pack.cases || []).find(i => i.id === instanceId);\n        if (!inst) {\n          resetDrag();\n          return;\n        }\n\n        const posInches = SceneManager.vecWorldToInches(obj.position);\n        PackLibrary.updateInstance(packId, instanceId, {\n          transform: { ...inst.transform, position: posInches },\n        });\n\n        UIComponents.showToast(\n          check.insideTruck ? 'Case placed' : 'Placed in staging (outside truck)',\n          check.insideTruck ? 'success' : 'info'\n        );\n        resetDrag();\n      }\n\n      function resetDrag() {\n        const controls = SceneManager.getControls();\n        if (controls) controls.enabled = true;\n        draggingId = null;\n        dragStartPosWorld = null;\n        pressed = null;\n        domEl.style.cursor = hoveredId ? 'grab' : 'default';\n        CaseScene.setDragging(null);\n      }\n\n      function updatePointer(ev) {\n        if (!domEl) return;\n        const rect = domEl.getBoundingClientRect();\n        pointer.x = ((ev.clientX - rect.left) / rect.width) * 2 - 1;\n        pointer.y = -((ev.clientY - rect.top) / rect.height) * 2 + 1;\n      }\n\n      function raycastFirst() {\n        const camera = SceneManager.getCamera();\n        if (!camera) return null;\n        raycaster.setFromCamera(pointer, camera);\n        const meshes = CaseScene.getRaycastMeshes();\n        const hits = raycaster.intersectObjects(meshes, false);\n        if (!hits.length) return null;\n        const hit = hits[0];\n        const instanceId = hit.object && hit.object.userData ? hit.object.userData.instanceId : null;\n        if (!instanceId) return null;\n        return { instanceId, pointWorld: hit.point.clone() };\n      }\n\n      function isEditorActive() {\n        return StateStore.get('currentScreen') === 'editor';\n      }\n\n      function getSelection() {\n        return StateStore.get('selectedInstanceIds') || [];\n      }\n\n      function setSelection(nextIds) {\n        StateStore.set({ selectedInstanceIds: nextIds }, { skipHistory: true });\n        CaseScene.setSelected(nextIds);\n      }\n\n      function selectAllInPack() {\n        const pack = PackLibrary.getById(StateStore.get('currentPackId'));\n        if (!pack) return;\n        setSelection((pack.cases || []).map(i => i.id));\n        UIComponents.showToast(`Selected ${(pack.cases || []).length} case(s)`, 'info');\n      }\n\n      function deleteSelection() {\n        const ids = getSelection();\n        if (!ids.length) return;\n        const packId = StateStore.get('currentPackId');\n        PackLibrary.removeInstances(packId, ids);\n        setSelection([]);\n        UIComponents.showToast(`Deleted ${ids.length} case(s)`, 'info');\n      }\n\n      return { init, setSelection, selectAllInPack, deleteSelection };\n    })();\n\n    const AutoPackEngine = (() => {\n      let isRunning = false;\n\n      /**\n       * MVP AutoPack: First-Fit Decreasing in 3D (no rotation).\n       * - Sort by volume (largest first)\n       * - Place into the first available space\n       * - Subdivide remaining space into candidate regions\n       */\n      async function pack() {\n        if (isRunning) return;\n        const packId = StateStore.get('currentPackId');\n        const packData = PackLibrary.getById(packId);\n        if (!packData) {\n          UIComponents.showToast('Open a pack first', 'warning');\n          return;\n        }\n        if (!(packData.cases || []).length) {\n          UIComponents.showToast('No cases to pack', 'warning');\n          return;\n        }\n\n        isRunning = true;\n        UIComponents.showToast('AutoPack starting…', 'info', { title: 'AutoPack', duration: 1800 });\n\n        const truck = packData.truck;\n        const packItems = (packData.cases || [])\n          .filter(inst => !inst.hidden)\n          .map(inst => {\n            const c = CaseLibrary.getById(inst.caseId);\n            if (!c) return null;\n            const vol = c.volume || Utils.volumeInCubicInches(c.dimensions);\n            return { inst, caseData: c, volume: vol };\n          })\n          .filter(Boolean)\n          .sort((a, b) => b.volume - a.volume);\n\n        // Step 1: move to staging (visual clarity)\n        const stagingMap = buildStagingMap(packItems, truck);\n        await stage(stagingMap);\n\n        // Step 2: compute packing\n        const spaces = [\n          {\n            x: 0,\n            y: 0,\n            z: -truck.width / 2,\n            length: truck.length,\n            width: truck.width,\n            height: truck.height,\n          },\n        ];\n\n        const placements = new Map(); // instanceId -> position inches\n        const packed = [];\n        const unpacked = [];\n\n        for (const item of packItems) {\n          const dims = item.caseData.dimensions;\n          let placed = false;\n          for (let i = 0; i < spaces.length; i++) {\n            const s = spaces[i];\n            if (dims.length <= s.length && dims.width <= s.width && dims.height <= s.height) {\n              const pos = {\n                x: s.x + dims.length / 2,\n                y: s.y + dims.height / 2,\n                z: s.z + dims.width / 2,\n              };\n              if (!hasPackingCollision(pos, dims, packed)) {\n                placements.set(item.inst.id, pos);\n                packed.push({ position: pos, dimensions: dims });\n                const nextSpaces = subdivideSpace(s, dims);\n                spaces.splice(i, 1, ...nextSpaces);\n                spaces.sort((a, b) => b.length * b.width * b.height - a.length * a.width * a.height);\n                placed = true;\n                break;\n              }\n            }\n          }\n          if (!placed) unpacked.push(item.inst.id);\n        }\n\n        // Step 3: animate to placements\n        await animatePlacements(placements);\n\n        // Step 4: persist to state (single update)\n        const nextCases = (packData.cases || []).map(inst => {\n          if (inst.hidden) return inst;\n          const p = placements.get(inst.id) || stagingMap.get(inst.id);\n          if (!p) return inst;\n          return { ...inst, transform: { ...inst.transform, position: p }, hidden: false };\n        });\n        PackLibrary.update(packId, { cases: nextCases });\n\n        const stats = PackLibrary.computeStats(PackLibrary.getById(packId));\n        const totalPackable = (packData.cases || []).filter(i => !i.hidden).length;\n        UIComponents.showToast(\n          `Packed ${stats.packedCases} of ${totalPackable} (${stats.volumePercent.toFixed(1)}%)`,\n          stats.packedCases === totalPackable ? 'success' : 'warning',\n          { title: 'AutoPack' }\n        );\n        if (unpacked.length)\n          {UIComponents.showToast(`${unpacked.length} case(s) could not fit`, 'warning', { title: 'AutoPack' });}\n\n        isRunning = false;\n      }\n\n      function buildStagingMap(packItems, truck) {\n        const baseX = -Math.max(60, truck.length * 0.12);\n        const spacing = 28;\n        const map = new Map();\n        packItems.forEach((item, idx) => {\n          const row = Math.floor(idx / 5);\n          const col = idx % 5;\n          const y = Math.max(\n            1,\n            item.caseData.dimensions && item.caseData.dimensions.height ? item.caseData.dimensions.height / 2 : 1\n          );\n          map.set(item.inst.id, { x: baseX - col * spacing, y, z: (row - 2) * spacing });\n        });\n        return map;\n      }\n\n      async function stage(stagingMap) {\n        const targets = Array.from(stagingMap.entries()).map(([id, pos]) => ({ id, pos }));\n        await Promise.all(targets.map(t => tweenInstanceToPosition(t.id, t.pos, 260)));\n      }\n\n      function hasPackingCollision(position, dims, packed) {\n        const EPS = 1e-6;\n        const box = {\n          min: {\n            x: position.x - dims.length / 2,\n            y: position.y - dims.height / 2,\n            z: position.z - dims.width / 2,\n          },\n          max: {\n            x: position.x + dims.length / 2,\n            y: position.y + dims.height / 2,\n            z: position.z + dims.width / 2,\n          },\n        };\n        for (const p of packed) {\n          const other = {\n            min: {\n              x: p.position.x - p.dimensions.length / 2,\n              y: p.position.y - p.dimensions.height / 2,\n              z: p.position.z - p.dimensions.width / 2,\n            },\n            max: {\n              x: p.position.x + p.dimensions.length / 2,\n              y: p.position.y + p.dimensions.height / 2,\n              z: p.position.z + p.dimensions.width / 2,\n            },\n          };\n          if (\n            box.min.x < other.max.x - EPS &&\n            box.max.x > other.min.x + EPS &&\n            box.min.y < other.max.y - EPS &&\n            box.max.y > other.min.y + EPS &&\n            box.min.z < other.max.z - EPS &&\n            box.max.z > other.min.z + EPS\n          )\n            {return true;}\n        }\n        return false;\n      }\n\n      function subdivideSpace(space, dims) {\n        const out = [];\n        const minVol = 10;\n\n        // Right (X+)\n        const rightLen = space.length - dims.length;\n        if (rightLen > 0)\n          {out.push({\n            x: space.x + dims.length,\n            y: space.y,\n            z: space.z,\n            length: rightLen,\n            width: space.width,\n            height: space.height,\n          });}\n\n        // Top (Y+)\n        const topH = space.height - dims.height;\n        if (topH > 0)\n          {out.push({\n            x: space.x,\n            y: space.y + dims.height,\n            z: space.z,\n            length: dims.length,\n            width: dims.width,\n            height: topH,\n          });}\n\n        // Back (Z+)\n        const backW = space.width - dims.width;\n        if (backW > 0)\n          {out.push({\n            x: space.x,\n            y: space.y,\n            z: space.z + dims.width,\n            length: dims.length,\n            width: backW,\n            height: dims.height,\n          });}\n\n        return out.filter(s => s.length * s.width * s.height > minVol);\n      }\n\n      async function animatePlacements(placements) {\n        for (const [id, pos] of placements.entries()) {\n          await tweenInstanceToPosition(id, pos, 240);\n          await sleep(35);\n        }\n      }\n\n      function tweenInstanceToPosition(instanceId, positionInches, duration) {\n        const obj = CaseScene.getObject(instanceId);\n        if (!obj) return Promise.resolve();\n        const target = SceneManager.vecInchesToWorld(positionInches);\n        return new Promise(resolve => {\n          new TWEEN.Tween(obj.position)\n            .to({ x: target.x, y: target.y, z: target.z }, duration)\n            .easing(TWEEN.Easing.Cubic.InOut)\n            .onComplete(resolve)\n            .start();\n        });\n      }\n\n      function sleep(ms) {\n        return new Promise(r => setTimeout(r, ms));\n      }\n\n      return {\n        pack,\n        get running() {\n          return isRunning;\n        },\n      };\n    })();\n\n    const ExportService = (() => {\n      function captureScreenshot() {\n        try {\n          const pack = getCurrentPack();\n          if (!pack) {\n            UIComponents.showToast('Open a pack first', 'warning', { title: 'Export' });\n            return;\n          }\n          const prefs = PreferencesManager.get();\n          const res = Utils.parseResolution(prefs.export && prefs.export.screenshotResolution);\n          const dataUrl = renderCameraToDataUrl(SceneManager.getCamera(), res.width, res.height, {\n            mimeType: 'image/png',\n            hideGrid: true,\n          });\n          downloadDataUrl(dataUrl, `truck-pack-${safeName(pack.title)}-${Date.now()}.png`);\n          UIComponents.showToast('Screenshot saved', 'success', { title: 'Export' });\n        } catch (err) {\n          console.error(err);\n          UIComponents.showToast('Screenshot failed: ' + err.message, 'error', { title: 'Export' });\n        }\n      }\n\n      function generatePDF() {\n        try {\n          if (!window.jspdf || !window.jspdf.jsPDF) throw new Error('jsPDF not available');\n          const pack = getCurrentPack();\n          if (!pack) {\n            UIComponents.showToast('Open a pack first', 'warning', { title: 'Export' });\n            return;\n          }\n\n          const prefs = PreferencesManager.get();\n          const { jsPDF } = window.jspdf;\n          const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });\n\n          const pageWidth = doc.internal.pageSize.getWidth();\n          const pageHeight = doc.internal.pageSize.getHeight();\n          const margin = 40;\n          let y = margin;\n\n          // Header\n          doc.setFontSize(22);\n          doc.setFont('helvetica', 'bold');\n          doc.text(pack.title || 'Pack', margin, y);\n          y += 22;\n\n          doc.setFontSize(10);\n          doc.setFont('helvetica', 'normal');\n          doc.text(`Generated: ${new Date().toLocaleString()}`, margin, y);\n          y += 16;\n\n          const details = [\n            pack.client ? `Client: ${pack.client}` : null,\n            pack.projectName ? `Project: ${pack.projectName}` : null,\n            pack.drawnBy ? `Drawn by: ${pack.drawnBy}` : null,\n          ].filter(Boolean);\n          details.forEach(line => {\n            doc.text(line, margin, y);\n            y += 14;\n          });\n          if (details.length) y += 8;\n\n          // Notes\n          if (pack.notes) {\n            doc.setFont('helvetica', 'bold');\n            doc.text('NOTES', margin, y);\n            y += 14;\n            doc.setFont('helvetica', 'normal');\n            const lines = doc.splitTextToSize(pack.notes, pageWidth - margin * 2);\n            doc.text(lines, margin, y);\n            y += lines.length * 12 + 10;\n          }\n\n          // Views\n          const viewWPt = pageWidth - margin * 2;\n          const viewWpx = 960;\n          const viewHpx = 540;\n          const perspective = renderCameraToDataUrl(SceneManager.getCamera(), viewWpx, viewHpx, {\n            mimeType: 'image/jpeg',\n            quality: 0.92,\n            hideGrid: true,\n          });\n\n          const { topCam, sideCam } = buildOrthoCameras(pack);\n          const topView = renderCameraToDataUrl(topCam, 960, 520, {\n            mimeType: 'image/jpeg',\n            quality: 0.9,\n            hideGrid: true,\n          });\n          const sideView = renderCameraToDataUrl(sideCam, 960, 420, {\n            mimeType: 'image/jpeg',\n            quality: 0.9,\n            hideGrid: true,\n          });\n\n          doc.setFont('helvetica', 'bold');\n          doc.setFontSize(12);\n          doc.text('PERSPECTIVE VIEW', margin, y);\n          y += 10;\n          y += 6;\n          const pvH = viewWPt * (viewHpx / viewWpx);\n          doc.addImage(perspective, 'JPEG', margin, y, viewWPt, pvH);\n          y += pvH + 16;\n\n          if (y + 220 > pageHeight - margin) {\n            doc.addPage();\n            y = margin;\n          }\n\n          doc.text('TOP VIEW', margin, y);\n          y += 10;\n          y += 6;\n          const tvH = viewWPt * (520 / 960);\n          doc.addImage(topView, 'JPEG', margin, y, viewWPt, tvH);\n          y += tvH + 16;\n\n          if (y + 200 > pageHeight - margin) {\n            doc.addPage();\n            y = margin;\n          }\n\n          doc.text('SIDE VIEW', margin, y);\n          y += 10;\n          y += 6;\n          const svH = viewWPt * (420 / 960);\n          doc.addImage(sideView, 'JPEG', margin, y, viewWPt, svH);\n\n          // Checklist page\n          doc.addPage();\n          y = margin;\n\n          doc.setFont('helvetica', 'bold');\n          doc.setFontSize(16);\n          doc.text('CASE CHECKLIST', margin, y);\n          y += 22;\n\n          const entries = buildChecklist(pack);\n\n          doc.setFontSize(9);\n          doc.setFont('helvetica', 'bold');\n          const x0 = margin;\n          const x1 = margin + 24;\n          const x2 = margin + 260;\n          const x3 = margin + 360;\n          const x4 = margin + 470;\n          doc.text('#', x0, y);\n          doc.text('Name', x1, y);\n          doc.text('Category', x2, y);\n          doc.text('Dims', x3, y);\n          doc.text('Weight', x4, y);\n          y += 8;\n          doc.line(margin, y, pageWidth - margin, y);\n          y += 14;\n\n          doc.setFont('helvetica', 'normal');\n          entries.forEach((e, idx) => {\n            if (y > pageHeight - margin) {\n              doc.addPage();\n              y = margin;\n              doc.setFont('helvetica', 'bold');\n              doc.text('#', x0, y);\n              doc.text('Name', x1, y);\n              doc.text('Category', x2, y);\n              doc.text('Dims', x3, y);\n              doc.text('Weight', x4, y);\n              y += 8;\n              doc.line(margin, y, pageWidth - margin, y);\n              y += 14;\n              doc.setFont('helvetica', 'normal');\n            }\n\n            const lineHeight = 14;\n            doc.text(String(idx + 1), x0, y);\n            doc.text(e.name, x1, y);\n            doc.text(e.category, x2, y);\n            doc.text(e.dims, x3, y);\n            doc.text(e.weight, x4, y);\n            y += lineHeight;\n          });\n\n          // Summary\n          const includeStats = Boolean(prefs.export && prefs.export.pdfIncludeStats);\n          if (includeStats) {\n            const stats = PackLibrary.computeStats(pack);\n            if (y + 90 > pageHeight - margin) {\n              doc.addPage();\n              y = margin;\n            } else {\n              y += 16;\n            }\n            doc.setFont('helvetica', 'bold');\n            doc.setFontSize(12);\n            doc.text('SUMMARY', margin, y);\n            y += 16;\n            doc.setFont('helvetica', 'normal');\n            doc.setFontSize(10);\n            doc.text(`Cases loaded: ${stats.totalCases}`, margin, y);\n            y += 14;\n            doc.text(`Packed (in truck): ${stats.packedCases}`, margin, y);\n            y += 14;\n            doc.text(`Volume used: ${stats.volumePercent.toFixed(1)}%`, margin, y);\n            y += 14;\n            doc.text(`Total weight: ${Utils.formatWeight(stats.totalWeight, prefs.units.weight)}`, margin, y);\n            y += 14;\n            doc.text(`Truck (in): ${pack.truck.length}×${pack.truck.width}×${pack.truck.height}`, margin, y);\n          }\n\n          doc.save(`${safeName(pack.title)}-plan.pdf`);\n          UIComponents.showToast('PDF exported', 'success', { title: 'Export' });\n        } catch (err) {\n          console.error(err);\n          UIComponents.showToast('PDF export failed: ' + err.message, 'error', { title: 'Export' });\n        }\n      }\n\n      function getCurrentPack() {\n        const packId = StateStore.get('currentPackId');\n        return packId ? PackLibrary.getById(packId) : null;\n      }\n\n      function safeName(name) {\n        return (\n          String(name || 'pack')\n            .trim()\n            .toLowerCase()\n            .replace(/[^a-z0-9]+/g, '-')\n            .replace(/^-+|-+$/g, '') || 'pack'\n        );\n      }\n\n      function downloadDataUrl(dataUrl, filename) {\n        const link = document.createElement('a');\n        link.href = dataUrl;\n        link.download = filename;\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n      }\n\n      function buildOrthoCameras(pack) {\n        const lengthW = SceneManager.toWorld(pack.truck.length);\n        const widthW = SceneManager.toWorld(pack.truck.width);\n        const heightW = SceneManager.toWorld(pack.truck.height);\n        const centerX = lengthW / 2;\n        const centerY = heightW / 2;\n        const margin = 3;\n\n        const topCam = new THREE.OrthographicCamera(\n          -(lengthW / 2 + margin),\n          lengthW / 2 + margin,\n          widthW / 2 + margin,\n          -(widthW / 2 + margin),\n          0.1,\n          2000\n        );\n        topCam.position.set(centerX, heightW + 40, 0);\n        topCam.up.set(0, 0, -1);\n        topCam.lookAt(centerX, 0, 0);\n        topCam.updateProjectionMatrix();\n\n        const sideCam = new THREE.OrthographicCamera(\n          -(lengthW / 2 + margin),\n          lengthW / 2 + margin,\n          heightW / 2 + margin,\n          -(heightW / 2 + margin),\n          0.1,\n          2000\n        );\n        sideCam.position.set(centerX, centerY, widthW / 2 + 60);\n        sideCam.lookAt(centerX, centerY, 0);\n        sideCam.updateProjectionMatrix();\n\n        return { topCam, sideCam };\n      }\n\n      function buildChecklist(pack) {\n        const prefs = PreferencesManager.get();\n        const truck = pack.truck;\n        const unitLen = prefs.units.length;\n        const unitWt = prefs.units.weight;\n        return (pack.cases || []).map(inst => {\n          const c = CaseLibrary.getById(inst.caseId);\n          if (!c) return { name: 'Missing case', category: '—', dims: '—', weight: '—' };\n          const meta = CategoryService.meta(c.category);\n          return {\n            name: c.name,\n            category: meta.name,\n            dims: Utils.formatDims(c.dimensions, unitLen),\n            weight: Utils.formatWeight(Number(c.weight) || 0, unitWt),\n            packed: isInsideTruckInstance(inst, c, truck) && !inst.hidden,\n          };\n        });\n      }\n\n      function isInsideTruckInstance(inst, c, truck) {\n        if (!inst || !c || !truck) return false;\n        const dims = c.dimensions || { length: 0, width: 0, height: 0 };\n        const pos = inst.transform && inst.transform.position ? inst.transform.position : { x: 0, y: 0, z: 0 };\n        const half = { x: dims.length / 2, y: dims.height / 2, z: dims.width / 2 };\n        const aabb = {\n          min: { x: pos.x - half.x, y: pos.y - half.y, z: pos.z - half.z },\n          max: { x: pos.x + half.x, y: pos.y + half.y, z: pos.z + half.z },\n        };\n        return (\n          aabb.min.x >= 0 &&\n          aabb.max.x <= truck.length &&\n          aabb.min.y >= 0 &&\n          aabb.max.y <= truck.height &&\n          aabb.min.z >= -truck.width / 2 &&\n          aabb.max.z <= truck.width / 2\n        );\n      }\n\n      function renderCameraToDataUrl(camera, width, height, options = {}) {\n        const renderer = SceneManager.getRenderer();\n        const scene = SceneManager.getScene();\n        if (!renderer || !scene || !camera) throw new Error('3D viewport not ready');\n\n        const mimeType = options.mimeType || 'image/png';\n        const quality = Number.isFinite(options.quality) ? options.quality : 0.92;\n\n        const prevTarget = renderer.getRenderTarget();\n        const prevViewport = new THREE.Vector4();\n        const prevScissor = new THREE.Vector4();\n        renderer.getViewport(prevViewport);\n        renderer.getScissor(prevScissor);\n        const prevScissorTest = renderer.getScissorTest ? renderer.getScissorTest() : false;\n        const prevPixelRatio = renderer.getPixelRatio();\n        const prevBg = scene.background;\n\n        const gridObj = scene.getObjectByName('grid');\n        const prevGridVisible = gridObj ? gridObj.visible : null;\n\n        const prevAspect = camera.isPerspectiveCamera ? camera.aspect : null;\n\n        const rt = new THREE.WebGLRenderTarget(width, height, { format: THREE.RGBAFormat });\n        const pixels = new Uint8Array(width * height * 4);\n\n        try {\n          if (options.hideGrid && gridObj) gridObj.visible = false;\n          renderer.setPixelRatio(1);\n          renderer.setRenderTarget(rt);\n          renderer.setViewport(0, 0, width, height);\n          renderer.setScissorTest(false);\n          if (camera.isPerspectiveCamera) {\n            camera.aspect = width / height;\n            camera.updateProjectionMatrix();\n          }\n          renderer.render(scene, camera);\n          renderer.readRenderTargetPixels(rt, 0, 0, width, height, pixels);\n        } finally {\n          renderer.setRenderTarget(prevTarget);\n          renderer.setPixelRatio(prevPixelRatio);\n          renderer.setViewport(prevViewport.x, prevViewport.y, prevViewport.z, prevViewport.w);\n          renderer.setScissor(prevScissor.x, prevScissor.y, prevScissor.z, prevScissor.w);\n          renderer.setScissorTest(prevScissorTest);\n          scene.background = prevBg;\n          if (gridObj && prevGridVisible != null) gridObj.visible = prevGridVisible;\n          if (camera.isPerspectiveCamera && prevAspect != null) {\n            camera.aspect = prevAspect;\n            camera.updateProjectionMatrix();\n          }\n          rt.dispose();\n        }\n\n        // Flip Y and encode\n        const canvas = document.createElement('canvas');\n        canvas.width = width;\n        canvas.height = height;\n        const ctx = canvas.getContext('2d');\n        const img = ctx.createImageData(width, height);\n        for (let y = 0; y < height; y++) {\n          const src = (height - y - 1) * width * 4;\n          const dst = y * width * 4;\n          img.data.set(pixels.subarray(src, src + width * 4), dst);\n        }\n        ctx.putImageData(img, 0, 0);\n        return canvas.toDataURL(mimeType, quality);\n      }\n\n      return { captureScreenshot, generatePDF };\n    })();\n\n    const EditorUI = (() => {\n      const shellEl = document.querySelector('.editor-shell');\n      const leftEl = document.getElementById('editor-left');\n      const rightEl = document.getElementById('editor-right');\n      const btnLeft = document.getElementById('btn-editor-left');\n      const btnRight = document.getElementById('btn-editor-right');\n      const btnLeftClose = document.getElementById('btn-left-close');\n      const btnRightClose = document.getElementById('btn-right-close');\n      const viewportEl = document.getElementById('viewport');\n      const inspectorEl = document.getElementById('inspector-body');\n      const caseSearchEl = document.getElementById('editor-case-search');\n      const caseChipsEl = document.getElementById('editor-case-chips');\n      const caseListEl = document.getElementById('editor-case-list');\n      const btnAutopack = document.getElementById('btn-autopack');\n      const btnPng = document.getElementById('btn-screenshot');\n      const btnPdf = document.getElementById('btn-pdf');\n\n      let initialized = false;\n      let resizeObserver = null;\n      let resizeQueued = false;\n      const browserCats = new Set();\n\n      function scheduleViewportResize() {\n        if (resizeQueued) return;\n        resizeQueued = true;\n        window.requestAnimationFrame(() => {\n          resizeQueued = false;\n          if (StateStore.get('currentScreen') !== 'editor') return;\n          SceneManager.resize();\n        });\n      }\n\n      function init() {\n        function showUpgradeRequired(featureLabel) {\n          const plan = BillingService.getCurrentPlan();\n          const daysLeft = BillingService.getDaysLeftInTrial();\n          const wrap = document.createElement('div');\n          const p = document.createElement('div');\n          p.className = 'muted';\n          p.style.fontSize = 'var(--text-sm)';\n          p.style.lineHeight = 'var(--leading-relaxed)';\n          p.textContent =\n            `${featureLabel} requires Truck Packer Pro. ` +\n            `Your current plan: ${plan}.` +\n            (daysLeft > 0 ? ` Trial days left: ${daysLeft}.` : '');\n          wrap.appendChild(p);\n          UIComponents.showModal({\n            title: 'Upgrade required',\n            content: wrap,\n            actions: [{ label: 'Close', variant: 'primary' }],\n          });\n        }\n\n        caseSearchEl.addEventListener('input', Utils.debounce(renderCaseBrowser, 250));\n        btnLeft.addEventListener('click', () => togglePanel('left'));\n        btnRight.addEventListener('click', () => togglePanel('right'));\n        btnLeftClose.addEventListener('click', () => setPanelVisible('left', false));\n        btnRightClose.addEventListener('click', () => setPanelVisible('right', false));\n\n        btnAutopack.addEventListener('click', async () => {\n          const session = getSession();\n          if (!canUseFeature('AUTOPACK', session)) {\n            showUpgradeRequired('AutoPack');\n            return;\n          }\n          btnAutopack.disabled = true;\n          try {\n            await AutoPackEngine.pack();\n            render();\n          } finally {\n            btnAutopack.disabled = false;\n          }\n        });\n        btnPng.addEventListener('click', () => ExportService.captureScreenshot());\n        btnPdf.addEventListener('click', () => {\n          const session = getSession();\n          if (!canUseFeature('PDF_EXPORT', session)) {\n            showUpgradeRequired('PDF export');\n            return;\n          }\n          ExportService.generatePDF();\n        });\n\n        window.addEventListener(\n          'resize',\n          Utils.debounce(() => {\n            if (StateStore.get('currentScreen') === 'editor') SceneManager.resize();\n          }, 120)\n        );\n      }\n\n      function ensureScene() {\n        if (initialized) return;\n        SceneManager.init(viewportEl);\n        InteractionManager.init(SceneManager.getRenderer().domElement);\n        wireDropToViewport(SceneManager.getRenderer().domElement);\n\n        if (!resizeObserver && 'ResizeObserver' in window) {\n          resizeObserver = new ResizeObserver(() => scheduleViewportResize());\n          resizeObserver.observe(viewportEl);\n        }\n        scheduleViewportResize();\n        initialized = true;\n      }\n\n      function render() {\n        if (StateStore.get('currentScreen') !== 'editor') return;\n        ensureScene();\n\n        const packId = StateStore.get('currentPackId');\n        const pack = PackLibrary.getById(packId);\n\n        btnAutopack.disabled = !pack || AutoPackEngine.running;\n        btnPng.disabled = !pack;\n        btnPdf.disabled = !pack;\n\n        if (!pack) {\n          SceneManager.setTruck({ length: 636, width: 102, height: 98 });\n          CaseScene.sync(null);\n          renderCaseBrowser();\n          renderInspectorNoPack();\n          SceneManager.resize();\n          return;\n        }\n\n        SceneManager.setTruck(pack.truck);\n        CaseScene.sync(pack);\n        CaseScene.setSelected(StateStore.get('selectedInstanceIds') || []);\n\n        renderCaseBrowser();\n        renderInspector(pack);\n        SceneManager.resize();\n      }\n\n      function renderCaseBrowser() {\n        const q = String(caseSearchEl.value || '').trim();\n        const cases = CaseLibrary.search(q, Array.from(browserCats)).sort((a, b) =>\n          (a.name || '').localeCompare(b.name || '')\n        );\n        const counts = CategoryService.listWithCounts(CaseLibrary.getCases());\n\n        caseChipsEl.innerHTML = '';\n        caseChipsEl.appendChild(\n          makeBrowserChip(\n            'All',\n            'all',\n            browserCats.size === 0,\n            () => {\n              browserCats.clear();\n              renderCaseBrowser();\n            },\n            '#9b9ba8'\n          )\n        );\n        counts.forEach(c => {\n          const active = browserCats.has(c.key);\n          caseChipsEl.appendChild(\n            makeBrowserChip(\n              `${c.name}: ${c.count}`,\n              c.key,\n              active,\n              () => {\n                if (browserCats.has(c.key)) browserCats.delete(c.key);\n                else browserCats.add(c.key);\n                renderCaseBrowser();\n              },\n              c.color\n            )\n          );\n        });\n\n        caseListEl.innerHTML = '';\n        cases.forEach(c => {\n          const card = document.createElement('div');\n          card.className = 'card';\n          card.style.padding = '12px';\n          card.style.display = 'grid';\n          card.style.gap = '8px';\n          card.draggable = true;\n          card.addEventListener('dragstart', ev => {\n            ev.dataTransfer.setData('text/plain', c.id);\n            ev.dataTransfer.effectAllowed = 'copy';\n          });\n\n          const header = document.createElement('div');\n          header.className = 'row space-between';\n          const left = document.createElement('div');\n          left.style.display = 'grid';\n          left.style.gap = '2px';\n          const name = document.createElement('div');\n          name.style.fontWeight = 'var(--font-semibold)';\n          name.textContent = c.name;\n          const dims = document.createElement('div');\n          dims.className = 'muted';\n          dims.style.fontSize = 'var(--text-xs)';\n          dims.textContent = `${c.dimensions.length}×${c.dimensions.width}×${c.dimensions.height} in`;\n          left.appendChild(name);\n          left.appendChild(dims);\n          header.appendChild(left);\n\n          const addBtn = document.createElement('button');\n          addBtn.className = 'btn btn-primary';\n          addBtn.type = 'button';\n          addBtn.style.padding = '6px 10px';\n          addBtn.style.boxShadow = 'none';\n          addBtn.innerHTML = '<i class=\"fa-solid fa-plus\"></i> Add';\n          addBtn.addEventListener('click', () => addCaseToPack(c.id));\n          header.appendChild(addBtn);\n\n          const metaRow = document.createElement('div');\n          metaRow.className = 'row';\n          metaRow.style.gap = '8px';\n          metaRow.appendChild(makeMiniCategoryChip(c.category));\n\n          card.appendChild(header);\n          card.appendChild(metaRow);\n          caseListEl.appendChild(card);\n        });\n      }\n\n      function makeBrowserChip(label, key, active, onClick, color) {\n        const el = document.createElement('div');\n        el.className = `chip ${active ? 'active' : ''}`;\n        el.tabIndex = 0;\n        const dot = document.createElement('span');\n        dot.className = 'chip-dot';\n        dot.style.background = color || 'var(--border-strong)';\n        const text = document.createElement('span');\n        text.textContent = label;\n        el.appendChild(dot);\n        el.appendChild(text);\n        el.addEventListener('click', onClick);\n        el.addEventListener('keydown', ev => {\n          if (ev.key === 'Enter') onClick();\n        });\n        return el;\n      }\n\n      function makeMiniCategoryChip(categoryKey) {\n        const meta = CategoryService.meta(categoryKey || 'default');\n        const el = document.createElement('span');\n        el.className = 'chip';\n        el.style.cursor = 'default';\n        el.style.padding = '4px 10px';\n        const dot = document.createElement('span');\n        dot.className = 'chip-dot';\n        dot.style.background = meta.color;\n        const text = document.createElement('span');\n        text.textContent = meta.name;\n        el.appendChild(dot);\n        el.appendChild(text);\n        return el;\n      }\n\n      function addCaseToPack(caseId, positionInches) {\n        const packId = StateStore.get('currentPackId');\n        const pack = PackLibrary.getById(packId);\n        if (!pack) {\n          UIComponents.showToast('Create or open a pack first', 'warning');\n          AppShell.navigate('packs');\n          return;\n        }\n\n        const count = (pack.cases || []).length;\n        const caseData = CaseLibrary.getById(caseId);\n        if (!caseData) return;\n        const stageX = -90 - (count % 4) * 40;\n        const stageZ = (Math.floor(count / 4) - 2) * 34;\n        const pos = positionInches || { x: stageX, y: Math.max(1, caseData.dimensions.height / 2), z: stageZ };\n        const inst = PackLibrary.addInstance(packId, caseId, pos);\n        if (inst) {\n          StateStore.set({ selectedInstanceIds: [inst.id] }, { skipHistory: true });\n          UIComponents.showToast('Case added to pack', 'success');\n        }\n      }\n\n      function renderInspectorNoPack() {\n        inspectorEl.innerHTML = '';\n        const card = document.createElement('div');\n        card.className = 'card';\n        card.innerHTML = `\n              <div style=\"font-weight:var(--font-semibold);margin-bottom:6px\">No pack open</div>\n              <div class=\"muted\" style=\"font-size:var(--text-sm);margin-bottom:12px\">Open a pack from the Packs screen to use the 3D editor.</div>\n            `;\n        const btn = document.createElement('button');\n        btn.className = 'btn btn-primary';\n        btn.type = 'button';\n        btn.innerHTML = '<i class=\"fa-solid fa-layer-group\"></i> Go to Packs';\n        btn.addEventListener('click', () => AppShell.navigate('packs'));\n        card.appendChild(btn);\n        inspectorEl.appendChild(card);\n      }\n\n      function renderInspector(pack) {\n        const prefs = PreferencesManager.get();\n        const sel = StateStore.get('selectedInstanceIds') || [];\n        inspectorEl.innerHTML = '';\n\n        if (!sel.length) {\n          renderTruckInspector(pack, prefs);\n          return;\n        }\n\n        if (sel.length > 1) {\n          renderMultiInspector(pack, sel);\n          return;\n        }\n\n        const instanceId = sel[0];\n        const inst = (pack.cases || []).find(i => i.id === instanceId);\n        if (!inst) {\n          StateStore.set({ selectedInstanceIds: [] }, { skipHistory: true });\n          renderTruckInspector(pack, prefs);\n          return;\n        }\n        const c = CaseLibrary.getById(inst.caseId);\n        if (!c) return;\n        renderSingleInspector(pack, inst, c, prefs);\n      }\n\n      function renderTruckInspector(pack, prefs) {\n        const card = document.createElement('div');\n        card.className = 'card';\n        card.style.display = 'grid';\n        card.style.gap = '12px';\n\n        const stats = PackLibrary.computeStats(pack);\n        card.innerHTML = `\n              <div style=\"font-weight:var(--font-semibold)\">Truck</div>\n              <div class=\"muted\" style=\"font-size:var(--text-sm)\">Edit dimensions in inches (internal units). Display units follow Settings.</div>\n            `;\n\n        const dimsRow = document.createElement('div');\n        dimsRow.className = 'row';\n        dimsRow.style.gap = '10px';\n        const fL = smallField('Length (in)', pack.truck.length);\n        const fW = smallField('Width (in)', pack.truck.width);\n        const fH = smallField('Height (in)', pack.truck.height);\n        dimsRow.appendChild(fL.wrap);\n        dimsRow.appendChild(fW.wrap);\n        dimsRow.appendChild(fH.wrap);\n\n        const btnSave = document.createElement('button');\n        btnSave.className = 'btn btn-primary';\n        btnSave.type = 'button';\n        btnSave.innerHTML = '<i class=\"fa-solid fa-floppy-disk\"></i> Update truck';\n        btnSave.addEventListener('click', () => {\n          const next = {\n            length: Math.max(24, Number(fL.input.value) || pack.truck.length),\n            width: Math.max(24, Number(fW.input.value) || pack.truck.width),\n            height: Math.max(24, Number(fH.input.value) || pack.truck.height),\n          };\n          PackLibrary.update(pack.id, { truck: next });\n          UIComponents.showToast('Truck updated', 'success');\n        });\n\n        const statsEl = document.createElement('div');\n        statsEl.className = 'card';\n        statsEl.style.background = 'var(--bg-elevated)';\n        statsEl.style.boxShadow = 'none';\n        statsEl.style.display = 'grid';\n        statsEl.style.gap = '8px';\n        statsEl.innerHTML = `\n              <div style=\"font-weight:var(--font-semibold)\">Stats</div>\n              <div class=\"muted\" style=\"font-size:var(--text-sm)\">Cases loaded: <b style=\"color:var(--text-primary)\">${stats.totalCases}</b></div>\n              <div class=\"muted\" style=\"font-size:var(--text-sm)\">Packed (in truck): <b style=\"color:var(--text-primary)\">${stats.packedCases}</b></div>\n              <div class=\"muted\" style=\"font-size:var(--text-sm)\">Volume used: <b style=\"color:var(--text-primary)\">${stats.volumePercent.toFixed(1)}%</b></div>\n              <div class=\"muted\" style=\"font-size:var(--text-sm)\">Total weight: <b style=\"color:var(--text-primary)\">${Utils.formatWeight(stats.totalWeight, prefs.units.weight)}</b></div>\n            `;\n\n        card.appendChild(dimsRow);\n        card.appendChild(btnSave);\n        inspectorEl.appendChild(card);\n        inspectorEl.appendChild(statsEl);\n      }\n\n      function renderMultiInspector(pack, selected) {\n        const card = document.createElement('div');\n        card.className = 'card';\n        card.style.display = 'grid';\n        card.style.gap = '12px';\n        card.innerHTML = `\n              <div style=\"font-weight:var(--font-semibold)\">${selected.length} selected</div>\n              <div class=\"muted\" style=\"font-size:var(--text-sm)\">Use keyboard shortcuts: Delete, Esc, Ctrl/Cmd+A.</div>\n            `;\n\n        const row = document.createElement('div');\n        row.className = 'row';\n        row.style.justifyContent = 'flex-end';\n        const btnDelete = document.createElement('button');\n        btnDelete.className = 'btn btn-danger';\n        btnDelete.type = 'button';\n        btnDelete.innerHTML = '<i class=\"fa-solid fa-trash\"></i> Delete';\n        btnDelete.addEventListener('click', () => InteractionManager.deleteSelection());\n        const btnClear = document.createElement('button');\n        btnClear.className = 'btn';\n        btnClear.type = 'button';\n        btnClear.innerHTML = '<i class=\"fa-solid fa-xmark\"></i> Deselect';\n        btnClear.addEventListener('click', () => StateStore.set({ selectedInstanceIds: [] }, { skipHistory: true }));\n        row.appendChild(btnClear);\n        row.appendChild(btnDelete);\n        card.appendChild(row);\n        inspectorEl.appendChild(card);\n      }\n\n      function renderSingleInspector(pack, inst, caseData, prefs) {\n        const card = document.createElement('div');\n        card.className = 'card';\n        card.style.display = 'grid';\n        card.style.gap = '12px';\n\n        const header = document.createElement('div');\n        const title = document.createElement('div');\n        title.style.fontWeight = 'var(--font-semibold)';\n        title.style.fontSize = 'var(--text-lg)';\n        title.textContent = caseData.name || '—';\n        const sub = document.createElement('div');\n        sub.className = 'muted';\n        sub.style.fontSize = 'var(--text-sm)';\n        const mfg = caseData.manufacturer ? caseData.manufacturer : '—';\n        const d = caseData.dimensions || { length: 0, width: 0, height: 0 };\n        sub.textContent = `${mfg} • ${d.length}×${d.width}×${d.height} in`;\n        header.appendChild(title);\n        header.appendChild(sub);\n        card.appendChild(header);\n        card.appendChild(makeMiniCategoryChip(caseData.category));\n\n        const posRow = document.createElement('div');\n        posRow.className = 'row';\n        posRow.style.gap = '10px';\n        const pos = inst.transform.position || { x: 0, y: 0, z: 0 };\n        const fX = smallField(`X (${prefs.units.length})`, Utils.inchesToUnit(pos.x, prefs.units.length));\n        const fY = smallField(`Y (${prefs.units.length})`, Utils.inchesToUnit(pos.y, prefs.units.length));\n        const fZ = smallField(`Z (${prefs.units.length})`, Utils.inchesToUnit(pos.z, prefs.units.length));\n        posRow.appendChild(fX.wrap);\n        posRow.appendChild(fY.wrap);\n        posRow.appendChild(fZ.wrap);\n\n        const row2 = document.createElement('div');\n        row2.className = 'row';\n        row2.style.gap = '10px';\n        const hide = document.createElement('button');\n        hide.className = 'btn';\n        hide.type = 'button';\n        hide.innerHTML = inst.hidden\n          ? '<i class=\"fa-solid fa-eye\"></i> Unhide'\n          : '<i class=\"fa-solid fa-eye-slash\"></i> Hide';\n        hide.addEventListener('click', () => PackLibrary.updateInstance(pack.id, inst.id, { hidden: !inst.hidden }));\n        const remove = document.createElement('button');\n        remove.className = 'btn btn-danger';\n        remove.type = 'button';\n        remove.innerHTML = '<i class=\"fa-solid fa-trash\"></i> Remove';\n        remove.addEventListener('click', () => {\n          PackLibrary.removeInstances(pack.id, [inst.id]);\n          StateStore.set({ selectedInstanceIds: [] }, { skipHistory: true });\n        });\n        row2.appendChild(hide);\n        row2.appendChild(remove);\n\n        const savePos = document.createElement('button');\n        savePos.className = 'btn btn-primary';\n        savePos.type = 'button';\n        savePos.innerHTML = '<i class=\"fa-solid fa-location-crosshairs\"></i> Apply position';\n        savePos.addEventListener('click', () => {\n          const nextPos = {\n            x: Utils.unitToInches(Number(fX.input.value) || 0, prefs.units.length),\n            y: Utils.unitToInches(Number(fY.input.value) || 0, prefs.units.length),\n            z: Utils.unitToInches(Number(fZ.input.value) || 0, prefs.units.length),\n          };\n          PackLibrary.updateInstance(pack.id, inst.id, { transform: { ...inst.transform, position: nextPos } });\n          SceneManager.focusOnWorldPoint(SceneManager.vecInchesToWorld(nextPos), { duration: 420 });\n          UIComponents.showToast('Position updated', 'success');\n        });\n\n        card.appendChild(posRow);\n        card.appendChild(savePos);\n        card.appendChild(row2);\n        inspectorEl.appendChild(card);\n      }\n\n      function smallField(label, value) {\n        const wrap = document.createElement('div');\n        wrap.className = 'field';\n        wrap.style.minWidth = '90px';\n        const l = document.createElement('div');\n        l.className = 'label';\n        l.textContent = label;\n        const input = document.createElement('input');\n        input.className = 'input';\n        input.type = 'number';\n        input.step = '0.1';\n        input.value = String(Number(value).toFixed(1));\n        wrap.appendChild(l);\n        wrap.appendChild(input);\n        return { wrap, input };\n      }\n\n      function setPanelVisible(side, visible) {\n        const isMobile = window.matchMedia('(max-width: 899px)').matches;\n        const defaultCol = which => {\n          const compact = window.matchMedia('(max-width: 1279px)').matches;\n          if (which === 'left') return compact ? '270px' : '290px';\n          return compact ? '300px' : '340px';\n        };\n        if (side === 'left') {\n          if (isMobile) leftEl.classList.toggle('open', visible);\n          else shellEl.style.setProperty('--left-col', visible ? defaultCol('left') : '0px');\n        }\n        if (side === 'right') {\n          if (isMobile) rightEl.classList.toggle('open', visible);\n          else shellEl.style.setProperty('--right-col', visible ? defaultCol('right') : '0px');\n        }\n        scheduleViewportResize();\n      }\n\n      function togglePanel(side) {\n        const isMobile = window.matchMedia('(max-width: 899px)').matches;\n        if (side === 'left') {\n          if (isMobile) {setPanelVisible('left', !leftEl.classList.contains('open'));}\n          else {\n            const current = getComputedStyle(shellEl).getPropertyValue('--left-col').trim() || '290px';\n            setPanelVisible('left', current === '0px');\n          }\n        }\n        if (side === 'right') {\n          if (isMobile) {setPanelVisible('right', !rightEl.classList.contains('open'));}\n          else {\n            const current = getComputedStyle(shellEl).getPropertyValue('--right-col').trim() || '340px';\n            setPanelVisible('right', current === '0px');\n          }\n        }\n        scheduleViewportResize();\n      }\n\n      function wireDropToViewport(canvasEl) {\n        canvasEl.addEventListener('dragover', ev => {\n          ev.preventDefault();\n          ev.dataTransfer.dropEffect = 'copy';\n        });\n        canvasEl.addEventListener('drop', ev => {\n          ev.preventDefault();\n          const caseId = ev.dataTransfer.getData('text/plain');\n          if (!caseId) return;\n          const world = worldPointOnGround(ev.clientX, ev.clientY, canvasEl);\n          if (!world) {\n            addCaseToPack(caseId);\n            return;\n          }\n          const inches = SceneManager.vecWorldToInches(world);\n          const c = CaseLibrary.getById(caseId);\n          if (c && c.dimensions && c.dimensions.height) inches.y = Math.max(1, c.dimensions.height / 2);\n          addCaseToPack(caseId, inches);\n        });\n      }\n\n      function worldPointOnGround(clientX, clientY, canvasEl) {\n        const camera = SceneManager.getCamera();\n        if (!camera) return null;\n        const rect = canvasEl.getBoundingClientRect();\n        const x = ((clientX - rect.left) / rect.width) * 2 - 1;\n        const y = -((clientY - rect.top) / rect.height) * 2 + 1;\n        const raycaster = new THREE.Raycaster();\n        raycaster.setFromCamera({ x, y }, camera);\n        const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);\n        const out = new THREE.Vector3();\n        const ok = raycaster.ray.intersectPlane(plane, out);\n        return ok ? out : null;\n      }\n\n      return { init, render };\n    })();\n\n    const UpdatesUI = (() => {\n      const listEl = document.getElementById('updates-list');\n      function init() {}\n      function render() {\n        listEl.innerHTML = '';\n        Data.updates.forEach(u => {\n          const card = document.createElement('div');\n          card.className = 'card';\n          const header = document.createElement('div');\n          header.className = 'row space-between';\n          header.style.alignItems = 'flex-start';\n          const left = document.createElement('div');\n          left.innerHTML = `<div style=\"font-weight:var(--font-semibold);font-size:var(--text-lg)\">Version ${u.version}</div><div class=\"muted\" style=\"font-size:var(--text-xs)\">${new Date(u.date).toLocaleDateString()}</div>`;\n          header.appendChild(left);\n          card.appendChild(header);\n\n          const sections = [\n            { title: 'New Features', items: u.features || [] },\n            { title: 'Bug Fixes', items: u.bugFixes || [] },\n            { title: 'Breaking Changes', items: u.breakingChanges || [] },\n          ].filter(s => s.items.length);\n          sections.forEach(s => {\n            const t = document.createElement('div');\n            t.style.marginTop = '12px';\n            t.style.fontWeight = 'var(--font-semibold)';\n            t.textContent = s.title;\n            card.appendChild(t);\n            const ul = document.createElement('ul');\n            ul.style.margin = '8px 0 0 16px';\n            ul.style.color = 'var(--text-secondary)';\n            ul.style.fontSize = 'var(--text-sm)';\n            s.items.forEach(it => {\n              const li = document.createElement('li');\n              li.textContent = it;\n              ul.appendChild(li);\n            });\n            card.appendChild(ul);\n          });\n          listEl.appendChild(card);\n        });\n      }\n      return { init, render };\n    })();\n\n    const RoadmapUI = (() => {\n      const listEl = document.getElementById('roadmap-list');\n      function init() {}\n      function render() {\n        listEl.innerHTML = '';\n        Data.roadmap.forEach(group => {\n          const wrap = document.createElement('div');\n          wrap.className = 'grid';\n          wrap.style.gap = '10px';\n          const h = document.createElement('div');\n          h.style.fontSize = 'var(--text-lg)';\n          h.style.fontWeight = 'var(--font-semibold)';\n          h.textContent = group.quarter;\n          wrap.appendChild(h);\n          const grid = document.createElement('div');\n          grid.className = 'pack-grid';\n          grid.style.gridTemplateColumns = 'repeat(2, minmax(0, 1fr))';\n          group.items.forEach(item => {\n            const card = document.createElement('div');\n            card.className = 'card';\n            card.style.cursor = 'pointer';\n            card.innerHTML = `\n                  <div class=\"row space-between\" style=\"gap:10px\">\n                    <div style=\"font-weight:var(--font-semibold)\">${item.title}</div>\n                    <div class=\"badge\" style=\"border-color:transparent;background:${item.color};color:white\">${item.badge} ${item.status}</div>\n                  </div>\n                  <div class=\"muted\" style=\"font-size:var(--text-sm);margin-top:8px\">${item.details}</div>\n                `;\n            card.addEventListener('click', () => {\n              UIComponents.showModal({\n                title: item.title,\n                content: `<div class=\"muted\" style=\"font-size:var(--text-sm)\">${item.details}</div>`,\n                actions: [{ label: 'Close', variant: 'primary' }],\n              });\n            });\n            grid.appendChild(card);\n          });\n          wrap.appendChild(grid);\n          listEl.appendChild(wrap);\n        });\n      }\n      return { init, render };\n    })();\n\n    const SettingsUI = (() => {\n      const elLength = document.getElementById('pref-length');\n      const elWeight = document.getElementById('pref-weight');\n      const elTheme = document.getElementById('pref-theme');\n      const elLabel = document.getElementById('pref-label-size');\n      const elHidden = document.getElementById('pref-hidden-opacity');\n      const elSnap = document.getElementById('pref-snapping-enabled');\n      const elGrid = document.getElementById('pref-grid-size');\n      const elShot = document.getElementById('pref-shot-res');\n      const elPdfStats = document.getElementById('pref-pdf-stats');\n      const btnSave = document.getElementById('btn-save-prefs');\n      const btnReset = document.getElementById('btn-reset-demo');\n\n      function init() {\n        btnSave.addEventListener('click', () => save());\n        btnReset.addEventListener('click', async () => {\n          const ok = await UIComponents.confirm({\n            title: 'Reset demo data?',\n            message: 'This replaces your local data with the demo set.',\n            danger: true,\n            okLabel: 'Reset',\n          });\n          if (!ok) return;\n          Storage.clearAll();\n          clearSession();\n          window.location.reload();\n        });\n      }\n\n      function loadForm() {\n        const p = PreferencesManager.get();\n        elLength.value = p.units.length;\n        elWeight.value = p.units.weight;\n        elTheme.value = p.theme;\n        elLabel.value = String(p.labelFontSize);\n        elHidden.value = String(p.hiddenCaseOpacity);\n        elSnap.value = String(Boolean(p.snapping.enabled));\n        elGrid.value = String(p.snapping.gridSize);\n        elShot.value = p.export.screenshotResolution;\n        elPdfStats.value = String(Boolean(p.export.pdfIncludeStats));\n      }\n\n      function save() {\n        const prev = PreferencesManager.get();\n        const next = Utils.deepClone(prev);\n        next.units.length = elLength.value;\n        next.units.weight = elWeight.value;\n        next.theme = elTheme.value;\n        next.labelFontSize = Utils.clamp(Number(elLabel.value) || 12, 8, 24);\n        next.hiddenCaseOpacity = Utils.clamp(Number(elHidden.value) || 0.3, 0, 1);\n        next.snapping.enabled = elSnap.value === 'true';\n        next.snapping.gridSize = Math.max(0.25, Number(elGrid.value) || 1);\n        next.export.screenshotResolution = elShot.value;\n        next.export.pdfIncludeStats = elPdfStats.value === 'true';\n        PreferencesManager.set(next);\n        PreferencesManager.applyTheme(next.theme);\n        UIComponents.showToast('Preferences saved', 'success');\n      }\n\n      return { init, loadForm };\n    })();\n\n    const KeyboardManager = (() => {\n      let clipboard = null;\n\n      function init() {\n        document.addEventListener('keydown', handleKeyDown);\n      }\n\n      function handleKeyDown(event) {\n        if (isTypingContext(event)) return;\n        const key = buildKeyString(event);\n        const handler = shortcuts[key];\n        if (!handler) return;\n        const handled = handler(event);\n        if (handled === false) return;\n        event.preventDefault();\n      }\n\n      function isTypingContext(event) {\n        const el = event.target;\n        if (!el) return false;\n        if (el.isContentEditable) return true;\n        return el.matches && el.matches('input, textarea, select');\n      }\n\n      function buildKeyString(event) {\n        const parts = [];\n        if (event.metaKey) parts.push('meta');\n        if (event.ctrlKey && !event.metaKey) parts.push('ctrl');\n        if (event.shiftKey) parts.push('shift');\n        if (event.altKey) parts.push('alt');\n        parts.push(String(event.key || '').toLowerCase());\n        return parts.join('+');\n      }\n\n      function inEditor() {\n        return StateStore.get('currentScreen') === 'editor';\n      }\n\n      function save() {\n        Storage.saveNow();\n        UIComponents.showToast('Saved locally', 'success', { title: 'Storage' });\n      }\n\n      function undo() {\n        const ok = StateStore.undo();\n        UIComponents.showToast(ok ? 'Undone' : 'Nothing to undo', ok ? 'info' : 'warning', { title: 'Edit' });\n      }\n\n      function redo() {\n        const ok = StateStore.redo();\n        UIComponents.showToast(ok ? 'Redone' : 'Nothing to redo', ok ? 'info' : 'warning', { title: 'Edit' });\n      }\n\n      function deselectAll() {\n        StateStore.set({ selectedInstanceIds: [] }, { skipHistory: true });\n        CaseScene.setSelected([]);\n      }\n\n      function selectAll() {\n        if (!inEditor()) return false;\n        InteractionManager.selectAllInPack();\n      }\n\n      function deleteSelected() {\n        if (!inEditor()) return false;\n        InteractionManager.deleteSelection();\n      }\n\n      function duplicateSelected() {\n        if (!inEditor()) return false;\n        const packId = StateStore.get('currentPackId');\n        const pack = PackLibrary.getById(packId);\n        const selected = StateStore.get('selectedInstanceIds') || [];\n        if (!pack || !selected.length) return;\n\n        const nextCases = [...(pack.cases || [])];\n        const newIds = [];\n        selected.forEach(id => {\n          const inst = (pack.cases || []).find(i => i.id === id);\n          if (!inst) return;\n          const pos = inst.transform && inst.transform.position ? inst.transform.position : { x: -80, y: 10, z: 0 };\n          nextCases.push({\n            ...Utils.deepClone(inst),\n            id: Utils.uuid(),\n            transform: {\n              ...Utils.deepClone(inst.transform || {}),\n              position: { x: pos.x + 12, y: pos.y, z: pos.z + 12 },\n            },\n            hidden: false,\n          });\n          newIds.push(nextCases[nextCases.length - 1].id);\n        });\n\n        PackLibrary.update(packId, { cases: nextCases });\n        StateStore.set({ selectedInstanceIds: newIds }, { skipHistory: true });\n        UIComponents.showToast(`Duplicated ${newIds.length} case(s)`, 'success', { title: 'Edit' });\n      }\n\n      function copySelected() {\n        if (!inEditor()) return false;\n        const packId = StateStore.get('currentPackId');\n        const pack = PackLibrary.getById(packId);\n        const selected = StateStore.get('selectedInstanceIds') || [];\n        if (!pack || !selected.length) return;\n        clipboard = selected\n          .map(id => (pack.cases || []).find(i => i.id === id))\n          .filter(Boolean)\n          .map(i => ({ caseId: i.caseId, transform: Utils.deepClone(i.transform || {}) }));\n        UIComponents.showToast(`Copied ${clipboard.length} case(s)`, 'info', { title: 'Clipboard' });\n      }\n\n      function pasteClipboard() {\n        if (!inEditor()) return false;\n        const packId = StateStore.get('currentPackId');\n        const pack = PackLibrary.getById(packId);\n        if (!pack || !clipboard || !clipboard.length) return;\n\n        const nextCases = [...(pack.cases || [])];\n        const newIds = [];\n        clipboard.forEach(item => {\n          const pos = item.transform && item.transform.position ? item.transform.position : { x: -80, y: 10, z: 0 };\n          nextCases.push({\n            id: Utils.uuid(),\n            caseId: item.caseId,\n            transform: {\n              position: { x: pos.x + 12, y: pos.y, z: pos.z + 12 },\n              rotation: Utils.deepClone((item.transform && item.transform.rotation) || { x: 0, y: 0, z: 0 }),\n              scale: Utils.deepClone((item.transform && item.transform.scale) || { x: 1, y: 1, z: 1 }),\n            },\n            hidden: false,\n            groupId: null,\n          });\n          newIds.push(nextCases[nextCases.length - 1].id);\n        });\n\n        PackLibrary.update(packId, { cases: nextCases });\n        StateStore.set({ selectedInstanceIds: newIds }, { skipHistory: true });\n        UIComponents.showToast(`Pasted ${newIds.length} case(s)`, 'success', { title: 'Clipboard' });\n      }\n\n      function focusSelected() {\n        if (!inEditor()) return false;\n        const selected = StateStore.get('selectedInstanceIds') || [];\n        if (!selected.length) return;\n        const obj = CaseScene.getObject(selected[0]);\n        if (!obj) return;\n        SceneManager.focusOnWorldPoint(obj.position.clone(), { duration: 600 });\n      }\n\n      function toggleGrid() {\n        if (!inEditor()) return false;\n        const visible = SceneManager.toggleGrid();\n        UIComponents.showToast(visible ? 'Grid shown' : 'Grid hidden', 'info', { title: 'View', duration: 1200 });\n      }\n\n      function toggleShadows() {\n        if (!inEditor()) return false;\n        const enabled = SceneManager.toggleShadows();\n        UIComponents.showToast(enabled ? 'Shadows enabled' : 'Shadows disabled', 'info', {\n          title: 'View',\n          duration: 1200,\n        });\n      }\n\n      function openPackDialog() {\n        const packs = PackLibrary.getPacks()\n          .slice()\n          .sort((a, b) => (b.lastEdited || 0) - (a.lastEdited || 0));\n        const content = document.createElement('div');\n        content.className = 'grid';\n        content.style.gap = '10px';\n        if (!packs.length) {\n          const empty = document.createElement('div');\n          empty.className = 'muted';\n          empty.style.fontSize = 'var(--text-sm)';\n          empty.textContent = 'No packs available.';\n          content.appendChild(empty);\n        } else {\n          packs.forEach(p => {\n            const row = document.createElement('button');\n            row.type = 'button';\n            row.className = 'btn';\n            row.style.justifyContent = 'space-between';\n            row.style.width = '100%';\n            const name = document.createElement('span');\n            name.style.fontWeight = 'var(--font-semibold)';\n            name.textContent = p.title || 'Untitled';\n            const meta = document.createElement('span');\n            meta.className = 'muted';\n            meta.style.fontSize = 'var(--text-xs)';\n            meta.textContent = `edited ${Utils.formatRelativeTime(p.lastEdited)}`;\n            row.appendChild(name);\n            row.appendChild(meta);\n            row.addEventListener('click', () => {\n              PackLibrary.open(p.id);\n              AppShell.navigate('editor');\n              modal.close();\n            });\n            content.appendChild(row);\n          });\n        }\n\n        const modal = UIComponents.showModal({\n          title: 'Open Pack',\n          content,\n          actions: [{ label: 'Close', variant: 'primary' }],\n        });\n      }\n\n      const shortcuts = {\n        'meta+s': save,\n        'ctrl+s': save,\n        'meta+z': undo,\n        'ctrl+z': undo,\n        'meta+shift+z': redo,\n        'ctrl+shift+z': redo,\n        'meta+a': selectAll,\n        'ctrl+a': selectAll,\n        'meta+shift+a': deselectAll,\n        'ctrl+shift+a': deselectAll,\n        escape: deselectAll,\n        delete: deleteSelected,\n        backspace: deleteSelected,\n        'meta+d': duplicateSelected,\n        'ctrl+d': duplicateSelected,\n        'meta+c': copySelected,\n        'ctrl+c': copySelected,\n        'meta+v': pasteClipboard,\n        'ctrl+v': pasteClipboard,\n        'meta+p': () => {\n          if (!inEditor()) return false;\n          const session = getSession();\n          if (!canUseFeature('AUTOPACK', session)) {\n            UIComponents.showToast('AutoPack requires Pro', 'warning', { title: 'Upgrade' });\n            return false;\n          }\n          AutoPackEngine.pack();\n        },\n        'ctrl+p': () => {\n          if (!inEditor()) return false;\n          const session = getSession();\n          if (!canUseFeature('AUTOPACK', session)) {\n            UIComponents.showToast('AutoPack requires Pro', 'warning', { title: 'Upgrade' });\n            return false;\n          }\n          AutoPackEngine.pack();\n        },\n        'meta+o': openPackDialog,\n        'ctrl+o': openPackDialog,\n        g: toggleGrid,\n        s: toggleShadows,\n        f: focusSelected,\n        p: () => {\n          if (!inEditor()) return false;\n          SceneManager.toggleDevOverlay();\n        },\n      };\n\n      return { init };\n    })();\n\n    function wireGlobalButtons() {\n      const btnAccount = document.getElementById('btn-account');\n      const btnExport = document.getElementById('btn-export-app');\n      const btnImport = document.getElementById('btn-import-app');\n      const btnTheme = document.getElementById('btn-theme');\n      const btnHelp = document.getElementById('btn-help');\n\n      function switchOrganization(nextOrgId) {\n        const orgId = String(nextOrgId || '').trim() || 'personal';\n        const storedOrg = Storage.loadOrg(orgId);\n        const allData = Storage.load();\n        const prefs =\n          allData && allData.preferences && typeof allData.preferences === 'object'\n            ? allData.preferences\n            : Defaults.defaultPreferences;\n        const normalized = Normalizer.normalizeAppData(\n          storedOrg || { caseLibrary: [], packLibrary: [], preferences: prefs, currentPackId: null }\n        );\n        const prev = StateStore.get();\n        const nextState = {\n          ...prev,\n          caseLibrary: normalized.caseLibrary,\n          packLibrary: normalized.packLibrary,\n          preferences: normalized.preferences,\n          currentPackId: normalized.currentPackId,\n          currentScreen: 'packs',\n          selectedInstanceIds: [],\n        };\n        StateStore.replace(nextState, { skipHistory: true });\n        Storage.saveNow();\n      }\n\n      mountAccountSwitcher({\n        buttonEl: btnAccount,\n        ui: UIComponents,\n        onOrgChange: payload => {\n          if (!payload || typeof payload !== 'object') return;\n          if (payload.phase === 'before') {\n            Storage.saveNow();\n            return;\n          }\n          if (payload.phase === 'after' && payload.nextOrgId) {\n            switchOrganization(payload.nextOrgId);\n          }\n        },\n      });\n\n      btnExport.addEventListener('click', () => {\n        const json = Storage.exportAppJSON();\n        Utils.downloadText(`truck-packer-3d-${Date.now()}.json`, json);\n        UIComponents.showToast('Exported app JSON', 'success');\n      });\n\n      btnImport.addEventListener('click', () => {\n        const input = document.createElement('input');\n        input.type = 'file';\n        input.accept = '.json,application/json';\n        input.addEventListener('change', async () => {\n          const file = input.files && input.files[0];\n          if (!file) return;\n          const text = await file.text();\n          try {\n            const imported = Storage.importAppJSON(text);\n            Storage.replaceAll(imported.data);\n\n            const orgIds = imported.data && imported.data.orgData ? Object.keys(imported.data.orgData) : [];\n            const currentSession = getSession();\n            let targetOrgId =\n              currentSession && currentSession.user && currentSession.user.currentOrgId\n                ? currentSession.user.currentOrgId\n                : 'personal';\n            if (!imported.data || !imported.data.orgData || !imported.data.orgData[targetOrgId]) {\n              targetOrgId = orgIds.includes('personal') ? 'personal' : orgIds[0] || 'personal';\n              if (targetOrgId && !(currentSession.orgs || []).some(o => o && o.id === targetOrgId)) {\n                upsertOrg({\n                  id: targetOrgId,\n                  type: targetOrgId === 'personal' ? 'personal' : 'organization',\n                  name: targetOrgId === 'personal' ? 'Personal Account' : `Imported ${targetOrgId}`,\n                  role: 'Owner',\n                  plan: 'Trial',\n                  trialEndsAt: Date.now() + 7 * 24 * 60 * 60 * 1000,\n                });\n              }\n              setCurrentOrgId(targetOrgId);\n            }\n\n            const storedOrg = Storage.loadOrg(targetOrgId);\n            const normalized = Normalizer.normalizeAppData(storedOrg || {});\n            const prev = StateStore.get();\n            const nextState = {\n              ...prev,\n              caseLibrary: normalized.caseLibrary,\n              packLibrary: normalized.packLibrary,\n              preferences: normalized.preferences,\n              currentPackId: normalized.currentPackId,\n              currentScreen: 'packs',\n              selectedInstanceIds: [],\n            };\n            StateStore.replace(nextState, { skipHistory: false });\n            PreferencesManager.applyTheme(nextState.preferences.theme);\n            UIComponents.showToast('Imported app JSON', 'success');\n          } catch (err) {\n            UIComponents.showToast('Import failed: ' + err.message, 'error');\n          }\n        });\n        input.click();\n      });\n\n      btnTheme.addEventListener('click', () => {\n        const prefs = PreferencesManager.get();\n        const next = Utils.deepClone(prefs);\n        next.theme = prefs.theme === 'dark' ? 'light' : 'dark';\n        PreferencesManager.set(next);\n        PreferencesManager.applyTheme(next.theme);\n        UIComponents.showToast(`Theme: ${next.theme}`, 'info');\n      });\n\n      if (btnHelp) {\n        btnHelp.addEventListener('click', () => {\n          UIComponents.showModal({\n            title: 'Help — Export / Import',\n            content: `\n                  <div class=\"muted\" style=\"font-size:var(--text-sm);line-height:var(--leading-relaxed)\">\n                    <strong>Export</strong>: Downloads data as JSON. Use the topbar <em>Export</em> to save a full app backup, or use a pack's <em>Export JSON</em> from the pack menu to export a single pack.<br><br>\n                    <strong>Import</strong>: Loads a full-app JSON backup. Click the topbar <em>Import</em>, choose a previously exported app JSON, and the app state will be restored/merged.<br><br>\n                    <strong>Import Pack</strong>: Adds a single pack to your library. Use when someone shares a pack JSON (exported from the pack kebab menu).<br><br>\n                    Tip: Always use <em>Export</em> to make a backup before importing.\n                  </div>\n                `,\n            actions: [{ label: 'Close', variant: 'primary' }],\n          });\n        });\n      }\n    }\n\n    function seedIfEmpty() {\n      initSession();\n      const session = getSession();\n      const orgId = session && session.user && session.user.currentOrgId ? session.user.currentOrgId : 'personal';\n\n      const storedOrg = Storage.loadOrg(orgId);\n      if (storedOrg && storedOrg.caseLibrary && storedOrg.packLibrary && storedOrg.preferences) {\n        const normalized = Normalizer.normalizeAppData(storedOrg);\n        const initialState = {\n          currentScreen: 'packs',\n          currentPackId: normalized.currentPackId || null,\n          selectedInstanceIds: [],\n          caseLibrary: normalized.caseLibrary,\n          packLibrary: normalized.packLibrary,\n          preferences: normalized.preferences,\n        };\n        StateStore.init(initialState);\n        return;\n      }\n\n      const allData = Storage.load();\n      const prefs =\n        allData && allData.preferences && typeof allData.preferences === 'object'\n          ? allData.preferences\n          : Defaults.defaultPreferences;\n\n      // New organizations start empty (personal account gets demo seed).\n      if (orgId !== 'personal') {\n        const initialState = {\n          currentScreen: 'packs',\n          currentPackId: null,\n          selectedInstanceIds: [],\n          caseLibrary: [],\n          packLibrary: [],\n          preferences: prefs,\n        };\n        StateStore.init(initialState);\n        Storage.saveNow();\n        return;\n      }\n\n      const cases = Defaults.seedCases();\n      cases.forEach(c => {\n        c.volume = Utils.volumeInCubicInches(c.dimensions);\n      });\n      const demoPack = Defaults.seedPack(cases);\n      demoPack.stats = PackLibrary.computeStats(demoPack, cases);\n      const initialState = {\n        currentScreen: 'packs',\n        currentPackId: demoPack.id,\n        selectedInstanceIds: [],\n        caseLibrary: cases,\n        packLibrary: [demoPack],\n        preferences: prefs,\n      };\n      StateStore.init(initialState);\n      Storage.saveNow();\n    }\n\n    function validateRuntime() {\n      const failures = window.__TP3D_BOOT && window.__TP3D_BOOT.cdnFailures ? window.__TP3D_BOOT.cdnFailures : [];\n      failures.forEach(f => {\n        UIComponents.showToast(`${f.name} failed to load`, 'error', {\n          title: 'CDN',\n          actions: [{ label: 'Retry', onClick: () => window.location.reload() }],\n        });\n      });\n\n      if (!Utils.hasWebGL()) {\n        SystemOverlay.show({\n          title: 'WebGL required',\n          message: 'This app requires WebGL. Please update your browser or enable hardware acceleration.',\n          items: ['Chrome/Edge: Settings → System → Use hardware acceleration', 'Safari: Update to Safari 14+'],\n        });\n        return false;\n      }\n\n      const missing = [];\n      if (!window.THREE) missing.push('three@0.160.0');\n      if (!window.THREE || !window.THREE.OrbitControls) missing.push('OrbitControls');\n      if (!window.TWEEN) missing.push('@tweenjs/tween.js');\n      if (!window.XLSX) missing.push('xlsx');\n      if (!window.jspdf) missing.push('jsPDF');\n      if (missing.length) {\n        SystemOverlay.show({\n          title: 'Missing dependencies',\n          message: 'Some required CDN libraries did not load. Check your connection or allowlisted CDNs.',\n          items: missing.map(m => `Missing: ${m}`),\n        });\n        return false;\n      }\n\n      return true;\n    }\n\n    function renderAll() {\n      AppShell.renderShell();\n      PacksUI.render();\n      CasesUI.render();\n      EditorUI.render();\n      UpdatesUI.render();\n      RoadmapUI.render();\n      SettingsUI.loadForm();\n    }\n\n    function installGlobalErrorHandlers() {\n      if (window.__TP3D_BOOT && window.__TP3D_BOOT._errorsInstalled) return;\n      window.__TP3D_BOOT = window.__TP3D_BOOT || {};\n      window.__TP3D_BOOT._errorsInstalled = true;\n\n      let shown = false;\n      const show = (title, message) => {\n        if (shown) return;\n        shown = true;\n        UIComponents.showToast(message, 'error', {\n          title,\n          duration: 0,\n          actions: [{ label: 'Reload', onClick: () => window.location.reload() }],\n        });\n      };\n\n      window.addEventListener(\n        'error',\n        ev => {\n          try {\n            const msg = ev && ev.message ? String(ev.message) : 'Unexpected error';\n            const src = ev && ev.filename ? String(ev.filename) : '';\n            if (src && (src.startsWith('chrome-extension://') || src.startsWith('moz-extension://'))) return;\n            console.error('[TruckPackerApp] Unhandled error', ev && ev.error ? ev.error : ev);\n            show('Unexpected error', msg);\n          } catch (_) {\n            // Ignore\n          }\n        },\n        true\n      );\n\n      window.addEventListener('unhandledrejection', ev => {\n        try {\n          const reason = ev && ev.reason ? ev.reason : null;\n          const msg = reason instanceof Error ? reason.message : String(reason || 'Unhandled promise rejection');\n          console.error('[TruckPackerApp] Unhandled rejection', reason);\n          show('Unhandled rejection', msg);\n        } catch (_) {\n          // Ignore\n        }\n      });\n    }\n\n    function init() {\n      console.info('[TruckPackerApp] init start');\n      installGlobalErrorHandlers();\n      if (!validateRuntime()) return;\n      seedIfEmpty();\n\n      // Hash router (works on any static server): #/packs, #/cases, ...\n      Router.init({\n        defaultScreen: 'packs',\n        onScreen: screen => {\n          if (StateStore.get('currentScreen') === screen) return;\n          StateStore.set({ currentScreen: screen }, { skipHistory: true });\n        },\n      });\n\n      PreferencesManager.applyTheme(StateStore.get('preferences').theme);\n\n      AppShell.init();\n      PacksUI.init();\n      CasesUI.init();\n      EditorUI.init();\n      UpdatesUI.init();\n      RoadmapUI.init();\n      SettingsUI.init();\n      wireGlobalButtons();\n      KeyboardManager.init();\n\n      StateStore.subscribe(changes => {\n        if (\n          changes.preferences ||\n          changes.caseLibrary ||\n          changes.packLibrary ||\n          changes.currentPackId ||\n          changes._undo ||\n          changes._redo ||\n          changes._replace\n        ) {\n          Storage.saveSoon();\n        }\n        if (changes.preferences || changes._undo || changes._redo || changes._replace) {\n          const prefs = StateStore.get('preferences');\n          if (prefs && prefs.theme) PreferencesManager.applyTheme(prefs.theme);\n          SceneManager.refreshTheme();\n          SettingsUI.loadForm();\n        }\n\n        if (changes.currentScreen) {\n          Router.setScreen(StateStore.get('currentScreen'));\n          AppShell.renderShell();\n          if (StateStore.get('currentScreen') === 'editor') EditorUI.render();\n        }\n\n        if (changes.caseLibrary || changes.packLibrary || changes._undo || changes._redo || changes._replace) {\n          PacksUI.render();\n          CasesUI.render();\n          EditorUI.render();\n          if (StateStore.get('currentScreen') === 'editor') AppShell.renderShell();\n        }\n        if (changes.currentPackId) {\n          AppShell.renderShell();\n          EditorUI.render();\n        }\n        if (changes.selectedInstanceIds) {\n          EditorUI.render();\n        }\n      });\n\n      renderAll();\n      UIComponents.showToast('Ready', 'success', { title: 'Truck Packer 3D' });\n    }\n\n    return {\n      init,\n      ui: {\n        showToast: UIComponents.showToast,\n        showModal: UIComponents.showModal,\n        confirm: UIComponents.confirm,\n      },\n      _debug: { Utils, StateStore, Storage, CaseLibrary, PackLibrary, Defaults },\n    };\n  })();\n\n  const boot = () => {\n    console.info('[TruckPackerApp] boot -> init');\n    try {\n      window.TruckPackerApp.init();\n    } catch (err) {\n      console.error('[TruckPackerApp] init failed', err);\n      try {\n        const overlay = document.getElementById('system-overlay');\n        const titleEl = document.getElementById('system-title');\n        const messageEl = document.getElementById('system-message');\n        const listEl = document.getElementById('system-list');\n        if (!overlay || !titleEl || !messageEl || !listEl) throw new Error('System overlay not available');\n        titleEl.textContent = 'Startup error';\n        messageEl.textContent =\n          err && err.message ? String(err.message) : 'An unexpected error occurred during startup.';\n        listEl.innerHTML = '';\n        [\n          'Try reloading the page',\n          'If this persists, clear site data (localStorage) and reload',\n          'Open DevTools Console for details',\n        ].forEach(text => {\n          const li = document.createElement('li');\n          li.textContent = text;\n          listEl.appendChild(li);\n        });\n        overlay.classList.add('active');\n      } catch (_) {\n        const message = err && err.message ? String(err.message) : 'An unexpected error occurred during startup.';\n        const fallbackTips =\n          '<ul><li>Try reloading the page</li><li>If this persists, clear site data (localStorage) and reload</li><li>Open DevTools Console for details</li></ul>';\n        const ui = window.TruckPackerApp && window.TruckPackerApp.ui;\n        if (ui && typeof ui.showModal === 'function') {\n          ui.showModal({\n            title: 'Startup error',\n            content: `<p>${message}</p>${fallbackTips}`,\n            actions: [{ label: 'Close' }],\n          });\n        } else if (ui && typeof ui.showToast === 'function') {\n          ui.showToast('Startup error: ' + message, 'error', { title: 'Truck Packer 3D' });\n        } else {\n          console.error('Startup error:', message);\n        }\n      }\n    }\n  };\n\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', boot);\n  } else {\n    boot();\n  }\n})();\n","usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/auth/permissions.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/auth/session.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/config/features.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/config/plans.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/config/roles.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/core/constants.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/core/event-bus.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/core/state.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/core/storage.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/data/models/case.model.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/data/models/org.model.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/data/models/pack.model.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/data/models/user.model.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/data/repositories/base.repository.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/data/repositories/local.repository.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/data/services/analytics.service.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/data/services/billing.service.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/data/services/cases.service.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/data/services/collaboration.service.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/data/services/maps.service.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/data/services/orgs.service.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/data/services/packs.service.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/data/services/users.service.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/features/editor/model-loader.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/router.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/ui/components/account-switcher.js","messages":[{"ruleId":"consistent-return","severity":1,"message":"Expected to return a value at the end of method 'onClick'.","line":71,"column":21,"nodeType":"ArrowFunctionExpression","messageId":"missingReturn","endLine":71,"endColumn":23},{"ruleId":"consistent-return","severity":1,"message":"Expected to return a value at the end of method 'onClick'.","line":79,"column":21,"nodeType":"ArrowFunctionExpression","messageId":"missingReturn","endLine":79,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { clearSession, getSession, setCurrentOrgId, subscribeSession } from '../../auth/session.js';\n\nfunction el(tag, attrs = {}, children = []) {\n  const node = document.createElement(tag);\n  Object.entries(attrs || {}).forEach(([k, v]) => {\n    if (k === 'className') node.className = v;\n    else if (k === 'text') node.textContent = v;\n    else node.setAttribute(k, String(v));\n  });\n  children.forEach(c => node.appendChild(c));\n  return node;\n}\n\nexport function mountAccountSwitcher({ buttonEl, ui, onOrgChange, onSettings, onLogout }) {\n  if (!buttonEl) return () => {};\n  const openDropdown = ui && ui.openDropdown ? ui.openDropdown : null;\n  const showModal = ui && ui.showModal ? ui.showModal : null;\n  const showToast = ui && ui.showToast ? ui.showToast : null;\n\n  function renderLabel() {\n    const session = getSession();\n    const org = session.currentOrg || null;\n    const name = org && org.name ? org.name : 'Account';\n    const role = org && org.role ? org.role : '';\n    buttonEl.querySelector('[data-account-label]').textContent = role ? `${name} (${role})` : name;\n  }\n\n  function open() {\n    if (!openDropdown) return;\n    const session = getSession();\n    const currentId = session.user && session.user.currentOrgId ? session.user.currentOrgId : null;\n    const orgs = Array.isArray(session.orgs) ? session.orgs : [];\n    const current = session.currentOrg || orgs.find(o => o.id === currentId) || orgs[0] || null;\n    const currentRole = current && current.role ? current.role : 'Owner';\n\n    const items = [\n      ...orgs.map(org => ({\n        label: org.id === currentId ? `${org.name} (${currentRole})` : `${org.name}`,\n        icon: 'fa-regular fa-user',\n        rightIcon: org.id === currentId ? 'fa-solid fa-check' : '',\n        onClick: () => {\n          try {\n            onOrgChange && onOrgChange({ phase: 'before', nextOrgId: org.id, previousOrgId: currentId });\n            setCurrentOrgId(org.id);\n            onOrgChange && onOrgChange({ phase: 'after', nextOrgId: org.id, previousOrgId: currentId });\n            showToast && showToast(`Switched to ${org.name}`, 'success');\n          } catch (err) {\n            showToast && showToast(err.message, 'error');\n          }\n        },\n      })),\n      {\n        label: 'Create Organization',\n        icon: 'fa-solid fa-plus',\n        onClick: () => {\n          if (showModal) {\n            showModal({\n              title: 'Create Organization',\n              content: el('div', { className: 'muted', text: 'Coming soon' }),\n              actions: [{ label: 'Close', variant: 'primary' }],\n            });\n            return;\n          }\n          showToast && showToast('Coming soon', 'info');\n        },\n      },\n      { type: 'divider' },\n      {\n        label: 'Settings',\n        icon: 'fa-solid fa-gear',\n        onClick: () => {\n          if (typeof onSettings === 'function') return onSettings('preferences');\n          showToast && showToast('Settings not available', 'warning');\n        },\n      },\n      {\n        label: 'Log out',\n        icon: 'fa-solid fa-right-from-bracket',\n        onClick: () => {\n          clearSession();\n          if (typeof onLogout === 'function') return onLogout();\n          try {\n            window.location.hash = '#/packs';\n          } catch {\n            // ignore\n          }\n          showToast && showToast('Logged out', 'info');\n        },\n      },\n    ];\n\n    const rect = buttonEl.getBoundingClientRect();\n    openDropdown(buttonEl, items, { align: 'left', width: rect.width });\n  }\n\n  const onClick = () => open();\n  buttonEl.addEventListener('click', onClick);\n\n  renderLabel();\n  const unsub = subscribeSession(() => renderLabel());\n\n  return () => {\n    unsub && unsub();\n    buttonEl.removeEventListener('click', onClick);\n  };\n}\n","usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/utils/debounce.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/utils/json.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/utils/uuid.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]},{"filePath":"/Users/franciscooliveira/Library/CloudStorage/Dropbox/360Virtual Tour Solutions/Projects/Truck Packer 3D/src/vendor/loader.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-floating-decimal","replacedBy":["@stylistic/no-floating-decimal"],"info":{"message":"Formatting rules are being moved out of ESLint core.","url":"https://eslint.org/blog/2023/10/deprecating-formatting-rules/","deprecatedSince":"8.53.0","availableUntil":"11.0.0","replacedBy":[{"message":"ESLint Stylistic now maintains deprecated stylistic core rules.","url":"https://eslint.style/guide/migration","plugin":{"name":"@stylistic/eslint-plugin","url":"https://eslint.style"},"rule":{"name":"no-floating-decimal","url":"https://eslint.style/rules/no-floating-decimal"}}]}}]}]